<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>DialTrader — Watch Trading Desk</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2MDAgNzAwIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPgogIDxkZWZzPgogICAgPHJhZGlhbEdyYWRpZW50IGlkPSJmY2dvbGQiIGN4PSI1MCUiIGN5PSI0NSUiIHI9IjY1JSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNGRkYzQjUiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIzMCUiIHN0b3AtY29sb3I9IiNFNUMxNUEiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI2NSUiIHN0b3AtY29sb3I9IiNDODlFMkYiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjOEE2QTFGIi8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJmY2VkZ2UiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI0ZGRjZDQyIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iI0Q0QTYzQSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3QTVBMTgiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNzAwIiBmaWxsPSIjMEEwQTBBIi8+CiAgPGNpcmNsZSBjeD0iMzAwIiBjeT0iMzMwIiByPSIyMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0idXJsKCNmY2dvbGQpIiBzdHJva2Utd2lkdGg9IjUwIi8+CiAgPGNpcmNsZSBjeD0iMzAwIiBjeT0iMzMwIiByPSIxODAiIGZpbGw9Im5vbmUiIHN0cm9rZT0idXJsKCNmY2VkZ2UpIiBzdHJva2Utd2lkdGg9IjMiIG9wYWNpdHk9IjAuNyIvPgogIDxjaXJjbGUgY3g9IjMwMCIgY3k9IjMzMCIgcj0iMTYwIiBmaWxsPSIjMEUwRTBFIiBzdHJva2U9InVybCgjZmNlZGdlKSIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGcgc3Ryb2tlPSJ1cmwoI2ZjZWRnZSkiIHN0cm9rZS13aWR0aD0iNiI+CiAgICA8bGluZSB4MT0iMzAwIiB5MT0iMTYwIiB4Mj0iMzAwIiB5Mj0iMTkwIi8+CiAgICA8bGluZSB4MT0iMzAwIiB5MT0iNDcwIiB4Mj0iMzAwIiB5Mj0iNTAwIi8+CiAgICA8bGluZSB4MT0iMTMwIiB5MT0iMzMwIiB4Mj0iMTYwIiB5Mj0iMzMwIi8+CiAgICA8bGluZSB4MT0iNDQwIiB5MT0iMzMwIiB4Mj0iNDcwIiB5Mj0iMzMwIi8+CiAgPC9nPgogIDxnIHN0cm9rZT0idXJsKCNmY2VkZ2UpIiBzdHJva2UtbGluZWNhcD0icm91bmQiPgogICAgPGxpbmUgeDE9IjMwMCIgeTE9IjMzMCIgeDI9IjI1MCIgeTI9IjI2MCIgc3Ryb2tlLXdpZHRoPSIxMCIvPgogICAgPGxpbmUgeDE9IjMwMCIgeTE9IjMzMCIgeDI9IjM4MCIgeTI9IjI1MCIgc3Ryb2tlLXdpZHRoPSI2Ii8+CiAgPC9nPgogIDxjaXJjbGUgY3g9IjMwMCIgY3k9IjMzMCIgcj0iMTAiIGZpbGw9InVybCgjZmNlZGdlKSIvPgo8L3N2Zz4=">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,700;1,400;1,500&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
  const SUPABASE_URL  = 'https://kstbnvcozplquymqecck.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzdGJudmNvenBscXV5bXFlY2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzY5ODYsImV4cCI6MjA4NzQ1Mjk4Nn0.RqcYRWvz4O-V1L5NAne8mP-nHKff8V451nAzle3CLWU';;
  // Business info now loaded from user profile (see userProfile variable in JS)
  const WIRE_BANK    = 'Centennial Bank';
  const WIRE_NAME    = 'NXT Enterprises LLC';
  const WIRE_ADDRESS = '345 Nob Hill St Conway, AR 72034';
  const WIRE_ACCOUNT = '502483711';
  const WIRE_ROUTING = '082902757';

</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F5F2ED;--surface:#FFFFFF;--surface2:#EEEBE5;--border:#DDD8D0;--border2:#CCC8C0;
  --text:#1A1A1A;--text2:#7A756E;--gold:#B8943A;--gold2:#D4AF5A;--gold-dim:rgba(184,148,58,0.12);
  --green:#3A7A5A;--green-dim:rgba(58,122,90,0.1);--red:#B03A3A;--red-dim:rgba(176,58,58,0.1);
  --blue:#3A6A9A;--blue-dim:rgba(58,106,154,0.1);--charcoal:#2A2A2A;--sidebar-w:210px;
}
html,body{height:100%;}
body{font-family:'Raleway',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes load{to{left:110%;}}

/* LOADING */
#loading-screen{display:none;position:fixed;inset:0;background:var(--charcoal);align-items:center;justify-content:center;flex-direction:column;gap:1.25rem;z-index:9999;}
#loading-screen.visible{display:flex;}
.loading-logo{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:500;letter-spacing:0.15em;color:#C9A84C;text-transform:uppercase;}
.loading-logo span{font-style:italic;color:#fff;}
.loading-bar{width:140px;height:1px;background:#444;position:relative;overflow:hidden;}
.loading-bar::after{content:'';position:absolute;left:-60%;top:0;width:60%;height:100%;background:#C9A84C;animation:load 1.2s ease infinite;}

/* AUTH */
#auth-screen{display:none;min-height:100vh;align-items:center;justify-content:center;background:var(--charcoal);}
#auth-screen.visible{display:flex;}
.auth-box{width:420px;max-width:95vw;background:#fff;border:1px solid var(--border2);padding:2.5rem;box-shadow:0 8px 40px rgba(0,0,0,0.2);}
.auth-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:500;letter-spacing:0.15em;color:var(--charcoal);text-transform:uppercase;text-align:center;margin-bottom:0.25rem;}
.auth-logo em{font-style:italic;color:var(--gold);}
.auth-tagline{text-align:center;font-size:0.62rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text2);margin-bottom:2rem;}
.auth-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1.5rem;}
.auth-tab{flex:1;text-align:center;padding:0.6rem;font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;font-weight:600;}
.auth-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.auth-form{display:none;}.auth-form.active{display:block;}
.auth-label{display:block;font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);margin-bottom:0.4rem;font-weight:600;}
.auth-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:0.7rem 0.85rem;font-family:'Raleway',sans-serif;font-size:0.82rem;outline:none;margin-bottom:1rem;transition:border-color 0.15s;}
.auth-input:focus{border-color:var(--gold);}
.auth-btn{width:100%;background:var(--charcoal);color:#fff;border:none;padding:0.75rem;font-family:'Raleway',sans-serif;font-size:0.75rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:background 0.15s;margin-top:0.5rem;}
.auth-btn:hover{background:#444;}.auth-btn:disabled{opacity:0.5;cursor:not-allowed;}
.auth-error{font-size:0.7rem;color:var(--red);margin-top:0.75rem;text-align:center;min-height:1.2rem;}
.auth-success{font-size:0.7rem;color:var(--green);margin-top:0.75rem;text-align:center;}

/* APP LAYOUT */
#app-screen{display:none;height:100vh;}
#app-screen.visible{display:flex;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--charcoal);display:flex;flex-direction:column;height:100vh;overflow-y:auto;border-right:3px solid var(--gold);}
.sidebar-logo{padding:1rem 0.75rem 0.75rem;border-bottom:1px solid #3A3A3A;text-align:center;}
.sidebar-logo-text{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:500;letter-spacing:0.1em;color:#fff;text-transform:uppercase;}
.sidebar-logo-text em{font-style:italic;color:var(--gold2);}
.sidebar-logo-sub{font-size:0.68rem;letter-spacing:0.18em;text-transform:uppercase;color:#999;margin-top:0.3rem;font-weight:500;}
.sidebar-section-label{font-size:0.52rem;letter-spacing:0.22em;text-transform:uppercase;color:#555;padding:1rem 1.25rem 0.4rem;font-weight:700;}
.nav-item{display:flex;align-items:center;gap:0.7rem;padding:0.65rem 1.25rem;font-size:0.75rem;font-weight:500;letter-spacing:0.04em;color:#AAA;cursor:pointer;transition:all 0.15s;border-left:3px solid transparent;margin-left:-3px;}
.nav-item:hover{color:#fff;background:rgba(255,255,255,0.05);}
.nav-item.active{color:#fff;background:rgba(184,148,58,0.15);border-left-color:var(--gold2);}
.nav-divider{height:1px;background:var(--border2);margin:0.5rem 1.25rem;}

/* ── STOREFRONT PAGE ── */
.sf-layout{display:grid;grid-template-columns:320px minmax(0,1fr);gap:0;border:1px solid var(--border);height:calc(100vh - 200px);overflow:hidden;}
.sf-controls{background:var(--surface2);border-right:1px solid var(--border);padding:1.5rem;overflow-y:auto;overflow-x:hidden;}
.sf-preview-pane{background:var(--bg);display:flex;flex-direction:column;height:100%;overflow:hidden;}
.sf-section-label{font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--text2);margin:1.25rem 0 0.6rem;padding-bottom:0.4rem;border-bottom:1px solid var(--border);}
.sf-section-label:first-child{margin-top:0;}
.sf-theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-bottom:0.25rem;}
.sf-theme-swatch{
  border:2px solid transparent;border-radius:2px;cursor:pointer;overflow:hidden;
  transition:border-color 0.15s;aspect-ratio:3/2;position:relative;
}
.sf-theme-swatch.active{border-color:var(--gold2);}
.sf-theme-swatch-inner{width:100%;height:100%;display:flex;flex-direction:column;}
.sf-swatch-header{flex:0 0 40%;display:flex;align-items:center;justify-content:center;}
.sf-swatch-body{flex:1;display:flex;align-items:center;justify-content:center;}
.sf-swatch-dot{width:8px;height:8px;border-radius:50%;}
.sf-swatch-label{font-size:0.58rem;color:var(--text2);text-align:center;margin-top:0.3rem;}
.sf-font-list{display:flex;flex-direction:column;gap:0.4rem;}
.sf-font-item{
  padding:0.6rem 0.75rem;border:1px solid var(--border);cursor:pointer;
  transition:border-color 0.15s,background 0.15s;
}
.sf-font-item:hover{background:rgba(255,255,255,0.04);}
.sf-font-item.active{border-color:var(--gold2);background:rgba(184,148,58,0.08);}
.sf-font-display{font-size:0.95rem;color:var(--text1);margin-bottom:0.1rem;}
.sf-font-sub{font-size:0.6rem;color:var(--text2);letter-spacing:0.05em;}
.sf-hero-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;}
.sf-hero-thumb{
  aspect-ratio:16/9;background-size:cover;background-position:center;
  border:2px solid transparent;cursor:pointer;transition:border-color 0.15s;
  position:relative;overflow:hidden;
}
.sf-hero-thumb.active{border-color:var(--gold2);}
.sf-hero-thumb-label{
  position:absolute;bottom:0;left:0;right:0;
  background:rgba(0,0,0,0.6);font-size:0.58rem;color:#fff;
  padding:0.25rem 0.4rem;text-align:center;
}
.sf-custom-url{width:100%;margin-top:0.5rem;}
.sf-preview-bar{
  background:var(--surface2);border-bottom:1px solid var(--border);
  padding:0.5rem 1rem;display:flex;align-items:center;gap:0.5rem;
}
.sf-preview-dot{width:10px;height:10px;border-radius:50%;}
.sf-preview-url{
  flex:1;background:rgba(255,255,255,0.05);border:1px solid var(--border);
  padding:0.2rem 0.75rem;font-size:0.62rem;color:var(--text2);font-family:monospace;
}
.sf-preview-frame{flex:1;border:none;width:100%;min-height:500px;background:#fff;}
.sf-download-bar{
  padding:1rem 1.5rem;border-top:1px solid var(--border);background:var(--surface2);
  display:flex;align-items:center;gap:1rem;flex-wrap:wrap;
}
.sf-status{font-size:0.72rem;color:var(--text2);flex:1;}
.sf-status strong{color:var(--gold2);}
@media(max-width:900px){.sf-layout{grid-template-columns:1fr;}.sf-preview-pane{min-height:400px;}}


.card{background:var(--surface2);border:1px solid var(--border);padding:1.5rem;}
.card-title{font-family:'Playfair Display',serif;font-size:1rem;font-weight:500;color:var(--text1);margin-bottom:0.25rem;}
.card-sub{font-size:0.72rem;color:var(--text2);margin-bottom:0.25rem;}

/* ── HELP CENTER ── */
.help-layout{display:grid;grid-template-columns:220px minmax(0,1fr);gap:0;border:1px solid var(--border);height:calc(100vh - 200px);overflow:hidden;}
.help-sidebar{background:var(--surface2);border-right:1px solid var(--border);padding:1rem 0;overflow-y:auto;overflow-x:hidden;}
.help-nav-section{font-size:0.58rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--text2);padding:0.75rem 1.25rem 0.35rem;margin-top:0.5rem;}
.help-nav-section:first-child{margin-top:0;}
.help-nav-item{font-size:0.75rem;color:#AAA;padding:0.5rem 1.25rem;cursor:pointer;transition:all 0.15s;border-left:3px solid transparent;}
.help-nav-item:hover{color:#fff;background:rgba(255,255,255,0.04);}
.help-nav-item.active{color:#fff;background:rgba(184,148,58,0.1);border-left-color:var(--gold2);}
.help-content{padding:2rem 2.5rem;overflow-y:auto;overflow-x:hidden;min-width:0;box-sizing:border-box;}
.help-article h1{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:500;color:var(--text1);margin-bottom:0.5rem;}
.help-article .help-tag{display:inline-block;font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;background:rgba(184,148,58,0.15);color:var(--gold2);padding:0.2rem 0.6rem;margin-bottom:1.25rem;}
.help-article h2{font-family:'Playfair Display',serif;font-size:1rem;font-weight:500;color:var(--text1);margin:1.75rem 0 0.6rem;}
.help-article p{font-size:0.82rem;color:var(--text2);line-height:1.8;margin-bottom:0.85rem;}
.help-article ul,.help-article ol{margin:0.5rem 0 0.85rem 1.5rem;}
.help-article li{font-size:0.82rem;color:var(--text2);line-height:1.8;margin-bottom:0.3rem;}
.help-article .help-tip{background:rgba(184,148,58,0.08);border-left:3px solid var(--gold2);padding:0.85rem 1rem;margin:1.25rem 0;font-size:0.8rem;color:var(--text2);line-height:1.7;}
.help-article .help-tip strong{color:var(--gold2);}
.help-article .help-warn{background:rgba(192,57,43,0.08);border-left:3px solid #C0392B;padding:0.85rem 1rem;margin:1.25rem 0;font-size:0.8rem;color:var(--text2);line-height:1.7;}
.help-article code{background:rgba(255,255,255,0.08);padding:0.15rem 0.4rem;font-family:monospace;font-size:0.78rem;color:#ddd;border:1px solid var(--border);}
.help-article .help-step{display:flex;gap:1rem;margin-bottom:1rem;align-items:flex-start;}
.help-article .help-step-num{width:26px;height:26px;background:var(--gold2);color:var(--charcoal);font-size:0.72rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:0.1rem;}
.help-article .help-step-body{flex:1;}
.help-article .help-step-body strong{display:block;font-size:0.82rem;color:var(--text1);margin-bottom:0.2rem;}
.help-article .help-step-body span{font-size:0.78rem;color:var(--text2);line-height:1.7;}
.help-article a{color:var(--gold2);text-decoration:none;}
.help-article a:hover{text-decoration:underline;}
.help-divider{height:1px;background:var(--border);margin:1.5rem 0;}
@media(max-width:700px){.help-layout{grid-template-columns:1fr;}.help-sidebar{border-right:none;border-bottom:1px solid var(--border);}}
.nav-icon{font-size:1rem;width:1.2rem;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--gold);color:#fff;font-size:0.55rem;font-weight:700;padding:0.1rem 0.4rem;border-radius:2px;}
.sidebar-footer{margin-top:auto;padding:1rem 1.25rem;border-top:1px solid #3A3A3A;}
.sidebar-user{font-size:0.65rem;color:#666;margin-bottom:0.6rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sidebar-signout{font-size:0.65rem;color:#888;cursor:pointer;letter-spacing:0.06em;text-transform:uppercase;}
.sidebar-signout:hover{color:var(--red);}

/* MAIN */
.main-content{flex:1;overflow-y:auto;height:100vh;}
.page{display:none;padding:2rem;padding-bottom:5rem;animation:fadeIn 0.25s ease;}
.page.active{display:block;min-height:0;}

/* BUTTONS */
.btn-gold{background:var(--gold);color:#fff;border:none;padding:0.5rem 1.2rem;font-family:'Raleway',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:background 0.15s;}
.btn-gold:hover{background:var(--gold2);}
.btn-outline{background:none;color:var(--text2);border:1px solid var(--border2);padding:0.5rem 1rem;font-family:'Raleway',sans-serif;font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.15s;}
.btn-outline:hover{color:var(--text);border-color:var(--text2);}
.btn-dark{background:var(--charcoal);color:#fff;border:none;padding:0.5rem 1.2rem;font-family:'Raleway',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;}
.btn-dark:hover{background:#444;}
.btn-danger{background:none;border:1px solid var(--red);color:var(--red);padding:0.5rem 1rem;font-family:'Raleway',sans-serif;font-size:0.7rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.15s;}
.btn-danger:hover{background:var(--red-dim);}
.btn-sm{padding:0.3rem 0.75rem;font-size:0.62rem;}

/* PAGE HEADER */
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:0.75rem;}
.page-title{font-family:'Playfair Display',serif;font-size:2rem;font-weight:400;}
.page-title span{color:var(--gold);font-style:italic;}
.page-subtitle{font-size:0.72rem;color:var(--text2);margin-top:0.25rem;}

/* DASHBOARD */
.dash-hero{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border:1px solid var(--border);margin-bottom:2rem;}
@media(max-width:900px){.dash-hero{grid-template-columns:repeat(2,1fr);}}
.hero-stat{background:var(--surface);padding:1.5rem;position:relative;overflow:hidden;}
.hero-stat::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--gold);transform:scaleX(0);transform-origin:left;transition:transform 0.6s cubic-bezier(0.4,0,0.2,1);}
.hero-stat.loaded::after{transform:scaleX(1);}
.hero-label{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text2);margin-bottom:0.6rem;font-weight:600;}
.hero-value{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:400;line-height:1;margin-bottom:0.3rem;}
.hero-value.green{color:var(--green);}.hero-value.gold{color:var(--gold);}.hero-value.red{color:var(--red);}
.hero-sub{font-size:0.62rem;color:var(--text2);}
.dash-grid{display:grid;grid-template-columns:1fr 300px;gap:1.5rem;}
@media(max-width:900px){.dash-grid{grid-template-columns:1fr;}}
.panel{background:var(--surface);border:1px solid var(--border);padding:1.5rem;}
.panel-title{font-size:0.62rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);margin-bottom:1.25rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border);font-weight:600;}
.mini-table{width:100%;border-collapse:collapse;}
.mini-table th{font-size:0.58rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);text-align:left;padding:0 0.75rem 0.75rem;border-bottom:1px solid var(--border);font-weight:600;}
.mini-table td{padding:0.75rem;font-size:0.75rem;border-bottom:1px solid var(--border);vertical-align:middle;}
.mini-table tr:last-child td{border-bottom:none;}
.mini-table tr:hover td{background:var(--surface2);}
.brand-badge{font-size:0.6rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--gold);background:var(--gold-dim);padding:0.15rem 0.5rem;display:inline-block;}
.days-pill{font-size:0.65rem;padding:0.15rem 0.5rem;background:var(--surface2);color:var(--text2);}
.days-pill.warn{background:rgba(176,58,58,0.15);color:var(--red);}
.days-pill.ok{background:var(--green-dim);color:var(--green);}
.brand-row{display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;}
.brand-name{font-size:0.72rem;min-width:80px;color:var(--text2);}
.brand-bar-wrap{flex:1;height:4px;background:var(--border);}
.brand-bar{height:100%;background:var(--gold);transition:width 0.8s cubic-bezier(0.4,0,0.2,1);}
.brand-profit{font-size:0.7rem;color:var(--green);min-width:70px;text-align:right;}

/* FILTER BAR */
.filter-bar{display:flex;gap:0.5rem;margin-bottom:1.5rem;align-items:center;flex-wrap:wrap;}
.search-input{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.85rem;font-family:'Raleway',sans-serif;font-size:0.75rem;outline:none;width:260px;transition:border-color 0.15s;}
.search-input::placeholder{color:var(--text2);}.search-input:focus{border-color:var(--gold);}
.filter-select{background:var(--surface);border:1px solid var(--border);color:var(--text2);padding:0.5rem 0.75rem;font-family:'Raleway',sans-serif;font-size:0.72rem;outline:none;cursor:pointer;}

/* INVENTORY */
.inv-rows{border:1px solid var(--border);background:var(--border);display:flex;flex-direction:column;gap:1px;}
.inv-row-header{display:grid;grid-template-columns:2.4fr 1fr 1fr 1fr 1fr 0.8fr 1fr;padding:0.5rem 1.25rem;background:var(--bg);gap:1rem;border-bottom:1px solid var(--border);}
.inv-row-header span{font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);font-weight:600;}
.inv-row{display:grid;grid-template-columns:2.4fr 1fr 1fr 1fr 1fr 0.8fr 1fr;align-items:center;padding:0.9rem 1.25rem;background:var(--surface);gap:1rem;cursor:pointer;transition:background 0.15s;}
.inv-row:hover{background:#EDE8E0;}
.inv-row:nth-child(even){background:var(--surface2);}
.inv-row:nth-child(even):hover{background:#E5E0D8;}
.inv-row-brand{font-size:0.64rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--gold);margin-bottom:0.25rem;font-weight:600;}
.inv-row-model{font-family:'Playfair Display',serif;font-size:1.1rem;line-height:1.25;color:var(--text);margin-bottom:0.2rem;}
.inv-row-sub{font-size:0.7rem;color:var(--text2);}
.inv-row-val{font-size:0.9rem;color:var(--text);}
.inv-row-val.gold{color:var(--gold);}.inv-row-val.green{color:var(--green);}.inv-row-val.red{color:var(--red);}.inv-row-val.muted{color:var(--text2);font-size:0.82rem;}

/* SOLD TABLE */
.sold-table{width:100%;border-collapse:collapse;}
.sold-table th{font-size:0.58rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);text-align:left;padding:0.6rem 0.75rem;border-bottom:2px solid var(--border);white-space:nowrap;cursor:pointer;font-weight:600;background:var(--bg);}
.sold-table th:hover{color:var(--gold);}
.sold-table td{padding:0.8rem 0.75rem;font-size:0.74rem;border-bottom:1px solid var(--border);vertical-align:middle;}
.sold-table tr{cursor:pointer;}.sold-table tr:hover td{background:var(--surface2);}
.profit-badge{display:inline-block;padding:0.15rem 0.5rem;font-size:0.68rem;font-weight:700;}
.profit-badge.pos{background:var(--green-dim);color:var(--green);}
.profit-badge.neg{background:var(--red-dim);color:var(--red);}

/* CONTACTS */
.contacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;}
.contact-card-item{background:var(--surface);border:1px solid var(--border);padding:1.25rem;cursor:pointer;transition:all 0.15s;display:flex;flex-direction:column;gap:0.5rem;}
.contact-card-item:hover{box-shadow:0 4px 20px rgba(0,0,0,0.08);transform:translateY(-2px);border-color:var(--gold);}
.contact-card-name{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:400;}
.contact-card-info{font-size:0.72rem;color:var(--text2);line-height:1.6;}
.contact-card-stats{display:flex;gap:0.75rem;margin-top:0.25rem;padding-top:0.75rem;border-top:1px solid var(--border);}
.contact-stat{text-align:center;}
.contact-stat-val{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--gold);}
.contact-stat-label{font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text2);}
.contact-tag{display:inline-block;font-size:0.55rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.15rem 0.5rem;margin-right:0.25rem;}
.contact-tag.buyer{background:var(--blue-dim);color:var(--blue);}
.contact-tag.seller{background:var(--green-dim);color:var(--green);}
.contact-tag.both{background:var(--gold-dim);color:var(--gold);}
.contact-history-item{display:flex;align-items:center;justify-content:space-between;padding:0.85rem 1rem;background:var(--surface);border:1px solid var(--border);margin-bottom:0.5rem;gap:1rem;}
.contact-history-type{font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.2rem 0.5rem;}
.contact-history-type.bought{background:var(--green-dim);color:var(--green);}
.contact-history-type.sold-to{background:var(--blue-dim);color:var(--blue);}

/* INVOICES LIST */
.invoice-list{display:flex;flex-direction:column;gap:0.75rem;}
.invoice-item{background:var(--surface);border:1px solid var(--border);padding:1rem 1.25rem;display:grid;grid-template-columns:90px 1fr auto auto auto;align-items:center;gap:1rem;cursor:pointer;transition:background 0.15s;}
.invoice-item:hover{background:var(--surface2);border-color:var(--gold);}
.invoice-num{font-family:'Playfair Display',serif;font-size:1rem;color:var(--gold);}
.invoice-client{font-size:0.85rem;font-weight:500;}
.invoice-desc{font-size:0.7rem;color:var(--text2);}
.invoice-amount{font-family:'Playfair Display',serif;font-size:1.1rem;text-align:right;}
.invoice-status{font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.2rem 0.6rem;}
.invoice-status.paid{background:var(--green-dim);color:var(--green);}
.invoice-status.unpaid{background:var(--red-dim);color:var(--red);}
.invoice-status.partial{background:var(--gold-dim);color:var(--gold);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;align-items:center;justify-content:center;padding:1rem;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);width:600px;max-width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.15);}
.modal-lg{width:860px;}
.modal-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--charcoal);}
.modal-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:400;color:#fff;}
.modal-close{background:none;border:none;color:#888;font-size:1.2rem;cursor:pointer;line-height:1;padding:0.25rem;}
.modal-close:hover{color:#fff;}
.modal-body{padding:1.5rem;}
.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:0.75rem;background:var(--bg);}
.modal-actions{display:flex;gap:0.5rem;}
.modal-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1.25rem;overflow-x:auto;}
.modal-tab{padding:0.6rem 1rem;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;white-space:nowrap;font-family:'Raleway',sans-serif;font-weight:600;}
.modal-tab:hover{color:var(--text);}.modal-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.modal-tab-panel{display:none;}.modal-tab-panel.active{display:block;}

/* FORMS */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.form-group{margin-bottom:0;}.form-group.full{grid-column:1/-1;}
.form-label{display:block;font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);margin-bottom:0.4rem;font-weight:600;}
.form-input,.form-select,.form-textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:0.6rem 0.75rem;font-family:'Raleway',sans-serif;font-size:0.78rem;outline:none;transition:border-color 0.15s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--gold);}
.form-textarea{resize:vertical;min-height:70px;}
.section-divider{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text2);margin:0.75rem 0;display:flex;align-items:center;gap:0.75rem;}
.section-divider::before,.section-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.contact-card-form{background:var(--bg);border:1px solid var(--border);padding:1rem;margin-bottom:0.75rem;}
.contact-card-form-title{font-size:0.6rem;letter-spacing:0.16em;text-transform:uppercase;color:var(--gold);margin-bottom:0.75rem;font-weight:600;}
.color-row{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.4rem;}
.color-chip{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color 0.1s,transform 0.1s;flex-shrink:0;}
.color-chip:hover{transform:scale(1.15);}.color-chip.selected{border-color:var(--gold)!important;}
.platform-checks{display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;}
.platform-check{display:flex;align-items:center;gap:0.3rem;background:var(--surface2);border:1px solid var(--border);padding:0.25rem 0.6rem;cursor:pointer;font-size:0.7rem;transition:all 0.12s;user-select:none;position:relative;}
.platform-check:hover{border-color:var(--gold);}
.platform-check.selected{background:var(--gold-dim);border-color:var(--gold);color:var(--gold);font-weight:600;}
.platform-check input{position:absolute;opacity:0;width:0;height:0;}
/* STAGE BADGES */
.stage-badge{display:inline-flex;align-items:center;gap:0.3rem;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.2rem 0.55rem;font-weight:700;white-space:nowrap;border-radius:2px;}
.stage-0{background:#2a2a2a;color:#888;}           /* Purchased - awaiting payment */
.stage-1{background:#1e3a5f;color:#6aabff;}        /* Paid - shipping to me */
.stage-2{background:#2d1f4a;color:#b48fff;}        /* In hand - cleaning */
.stage-3{background:#3a2200;color:#ffad33;}        /* Photography / prep */
.stage-4{background:#0a3a2a;color:#3fc88a;}        /* Listed - active */
.stage-5{background:#3a1a00;color:#ff8c42;}        /* Offer accepted */
.stage-6{background:#3a0a1a;color:#ff6b9d;}        /* Authentication */
.stage-7{background:#1a1a3a;color:#7eb3ff;}        /* Awaiting payment */
.stage-8{background:#003a2a;color:#4dffb4;}        /* Shipped to buyer */
.stage-9{background:#1a3a00;color:#90ff60;}        /* Closed / Complete */
.stage-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
/* Stage selector in modal */
.stage-selector{display:flex;flex-direction:column;gap:0.35rem;margin-top:0.4rem;}
.stage-option{display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0.75rem;border:1px solid var(--border);cursor:pointer;transition:all 0.12s;font-size:0.74rem;}
.stage-option:hover{border-color:var(--gold);background:var(--gold-dim);}
.stage-option.selected{border-color:var(--gold);background:var(--gold-dim);}
.stage-option-num{font-size:0.6rem;color:var(--text2);min-width:1.2rem;}
.tax-year-block{background:var(--surface);border:1px solid var(--border);margin-bottom:1.5rem;}
.tax-year-header{background:var(--charcoal);color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
.tax-year-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:400;}
.tax-year-net{font-family:'Playfair Display',serif;font-size:1.5rem;}
.tax-year-net.pos{color:#7fca9f;}.tax-year-net.neg{color:#e8897a;}
.tax-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);}
.tax-summary-cell{background:var(--surface);padding:1rem 1.5rem;}
.tax-summary-label{font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);margin-bottom:0.35rem;font-weight:600;}
.tax-summary-val{font-family:'Playfair Display',serif;font-size:1.3rem;}
.tax-transactions{padding:1.5rem;}
.tax-transactions table{width:100%;border-collapse:collapse;font-size:0.74rem;}
.tax-transactions th{font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text2);padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);text-align:left;}
.tax-transactions td{padding:0.65rem 0.75rem;border-bottom:1px solid var(--border);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-thumb .photo-remove{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);color:#fff;border:none;width:20px;height:20px;border-radius:50%;font-size:0.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.photo-thumb .photo-main-badge{position:absolute;bottom:3px;left:3px;background:var(--gold);color:#fff;font-size:0.5rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.1rem 0.3rem;}

/* IMPORT */
.import-zone{border:2px dashed var(--border2);padding:3rem;text-align:center;transition:border-color 0.2s;cursor:pointer;margin-bottom:1rem;}
.import-zone:hover,.import-zone.drag{border-color:var(--gold);}
.import-zone-icon{font-size:2.5rem;margin-bottom:1rem;opacity:0.4;}
.import-zone-title{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--text2);margin-bottom:0.5rem;}
.import-zone-sub{font-size:0.72rem;color:var(--text2);line-height:1.6;}
.import-instructions{background:var(--surface);border:1px solid var(--border);padding:1.5rem;margin-bottom:1.5rem;}
.import-instructions h3{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--gold);margin-bottom:0.75rem;font-weight:500;}
.import-instructions p{font-size:0.75rem;color:var(--text2);line-height:1.7;}
.import-instructions code{background:var(--bg);padding:0.1rem 0.4rem;color:var(--gold);font-size:0.7rem;border:1px solid var(--border);}

/* INVOICE PREVIEW */
.invoice-preview{background:#fff;padding:2.5rem;font-family:'Raleway',sans-serif;border:1px solid var(--border);max-width:800px;margin:0 auto;}
.inv-hdr{display:grid;grid-template-columns:1fr auto 1fr;gap:1.5rem;align-items:start;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid #e0e0e0;}
.inv-biz-name{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:#1A1A1A;margin-bottom:0.4rem;}
.inv-biz-info{font-size:0.75rem;color:#555;line-height:1.8;}
.inv-logo-area{text-align:center;display:flex;align-items:center;justify-content:center;}
.inv-logo-placeholder{font-size:2.5rem;opacity:0.3;}
.inv-title-block{text-align:right;}
.inv-title{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:400;color:#1A1A1A;margin-bottom:0.75rem;}
.inv-meta-row{font-size:0.78rem;color:#555;display:flex;justify-content:flex-end;gap:1rem;margin-bottom:0.2rem;}
.inv-meta-row strong{color:#1A1A1A;min-width:80px;text-align:right;display:inline-block;}
.inv-bill-section{margin-bottom:2rem;padding:1.25rem;background:#f9f9f9;border-left:3px solid #2A2A2A;}
.inv-bill-label{font-size:0.6rem;letter-spacing:0.18em;text-transform:uppercase;color:#888;margin-bottom:0.5rem;font-weight:700;}
.inv-bill-name{font-size:1rem;font-weight:600;color:#1A1A1A;margin-bottom:0.25rem;}
.inv-bill-info{font-size:0.78rem;color:#555;line-height:1.7;}
.inv-table{width:100%;border-collapse:collapse;margin-bottom:1.5rem;}
.inv-table th{background:#2A2A2A;color:#fff;font-size:0.65rem;letter-spacing:0.14em;text-transform:uppercase;padding:0.65rem 1rem;text-align:left;font-weight:600;}
.inv-table th.right{text-align:right;}
.inv-table td{padding:1rem;font-size:0.82rem;border-bottom:1px solid #f0f0f0;vertical-align:top;}
.inv-table td.right{text-align:right;}
.inv-table .non-tax{font-size:0.65rem;color:#aaa;display:block;margin-top:0.2rem;}
.inv-bottom{display:grid;grid-template-columns:1fr 260px;gap:2rem;align-items:start;margin-top:1rem;}
.inv-payment-box{background:#f8f8f8;padding:1.25rem;border:1px solid #e8e8e8;}
.inv-payment-box h4{font-size:0.65rem;letter-spacing:0.16em;text-transform:uppercase;color:#888;margin-bottom:0.85rem;font-weight:700;}
.inv-payment-box p{font-size:0.78rem;color:#444;line-height:2;}
.inv-total-row{display:flex;justify-content:space-between;padding:0.4rem 0;font-size:0.82rem;color:#555;border-bottom:1px solid #f0f0f0;}
.inv-total-row.subtotal{}.inv-total-row.grand{font-weight:600;color:#1A1A1A;font-size:0.9rem;border-bottom:none;}
.inv-total-row.deposit-line{color:var(--green);}
.inv-balance-bar{background:#2A2A2A;color:#fff;display:flex;justify-content:space-between;padding:0.75rem 0;font-weight:700;font-size:1rem;margin-top:0.5rem;}
.inv-footer-note{text-align:center;margin-top:2rem;font-size:0.65rem;color:#bbb;border-top:1px solid #eee;padding-top:1rem;}
.inv-notes-box{margin-top:1.5rem;padding:1rem;background:#f8f8f8;border-left:3px solid #2A2A2A;font-size:0.78rem;color:#555;line-height:1.7;}

/* UTIL */
.empty-state{text-align:center;padding:4rem 2rem;color:var(--text2);}
.empty-state h3{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:400;margin-bottom:0.5rem;color:var(--text);}
.empty-state p{font-size:0.75rem;}
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--charcoal);border-left:3px solid var(--gold);color:#fff;padding:0.75rem 1.25rem;font-size:0.75rem;z-index:9000;display:none;animation:fadeIn 0.2s ease;max-width:340px;font-family:'Raleway',sans-serif;}
.toast.show{display:block;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);}


/* ── CONTACTS LIST VIEW ── */
.contact-list-header{display:grid;grid-template-columns:2fr 2fr 1fr 1fr;padding:0.5rem 1.25rem;background:var(--bg);border:1px solid var(--border);border-bottom:none;gap:1rem;}
.contact-list-header span{font-size:0.6rem;letter-spacing:0.14em;text-transform:uppercase;color:var(--text2);font-weight:600;}
.contacts-list{display:flex;flex-direction:column;gap:1px;background:var(--border);border:1px solid var(--border);}
.contact-list-row{display:grid;grid-template-columns:2fr 2fr 1fr 1fr;align-items:center;padding:0.85rem 1.25rem;background:var(--surface);gap:1rem;cursor:pointer;transition:background 0.15s;}
.contact-list-row:hover{background:var(--surface2);}
.contact-list-name{font-family:'Playfair Display',serif;font-size:1rem;color:var(--text1);}
.contact-list-sub{font-size:0.68rem;color:var(--text2);margin-top:0.15rem;}
.contact-list-stat{font-size:0.78rem;color:var(--text2);}
.contact-role-badge{font-size:0.58rem;padding:0.2rem 0.5rem;background:rgba(184,148,58,0.1);color:var(--gold2);border:1px solid rgba(184,148,58,0.25);white-space:nowrap;}

/* ── NOTES LOG ── */
.note-item{display:flex;gap:0.75rem;align-items:flex-start;background:var(--surface);border:1px solid var(--border);padding:0.85rem 1rem;}
.note-body{flex:1;min-width:0;}
.note-text{font-size:0.82rem;color:var(--text1);line-height:1.6;word-break:break-word;}
.note-meta{font-size:0.64rem;color:var(--text2);margin-top:0.3rem;}
.note-actions{display:flex;gap:0.3rem;flex-shrink:0;}
.note-btn{background:none;border:none;cursor:pointer;font-size:0.68rem;color:var(--text2);padding:0.2rem 0.5rem;font-family:'Raleway',sans-serif;transition:color 0.15s;}
.note-btn:hover{color:var(--text1);}
.note-btn.red:hover{color:var(--red);}
.note-edit-ta{width:100%;background:var(--bg);border:1px solid var(--border);padding:0.5rem;font-size:0.82rem;color:var(--text1);font-family:'Raleway',sans-serif;resize:vertical;box-sizing:border-box;margin-top:0.3rem;}

/* ── TRASH BIN ── */
.trash-toggle{display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.75rem;color:var(--text2);padding:0.9rem 0;margin-top:1.25rem;border-top:1px solid var(--border);user-select:none;}
.trash-toggle:hover{color:var(--text1);}
.trash-count-badge{background:rgba(176,58,58,0.15);color:var(--red);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:2px;}
.trash-list{border:1px solid rgba(176,58,58,0.2);display:flex;flex-direction:column;gap:1px;background:var(--border);}
.trash-row{display:grid;grid-template-columns:2fr 0.8fr 0.8fr auto;align-items:center;padding:0.7rem 1.1rem;background:rgba(176,58,58,0.04);gap:1rem;}
.trash-name{font-size:0.85rem;color:var(--text2);}
.trash-sub{font-size:0.65rem;color:var(--text2);opacity:0.7;}
.trash-type{font-size:0.65rem;color:var(--text2);}
.trash-expiry{font-size:0.65rem;color:var(--red);}
.trash-actions{display:flex;align-items:center;gap:0.5rem;}
.btn-restore{background:none;border:1px solid var(--border);padding:0.25rem 0.65rem;font-size:0.65rem;cursor:pointer;color:var(--text2);font-family:'Raleway',sans-serif;transition:all 0.15s;}
.btn-restore:hover{border-color:var(--green);color:var(--green);}
.trash-perm-btn{background:none;border:none;font-size:0.9rem;cursor:pointer;color:var(--text2);padding:0.2rem;line-height:1;transition:opacity 0.15s;}
.trash-perm-btn:hover{opacity:0.6;}
.trash-del-btn{background:none;border:none;font-size:0.85rem;cursor:pointer;color:var(--text2);padding:0.15rem;line-height:1;transition:opacity 0.15s;margin-left:auto;}
.trash-del-btn:hover{opacity:0.5;}

/* ── BOTTOM NAV ── */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:1000;background:var(--charcoal);border-top:2px solid var(--gold);padding-bottom:env(safe-area-inset-bottom,0px);}
.bnav-inner{display:flex;height:56px;}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:none;border:none;cursor:pointer;color:#777;font-size:0.48rem;letter-spacing:0.07em;text-transform:uppercase;font-weight:600;font-family:'Raleway',sans-serif;-webkit-tap-highlight-color:transparent;transition:color 0.15s;}
.bnav-btn.active{color:var(--gold2);}
.bnav-icon{font-size:1.2rem;line-height:1;}
#more-overlay{display:none;position:fixed;inset:0;z-index:998;background:rgba(0,0,0,0.35);}
#more-overlay.open{display:block;}
#more-menu{display:none;position:fixed;bottom:56px;left:0;right:0;z-index:999;background:var(--charcoal);border-top:1px solid #333;box-shadow:0 -8px 32px rgba(0,0,0,0.45);}
#more-menu.open{display:block;}
.more-item{display:flex;align-items:center;gap:1rem;padding:0.9rem 1.5rem;color:#999;font-size:0.82rem;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;}
.more-item:hover,.more-item.active{color:#fff;background:rgba(255,255,255,0.05);}
.more-icon{font-size:1rem;width:1.4rem;text-align:center;}

/* ════════════════════════
   MOBILE RESPONSIVE
   ════════════════════════ */
@media(max-width:768px){
  .sidebar{display:none!important;}
  #bottom-nav{display:block;}
  #app-screen.visible{flex-direction:column;}
  .main-content{height:calc(100svh - 56px);overflow-y:auto;}
  .page{padding:0.9rem 0.9rem 4rem;}

  /* Dashboard — 2 col */
  .dash-hero{grid-template-columns:repeat(2,1fr)!important;gap:0.5rem!important;}
  .dash-grid{grid-template-columns:1fr!important;}
  .hero-stat{padding:0.85rem 1rem!important;}
  .hero-stat-val{font-size:1.5rem!important;}

  /* Inventory — hide table header, stack rows */
  .inv-row-header{display:none!important;}
  .inv-rows{gap:0!important;background:transparent!important;border:1px solid var(--border);}
  .inv-row{
    display:block!important;padding:0.85rem 1rem!important;
    border-bottom:1px solid var(--border)!important;
    background:var(--surface)!important;
  }
  .inv-row:nth-child(even){background:var(--surface2)!important;}
  .inv-row>div:nth-child(2),.inv-row>div:nth-child(3),
  .inv-row>div:nth-child(5),.inv-row>div:nth-child(7){display:none!important;}
  .inv-row>div:first-child{margin-bottom:0.4rem;}
  .inv-row>div:nth-child(4){font-size:0.78rem;color:var(--text2);}
  .inv-row>div:nth-child(6){margin-top:0.3rem;}

  /* Contacts — hide header columns, simplify */
  .contact-list-header{display:none!important;}
  .contact-list-row{grid-template-columns:1fr auto!important;}
  .contact-list-row>div:nth-child(2){display:none!important;}
  .contact-list-row>div:nth-child(3){display:none!important;}

  /* Modals → full screen slide up */
  .modal-overlay{align-items:flex-end!important;padding:0!important;}
  .modal{width:100%!important;max-width:100%!important;border-radius:14px 14px 0 0!important;max-height:92svh!important;}
  .modal-header{padding:1rem 1rem 0.75rem!important;}
  .modal-body{padding:0.75rem 0.85rem!important;}
  .modal-footer{padding:0.75rem 1rem!important;}

  /* Forms: single column */
  .form-grid{grid-template-columns:1fr!important;}
  .form-group.full{grid-column:1!important;}

  /* Page headers */
  .page-header{flex-direction:column!important;align-items:stretch!important;gap:0.6rem!important;}
  .page-header>div:last-child{display:flex!important;flex-wrap:wrap!important;gap:0.5rem!important;}
  .page-header .search-input,.page-header .filter-select{flex:1!important;}

  /* Help and storefront: stack */
  .help-layout,.sf-layout{grid-template-columns:1fr!important;height:auto!important;overflow:visible!important;}
  .help-sidebar{height:auto!important;max-height:180px!important;overflow-y:auto!important;border-right:none!important;border-bottom:1px solid var(--border)!important;}
  .help-content{height:auto!important;min-height:300px!important;}
  .sf-controls{height:auto!important;overflow-y:visible!important;}
  .sf-preview-pane{height:350px!important;}

  /* Trash rows */
  .trash-row{grid-template-columns:1fr auto!important;}
  .trash-type,.trash-expiry{display:none!important;}

  /* AI prompt box */
  #ai-prompt-box,#ai-sold-prompt-box{font-size:0.65rem!important;}
}
@media print{
  body *{visibility:hidden;}
  #print-area,#print-area *{visibility:visible;}
  #print-area{position:fixed;left:0;top:0;width:100%;}
  .invoice-preview{border:none;padding:1.5rem;}
}

/* ── MOBILE BOTTOM NAV ──────────────────────────────── */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--charcoal);border-top:2px solid var(--gold);z-index:200;padding-bottom:env(safe-area-inset-bottom);}
.mob-nav-inner{display:flex;height:56px;}
.mob-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;color:#666;font-size:0.52rem;letter-spacing:0.05em;text-transform:uppercase;font-weight:600;transition:color 0.15s;border:none;background:none;padding:0;}
.mob-tab .mob-icon{font-size:1.3rem;line-height:1;}
.mob-tab.active,.mob-tab:hover{color:var(--gold2);}
.mob-more-menu{display:none;position:fixed;bottom:56px;left:0;right:0;background:var(--charcoal);border-top:1px solid var(--border);z-index:199;padding:0.5rem 0;padding-bottom:env(safe-area-inset-bottom);}
.mob-more-menu.open{display:block;}
.mob-more-item{padding:0.85rem 1.5rem;font-size:0.8rem;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:0.75rem;transition:background 0.1s;}
.mob-more-item:hover{background:rgba(255,255,255,0.05);color:var(--text1);}
.mob-more-item .mob-more-icon{font-size:1.1rem;width:1.5rem;text-align:center;}

/* ── CONTACT LIST VIEW ──────────────────────────────── */
.contact-list{display:flex;flex-direction:column;gap:0;}
.contact-list-item{display:flex;align-items:center;gap:1rem;padding:0.85rem 1rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.12s;}
.contact-list-item:hover{background:var(--surface2);}
.contact-list-avatar{width:38px;height:38px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1rem;color:var(--gold2);flex-shrink:0;}
.contact-list-info{flex:1;min-width:0;}
.contact-list-name{font-size:0.88rem;font-weight:600;color:var(--text1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.contact-list-sub{font-size:0.68rem;color:var(--text2);margin-top:0.1rem;}
.contact-list-meta{display:flex;flex-direction:column;align-items:flex-end;gap:0.2rem;flex-shrink:0;}
.contact-list-txn{font-size:0.7rem;color:var(--text2);}
.contact-tag{font-size:0.55rem;padding:0.15rem 0.4rem;border-radius:2px;text-transform:uppercase;letter-spacing:0.08em;font-weight:700;}
.contact-tag.buyer{background:rgba(58,122,90,0.15);color:var(--green);}
.contact-tag.seller{background:rgba(184,148,58,0.15);color:var(--gold2);}
.contact-tag.both{background:rgba(70,130,180,0.15);color:#6aa8d4;}

/* ── TRASH BIN ──────────────────────────────────────── */
.trash-item{display:flex;align-items:center;gap:1rem;padding:0.85rem;border:1px solid var(--border);margin-bottom:0.5rem;background:var(--surface);}
.trash-item-info{flex:1;min-width:0;}
.trash-item-name{font-size:0.88rem;font-weight:600;color:var(--text1);}
.trash-item-sub{font-size:0.68rem;color:var(--text2);margin-top:0.15rem;}
.trash-item-days{font-size:0.65rem;color:var(--red);white-space:nowrap;}
.trash-badge{background:rgba(176,58,58,0.12);color:var(--red);font-size:0.55rem;padding:0.15rem 0.5rem;text-transform:uppercase;letter-spacing:0.1em;font-weight:700;border-radius:2px;}

/* ── NOTES LOG ──────────────────────────────────────── */
.note-entry{padding:0.75rem;border:1px solid var(--border);background:var(--surface);position:relative;}
.note-entry:hover .note-actions{opacity:1;}
.note-ts{font-size:0.6rem;color:var(--text2);margin-bottom:0.35rem;letter-spacing:0.04em;}
.note-body{font-size:0.82rem;color:var(--text1);line-height:1.6;white-space:pre-wrap;}
.note-actions{position:absolute;top:0.5rem;right:0.5rem;display:flex;gap:0.3rem;opacity:0;transition:opacity 0.15s;}
.note-edit-btn,.note-del-btn{font-size:0.6rem;padding:0.2rem 0.45rem;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text2);}
.note-edit-btn:hover{color:var(--gold2);}
.note-del-btn:hover{color:var(--red);}

/* ── SELL BUTTON ON INVENTORY CARDS ─────────────────── */
.inv-card-delete{opacity:0;transition:opacity 0.15s;cursor:pointer;font-size:0.65rem;color:var(--red);padding:0.2rem 0.4rem;border:1px solid rgba(176,58,58,0.3);background:transparent;}
.inv-card:hover .inv-card-delete,.sold-row:hover .inv-card-delete{opacity:1;}

/* ── MOBILE RESPONSIVE ──────────────────────────────── */
@media (max-width: 768px) {
  .sidebar{display:none !important;}
  .mob-nav{display:flex;flex-direction:column;}
  .main-content{height:calc(100vh - 56px - env(safe-area-inset-bottom));padding-bottom:0;}
  .page{padding:1rem 1rem 2rem;}
  .modal{width:100% !important;max-width:100% !important;height:100dvh;max-height:100dvh;border-radius:0;margin:0;display:flex;flex-direction:column;}
  .modal-body{flex:1;overflow-y:auto;}
  .modal-tabs{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .modal-tab{white-space:nowrap;flex-shrink:0;}
  .page-header{flex-direction:column;align-items:flex-start;gap:0.75rem;}
  .page-header > div:last-child{width:100%;display:flex;flex-wrap:wrap;gap:0.5rem;}
  .page-header > div:last-child .btn-gold,
  .page-header > div:last-child .btn-outline{flex:1;text-align:center;}
  .hero-stats{grid-template-columns:1fr 1fr;}
  .form-grid{grid-template-columns:1fr !important;}
  .form-group.full{grid-column:span 1 !important;}
  .sf-layout{grid-template-columns:1fr !important;height:auto !important;}
  .help-layout{grid-template-columns:1fr !important;height:auto !important;}
  .help-sidebar{border-right:none !important;border-bottom:1px solid var(--border);}
  .help-content{height:auto !important;}
  .inv-filters{flex-wrap:wrap;}
  .search-input{width:100% !important;}
  .dashboard-grid{grid-template-columns:1fr 1fr !important;}
  .pipeline-board{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  table{font-size:0.72rem;}
  .contact-list-item{padding:0.75rem 0.5rem;}
}
@media (max-width: 480px) {
  .hero-stats{grid-template-columns:1fr 1fr;}
  .page-title{font-size:1.5rem;}
}

</style>
</head>
<body>

<div id="loading-screen" class="visible">
  <div class="loading-logo">Dial<span>Trader</span></div>
  <div class="loading-bar"></div>
</div>

<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Dial<em>Trader</em></div>
    <div class="auth-tagline">Watch Trading Desk</div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchAuthTab('signup')">Create Account</div>
    </div>
    <div class="auth-form active" id="auth-login">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="login-email" type="email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLogin()">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="login-password" type="password" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="auth-btn" id="login-btn" onclick="doLogin()">Sign In</button>
      <div class="auth-error" id="login-error"></div>
      <div style="text-align:center;margin-top:1rem"><span style="font-size:0.65rem;color:var(--text2);cursor:pointer;text-decoration:underline" onclick="doForgotPassword()">Forgot password?</span></div>
    </div>
    <div class="auth-form" id="auth-signup">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="signup-email" type="email" placeholder="you@example.com">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="signup-password" type="password" placeholder="Min. 8 characters">
      <label class="auth-label">Confirm Password</label>
      <input class="auth-input" id="signup-confirm" type="password" onkeydown="if(event.key==='Enter')doSignup()">
      <button class="auth-btn" id="signup-btn" onclick="doSignup()">Create Account</button>
      <div class="auth-error" id="signup-error"></div>
      <div class="auth-success" id="signup-success"></div>
    </div>
  </div>
</div>

<div id="app-screen">
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div id="sidebar-logo-icon" style="width:100%;display:flex;justify-content:center;margin-bottom:0.6rem;"></div>
      <div style="text-align:center;">
        <div class="sidebar-logo-text">Dial<em>Trader</em></div>
        <div class="sidebar-logo-sub">Watch Trading Desk</div>
      </div>
    </div>
    <div class="sidebar-section-label">Main</div>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">📊</span>Dashboard</div>
    <div class="nav-item" onclick="showPage('inventory')"><span class="nav-icon">🕐</span>Inventory<span class="nav-badge" id="nav-inv-count">0</span></div>
    <div class="nav-item" onclick="showPage('sold')"><span class="nav-icon">✅</span>Sold History</div>
    <div class="sidebar-section-label">Business</div>
    <div class="nav-item" onclick="showPage('contacts')"><span class="nav-icon">👤</span>Contacts<span class="nav-badge" id="nav-contact-count">0</span></div>
    <div class="nav-item" onclick="showPage('invoices')"><span class="nav-icon">📄</span>Invoices<span class="nav-badge" id="nav-invoice-count">0</span></div>
    <div class="sidebar-section-label">Tools</div>
    <div class="nav-item" onclick="showPage('import')"><span class="nav-icon">📥</span>Import / Export</div>
    <div class="nav-item" onclick="showPage('tax')"><span class="nav-icon">💰</span>Tax Report</div>
    <div class="nav-divider"></div>
    <div class="nav-item" onclick="showPage('storefront')"><span class="nav-icon">🌐</span>My Storefront</div>
    <div class="nav-item" onclick="showPage('help')"><span class="nav-icon">❓</span>Help &amp; Setup</div>
    <div class="nav-item" onclick="showPage('settings')"><span class="nav-icon">⚙️</span>Settings</div>
    <div class="sidebar-footer">
      <div class="sidebar-user" id="sidebar-user"></div>
      <div style="font-size:0.58rem;color:#555;margin-bottom:0.6rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="sidebar-email"></div>
      <div class="sidebar-signout" onclick="doSignOut()">Sign Out</div>
    </div>
  </nav>

  <div class="main-content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div><div class="page-title">Dashboard</div></div>
        <button class="btn-gold" onclick="openModal()">+ Add Watch</button>
      </div>
      <div class="dash-hero">
        <div class="hero-stat"><div class="hero-label">Capital Deployed</div><div class="hero-value gold" id="stat-capital-val">—</div><div class="hero-sub" id="stat-capital-sub"></div></div>
        <div class="hero-stat"><div class="hero-label">Total Profit</div><div class="hero-value green" id="stat-profit-val">—</div><div class="hero-sub" id="stat-profit-sub"></div></div>
        <div class="hero-stat"><div class="hero-label">In Inventory</div><div class="hero-value" id="stat-inv-val">—</div><div class="hero-sub" id="stat-inv-sub"></div></div>
        <div class="hero-stat"><div class="hero-label">Avg ROI</div><div class="hero-value gold" id="stat-roi-val">—</div><div class="hero-sub">on sold watches</div></div>
      </div>
      <div class="dash-grid">
        <div class="panel">
          <div class="panel-title">Current Inventory</div>
          <table class="mini-table"><thead><tr><th>Watch</th><th>Cost Basis</th><th>Break Even</th><th>Days Held</th></tr></thead><tbody id="dash-inv-body"></tbody></table>
        </div>
        <div class="panel">
          <div class="panel-title">Profit by Brand</div>
          <div id="dash-brand-bars"></div>
        </div>
      </div>
    </div>

    <!-- INVENTORY -->
    <div class="page" id="page-inventory">
      <div class="page-header">
        <div><div class="page-title">Inventory</div><div class="page-subtitle" id="inv-subtitle"></div></div>
        <button class="btn-gold" onclick="openModal()">+ Add Watch</button>
      </div>
      <div class="filter-bar">
        <input class="search-input" id="inv-search" type="text" placeholder="Search brand, model, ref..." oninput="renderInventory()">
        <select class="filter-select" id="inv-sort" onchange="renderInventory()">
          <option value="date-desc">Newest First</option><option value="date-asc">Oldest First</option>
          <option value="cost-desc">Cost: High→Low</option><option value="cost-asc">Cost: Low→High</option>
          <option value="days-desc">Days Held: Most</option>
        </select>
      </div>
      <div class="inv-rows" id="inventory-grid">
        <div class="inv-row-header"><span>Watch / Stage</span><span>Cost Basis</span><span>MSRP</span><span>Listed At</span><span>Potential Profit</span><span>Days Held</span><span>Platform</span></div>
      </div>
      
      <div style="text-align:right;margin-top:1rem">
        <button class="btn-outline" onclick="showTrash()" style="font-size:0.68rem;color:var(--red);border-color:rgba(176,58,58,0.4)">🗑 Trash Bin</button>
      </div>
      <div id="inv-empty" class="empty-state" style="display:none"><h3>No watches in inventory</h3><p>Click "+ Add Watch" to get started.</p></div>
      <div class="trash-toggle" onclick="toggleTrash('inv-trash')">
        <span>🗑</span>&nbsp;Trash&nbsp;<span class="trash-count-badge" id="inv-trash-badge" style="display:none"></span>
        <span style="margin-left:auto;font-size:0.7rem;opacity:0.5">▾</span>
      </div>
      <div id="inv-trash" style="display:none"></div>
    </div>

    <!-- SOLD -->
    <div class="page" id="page-sold">
      <div class="page-header">
        <div><div class="page-title">Sold <span>History</span></div><div class="page-subtitle" id="sold-subtitle"></div></div>
      </div>
      <div class="filter-bar">
        <input class="search-input" id="sold-search" type="text" placeholder="Search sold watches..." oninput="renderSold()">
        <select class="filter-select" id="sold-sort" onchange="renderSold()">
          <option value="date-desc">Most Recent</option><option value="profit-desc">Profit: High→Low</option>
          <option value="profit-asc">Profit: Low→High</option><option value="roi-desc">ROI: High→Low</option>
        </select>
      </div>
      <div style="overflow-x:auto">
        <table class="sold-table">
          <thead><tr>
            <th>Brand / Model</th><th>Ref / Serial</th><th>Cost Basis</th><th>Sold Price</th><th>Platform</th>
            <th onclick="setSoldSort('profit-desc')" style="cursor:pointer">Net Profit ↕</th>
            <th onclick="setSoldSort('roi-desc')" style="cursor:pointer">ROI ↕</th>
            <th>Hold Days</th><th>P/Day</th><th>Photos</th><th></th>
          </tr></thead>
          <tbody id="sold-body"></tbody>
        </table>
      </div>
      
      <div style="text-align:right;margin-top:1rem">
        <button class="btn-outline" onclick="showTrash()" style="font-size:0.68rem;color:var(--red);border-color:rgba(176,58,58,0.4)">🗑 Trash Bin</button>
      </div>
      <div id="sold-empty" class="empty-state" style="display:none"><h3>No sold watches yet</h3><p>Mark a watch as sold from Inventory.</p></div>
      <div class="trash-toggle" onclick="toggleTrash('sold-trash')">
        <span>🗑</span>&nbsp;Trash&nbsp;<span class="trash-count-badge" id="sold-trash-badge" style="display:none"></span>
        <span style="margin-left:auto;font-size:0.7rem;opacity:0.5">▾</span>
      </div>
      <div id="sold-trash" style="display:none"></div>
    </div>

    <!-- CONTACTS -->
    <div class="page" id="page-contacts">
      <div id="contacts-list-view">
        <div class="page-header">
          <div><div class="page-title">Contacts</div><div class="page-subtitle" id="contacts-subtitle"></div></div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <input class="search-input" id="contact-search" type="text" placeholder="Search contacts..." oninput="renderContacts()" style="width:200px">
            <button class="btn-outline" onclick="syncSoldContacts()" title="Import contacts from sold watch buyer/seller names">↻ Sync from Sold</button>
            <button class="btn-gold" onclick="openContactModal()">+ Add Contact</button>
          </div>
        </div>
        <div class="contacts-grid" id="contacts-grid"></div>
        <div id="contacts-empty" class="empty-state" style="display:none"><h3>No contacts yet</h3><p>Add buyers and sellers to track their full transaction history.</p></div>
      </div>
      <div id="contacts-detail-view" style="display:none">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
          <span style="font-size:0.7rem;color:var(--text2);cursor:pointer;letter-spacing:0.06em;text-transform:uppercase" onclick="showContactsList()">← Back to Contacts</span>
        </div>
        <div id="contact-detail-content"></div>
      </div>
    </div>

    <!-- INVOICES -->
    <div class="page" id="page-invoices">
      <div id="invoices-list-view">
        <div class="page-header">
          <div><div class="page-title">Invoices</div><div class="page-subtitle" id="invoices-subtitle"></div></div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <div style="display:flex;border:1px solid var(--border)">
              <div class="inv-tab-btn active" id="tab-sent-btn" onclick="switchInvoiceTab('sent')" style="padding:0.45rem 1rem;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;font-weight:600;background:var(--charcoal);color:#fff;">Sent</div>
              <div class="inv-tab-btn" id="tab-received-btn" onclick="switchInvoiceTab('received')" style="padding:0.45rem 1rem;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;font-weight:600;color:var(--text2);">Received</div>
            </div>
            <button class="btn-gold" id="new-invoice-btn" onclick="openInvoiceModal()">+ New Invoice</button>
            <button class="btn-outline" id="upload-invoice-btn" onclick="openReceivedModal()" style="display:none">+ Upload Invoice</button>
          </div>
        </div>
        <!-- SENT -->
        <div id="sent-invoices-panel">
          <div class="invoice-list" id="invoice-list"></div>
          <div id="invoices-empty" class="empty-state" style="display:none"><h3>No invoices yet</h3><p>Create an invoice to send to a buyer.</p></div>
        </div>
        <!-- RECEIVED -->
        <div id="received-invoices-panel" style="display:none">
          <div class="invoice-list" id="received-invoice-list"></div>
          <div id="received-empty" class="empty-state" style="display:none"><h3>No received invoices yet</h3><p>Upload invoices you receive from sellers when purchasing watches.</p></div>
        </div>
      </div>
      <div id="invoices-detail-view" style="display:none">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap">
          <span style="font-size:0.7rem;color:var(--text2);cursor:pointer;letter-spacing:0.06em;text-transform:uppercase" onclick="showInvoicesList()">← Back to Invoices</span>
          <div style="margin-left:auto;display:flex;gap:0.5rem">
            <button class="btn-outline btn-sm" onclick="printInvoice()">🖨 Print / PDF</button>
            <button class="btn-outline btn-sm" onclick="editCurrentInvoice()">✏️ Edit</button>
            <button class="btn-gold btn-sm" id="btn-mark-paid" onclick="markInvoicePaid()">Mark Paid</button>
          </div>
        </div>
        <div id="print-area"><div id="invoice-detail-content"></div></div>
      </div>
    </div>

    <!-- IMPORT -->
    <div class="page" id="page-import">
      <div class="page-header">
        <div><div class="page-title">Import / <span>Export</span></div><div class="page-subtitle">Bring in existing data from spreadsheets — or export what you have</div></div>
      </div>

      <!-- AI CONVERSION GUIDE -->
      <div class="card" style="margin-bottom:2rem;border-left:3px solid var(--gold2)">
        <div class="card-title">⚡ Convert Your Existing Spreadsheet with AI</div>
        <div class="card-sub" style="margin-bottom:1.25rem">Already tracking watches in Excel or Google Sheets? Use this copy-paste prompt to convert your data in under 2 minutes — no manual reformatting needed.</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
          <div>
            <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:0.6rem;font-weight:600;">Step 1 — Copy this prompt</div>
            <div style="position:relative">
              <div id="ai-prompt-box" style="background:var(--bg);border:1px solid var(--border);padding:1rem;font-size:0.72rem;color:var(--text2);line-height:1.8;font-family:monospace;max-height:220px;overflow-y:auto;">I have a watch inventory spreadsheet I need to convert to a specific CSV format for import into DialTrader.

Here are the EXACT column headers I need in the output CSV:
brand, model, ref, serial, year, purchase_date, purchase_price, tax, shipping_in, other_fees, listed_price, platform, condition, box_papers, notes

Rules:
- Output ONLY the CSV — no explanation, no markdown backticks, no extra columns
- Dates must be in YYYY-MM-DD format (e.g. 2024-01-15)
- Numbers with no dollar signs, commas, or symbols (e.g. 12500 not $12,500)
- If a column has no data, leave it empty (just a comma)
- condition should be text like: Mint, Excellent, Good, Fair
- box_papers should be: Full Set, Box Only, Papers Only, No Box/Papers, or empty
- platform should be the main platform the watch is listed on, or empty
- First row must be the header row exactly as shown above

Here is my spreadsheet data:
[PASTE YOUR DATA HERE — copy from Excel/Google Sheets and paste directly]</div>
              <button class="btn-outline" style="position:absolute;top:0.5rem;right:0.5rem;font-size:0.65rem;padding:0.3rem 0.6rem" onclick="copyAIPrompt()">Copy</button>
            </div>
          </div>
          <div>
            <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:0.6rem;font-weight:600;">Step 2 — Use ChatGPT or Claude</div>
            <div style="font-size:0.78rem;color:var(--text2);line-height:1.8;margin-bottom:1rem">
              1. Go to <strong style="color:var(--text1)">chat.openai.com</strong> or <strong style="color:var(--text1)">claude.ai</strong><br>
              2. Paste the prompt above<br>
              3. Replace <code>[PASTE YOUR DATA HERE]</code> with your actual spreadsheet data (copy from Excel/Sheets)<br>
              4. Send — the AI will output a clean CSV<br>
              5. Copy the AI's output into a text file, save as <code>my-watches.csv</code>
            </div>
            <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:0.6rem;font-weight:600;">Step 3 — Drop the CSV below</div>
            <div style="font-size:0.78rem;color:var(--text2);line-height:1.8">
              Drop your converted CSV into the Inventory import zone. DialTrader will show you a preview before importing anything — you can cancel if something looks off.
            </div>
            <div class="card" style="margin-top:1rem;background:rgba(184,148,58,0.06);border-color:rgba(184,148,58,0.2)">
              <div style="font-size:0.72rem;color:var(--text2);line-height:1.7"><strong style="color:var(--gold2)">Tip:</strong> If the AI output has backtick fences (```csv ... ```) just delete those lines — keep only the comma-separated rows. Numbers sometimes come back with quotes — that's fine, the importer handles it.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- SOLD HISTORY AI PROMPT -->
      <div class="card" style="margin-bottom:2rem">
        <div class="card-title">Importing Sold History</div>
        <div class="card-sub" style="margin-bottom:1rem">Use this separate prompt for watches you've already sold.</div>
        <div style="position:relative;display:inline-block;width:100%">
          <div id="ai-sold-prompt-box" style="background:var(--bg);border:1px solid var(--border);padding:1rem;font-size:0.72rem;color:var(--text2);line-height:1.8;font-family:monospace;max-height:160px;overflow-y:auto;">Convert my sold watch data to this EXACT CSV format (output CSV only, no explanation):
brand, model, ref, serial, year, purchase_date, purchase_price, tax, shipping_in, other_fees, sale_date, sold_price, platform_fee, payment_fee, shipping_out, platform, notes

Rules: dates YYYY-MM-DD, numbers no symbols, empty cell = empty comma, first row = headers.

[PASTE YOUR SOLD WATCH DATA HERE]</div>
          <button class="btn-outline" style="position:absolute;top:0.5rem;right:0.5rem;font-size:0.65rem;padding:0.3rem 0.6rem" onclick="copyAISoldPrompt()">Copy</button>
        </div>
      </div>

      <!-- IMPORT ZONES -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem">
        <div>
          <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:0.75rem;font-weight:600;">Import Inventory</div>
          <div class="import-zone" id="drop-inventory" onclick="document.getElementById('file-inventory').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event,'inventory')">
            <div class="import-zone-icon">📋</div><div class="import-zone-title">Drop Inventory CSV Here</div><div class="import-zone-sub">or click to browse</div>
          </div>
          <input type="file" id="file-inventory" accept=".csv" style="display:none" onchange="handleFileInput(event,'inventory')">
          <div style="display:flex;gap:0.5rem;margin-top:0.75rem">
            <button class="btn-outline" onclick="downloadTemplate('inventory')">⬇ Download Template</button>
            <button class="btn-outline" onclick="exportInventoryCSV()">⬆ Export CSV</button>
          </div>
        </div>
        <div>
          <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:0.75rem;font-weight:600;">Import Sold History</div>
          <div class="import-zone" id="drop-sold" onclick="document.getElementById('file-sold').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event,'sold')">
            <div class="import-zone-icon">📋</div><div class="import-zone-title">Drop Sold History CSV Here</div><div class="import-zone-sub">or click to browse</div>
          </div>
          <input type="file" id="file-sold" accept=".csv" style="display:none" onchange="handleFileInput(event,'sold')">
          <button class="btn-outline" style="margin-top:0.75rem" onclick="downloadTemplate('sold')">⬇ Download Template</button>
        </div>
      </div>
      <div id="import-preview" style="display:none;margin-top:2rem"></div>
    </div>

  

    <!-- TAX REPORT -->
    <div class="page" id="page-tax" style="display:none">
      <div class="page-header">
        <div><div class="page-title">Tax <span>Report</span></div><div class="page-subtitle">P&amp;L summary by tax year — export for your accountant</div></div>
        <div style="display:flex;gap:0.5rem;align-items:center">
          <select class="filter-select" id="tax-year-filter" onchange="renderTaxReport()"><option value="all">All Years</option></select>
          <button class="btn-outline" onclick="exportTaxCSV()">⬆ Export CSV</button>
          <button class="btn-gold" onclick="window.print()">🖨 Print Report</button>
        </div>
      </div>
      <div id="tax-report-content" style="overflow-x:auto;"></div>
    </div>

    <!-- MY STOREFRONT PAGE -->
    <div class="page" id="page-storefront" style="display:none">
      <div class="page-header">
        <div><div class="page-title">My <span>Storefront</span></div><div class="page-subtitle">Customize your public watch store — pick a theme and download your ready-to-deploy file</div></div>
      </div>

      <!-- PROFILE INCOMPLETE WARNING -->
      <div id="sf-profile-warn" style="display:none;background:rgba(192,57,43,0.12);border:1px solid rgba(192,57,43,0.3);padding:0.85rem 1rem;margin-bottom:1.25rem;font-size:0.78rem;color:#e07060;">
        ⚠️ Your <strong>Business Profile</strong> is incomplete. <a href="#" onclick="showPage('settings')" style="color:var(--gold2)">Go to Settings</a> and fill in your business name, email, and phone before downloading — those appear on your storefront.
      </div>

      <div class="sf-layout">
        <!-- LEFT: CONTROLS -->
        <div class="sf-controls">

          <div class="sf-section-label">Color Theme</div>
          <div class="sf-theme-grid" id="sf-theme-grid">
            <!-- Swatches injected by JS -->
          </div>

          <div class="sf-section-label">Font Pairing</div>
          <div class="sf-font-list" id="sf-font-list">
            <!-- Font options injected by JS -->
          </div>

          <div class="sf-section-label">Hero Background</div>
          <div class="sf-hero-grid" id="sf-hero-grid">
            <!-- Hero thumbs injected by JS -->
          </div>
          <input class="form-input sf-custom-url" id="sf-hero-custom" placeholder="Or paste any image URL..." oninput="sfSetCustomHero(this.value)">

        </div>

        <!-- RIGHT: PREVIEW + DOWNLOAD -->
        <div class="sf-preview-pane">
          <div class="sf-preview-bar">
            <div class="sf-preview-dot" style="background:#ff5f57"></div>
            <div class="sf-preview-dot" style="background:#febc2e"></div>
            <div class="sf-preview-dot" style="background:#28c840"></div>
            <div class="sf-preview-url" id="sf-preview-url">yoursite.com</div>
          </div>
          <iframe class="sf-preview-frame" id="sf-preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
          <div class="sf-download-bar">
            <div class="sf-status" id="sf-status">
              Theme: <strong id="sf-status-theme">Classic Dark</strong> &nbsp;·&nbsp;
              Fonts: <strong id="sf-status-font">Playfair + Raleway</strong>
            </div>
            <button class="btn-outline" onclick="sfRefreshPreview()">↻ Refresh Preview</button>
            <button class="btn-gold" onclick="sfDownload()">⬇ Download Storefront</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div class="page" id="page-settings" style="display:none">
      <div class="page-header"><div><div class="page-title">Settings</div><div class="page-subtitle">Your business profile and account preferences</div></div></div>
      <div style="max-width:720px">
        <div class="card" style="margin-bottom:1.5rem">
          <div class="card-title">Business Profile</div>
          <div class="card-sub">This information appears on your invoices and storefront</div>
          <div class="form-grid" style="margin-top:1.25rem">
            <div class="form-group full"><label class="form-label">Business / Trading Name *</label><input class="form-input" id="sp-biz-name" placeholder="e.g. SourceMax Luxury"></div>
            <div class="form-group"><label class="form-label">Your Name</label><input class="form-input" id="sp-owner-name" placeholder="Full name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="sp-phone" type="tel" placeholder="(555) 000-0000"></div>
            <div class="form-group full"><label class="form-label">Email</label><input class="form-input" id="sp-email" type="email" placeholder="your@email.com"></div>
            <div class="form-group full"><label class="form-label">Address / City, State</label><input class="form-input" id="sp-address" placeholder="Conway, Arkansas"></div>
            <div class="form-group full"><label class="form-label">Website (optional)</label><input class="form-input" id="sp-website" placeholder="https://yoursite.com"></div>
          </div>
        </div>
        <div class="card" style="margin-bottom:1.5rem">
          <div class="card-title">Payment Information</div>
          <div class="card-sub">Shown on invoices when you enable payment options</div>
          <div class="form-grid" style="margin-top:1.25rem">
            <div class="form-group"><label class="form-label">Zelle (phone or email)</label><input class="form-input" id="sp-zelle" placeholder="(555) 000-0000"></div>
            <div class="form-group"><label class="form-label">Apple Pay (phone)</label><input class="form-input" id="sp-applepay" placeholder="(555) 000-0000"></div>
            <div class="form-group full"><label class="form-label">Wire / Bank Info</label><textarea class="form-textarea" id="sp-wire" placeholder="Bank name, routing, account number..." style="height:80px"></textarea></div>
          </div>
        </div>
        <div class="card" style="margin-bottom:1.5rem">
          <div class="card-title">Invoice Defaults</div>
          <div class="card-sub">Default text for new invoices</div>
          <div class="form-grid" style="margin-top:1.25rem">
            <div class="form-group full"><label class="form-label">Invoice Notes / Terms</label><textarea class="form-textarea" id="sp-inv-notes" placeholder="e.g. All sales final. Watch authenticated before shipment." style="height:80px"></textarea></div>
          </div>
        </div>
        <div class="card" style="margin-bottom:1.5rem">
          <div class="card-title">Account</div>
          <div class="card-sub">Your login email: <strong id="sp-login-email" style="color:#fff"></strong></div>
          <div style="margin-top:1rem;display:flex;gap:0.75rem;flex-wrap:wrap">
            <button class="btn-outline" onclick="changePassword()">Change Password</button>
            <button class="btn-danger" onclick="doSignOut()">Sign Out</button>
          </div>
        </div>
        <div style="display:flex;gap:0.75rem">
          <button class="btn-gold" onclick="saveProfile()">Save Profile</button>
          <span id="sp-saved" style="font-size:0.72rem;color:var(--green);align-self:center;display:none">✓ Saved</span>
        </div>
      </div>
    </div>

    <!-- HELP PAGE -->
    <div class="page" id="page-help" style="display:none">
      <div class="page-header"><div><div class="page-title">Help &amp; Setup</div><div class="page-subtitle">Guides, tutorials, and resources to get the most out of DialTrader</div></div></div>
      <div class="help-layout">
        <div class="help-sidebar">
          <div class="help-nav-section">Getting Started</div>
          <div class="help-nav-item active" onclick="showHelp('welcome')">Welcome to DialTrader</div>
          <div class="help-nav-item" onclick="showHelp('plans')">Membership Plans</div>
          <div class="help-nav-item" onclick="showHelp('profile')">Setting Up Your Profile</div>
          <div class="help-nav-item" onclick="showHelp('first-watch')">Adding Your First Watch</div>
          <div class="help-nav-item" onclick="showHelp('import-data')">Importing Existing Data</div>
          <div class="help-nav-section">Your Storefront <span style="font-size:0.55rem;color:var(--gold2);margin-left:0.3rem">Pro</span></div>
          <div class="help-nav-item" onclick="showHelp('storefront-intro')">What Is the Storefront?</div>
          <div class="help-nav-item" onclick="showHelp('vercel-deploy')">Deploying on Vercel (Free)</div>
          <div class="help-nav-item" onclick="showHelp('custom-domain')">Using Your Own Domain</div>
          <div class="help-nav-item" onclick="showHelp('storefront-themes')">Themes &amp; Customization</div>
          <div class="help-nav-section">Features</div>
          <div class="help-nav-item" onclick="showHelp('pipeline')">The Deal Pipeline</div>
          <div class="help-nav-item" onclick="showHelp('invoices')">Creating Invoices</div>
          <div class="help-nav-item" onclick="showHelp('photos')">Photo Management</div>
          <div class="help-nav-item" onclick="showHelp('crm')">CRM &amp; Contacts</div>
          <div class="help-nav-item" onclick="showHelp('tax')">Tax Reporting</div>
        </div>
        <div class="help-content" id="help-content-area"></div>
      </div>
    </div>


</div><!-- end main-content -->

  
<!-- TRASH BIN MODAL -->
<div class="modal-overlay" id="trash-overlay" style="display:none" onclick="if(event.target===this)closeTrash()">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <div class="modal-title">🗑 Trash Bin <span style="font-size:0.7rem;color:var(--text2);font-style:normal">— Restores within 14 days</span></div>
      <button class="modal-close" onclick="closeTrash()">✕</button>
    </div>
    <div class="modal-body" style="padding:1.25rem">
      <div id="trash-empty" class="empty-state" style="display:none"><p>Trash bin is empty.</p></div>
      <div id="trash-list"></div>
    </div>
  </div>
</div>

  <!-- MOBILE BOTTOM NAV -->
  <nav class="mob-nav" id="mob-nav">
    <div class="mob-nav-inner">
      <button class="mob-tab active" id="mobt-dashboard" onclick="mobNav('dashboard')">
        <span class="mob-icon">📊</span>Dashboard
      </button>
      <button class="mob-tab" id="mobt-inventory" onclick="mobNav('inventory')">
        <span class="mob-icon">⌚</span>Inventory
      </button>
      <button class="mob-tab" id="mobt-contacts" onclick="mobNav('contacts')">
        <span class="mob-icon">👤</span>Contacts
      </button>
      <button class="mob-tab" id="mobt-invoices" onclick="mobNav('invoices')">
        <span class="mob-icon">🧾</span>Invoices
      </button>
      <button class="mob-tab" id="mobt-more" onclick="toggleMobMore()">
        <span class="mob-icon">☰</span>More
      </button>
    </div>
  </nav>
  <div class="mob-more-menu" id="mob-more-menu">
    <div class="mob-more-item" onclick="mobNav('sold')"><span class="mob-more-icon">📦</span>Sold History</div>
    <div class="mob-more-item" onclick="mobNav('tax')"><span class="mob-more-icon">💰</span>Tax Report</div>
    <div class="mob-more-item" onclick="mobNav('import')"><span class="mob-more-icon">📥</span>Import / Export</div>
    <div class="mob-more-item" onclick="mobNav('storefront')"><span class="mob-more-icon">🌐</span>My Storefront</div>
    <div class="mob-more-item" onclick="mobNav('help')"><span class="mob-more-icon">❓</span>Help & Setup</div>
    <div class="mob-more-item" onclick="mobNav('settings')"><span class="mob-more-icon">⚙️</span>Settings</div>
  </div>

<!-- MORE OVERLAY -->
<div id="more-overlay" onclick="closeMore()"></div>

<!-- MORE MENU -->
<div id="more-menu">
  <div class="more-item" onclick="moreNav('pipeline')"><span class="more-icon">📊</span>Pipeline</div>
  <div class="more-item" onclick="moreNav('sold')"><span class="more-icon">✅</span>Sold History</div>
  <div class="more-item" onclick="moreNav('tax')"><span class="more-icon">💰</span>Tax Report</div>
  <div class="more-item" onclick="moreNav('import')"><span class="more-icon">📥</span>Import / Export</div>
  <div class="more-item" onclick="moreNav('storefront')"><span class="more-icon">🌐</span>My Storefront</div>
  <div class="more-item" onclick="moreNav('help')"><span class="more-icon">❓</span>Help &amp; Setup</div>
  <div class="more-item" onclick="moreNav('settings')"><span class="more-icon">⚙️</span>Settings</div>
</div>

<!-- BOTTOM NAV -->
<div id="bottom-nav">
  <div class="bnav-inner">
    <button class="bnav-btn active" id="bnav-dashboard" onclick="bNav('dashboard')">
      <span class="bnav-icon">📈</span>Dashboard
    </button>
    <button class="bnav-btn" id="bnav-inventory" onclick="bNav('inventory')">
      <span class="bnav-icon">⌚</span>Inventory
    </button>
    <button class="bnav-btn" id="bnav-contacts" onclick="bNav('contacts')">
      <span class="bnav-icon">👤</span>Contacts
    </button>
    <button class="bnav-btn" id="bnav-invoices" onclick="bNav('invoices')">
      <span class="bnav-icon">🧾</span>Invoices
    </button>
    <button class="bnav-btn" id="bnav-more" onclick="toggleMore()">
      <span class="bnav-icon">≡</span>More
    </button>
  </div>
</div>

</div><!-- end app-screen -->

<!-- WATCH MODAL -->
<div class="modal-overlay" id="modal" onclick="closeModalOverlay(event)">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modal-title">Add Watch</div><button class="modal-close" onclick="closeModal()">✕</button></div>
    <div class="modal-body">
      <div class="modal-tabs">
        <div class="modal-tab active" onclick="switchTab('basics')">Basics</div>
        <div class="modal-tab" onclick="switchTab('details')">Details</div>
        <div class="modal-tab" onclick="switchTab('photos')">Photos</div>
        <div class="modal-tab" onclick="switchTab('wtcontacts')">Contacts</div>
        <div class="modal-tab" onclick="switchTab('notes')">Notes</div>
        <div class="modal-tab" id="tab-sell-btn" onclick="switchTab('sell')" style="display:none">Mark Sold</div>
      </div>
      <div class="modal-tab-panel active" id="tab-basics">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Brand *</label><input class="form-input" id="f-brand" placeholder="e.g. Rolex"></div>
          <div class="form-group"><label class="form-label">Model *</label><input class="form-input" id="f-model" placeholder="e.g. Submariner"></div>
          <div class="form-group"><label class="form-label">Reference</label><input class="form-input" id="f-ref" placeholder="e.g. 126610LN"></div>
          <div class="form-group"><label class="form-label">Serial Number</label><input class="form-input" id="f-serial" placeholder="Watch serial number"></div>
          <div class="form-group"><label class="form-label">Year</label><input class="form-input" id="f-year" placeholder="e.g. 2021"></div>
          <div class="form-group"><label class="form-label">Purchase Date</label><input class="form-input" id="f-purchase-date" type="date"></div>
          <div class="form-group"><label class="form-label">Purchase Price ($)</label><input class="form-input" id="f-purchase-price" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Tax ($)</label><input class="form-input" id="f-tax" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Shipping In ($)</label><input class="form-input" id="f-shipping-in" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Other Fees ($)</label><input class="form-input" id="f-other-fees" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">Listed Price ($)</label><input class="form-input" id="f-listed-price" type="number" placeholder="0.00"></div>
          <div class="form-group"><label class="form-label">MSRP ($)</label><input class="form-input" id="f-msrp" type="number" placeholder="Retail / market value"></div>
          <div class="form-group full"><label class="form-label">Platform(s) Listed On</label>
            <div class="platform-checks" id="f-platform-checks">
              <div class="platform-check" data-val="Grailzee" onclick="togglePlatform(this)">Grailzee</div>
              <div class="platform-check" data-val="eBay" onclick="togglePlatform(this)">eBay</div>
              <div class="platform-check" data-val="Chrono24" onclick="togglePlatform(this)">Chrono24</div>
              <div class="platform-check" data-val="Reddit" onclick="togglePlatform(this)">Reddit</div>
              <div class="platform-check" data-val="Instagram Post" onclick="togglePlatform(this)">Instagram Post</div>
              <div class="platform-check" data-val="Facebook Post" onclick="togglePlatform(this)">Facebook Post</div>
              <div class="platform-check" data-val="Facebook Marketplace" onclick="togglePlatform(this)">Facebook Marketplace</div>
              <div class="platform-check" data-val="WatchUSeek" onclick="togglePlatform(this)">WatchUSeek</div>
              <div class="platform-check" data-val="FB — Watch Trading Academy B/S/T" onclick="togglePlatform(this)">FB — Watch Trading Academy</div>
              <div class="platform-check" data-val="FB — Buy My Watch" onclick="togglePlatform(this)">FB — Buy My Watch</div>
              <div class="platform-check" data-val="FB — Bay Watch Club" onclick="togglePlatform(this)">FB — Bay Watch Club</div>
              <div class="platform-check" data-val="FB — Audemars Piguet" onclick="togglePlatform(this)">FB — Audemars Piguet</div>
              <div class="platform-check" data-val="FB — Vintage &amp; Pre-Owned Rolex" onclick="togglePlatform(this)">FB — Vintage &amp; Pre-Owned Rolex</div>
              <div class="platform-check" data-val="FB — Moda Watch Club" onclick="togglePlatform(this)">FB — Moda Watch Club</div>
              <div class="platform-check" data-val="Other" onclick="togglePlatform(this)">Other</div>
            </div>
          </div>
          <div class="form-group full"><label class="form-label">Link to Contact</label><select class="form-select" id="f-contact-link"><option value="">— None —</option></select></div>
          <div class="form-group full">
            <label class="form-label">Deal Stage</label>
            <div class="stage-selector" id="f-stage-selector"></div>
          </div>
          <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" placeholder="Additional notes..."></textarea></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-details">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Condition</label>
            <select class="form-select" id="f-condition"><option value="">— Select —</option><option>New / Unworn</option><option>Mint (9/10)</option><option>Excellent (8/10)</option><option>Very Good (7/10)</option><option>Good (6/10)</option><option>Fair (5/10)</option><option>Parts/Repair</option></select>
          </div>
          <div class="form-group"><label class="form-label">Box & Papers</label>
            <select class="form-select" id="f-box-papers"><option value="">— Select —</option><option>Full Set (Box + Papers)</option><option>Box Only</option><option>Papers Only</option><option>No Box, No Papers</option></select>
          </div>
          <div class="form-group"><label class="form-label">Case Size (mm)</label><input class="form-input" id="f-case-size" placeholder="e.g. 41"></div>
          <div class="form-group"><label class="form-label">Case Material</label>
            <select class="form-select" id="f-case-material"><option value="">— Select —</option><option>Stainless Steel</option><option>Yellow Gold</option><option>White Gold</option><option>Rose Gold</option><option>Two-Tone</option><option>Titanium</option><option>Ceramic</option><option>Platinum</option></select>
          </div>
          <div class="form-group"><label class="form-label">Movement</label>
            <select class="form-select" id="f-movement"><option value="">— Select —</option><option>Automatic</option><option>Manual Wind</option><option>Quartz</option><option>Solar</option><option>Spring Drive</option></select>
          </div>
          <div class="form-group"><label class="form-label">Bracelet Type</label>
            <select class="form-select" id="f-bracelet-type"><option value="">— Select —</option><option>Oyster/Metal Bracelet</option><option>Jubilee</option><option>President</option><option>Leather Strap</option><option>Rubber Strap</option><option>NATO Strap</option><option>Integrated Bracelet</option></select>
          </div>
          <div class="form-group"><label class="form-label">Dial Color</label><input class="form-input" id="f-dial-color" placeholder="e.g. Black, Blue, Green"><div class="color-row" id="dial-colors"></div></div>
          <div class="form-group"><label class="form-label">Bezel Color</label><input class="form-input" id="f-bezel-color" placeholder="e.g. Black, Blue"><div class="color-row" id="bezel-colors"></div></div>
          <div class="form-group"><label class="form-label">Bracelet Color</label><input class="form-input" id="f-bracelet-color" placeholder="e.g. Steel, Black"></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-photos">
        <div style="font-size:0.68rem;color:var(--text2);margin-bottom:1rem;line-height:1.6"><strong>First photo = main storefront image.</strong> Drag to reorder. JPG/PNG only — HEIC not supported.</div>
        <div id="photo-upload-zone" style="border:2px dashed var(--border2);padding:2rem;text-align:center;cursor:pointer;transition:border-color 0.2s;margin-bottom:1rem">
          <div style="font-size:2rem;margin-bottom:0.5rem;opacity:0.4">📷</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text2)">Click or drop photos here</div>
          <div style="font-size:0.68rem;color:var(--text2);margin-top:0.25rem">JPG, PNG — max 5MB each</div>
        </div>
        <input type="file" id="photo-file-input" accept="image/*" multiple style="display:none">
        <div id="photo-preview-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem"></div>
        <div id="photo-upload-status" style="font-size:0.7rem;color:var(--text2);margin-top:0.5rem;text-align:center"></div>
      </div>
      <div class="modal-tab-panel" id="tab-wtcontacts">
        <div class="contact-card-form"><div class="contact-card-form-title">▸ Purchased From</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="f-buy-name" placeholder="Full name or business"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="f-buy-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-buy-email" type="email"></div>
            <div class="form-group full"><label class="form-label">Location</label><input class="form-input" id="f-buy-location"></div>
          </div>
        </div>
        <div class="contact-card-form"><div class="contact-card-form-title">▸ Sold To (pre-fill or complete at sale)</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="f-sell-name" placeholder="Buyer name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="f-sell-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-sell-email" type="email"></div>
            <div class="form-group full"><label class="form-label">Location</label><input class="form-input" id="f-sell-location"></div>
          </div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-notes">
        <div style="display:flex;gap:0.75rem;margin-bottom:1rem">
          <input class="form-input" id="note-input" placeholder="Add a note — offer, price change, condition update..." style="flex:1">
          <button class="btn-gold" onclick="addWatchNote()" style="padding:0 1.25rem;white-space:nowrap">Add</button>
        </div>
        <div id="notes-list" style="display:flex;flex-direction:column;gap:0.5rem;max-height:340px;overflow-y:auto"></div>
        <div id="notes-empty" style="color:var(--text2);font-size:0.78rem;text-align:center;padding:2rem 0">No notes yet.</div>
      </div>
      <div class="modal-tab-panel" id="tab-sell">
        <div style="font-size:0.78rem;color:var(--text2);margin-bottom:1.25rem;line-height:1.7">Complete sale details below. The watch moves to Sold History.</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Sale Date</label><input class="form-input" id="f-sale-date" type="date"></div>
          <div class="form-group"><label class="form-label">Sold Price ($) *</label><input class="form-input" id="f-sold-price" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group"><label class="form-label">Platform Fee ($)</label><input class="form-input" id="f-platform-fee" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group"><label class="form-label">Payment Fee ($)</label><input class="form-input" id="f-payment-fee" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group"><label class="form-label">Shipping Out ($)</label><input class="form-input" id="f-shipping-out" type="number" placeholder="0.00" oninput="updateSellPnL()"></div>
          <div class="form-group full"><label class="form-label">Sale Platform</label>
            <div class="platform-checks" id="f-sale-platform-checks">
              <div class="platform-check" data-val="Grailzee" onclick="togglePlatform(this)">Grailzee</div>
              <div class="platform-check" data-val="eBay" onclick="togglePlatform(this)">eBay</div>
              <div class="platform-check" data-val="Chrono24" onclick="togglePlatform(this)">Chrono24</div>
              <div class="platform-check" data-val="Reddit" onclick="togglePlatform(this)">Reddit</div>
              <div class="platform-check" data-val="Instagram Post" onclick="togglePlatform(this)">Instagram Post</div>
              <div class="platform-check" data-val="Facebook Post" onclick="togglePlatform(this)">Facebook Post</div>
              <div class="platform-check" data-val="Facebook Marketplace" onclick="togglePlatform(this)">Facebook Marketplace</div>
              <div class="platform-check" data-val="WatchUSeek" onclick="togglePlatform(this)">WatchUSeek</div>
              <div class="platform-check" data-val="FB — Watch Trading Academy B/S/T" onclick="togglePlatform(this)">FB — Watch Trading Academy</div>
              <div class="platform-check" data-val="FB — Buy My Watch" onclick="togglePlatform(this)">FB — Buy My Watch</div>
              <div class="platform-check" data-val="FB — Bay Watch Club" onclick="togglePlatform(this)">FB — Bay Watch Club</div>
              <div class="platform-check" data-val="FB — Audemars Piguet" onclick="togglePlatform(this)">FB — Audemars Piguet</div>
              <div class="platform-check" data-val="FB — Vintage &amp; Pre-Owned Rolex" onclick="togglePlatform(this)">FB — Vintage &amp; Pre-Owned Rolex</div>
              <div class="platform-check" data-val="FB — Moda Watch Club" onclick="togglePlatform(this)">FB — Moda Watch Club</div>
              <div class="platform-check" data-val="Other" onclick="togglePlatform(this)">Other</div>
            </div>
          </div>
          <div class="form-group full"><label class="form-label">Sold To (Name)</label><input class="form-input" id="f-sell-name-sell" placeholder="Buyer name"></div>
          <div class="form-group"><label class="form-label">Buyer Phone</label><input class="form-input" id="f-sell-phone-sell" type="tel"></div>
          <div class="form-group"><label class="form-label">Buyer Email</label><input class="form-input" id="f-sell-email-sell" type="email"></div>
        </div>
        <div id="sell-pnl" style="margin-top:1rem;padding:1rem;background:var(--surface2);border:1px solid var(--border);font-size:0.8rem;color:var(--text2)">Enter sold price above to see projected profit.</div>
        <button class="btn-gold" style="width:100%;padding:0.9rem;margin-top:1rem" onclick="markAsSold()">✓ Confirm Sale & Move to Sold History</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="btn-delete" onclick="deleteWatch()" style="display:none">Delete</button>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeModal()">Cancel</button>
        <button class="btn-gold" id="btn-save" onclick="saveWatch()">Save Watch</button>
      </div>
    </div>
  </div>
</div>

<!-- CONTACT MODAL -->
<div class="modal-overlay" id="contact-modal" onclick="if(event.target===this)closeContactModal()">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="contact-modal-title">Add Contact</div><button class="modal-close" onclick="closeContactModal()">✕</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Full Name *</label><input class="form-input" id="cf-name" placeholder="Full name"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="cf-phone" type="tel" placeholder="(555) 000-0000"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="cf-email" type="email" placeholder="contact@email.com"></div>
        <div class="form-group full"><label class="form-label">Street Address</label><input class="form-input" id="cf-address" placeholder="Street address"></div>
        <div class="form-group"><label class="form-label">City</label><input class="form-input" id="cf-city" placeholder="City"></div>
        <div class="form-group"><label class="form-label">State / ZIP</label><input class="form-input" id="cf-state" placeholder="AR 72034"></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="cf-notes" placeholder="Notes about this contact..."></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="cf-delete-btn" onclick="deleteContact()" style="display:none">Delete</button>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeContactModal()">Cancel</button>
        <button class="btn-gold" onclick="saveContact()">Save Contact</button>
      </div>
    </div>
  </div>
</div>

<!-- INVOICE MODAL -->
<div class="modal-overlay" id="invoice-modal" onclick="if(event.target===this)closeInvoiceModal()">
  <div class="modal modal-lg">
    <div class="modal-header"><div class="modal-title" id="invoice-modal-title">New Invoice</div><button class="modal-close" onclick="closeInvoiceModal()">✕</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
        <div>
          <div class="section-divider">Bill To</div>
          <div class="form-group" style="margin-bottom:0.75rem">
            <label class="form-label">Select Existing Contact</label>
            <select class="form-select" id="inv-contact-select" onchange="fillInvoiceContact()"><option value="">— Manual entry —</option></select>
          </div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name *</label><input class="form-input" id="inv-bill-name" placeholder="Full name"></div>
            <div class="form-group full"><label class="form-label">Street Address</label><input class="form-input" id="inv-bill-address" placeholder="Street address"></div>
            <div class="form-group"><label class="form-label">City, State ZIP</label><input class="form-input" id="inv-bill-city" placeholder="City, AR 72034"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="inv-bill-phone" type="tel" placeholder="(555) 000-0000"></div>
            <div class="form-group full"><label class="form-label">Email</label><input class="form-input" id="inv-bill-email" type="email" placeholder="buyer@email.com"></div>
          </div>
        </div>
        <div>
          <div class="section-divider">Invoice Details</div>
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Invoice #</label><input class="form-input" id="inv-number" placeholder="e.g. 26-154"></div>
            <div class="form-group"><label class="form-label">Invoice Date</label><input class="form-input" id="inv-date" type="date"></div>
            <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" id="inv-due-date" type="date"></div>
            <div class="form-group"><label class="form-label">Deposit Received ($)</label><input class="form-input" id="inv-deposit" type="number" placeholder="0.00" oninput="updateInvoiceTotals()"></div>
            <div class="form-group full"><label class="form-label">Notes / Terms</label><textarea class="form-textarea" id="inv-notes" placeholder="Payment terms, delivery notes..." style="min-height:55px"></textarea></div>
          </div>
        </div>
      </div>
      <div class="section-divider">Line Items</div>
      <div id="inv-line-items" style="margin-bottom:0.75rem"></div>
      <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem">
        <button class="btn-outline btn-sm" onclick="addInvoiceLineFromInventory()">+ From Inventory</button>
        <button class="btn-outline btn-sm" onclick="addInvoiceLineManual()">+ Manual Item</button>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-bottom:1.5rem">
        <div style="width:300px">
          <div style="display:flex;justify-content:space-between;padding:0.4rem 0;font-size:0.82rem;color:var(--text2);border-bottom:1px solid var(--border)"><span>Subtotal</span><span id="inv-preview-subtotal">$0.00</span></div>
          <div id="inv-deposit-row" style="display:none;justify-content:space-between;padding:0.4rem 0;font-size:0.82rem;color:var(--green);border-bottom:1px solid var(--border)"><span>Deposit</span><span id="inv-preview-deposit"></span></div>
          <div style="display:flex;justify-content:space-between;padding:0.5rem 0;font-size:0.9rem;font-weight:600;color:var(--text)"><span>Balance Due</span><span id="inv-preview-balance">$0.00</span></div>
        </div>
      </div>
      <div class="section-divider">Payment Instructions (toggle what to show)</div>
      <div style="display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:0.5rem">
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;cursor:pointer"><input type="checkbox" id="inv-show-zelle"> Show Zelle</label>
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;cursor:pointer"><input type="checkbox" id="inv-show-apple"> Show Apple Pay</label>
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;cursor:pointer"><input type="checkbox" id="inv-show-wire"> Show Wire Transfer</label>
      </div>
      <div style="font-size:0.65rem;color:var(--text2)">Wire instructions will only appear on the invoice if you check the box above — they are hidden by default.</div>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--text2)">Saved invoices can be printed to PDF</span>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeInvoiceModal()">Cancel</button>
        <button class="btn-gold" onclick="saveInvoice()">Save & Preview</button>
      </div>
    </div>
  </div>
</div>

<!-- INVENTORY PICKER -->
<div class="modal-overlay" id="inv-picker-modal" onclick="if(event.target===this)closeInvPicker()">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Select from Inventory</div><button class="modal-close" onclick="closeInvPicker()">✕</button></div>
    <div class="modal-body">
      <input class="search-input" id="inv-picker-search" type="text" placeholder="Search inventory..." oninput="renderInvPicker()" style="width:100%;margin-bottom:1rem">
      <div id="inv-picker-list" style="max-height:380px;overflow-y:auto;border:1px solid var(--border)"></div>
    </div>
  </div>
</div>

<!-- SOLD PHOTO MODAL -->
<div class="modal-overlay" id="sold-photo-modal" onclick="if(event.target===this)closeSoldPhotoModal()">
  <div class="modal" style="max-width:520px">
    <div class="modal-header"><div class="modal-title" id="sold-photo-modal-title">Edit Photos</div><button class="modal-close" onclick="closeSoldPhotoModal()">✕</button></div>
    <div class="modal-body">
      <div style="font-size:0.72rem;color:var(--text2);margin-bottom:1rem;line-height:1.6">First photo = storefront image. Drag to reorder. JPG/PNG only.</div>
      <div id="sold-photo-upload-zone" style="border:2px dashed var(--border2);padding:2rem;text-align:center;cursor:pointer;transition:border-color 0.2s;margin-bottom:1rem">
        <div style="font-size:2rem;margin-bottom:0.5rem;opacity:0.4">📷</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text2)">Click or drop photos here</div>
      </div>
      <input type="file" id="sold-photo-file-input" accept="image/*" multiple style="display:none">
      <div id="sold-photo-preview-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem"></div>
      <div id="sold-photo-status" style="font-size:0.7rem;color:var(--text2);margin-top:0.5rem;text-align:center"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeSoldPhotoModal()">Cancel</button>
      <button class="btn-gold" id="sold-photo-save-btn" onclick="saveSoldPhotos()">Save Photos</button>
    </div>
  </div>
</div>

<!-- PROFILE SETUP MODAL (first login) -->
<div class="modal-overlay" id="profile-setup-modal" style="z-index:2000">
  <div class="modal" style="max-width:560px">
    <div class="modal-header"><div class="modal-title">Welcome to DialTrader — Set Up Your Profile</div></div>
    <div class="modal-body">
      <p style="font-size:0.8rem;color:var(--text2);margin-bottom:1.25rem;line-height:1.7">Before you get started, add your business info. This appears on your invoices and storefront. You can always update it in <strong style="color:#fff">Settings</strong>.</p>
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Business / Trading Name *</label><input class="form-input" id="ps-biz-name" placeholder="e.g. SourceMax Luxury"></div>
        <div class="form-group"><label class="form-label">Your Name</label><input class="form-input" id="ps-owner-name" placeholder="Full name"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="ps-phone" type="tel" placeholder="(555) 000-0000"></div>
        <div class="form-group full"><label class="form-label">Contact Email</label><input class="form-input" id="ps-email" type="email" placeholder="your@email.com"></div>
        <div class="form-group full"><label class="form-label">City, State</label><input class="form-input" id="ps-address" placeholder="e.g. Conway, Arkansas"></div>
        <div class="form-group"><label class="form-label">Zelle (for invoices)</label><input class="form-input" id="ps-zelle" placeholder="Phone or email"></div>
        <div class="form-group"><label class="form-label">Apple Pay (for invoices)</label><input class="form-input" id="ps-applepay" placeholder="Phone number"></div>
      </div>
      <div id="ps-error" style="color:var(--red);font-size:0.75rem;margin-top:0.75rem"></div>
    </div>
    <div class="modal-footer">
      <div class="modal-actions">
        <button class="btn-outline" onclick="skipProfileSetup()">Skip for Now</button>
        <button class="btn-gold" onclick="saveProfileSetup()">Save &amp; Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- RECEIVED INVOICE MODAL -->
<div class="modal-overlay" id="received-modal" onclick="if(event.target===this)closeReceivedModal()">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="received-modal-title">Upload Received Invoice</div><button class="modal-close" onclick="closeReceivedModal()">✕</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">From (Seller Name)</label><input class="form-input" id="ri-seller" placeholder="Who sent this invoice?"></div>
        <div class="form-group"><label class="form-label">Invoice Date</label><input class="form-input" id="ri-date" type="date"></div>
        <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" id="ri-amount" type="number" placeholder="0.00"></div>
        <div class="form-group full"><label class="form-label">Link to Watch in Inventory</label><select class="form-select" id="ri-watch-link"><option value="">— None / not yet in inventory —</option></select></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="ri-notes" placeholder="Notes about this purchase..."></textarea></div>
      </div>
      <div style="margin-top:1rem">
        <label class="form-label">Invoice File (PDF or Image)</label>
        <div id="ri-upload-zone" style="border:2px dashed var(--border2);padding:2rem;text-align:center;cursor:pointer;margin-top:0.4rem;transition:border-color 0.2s" onclick="document.getElementById('ri-file-input').click()" ondragover="event.preventDefault();this.style.borderColor='var(--gold)'" ondragleave="this.style.borderColor=''" ondrop="handleRiDrop(event)">
          <div style="font-size:2rem;margin-bottom:0.5rem;opacity:0.4">📎</div>
          <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--text2)" id="ri-upload-label">Drop PDF or image here, or click to browse</div>
          <div style="font-size:0.68rem;color:var(--text2);margin-top:0.25rem">PDF, JPG, PNG</div>
        </div>
        <input type="file" id="ri-file-input" accept=".pdf,image/*" style="display:none" onchange="handleRiFile(event)">
        <div id="ri-file-preview" style="margin-top:0.75rem;display:none">
          <div style="background:var(--surface2);border:1px solid var(--border);padding:0.75rem;display:flex;align-items:center;gap:0.75rem">
            <span style="font-size:1.5rem">📄</span>
            <div>
              <div style="font-size:0.8rem;font-weight:500" id="ri-file-name"></div>
              <div style="font-size:0.65rem;color:var(--text2)" id="ri-file-size"></div>
            </div>
            <button onclick="clearRiFile()" style="margin-left:auto;background:none;border:none;color:var(--red);cursor:pointer;font-size:1.1rem">✕</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="ri-delete-btn" onclick="deleteReceivedInvoice()" style="display:none">Delete</button>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeReceivedModal()">Cancel</button>
        <button class="btn-gold" onclick="saveReceivedInvoice()">Save Invoice</button>
      </div>
    </div>
  </div>
</div>

<!-- SOLD EDIT MODAL -->
<div class="modal-overlay" id="sold-edit-modal" onclick="if(event.target===this)closeSoldEditModal()">
  <div class="modal modal-lg">
    <div class="modal-header"><div class="modal-title" id="sold-edit-title">Edit Sold Watch</div><button class="modal-close" onclick="closeSoldEditModal()">✕</button></div>
    <div class="modal-body">
      <div class="modal-tabs">
        <div class="modal-tab active" onclick="switchSoldTab('se-basics')">Sale Details</div>
        <div class="modal-tab" onclick="switchSoldTab('se-watch')">Watch Info</div>
        <div class="modal-tab" onclick="switchSoldTab('se-contacts')">Buyer / Seller</div>
      </div>
      <div class="modal-tab-panel active" id="tab-se-basics">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Sale Date</label><input class="form-input" id="se-sale-date" type="date"></div>
          <div class="form-group"><label class="form-label">Sold Price ($)</label><input class="form-input" id="se-sold-price" type="number"></div>
          <div class="form-group"><label class="form-label">Platform Fee ($)</label><input class="form-input" id="se-platform-fee" type="number"></div>
          <div class="form-group"><label class="form-label">Payment Fee ($)</label><input class="form-input" id="se-payment-fee" type="number"></div>
          <div class="form-group"><label class="form-label">Shipping Out ($)</label><input class="form-input" id="se-shipping-out" type="number"></div>
          <div class="form-group"><label class="form-label">Purchase Date</label><input class="form-input" id="se-purchase-date" type="date"></div>
          <div class="form-group"><label class="form-label">Purchase Price ($)</label><input class="form-input" id="se-purchase-price" type="number"></div>
          <div class="form-group"><label class="form-label">Tax ($)</label><input class="form-input" id="se-tax" type="number"></div>
          <div class="form-group"><label class="form-label">Shipping In ($)</label><input class="form-input" id="se-shipping-in" type="number"></div>
          <div class="form-group"><label class="form-label">Other Fees ($)</label><input class="form-input" id="se-other-fees" type="number"></div>
          <div class="form-group full"><label class="form-label">Sale Platform</label>
            <div class="platform-checks" id="se-platform-checks">
              <div class="platform-check" data-val="Grailzee" onclick="togglePlatform(this)">Grailzee</div>
              <div class="platform-check" data-val="eBay" onclick="togglePlatform(this)">eBay</div>
              <div class="platform-check" data-val="Chrono24" onclick="togglePlatform(this)">Chrono24</div>
              <div class="platform-check" data-val="Reddit" onclick="togglePlatform(this)">Reddit</div>
              <div class="platform-check" data-val="Instagram Post" onclick="togglePlatform(this)">Instagram Post</div>
              <div class="platform-check" data-val="Facebook Post" onclick="togglePlatform(this)">Facebook Post</div>
              <div class="platform-check" data-val="Facebook Marketplace" onclick="togglePlatform(this)">Facebook Marketplace</div>
              <div class="platform-check" data-val="WatchUSeek" onclick="togglePlatform(this)">WatchUSeek</div>
              <div class="platform-check" data-val="FB — Watch Trading Academy B/S/T" onclick="togglePlatform(this)">FB — Watch Trading Academy</div>
              <div class="platform-check" data-val="FB — Buy My Watch" onclick="togglePlatform(this)">FB — Buy My Watch</div>
              <div class="platform-check" data-val="FB — Bay Watch Club" onclick="togglePlatform(this)">FB — Bay Watch Club</div>
              <div class="platform-check" data-val="FB — Audemars Piguet" onclick="togglePlatform(this)">FB — Audemars Piguet</div>
              <div class="platform-check" data-val="FB — Vintage &amp; Pre-Owned Rolex" onclick="togglePlatform(this)">FB — Vintage &amp; Pre-Owned Rolex</div>
              <div class="platform-check" data-val="FB — Moda Watch Club" onclick="togglePlatform(this)">FB — Moda Watch Club</div>
              <div class="platform-check" data-val="Other" onclick="togglePlatform(this)">Other</div>
            </div>
          </div>
          <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="se-notes"></textarea></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-se-watch">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Brand</label><input class="form-input" id="se-brand"></div>
          <div class="form-group"><label class="form-label">Model</label><input class="form-input" id="se-model"></div>
          <div class="form-group"><label class="form-label">Reference</label><input class="form-input" id="se-ref"></div>
          <div class="form-group"><label class="form-label">Serial</label><input class="form-input" id="se-serial"></div>
          <div class="form-group"><label class="form-label">Year</label><input class="form-input" id="se-year"></div>
          <div class="form-group"><label class="form-label">Condition</label>
            <select class="form-select" id="se-condition"><option value="">— Select —</option><option>New / Unworn</option><option>Mint (9/10)</option><option>Excellent (8/10)</option><option>Very Good (7/10)</option><option>Good (6/10)</option><option>Fair (5/10)</option><option>Parts/Repair</option></select>
          </div>
          <div class="form-group"><label class="form-label">Box & Papers</label>
            <select class="form-select" id="se-box-papers"><option value="">— Select —</option><option>Full Set (Box + Papers)</option><option>Box Only</option><option>Papers Only</option><option>No Box, No Papers</option></select>
          </div>
          <div class="form-group"><label class="form-label">Case Size (mm)</label><input class="form-input" id="se-case-size"></div>
          <div class="form-group"><label class="form-label">Dial Color</label><input class="form-input" id="se-dial-color"></div>
        </div>
      </div>
      <div class="modal-tab-panel" id="tab-se-contacts">
        <div class="contact-card-form"><div class="contact-card-form-title">▸ Purchased From</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="se-buy-name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="se-buy-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="se-buy-email" type="email"></div>
          </div>
        </div>
        <div class="contact-card-form"><div class="contact-card-form-title">▸ Sold To</div>
          <div class="form-grid">
            <div class="form-group full"><label class="form-label">Name</label><input class="form-input" id="se-sell-name"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="se-sell-phone" type="tel"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="se-sell-email" type="email"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span style="font-size:0.7rem;color:var(--text2)">Editing does not affect sold status</span>
      <div class="modal-actions">
        <button class="btn-outline" onclick="closeSoldEditModal()">Cancel</button>
        <button class="btn-gold" onclick="saveSoldEdit()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
const{createClient}=supabase;
const LOGO_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 700" width="600" height="700">

  <defs>
    <!-- Gold Radial Depth -->
    <radialGradient id="goldCore" cx="50%" cy="45%" r="65%">
      <stop offset="0%" stop-color="#FFF3B5"></stop>
      <stop offset="30%" stop-color="#E5C15A"></stop>
      <stop offset="65%" stop-color="#C89E2F"></stop>
      <stop offset="100%" stop-color="#8A6A1F"></stop>
    </radialGradient>

    <!-- Bezel Edge Shine -->
    <linearGradient id="goldEdge" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#FFF6CC"></stop>
      <stop offset="50%" stop-color="#D4A63A"></stop>
      <stop offset="100%" stop-color="#7A5A18"></stop>
    </linearGradient>

    <!-- Subtle Shadow -->
    <filter id="shadow">
      <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="#000" flood-opacity="0.5"></feDropShadow>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="600" height="700" fill="#0A0A0A"></rect>

  <!-- ===== OUTER BEZEL ===== -->
  <circle cx="300" cy="330" r="210" fill="none" stroke="url(#goldCore)" stroke-width="50" filter="url(#shadow)"></circle>

  <!-- Inner Bezel Highlight -->
  <circle cx="300" cy="330" r="180" fill="none" stroke="url(#goldEdge)" stroke-width="3" opacity="0.7"></circle>

  <!-- ===== DIAL FACE ===== -->
  <circle cx="300" cy="330" r="160" fill="#0E0E0E" stroke="url(#goldEdge)" stroke-width="2"></circle>

  <!-- ===== HOUR MARKERS ===== -->
  <!-- Major markers -->
  <g stroke="url(#goldEdge)" stroke-width="6">
    <line x1="300" y1="160" x2="300" y2="190"></line>
    <line x1="300" y1="470" x2="300" y2="500"></line>
    <line x1="130" y1="330" x2="160" y2="330"></line>
    <line x1="440" y1="330" x2="470" y2="330"></line>
  </g>

  <!-- Minor markers -->
  <g stroke="url(#goldEdge)" stroke-width="3" opacity="0.7">
    <!-- 8 evenly spaced -->
    <line x1="380" y1="180" x2="395" y2="200"></line>
    <line x1="420" y1="230" x2="440" y2="245"></line>
    <line x1="420" y1="430" x2="440" y2="415"></line>
    <line x1="380" y1="480" x2="395" y2="460"></line>
    <line x1="220" y1="480" x2="205" y2="460"></line>
    <line x1="180" y1="430" x2="160" y2="415"></line>
    <line x1="180" y1="230" x2="160" y2="245"></line>
    <line x1="220" y1="180" x2="205" y2="200"></line>
  </g>

  <!-- ===== HANDS (Set at 10:10) ===== -->
  <g stroke="url(#goldEdge)" stroke-linecap="round">
    <!-- Hour hand -->
    <line x1="300" y1="330" x2="250" y2="260" stroke-width="10"></line>
    <!-- Minute hand -->
    <line x1="300" y1="330" x2="380" y2="250" stroke-width="6"></line>
  </g>

  <!-- Center Pin -->
  <circle cx="300" cy="330" r="10" fill="url(#goldEdge)"></circle>

  <!-- ===== WORDMARK ===== -->
  <text x="300" y="630" font-family="Georgia, 'Times New Roman', serif" font-size="48" font-weight="700" fill="url(#goldEdge)" text-anchor="middle" letter-spacing="10">
        DIALTRADER
  </text>

</svg>`;
const db=createClient(SUPABASE_URL,SUPABASE_ANON);
let currentUser=null,inventory=[],soldWatches=[],contacts=[],invoices=[];
let editingId=null,editingContactId=null,editingInvoiceId=null;
let invoiceLineItems=[],currentInvoiceData=null;

// ── AUTH ──────────────────────────────────────────
async function initAuth(){
  const{data:{session}}=await db.auth.getSession();
  if(session?.user){currentUser=session.user;await showApp();}
  else showAuthScreen();
  db.auth.onAuthStateChange(async(event,session)=>{
    if(event==='SIGNED_IN'&&!currentUser){currentUser=session.user;await showApp();}
    else if(event==='SIGNED_IN'&&currentUser){currentUser=session.user;}
    else if(event==='SIGNED_OUT'){currentUser=null;inventory=[];soldWatches=[];contacts=[];invoices=[];showAuthScreen();}
  });
}
function showAuthScreen(){document.getElementById('loading-screen').classList.remove('visible');document.getElementById('app-screen').classList.remove('visible');document.getElementById('auth-screen').classList.add('visible');}
async function showApp(){
  document.getElementById('auth-screen').classList.remove('visible');
  document.getElementById('loading-screen').classList.add('visible');
  document.getElementById('app-screen').classList.remove('visible');
  const profileComplete=await loadUserProfile();
  await loadAllData();
  renderDashboard();renderInventory();renderSold();renderContacts();renderInvoices();renderTaxReport();
  document.getElementById('loading-screen').classList.remove('visible');
  document.getElementById('app-screen').classList.add('visible');
  showPage('dashboard');
  if(!profileComplete){setTimeout(openProfileSetupModal,600);}
  const sidebarIcon=document.getElementById('sidebar-logo-icon');
  if(sidebarIcon&&typeof LOGO_SVG!=='undefined'){
    const sized=LOGO_SVG.replace(/width="600"/,'width="160"').replace(/height="700"/,'height="187"');
    sidebarIcon.innerHTML=sized;
  }
}
function switchAuthTab(tab){document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));document.querySelector(`.auth-tab[onclick="switchAuthTab('${tab}')"]`).classList.add('active');document.getElementById('auth-'+tab).classList.add('active');}
async function doLogin(){const email=document.getElementById('login-email').value.trim(),pw=document.getElementById('login-password').value,btn=document.getElementById('login-btn'),err=document.getElementById('login-error');err.textContent='';if(!email||!pw){err.textContent='Please enter email and password.';return;}btn.disabled=true;btn.textContent='Signing in...';const{error}=await db.auth.signInWithPassword({email,password:pw});btn.disabled=false;btn.textContent='Sign In';if(error)err.textContent=error.message;}
async function doSignup(){const email=document.getElementById('signup-email').value.trim(),pw=document.getElementById('signup-password').value,confirm=document.getElementById('signup-confirm').value,btn=document.getElementById('signup-btn'),err=document.getElementById('signup-error'),succ=document.getElementById('signup-success');err.textContent='';succ.textContent='';if(!email||!pw){err.textContent='Fill in all fields.';return;}if(pw!==confirm){err.textContent='Passwords do not match.';return;}if(pw.length<8){err.textContent='Password must be 8+ characters.';return;}btn.disabled=true;btn.textContent='Creating...';const{error}=await db.auth.signUp({email,password:pw});btn.disabled=false;btn.textContent='Create Account';if(error)err.textContent=error.message;else succ.textContent='Check your email to confirm.';}
async function doForgotPassword(){const email=document.getElementById('login-email').value.trim();if(!email){document.getElementById('login-error').textContent='Enter your email above first.';return;}await db.auth.resetPasswordForEmail(email);document.getElementById('login-error').style.color='var(--green)';document.getElementById('login-error').textContent='Reset email sent.';}
async function doSignOut(){await db.auth.signOut();}

// ── DATA ──────────────────────────────────────────
async function syncSoldContacts(){
  // Backfill contacts from all sold watches — handles both buyer AND seller per watch
  showToast('Syncing...');
  let created = 0, linked = 0;

  async function upsertContact(name, phone, email){
    if(!name?.trim()) return null;
    name = name.trim();
    let contact = contacts.find(c=>c.name?.toLowerCase()===name.toLowerCase());
    if(!contact){
      const{data:nc,error}=await db.from('contacts').insert({
        user_id:currentUser.id, name, phone:phone||null, email:email||null
      }).select().single();
      if(nc){ contact=nc; contacts=[...contacts,nc]; created++; }
    }
    return contact?.id||null;
  }

  for(const w of soldWatches){
    // Handle buyer
    if(w.buy_name){
      const cid = await upsertContact(w.buy_name, w.buy_phone, w.buy_email);
      if(cid && !w.contact_id){
        await db.from('sold_inventory').update({contact_id:cid}).eq('id',w.id);
        soldWatches=soldWatches.map(s=>s.id===w.id?{...s,contact_id:cid}:s);
        linked++;
      }
    }
    // Handle seller (stored on inventory side, may also be on sold record)
    if(w.sell_name){
      await upsertContact(w.sell_name, w.sell_phone, w.sell_email);
    }
  }

  // Also sync from active inventory contacts
  for(const w of inventory){
    if(w.buy_name) await upsertContact(w.buy_name, w.buy_phone, w.buy_email);
    if(w.sell_name) await upsertContact(w.sell_name, w.sell_phone, w.sell_email);
  }

  renderContacts(); updateNavBadges();
  showToast(`Sync complete — ${created} new contact${created!==1?'s':''} created.`);
}

async function loadAllData(){
  const[invRes,soldRes,contactRes,invoiceRes,receivedRes]=await Promise.all([
    db.from('inventory').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
    db.from('sold_inventory').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
    db.from('contacts').select('*').eq('user_id',currentUser.id).order('name',{ascending:true}),
    db.from('invoices').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
    db.from('received_invoices').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}),
  ]);
  inventory=(invRes.data||[]).filter(w=>!w.trashed);soldWatches=(soldRes.data||[]).filter(w=>!w.trashed);contacts=contactRes.data||[];invoices=invoiceRes.data||[];receivedInvoices=receivedRes.data||[];
  await loadTrash();
  updateNavBadges();populateContactDropdowns();
}
function updateNavBadges(){document.getElementById('nav-inv-count').textContent=inventory.length;document.getElementById('nav-contact-count').textContent=contacts.length;document.getElementById('nav-invoice-count').textContent=invoices.length;}

// ── NAV ───────────────────────────────────────────
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg=document.getElementById('page-'+name);if(pg){pg.style.display='block';pg.classList.add('active');}
  const navEl=document.querySelector(`.nav-item[onclick="showPage('${name}')"]`);if(navEl)navEl.classList.add('active');
  if(name==='dashboard')renderDashboard();
  if(name==='inventory')renderInventory();
  if(name==='sold')renderSold();
  if(name==='contacts')renderContacts();
  if(name==='invoices')renderInvoices();
  if(name==='tax')renderTaxReport();
  if(name==='settings')populateSettingsPage();
  if(name==='help'){showHelp(currentHelpArticle);}
  if(name==='storefront')initStorefrontPage();
}

// ── HELPERS ───────────────────────────────────────
function fmt(n,d=0){if(n==null||isNaN(n))return'—';return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:d,maximumFractionDigits:d}).format(n);}
function fmtPct(n){if(n==null||isNaN(n)||!isFinite(n))return'—';return(n>=0?'+':'')+n.toFixed(1)+'%';}
function daysHeld(start,end){if(!start)return null;return Math.floor((new Date(end||Date.now())-new Date(start))/86400000);}
function costBasis(w){return(+w.purchase_price||0)+(+w.tax||0)+(+w.shipping_in||0)+(+w.other_fees||0);}
function soldCostBasis(s){return(+s.purchase_price||0)+(+s.tax||0)+(+s.shipping_in||0)+(+s.other_fees||0);}
function soldNetProfit(s){return(+s.sold_price||0)-(+s.platform_fee||0)-(+s.payment_fee||0)-(+s.shipping_out||0)-soldCostBasis(s);}
function soldROI(s){const b=soldCostBasis(s);return b?soldNetProfit(s)/b*100:0;}
function showToast(m,dur=3500){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur);}

// ── DASHBOARD ─────────────────────────────────────
function renderDashboard(){
  const cap=inventory.reduce((s,w)=>s+costBasis(w),0);
  const prof=soldWatches.reduce((s,w)=>s+soldNetProfit(w),0);
  const rois=soldWatches.map(soldROI).filter(r=>isFinite(r));
  const avgROI=rois.length?rois.reduce((a,b)=>a+b)/rois.length:0;
  document.getElementById('stat-capital-val').textContent=fmt(cap);
  document.getElementById('stat-capital-sub').textContent=`across ${inventory.length} watches`;
  document.getElementById('stat-profit-val').textContent=fmt(prof);
  document.getElementById('stat-profit-sub').textContent=`from ${soldWatches.length} sold`;
  document.getElementById('stat-inv-val').textContent=inventory.length;
  document.getElementById('stat-inv-sub').textContent=fmt(cap)+' deployed';
  document.getElementById('stat-roi-val').textContent=fmtPct(avgROI);
  document.querySelectorAll('.hero-stat').forEach(s=>s.classList.add('loaded'));
  document.getElementById('dash-inv-body').innerHTML=inventory.slice(0,6).map(w=>{
    const b=costBasis(w),d=daysHeld(w.purchase_date);
    const pc=d!==null?d+'d':'—',pillCls=d>60?'warn':d>30?'':'ok';
    return`<tr><td><div class="brand-badge">${w.brand||'?'}</div><div style="font-size:0.8rem;margin-top:0.3rem">${w.model||''}</div></td><td>${fmt(b)}</td><td>${w.listed_price?fmt(w.listed_price):'—'}</td><td><span class="days-pill ${pillCls}">${pc}</span></td></tr>`;
  }).join('');
  const bmap={};soldWatches.forEach(s=>{const b=s.brand||'Unknown';bmap[b]=(bmap[b]||0)+soldNetProfit(s);});
  const sorted=Object.entries(bmap).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const max=sorted.length?Math.max(...sorted.map(e=>Math.abs(e[1]))):1;
  document.getElementById('dash-brand-bars').innerHTML=sorted.map(([brand,profit])=>
    `<div class="brand-row"><div class="brand-name">${brand}</div><div class="brand-bar-wrap"><div class="brand-bar" style="width:${Math.abs(profit)/max*100}%"></div></div><div class="brand-profit">${fmt(profit)}</div></div>`
  ).join('');
}

// ── INVENTORY ─────────────────────────────────────
function renderInventory(){
  const q=(document.getElementById('inv-search').value||'').toLowerCase();
  const sort=document.getElementById('inv-sort').value;
  let f=inventory.filter(w=>`${w.brand} ${w.model} ${w.ref} ${w.serial}`.toLowerCase().includes(q));
  f.sort((a,b)=>{
    const ba=costBasis(a),bb=costBasis(b);
    if(sort==='date-asc')return new Date(a.created_at||0)-new Date(b.created_at||0);
    if(sort==='cost-desc')return bb-ba;if(sort==='cost-asc')return ba-bb;
    if(sort==='days-desc'){const da=daysHeld(a.purchase_date)||0,db2=daysHeld(b.purchase_date)||0;return db2-da;}
    return new Date(b.created_at||0)-new Date(a.created_at||0);
  });
  const cap=inventory.reduce((s,w)=>s+costBasis(w),0);
  document.getElementById('inv-subtitle').textContent=`${inventory.length} watches · ${fmt(cap)} capital`;
  const grid=document.getElementById('inventory-grid'),empty=document.getElementById('inv-empty');
  const hdr=`<div class="inv-row-header"><span>Watch / Stage</span><span>Cost Basis</span><span>MSRP</span><span>Listed At</span><span>Potential Profit</span><span>Days Held</span><span>Platform</span></div>`;
  if(!f.length){grid.innerHTML=hdr;empty.style.display='block';return;}
  empty.style.display='none';
  grid.innerHTML=hdr+f.map(w=>{
    const b=costBasis(w),d=daysHeld(w.purchase_date);
    const profit=w.listed_price?w.listed_price-b:null;
    const pillCls=d>60?'warn':d>30?'':'ok';
    const sub=[w.ref,w.serial?'SN:'+w.serial:'',w.dial_color,w.case_size].filter(Boolean).join(' · ');
    const plat=Array.isArray(w.platform)?w.platform.join(', '):(w.platform||'—');
    const si=w.stage_index!=null?w.stage_index:null;
    const stageBadge=si!=null?`<div style="margin-top:0.4rem"><span class="stage-badge stage-${si}"><span class="stage-dot"></span>${STAGES[si]}</span></div>`:'';
    return`<div class="inv-row" onclick="editWatch('${w.id}')">
      <div><div class="inv-row-brand">${w.brand||''}${w.year?' · '+w.year:''}</div><div class="inv-row-model">${w.model||''}</div><div class="inv-row-sub">${sub||'—'}</div>${stageBadge}</div>
      <div class="inv-row-val gold">${fmt(b)}</div>
      <div class="inv-row-val muted">${w.msrp?fmt(w.msrp):'—'}</div>
      <div class="inv-row-val">${w.listed_price?fmt(w.listed_price):'—'}</div>
      <div class="inv-row-val ${profit!=null?(profit>=0?'green':'red'):'muted'}">${profit!=null?fmt(profit):'—'}</div>
      <div class="inv-row-val"><span class="days-pill ${pillCls}">${d!==null?d+'d':'—'}</span></div>
      <div class="inv-row-val muted" style="display:flex;align-items:center;gap:0.5rem">
        <span>${plat}</span>
        <button class="trash-del-btn" title="Move to Trash" onclick="event.stopPropagation();softDelete('${w.id}','inventory')">🗑</button>
      </div>
    </div>`;
  }).join('');
}

// ── SOLD ──────────────────────────────────────────
function setSoldSort(v){document.getElementById('sold-sort').value=v;renderSold();}
function renderSold(){
  const q=(document.getElementById('sold-search').value||'').toLowerCase();
  const sort=document.getElementById('sold-sort').value;
  let f=soldWatches.filter(s=>`${s.brand} ${s.model} ${s.ref}`.toLowerCase().includes(q));
  f.sort((a,b)=>{
    if(sort==='profit-desc')return soldNetProfit(b)-soldNetProfit(a);
    if(sort==='profit-asc')return soldNetProfit(a)-soldNetProfit(b);
    if(sort==='roi-desc')return soldROI(b)-soldROI(a);
    return new Date(b.sale_date||0)-new Date(a.sale_date||0);
  });
  const tot=soldWatches.reduce((s,w)=>s+soldNetProfit(w),0);
  document.getElementById('sold-subtitle').textContent=`${soldWatches.length} sold · ${fmt(tot)} profit`;
  const tbody=document.getElementById('sold-body'),empty=document.getElementById('sold-empty');
  if(!f.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=f.map(s=>{
    const p=soldNetProfit(s),r=soldROI(s),d=daysHeld(s.purchase_date,s.sale_date);
    const ppd=d&&d>0?p/d:null,hp=s.photo_urls&&s.photo_urls.length>0;
    return`<tr onclick="openSoldPhotoModal('${s.id}')" title="Click to add/edit photos">
      <td><div style="font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);margin-bottom:0.2rem">${s.brand||''}</div><div style="font-size:0.76rem">${s.model||''}</div></td>
      <td style="color:var(--text2);font-size:0.7rem">${[s.ref,s.serial?'SN:'+s.serial:''].filter(Boolean).join(' · ')||'—'}</td>
      <td>${fmt(soldCostBasis(s))}</td><td>${fmt(s.sold_price)}</td>
      <td style="font-size:0.68rem;color:var(--text2)">${Array.isArray(s.platform)?s.platform.join(', '):(s.platform||'—')}</td>
      <td><span class="profit-badge ${p>=0?'pos':'neg'}">${p>=0?'+':''}${fmt(p)}</span></td>
      <td style="color:${r>=0?'var(--green)':'var(--red)'}">${fmtPct(r)}</td>
      <td style="color:var(--text2)">${d!==null?d+'d':'—'}</td>
      <td style="color:var(--text2);font-size:0.68rem">${ppd!==null?(ppd>=0?'+':'')+fmt(ppd,2):'—'}</td>
      <td style="font-size:0.7rem;cursor:pointer" onclick="event.stopPropagation();openSoldPhotoModal('${s.id}')">${hp?'📷'+s.photo_urls.length:'<span style="color:var(--text2)">+📷</span>'}</td>
      <td>
        <button class="btn-outline btn-sm" style="white-space:nowrap;font-size:0.6rem" onclick="event.stopPropagation();openSoldEditModal('${s.id}')">✏️ Edit</button>
        <button class="btn-outline btn-sm" style="white-space:nowrap;font-size:0.6rem;margin-top:0.2rem" onclick="event.stopPropagation();unsellWatch('${s.id}')" title="Move back to inventory">↩ Unsell</button>
        <button class="trash-del-btn" style="margin-top:0.2rem;display:block" title="Move to Trash" onclick="event.stopPropagation();softDelete('${s.id}','sold')">🗑</button>
      </td>
    </tr>`;
  }).join('');
}

// ── CONTACTS ─────────────────────────────────────
function populateContactDropdowns(){
  const opts='<option value="">— None —</option>'+contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('f-contact-link').innerHTML=opts;
  const iOpts='<option value="">— Manual entry —</option>'+contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('inv-contact-select').innerHTML=iOpts;
}

function renderContacts(){
  const q=(document.getElementById('contact-search').value||'').toLowerCase();
  const f=contacts.filter(c=>`${c.name} ${c.email||''} ${c.phone||''}`.toLowerCase().includes(q));
  document.getElementById('contacts-subtitle').textContent=`${contacts.length} contact${contacts.length!==1?'s':''}`;
  const grid=document.getElementById('contacts-grid'),empty=document.getElementById('contacts-empty');
  if(!f.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  grid.innerHTML=`<div class="contact-list-header">
      <span>Name</span><span>Contact</span><span>Transactions</span><span>Role</span>
    </div>
    <div class="contacts-list">${f.map(c=>{
      const bought=inventory.filter(w=>w.contact_id===c.id);
      const sold2=soldWatches.filter(w=>w.contact_id===c.id);
      const total=bought.length+sold2.length;
      const isBuyer=sold2.length>0,isSeller=bought.length>0;
      const role=isBuyer&&isSeller?'Buyer & Seller':isBuyer?'Buyer':isSeller?'Seller':'';
      const info=[c.phone,c.email].filter(Boolean).join(' · ');
      return`<div class="contact-list-row" onclick="showContactDetail('${c.id}')">
        <div><div class="contact-list-name">${c.name}</div>${c.city||c.state?`<div class="contact-list-sub">${[c.city,c.state].filter(Boolean).join(', ')}</div>`:''}</div>
        <div class="contact-list-sub">${info||'—'}</div>
        <div class="contact-list-stat">${total?total+' watch'+(total!==1?'es':''):'—'}</div>
        <div>${role?`<span class="contact-role-badge">${role}</span>`:''}</div>
      </div>`;
    }).join('')}</div>`;
}

function showContactDetail(id){
  const c=contacts.find(x=>x.id===id);if(!c)return;
  document.getElementById('contacts-list-view').style.display='none';
  document.getElementById('contacts-detail-view').style.display='block';
  const bought=inventory.filter(w=>w.contact_id===id);
  const sold2=soldWatches.filter(w=>w.contact_id===id);
  const cinvoices=invoices.filter(i=>i.contact_id===id);
  document.getElementById('contact-detail-content').innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:2rem;font-weight:400">${c.name}</div>
        <div style="font-size:0.8rem;color:var(--text2);margin-top:0.25rem;line-height:1.8">${[c.phone,c.email,c.address,[c.city,c.state].filter(Boolean).join(' ')].filter(Boolean).join(' · ')}</div>
        ${c.notes?`<div style="margin-top:0.75rem;font-size:0.75rem;color:var(--text2);background:var(--surface2);padding:0.75rem;border-left:3px solid var(--gold)">${c.notes}</div>`:''}
      </div>
      <div style="display:flex;gap:0.5rem">
        <button class="btn-outline btn-sm" onclick="editContactModal('${id}')">Edit Contact</button>
        <button class="btn-gold btn-sm" onclick="newInvoiceForContact('${id}')">+ New Invoice</button>
      </div>
    </div>
    ${bought.length?`<div class="panel-title" style="margin-bottom:0.75rem">Watches Purchased From (${bought.length})</div>${bought.map(w=>`<div class="contact-history-item"><div><div style="font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold)">${w.brand}</div><div style="font-size:0.85rem">${w.model}${w.ref?' · '+w.ref:''}${w.serial?' · SN:'+w.serial:''}</div></div><span class="contact-history-type bought">Source</span><div style="font-size:0.85rem;color:var(--gold)">${fmt(costBasis(w))}</div></div>`).join('')}`:''}
    ${sold2.length?`<div class="panel-title" style="margin:1.5rem 0 0.75rem">Watches Sold To (${sold2.length})</div>${sold2.map(s=>`<div class="contact-history-item"><div><div style="font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold)">${s.brand}</div><div style="font-size:0.85rem">${s.model}${s.ref?' · '+s.ref:''}${s.serial?' · SN:'+s.serial:''}</div></div><span class="contact-history-type sold-to">Buyer</span><div><div style="font-size:0.85rem">${fmt(s.sold_price)}</div><div style="font-size:0.7rem;color:${soldNetProfit(s)>=0?'var(--green)':'var(--red)'}">${fmt(soldNetProfit(s))} profit</div></div></div>`).join('')}`:''}
    ${cinvoices.length?`<div class="panel-title" style="margin:1.5rem 0 0.75rem">Invoices (${cinvoices.length})</div>${cinvoices.map(i=>`<div class="contact-history-item" onclick="viewInvoice('${i.id}')" style="cursor:pointer"><div><div style="font-size:0.75rem;font-weight:600">Invoice #${i.invoice_number||'—'}</div><div style="font-size:0.7rem;color:var(--text2)">${i.invoice_date||''}</div></div><span class="invoice-status ${i.status||'unpaid'}">${i.status||'Unpaid'}</span><div style="font-family:'Playfair Display',serif;font-size:1rem">${fmt(i.total)}</div></div>`).join('')}`:''}
    ${!bought.length&&!sold2.length&&!cinvoices.length?`<div class="empty-state"><p>No transactions yet for this contact.</p></div>`:''}
  `;
}

function showContactsList(){document.getElementById('contacts-list-view').style.display='';document.getElementById('contacts-detail-view').style.display='none';}

function openContactModal(){
  editingContactId=null;
  document.getElementById('contact-modal-title').textContent='Add Contact';
  document.getElementById('cf-delete-btn').style.display='none';
  ['cf-name','cf-phone','cf-email','cf-address','cf-city','cf-state','cf-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('contact-modal').classList.add('open');
}
function editContactModal(id){
  const c=contacts.find(x=>x.id===id);if(!c)return;
  editingContactId=id;
  document.getElementById('contact-modal-title').textContent='Edit Contact';
  document.getElementById('cf-delete-btn').style.display='inline-block';
  document.getElementById('cf-name').value=c.name||'';
  document.getElementById('cf-phone').value=c.phone||'';
  document.getElementById('cf-email').value=c.email||'';
  document.getElementById('cf-address').value=c.address||'';
  document.getElementById('cf-city').value=c.city||'';
  document.getElementById('cf-state').value=c.state||'';
  document.getElementById('cf-notes').value=c.notes||'';
  document.getElementById('contact-modal').classList.add('open');
}
function closeContactModal(){document.getElementById('contact-modal').classList.remove('open');}
async function saveContact(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name){showToast('Name is required.');return;}
  const row={user_id:currentUser.id,name,phone:document.getElementById('cf-phone').value.trim()||null,email:document.getElementById('cf-email').value.trim()||null,address:document.getElementById('cf-address').value.trim()||null,city:document.getElementById('cf-city').value.trim()||null,state:document.getElementById('cf-state').value.trim()||null,notes:document.getElementById('cf-notes').value.trim()||null};
  if(editingContactId){
    const{error}=await db.from('contacts').update(row).eq('id',editingContactId);
    if(error){showToast('Error: '+error.message);return;}
    contacts=contacts.map(c=>c.id===editingContactId?{...c,...row,id:editingContactId}:c);
  }else{
    const{data,error}=await db.from('contacts').insert(row).select().single();
    if(error){showToast('Error: '+error.message);return;}
    contacts.unshift(data);
  }
  closeContactModal();populateContactDropdowns();renderContacts();updateNavBadges();
  showToast(editingContactId?'Contact updated.':'Contact added.');
}
async function deleteContact(){
  if(!editingContactId)return;
  if(!confirm('Delete this contact? Transaction history will remain.'))return;
  const{error}=await db.from('contacts').delete().eq('id',editingContactId);
  if(error){showToast('Error: '+error.message);return;}
  contacts=contacts.filter(c=>c.id!==editingContactId);
  closeContactModal();renderContacts();updateNavBadges();showToast('Contact deleted.');
}

// ── INVOICES ─────────────────────────────────────
function renderInvoices(){
  document.getElementById('invoices-subtitle').textContent=`${invoices.length} sent · ${receivedInvoices.length} received`;
  const list=document.getElementById('invoice-list'),empty=document.getElementById('invoices-empty');
  if(!invoices.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=invoices.map(inv=>`
    <div class="invoice-item" onclick="viewInvoice('${inv.id}')">
      <div class="invoice-num">#${inv.invoice_number||'—'}</div>
      <div><div class="invoice-client">${inv.bill_name||'—'}</div><div class="invoice-desc">${inv.invoice_date||''}</div></div>
      <div></div>
      <div class="invoice-amount">${fmt(inv.total)}</div>
      <span class="invoice-status ${inv.status||'unpaid'}">${capitalize(inv.status||'unpaid')}</span>
    </div>`).join('');
}
function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function showInvoicesList(){document.getElementById('invoices-list-view').style.display='';document.getElementById('invoices-detail-view').style.display='none';}

function openInvoiceModal(contactId){
  editingInvoiceId=null;invoiceLineItems=[];
  document.getElementById('invoice-modal-title').textContent='New Invoice';
  populateContactDropdowns();
  // Auto-increment invoice number
  let nextNum='26-001';
  if(invoices.length){
    const last=invoices[0].invoice_number||'';
    const m=last.match(/^(\d+)-(\d+)$/);
    if(m)nextNum=m[1]+'-'+(String(parseInt(m[2])+1).padStart(String(m[2]).length,'0'));
    else nextNum=last;
  }
  document.getElementById('inv-number').value=nextNum;
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('inv-date').value=today;
  document.getElementById('inv-due-date').value=today;
  document.getElementById('inv-deposit').value='';
  document.getElementById('inv-notes').value='';
  ['inv-bill-name','inv-bill-address','inv-bill-city','inv-bill-phone','inv-bill-email'].forEach(id=>document.getElementById(id).value='');
  ['inv-show-zelle','inv-show-apple','inv-show-wire'].forEach(id=>document.getElementById(id).checked=false);
  document.getElementById('inv-contact-select').value='';
  if(contactId){document.getElementById('inv-contact-select').value=contactId;fillInvoiceContact();}
  renderInvoiceLines();updateInvoiceTotals();
  document.getElementById('invoice-modal').classList.add('open');
}
function closeInvoiceModal(){document.getElementById('invoice-modal').classList.remove('open');}
function newInvoiceForContact(contactId){showPage('invoices');setTimeout(()=>openInvoiceModal(contactId),50);}

function fillInvoiceContact(){
  const id=document.getElementById('inv-contact-select').value;if(!id)return;
  const c=contacts.find(x=>x.id===id);if(!c)return;
  document.getElementById('inv-bill-name').value=c.name||'';
  document.getElementById('inv-bill-phone').value=c.phone||'';
  document.getElementById('inv-bill-email').value=c.email||'';
  document.getElementById('inv-bill-address').value=c.address||'';
  document.getElementById('inv-bill-city').value=[c.city,c.state].filter(Boolean).join(', ');
}

function addInvoiceLineManual(){
  invoiceLineItems.push({type:'manual',description:'',qty:1,price:0,watchId:null});
  renderInvoiceLines();
}
function addInvoiceLineFromInventory(){document.getElementById('inv-picker-modal').classList.add('open');renderInvPicker();}
function closeInvPicker(){document.getElementById('inv-picker-modal').classList.remove('open');}
function renderInvPicker(){
  const q=(document.getElementById('inv-picker-search').value||'').toLowerCase();
  const f=inventory.filter(w=>`${w.brand} ${w.model} ${w.ref} ${w.serial||''}`.toLowerCase().includes(q));
  document.getElementById('inv-picker-list').innerHTML=f.length?f.map(w=>
    `<div style="padding:0.85rem 1rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''" onclick="pickWatchForInvoice('${w.id}')">
      <div style="font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);margin-bottom:0.2rem">${w.brand}</div>
      <div style="font-size:0.88rem;font-weight:500">${w.model}${w.ref?' · Ref: '+w.ref:''}${w.serial?' · SN: '+w.serial:''}</div>
      <div style="font-size:0.7rem;color:var(--text2);margin-top:0.15rem">${w.year?'Year: '+w.year+' · ':''} Listed: ${w.listed_price?fmt(w.listed_price):'No price set'} · ${w.condition||''} ${w.box_papers?'· '+w.box_papers:''}</div>
    </div>`).join(''):'<div style="padding:1.5rem;text-align:center;color:var(--text2);font-size:0.75rem">No inventory matches</div>';
}
function pickWatchForInvoice(watchId){
  const w=inventory.find(x=>x.id===watchId);if(!w)return;
  const parts=[w.brand,w.model];
  if(w.ref)parts.push('Ref: '+w.ref);
  if(w.year)parts.push('Year: '+w.year);
  if(w.serial)parts.push('SN: '+w.serial);
  if(w.condition)parts.push(w.condition);
  if(w.box_papers)parts.push(w.box_papers);
  invoiceLineItems.push({type:'watch',description:parts.join(' · '),qty:1,price:w.listed_price||0,watchId:w.id});
  closeInvPicker();renderInvoiceLines();updateInvoiceTotals();
}
function renderInvoiceLines(){
  const c=document.getElementById('inv-line-items');
  if(!invoiceLineItems.length){c.innerHTML=`<div style="text-align:center;padding:1.5rem;border:1px dashed var(--border);color:var(--text2);font-size:0.75rem;margin-bottom:0.75rem">No items yet — add from inventory or manually</div>`;return;}
  c.innerHTML=invoiceLineItems.map((item,i)=>`
    <div style="display:grid;grid-template-columns:1fr 80px 130px auto;gap:0.5rem;align-items:center;margin-bottom:0.5rem;padding:0.5rem;background:var(--surface2);border:1px solid var(--border)">
      <input class="form-input" value="${escHtml(item.description)}" placeholder="Description" oninput="invoiceLineItems[${i}].description=this.value" style="font-size:0.75rem">
      <input class="form-input" type="number" value="${item.qty}" min="1" oninput="invoiceLineItems[${i}].qty=+this.value;updateInvoiceTotals()" style="font-size:0.75rem">
      <input class="form-input" type="number" value="${item.price}" placeholder="Price" oninput="invoiceLineItems[${i}].price=+this.value;updateInvoiceTotals()" style="font-size:0.75rem">
      <button onclick="removeInvoiceLine(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:1.1rem;padding:0 0.25rem;line-height:1">✕</button>
    </div>`).join('');
}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function removeInvoiceLine(i){invoiceLineItems.splice(i,1);renderInvoiceLines();updateInvoiceTotals();}
function updateInvoiceTotals(){
  const sub=invoiceLineItems.reduce((s,item)=>s+(+item.price||0)*(+item.qty||1),0);
  const dep=parseFloat(document.getElementById('inv-deposit').value)||0;
  document.getElementById('inv-preview-subtotal').textContent=fmt(sub);
  document.getElementById('inv-preview-balance').textContent=fmt(sub-dep);
  if(dep>0){document.getElementById('inv-deposit-row').style.display='flex';document.getElementById('inv-preview-deposit').textContent='-'+fmt(dep);}
  else document.getElementById('inv-deposit-row').style.display='none';
}

async function saveInvoice(){
  const billName=document.getElementById('inv-bill-name').value.trim();
  if(!billName){showToast('Buyer name is required.');return;}
  if(!invoiceLineItems.length){showToast('Add at least one item.');return;}
  const sub=invoiceLineItems.reduce((s,item)=>s+(+item.price||0)*(+item.qty||1),0);
  const dep=parseFloat(document.getElementById('inv-deposit').value)||0;
  const contactId=document.getElementById('inv-contact-select').value||null;
  const status=dep>=sub&&sub>0?'paid':dep>0?'partial':'unpaid';
  const row={
    user_id:currentUser.id,contact_id:contactId,
    invoice_number:document.getElementById('inv-number').value.trim(),
    invoice_date:document.getElementById('inv-date').value,
    due_date:document.getElementById('inv-due-date').value,
    bill_name:billName,
    bill_address:document.getElementById('inv-bill-address').value.trim()||null,
    bill_city:document.getElementById('inv-bill-city').value.trim()||null,
    bill_phone:document.getElementById('inv-bill-phone').value.trim()||null,
    bill_email:document.getElementById('inv-bill-email').value.trim()||null,
    line_items:invoiceLineItems,
    subtotal:sub,deposit:dep,total:sub,balance_due:sub-dep,
    notes:document.getElementById('inv-notes').value.trim()||null,
    show_zelle:document.getElementById('inv-show-zelle').checked,
    show_applepay:document.getElementById('inv-show-apple').checked,
    show_wire:document.getElementById('inv-show-wire').checked,
    status,
  };
  let savedId;
  if(editingInvoiceId){
    const{error}=await db.from('invoices').update(row).eq('id',editingInvoiceId);
    if(error){showToast('Error: '+error.message);return;}
    invoices=invoices.map(i=>i.id===editingInvoiceId?{...i,...row,id:editingInvoiceId}:i);
    savedId=editingInvoiceId;
  }else{
    const{data,error}=await db.from('invoices').insert(row).select().single();
    if(error){showToast('Error: '+error.message);return;}
    invoices.unshift(data);savedId=data.id;
  }
  closeInvoiceModal();updateNavBadges();
  showPage('invoices');setTimeout(()=>viewInvoice(savedId),50);
}

function viewInvoice(id){
  const inv=invoices.find(x=>x.id===id);if(!inv)return;
  currentInvoiceData=inv;
  showPage('invoices');
  document.getElementById('invoices-list-view').style.display='none';
  document.getElementById('invoices-detail-view').style.display='block';
  document.getElementById('btn-mark-paid').style.display=inv.status==='paid'?'none':'inline-block';
  document.getElementById('invoice-detail-content').innerHTML=buildInvoiceHTML(inv);
}

function editCurrentInvoice(){
  if(!currentInvoiceData)return;
  const inv=currentInvoiceData;
  editingInvoiceId=inv.id;
  invoiceLineItems=JSON.parse(JSON.stringify(inv.line_items||[]));
  populateContactDropdowns();
  document.getElementById('invoice-modal-title').textContent='Edit Invoice';
  document.getElementById('inv-number').value=inv.invoice_number||'';
  document.getElementById('inv-date').value=inv.invoice_date||'';
  document.getElementById('inv-due-date').value=inv.due_date||'';
  document.getElementById('inv-bill-name').value=inv.bill_name||'';
  document.getElementById('inv-bill-address').value=inv.bill_address||'';
  document.getElementById('inv-bill-city').value=inv.bill_city||'';
  document.getElementById('inv-bill-phone').value=inv.bill_phone||'';
  document.getElementById('inv-bill-email').value=inv.bill_email||'';
  document.getElementById('inv-deposit').value=inv.deposit||'';
  document.getElementById('inv-notes').value=inv.notes||'';
  document.getElementById('inv-contact-select').value=inv.contact_id||'';
  document.getElementById('inv-show-zelle').checked=inv.show_zelle||false;
  document.getElementById('inv-show-apple').checked=inv.show_applepay||false;
  document.getElementById('inv-show-wire').checked=inv.show_wire||false;
  renderInvoiceLines();updateInvoiceTotals();
  document.getElementById('invoice-modal').classList.add('open');
}

async function markInvoicePaid(){
  if(!currentInvoiceData)return;
  const{error}=await db.from('invoices').update({status:'paid'}).eq('id',currentInvoiceData.id);
  if(error){showToast('Error: '+error.message);return;}
  invoices=invoices.map(i=>i.id===currentInvoiceData.id?{...i,status:'paid'}:i);
  currentInvoiceData={...currentInvoiceData,status:'paid'};
  document.getElementById('btn-mark-paid').style.display='none';
  document.getElementById('invoice-detail-content').innerHTML=buildInvoiceHTML(currentInvoiceData);
  showToast('Invoice marked as paid.');
}

function printInvoice(){window.print();}

function buildInvoiceHTML(inv){
  const items=inv.line_items||[];
  const logoHtml=`<div style="width:80px;height:94px;display:flex;align-items:center;justify-content:center">${LOGO_SVG.replace(/width="600"/, 'width="80"').replace(/height="700"/, 'height="94"')}</div>`;
  return`<div class="invoice-preview">
    <div class="inv-hdr">
      <div>
        <div class="inv-biz-name">${userProfile.biz_name||'Your Business Name'}</div>
        <div class="inv-biz-info">${userProfile.address||''}<br>${userProfile.contact_email||''}<br>${userProfile.phone||''}</div>
      </div>
      <div class="inv-logo-area" id="inv-logo-area">${logoHtml}</div>
      <div class="inv-title-block">
        <div class="inv-title">Invoice</div>
        <div class="inv-meta-row"><strong>Invoice No:</strong>${inv.invoice_number||'—'}</div>
        <div class="inv-meta-row"><strong>Date:</strong>${inv.invoice_date||'—'}</div>
        <div class="inv-meta-row"><strong>Due Date:</strong>${inv.due_date||inv.invoice_date||'—'}</div>
      </div>
    </div>
    <div class="inv-bill-section">
      <div class="inv-bill-label">Bill To</div>
      <div class="inv-bill-name">${inv.bill_name||'—'}</div>
      <div class="inv-bill-info">${[inv.bill_email,inv.bill_address,inv.bill_city,inv.bill_phone].filter(Boolean).join('<br>')}</div>
    </div>
    <table class="inv-table">
      <thead><tr><th>Description</th><th class="right">Qty</th><th class="right">Rate</th><th class="right">Amount</th></tr></thead>
      <tbody>
        ${items.map(item=>`<tr>
          <td>${escHtml(item.description||'—')}<span class="non-tax">*Non-taxable item</span></td>
          <td class="right">${item.qty||1}</td>
          <td class="right">${fmt(item.price)}</td>
          <td class="right">${fmt((+item.price||0)*(+item.qty||1))}*</td>
        </tr>`).join('')}
      </tbody>
    </table>
    ${inv.notes?`<div class="inv-notes-box">${escHtml(inv.notes)}</div>`:''}
    <div class="inv-bottom">
      ${showPay?`<div class="inv-payment-box">
        <h4>Payment Instructions</h4>
        <p>
          ${inv.show_zelle?`Zelle: ${userProfile.zelle||'(add in Settings)'}<br>`:''}
          ${inv.show_applepay?`Apple Pay: ${userProfile.applepay||'(add in Settings)'}<br>`:''}
          ${inv.show_wire&&userProfile.wire_info?`<br><strong>Wire / Bank Info</strong><br>${userProfile.wire_info.replace(/\n/g,'<br>')}`:inv.show_wire?'Wire info: (add in Settings)':''}
        </p>
      </div>`:'<div></div>'}
      <div>
        <div class="inv-total-row subtotal"><span>Subtotal</span><span>${fmt(inv.subtotal)}</span></div>
        <div class="inv-total-row grand"><span>Total</span><span>${fmt(inv.total)}</span></div>
        ${inv.deposit?`<div class="inv-total-row deposit-line"><span>Deposit Received</span><span>–${fmt(inv.deposit)}</span></div>`:''}
        <div class="inv-total-row"><span>Paid</span><span>${fmt(inv.deposit||0)}</span></div>
        <div class="inv-balance-bar"><span>Balance Due</span><span>${fmt(inv.balance_due)}</span></div>
      </div>
    </div>
    <div class="inv-footer-note">Thank you for your business · ${userProfile.biz_name||'DialTrader'}</div>
  </div>`;
}

// ── WATCH MODAL ───────────────────────────────────
function switchTab(tab){
  document.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.modal-tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelector(`.modal-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
}
function openModal(){
  editingId=null;currentWatchId=null;
  const nl=document.getElementById('notes-list');if(nl)nl.innerHTML='';
  const ne=document.getElementById('notes-empty');if(ne)ne.style.display='block';
  document.getElementById('modal-title').textContent='Add Watch to Inventory';
  document.getElementById('btn-delete').style.display='none';
  document.getElementById('tab-sell-btn').style.display='none';
  clearWatchForm();pendingPhotos=[];renderPhotoGrid();
  buildSwatches('dial-colors',DIAL_COLORS,'f-dial-color');
  buildSwatches('bezel-colors',BEZEL_COLORS,'f-bezel-color');
  populateContactDropdowns();
  buildStageSelector(0);
  switchTab('basics');
  document.getElementById('modal').classList.add('open');
  setTimeout(()=>document.getElementById('f-brand').focus(),50);
}
function editWatch(id){
  const w=inventory.find(x=>x.id===id);if(!w)return;
  editingId=id;currentWatchId=id;loadNotesForWatch(id);
  document.getElementById('modal-title').textContent='Edit Watch';
  document.getElementById('btn-delete').style.display='inline-block';
  document.getElementById('tab-sell-btn').style.display='block';
  buildSwatches('dial-colors',DIAL_COLORS,'f-dial-color');
  buildSwatches('bezel-colors',BEZEL_COLORS,'f-bezel-color');
  populateContactDropdowns();
  buildStageSelector(w.stage_index!=null?w.stage_index:0);
  loadPhotosForEdit(w.photo_urls||[]);
  const fields={
    'f-brand':w.brand,'f-model':w.model,'f-ref':w.ref,'f-serial':w.serial,
    'f-year':w.year,'f-purchase-date':w.purchase_date,'f-purchase-price':w.purchase_price,
    'f-tax':w.tax,'f-shipping-in':w.shipping_in,'f-other-fees':w.other_fees,
    'f-listed-price':w.listed_price,'f-msrp':w.msrp,'f-notes':w.notes,'f-case-size':w.case_size,
    'f-dial-color':w.dial_color,'f-bezel-color':w.bezel_color,'f-bracelet-color':w.bracelet_color,
    'f-buy-name':w.buy_name,'f-buy-phone':w.buy_phone,'f-buy-email':w.buy_email,'f-buy-location':w.buy_location,
    'f-sell-name':w.sell_name,'f-sell-phone':w.sell_phone,'f-sell-email':w.sell_email,'f-sell-location':w.sell_location,
  };
  const selects={'f-platform':w.platform,'f-condition':w.condition,'f-box-papers':w.box_papers,'f-case-material':w.case_material,'f-movement':w.movement,'f-bracelet-type':w.bracelet_type,'f-contact-link':w.contact_id||''};
  Object.entries(fields).forEach(([id,val])=>{const el=document.getElementById(id);if(el)el.value=val||'';});
  Object.entries(selects).forEach(([id,val])=>{const el=document.getElementById(id);if(el)el.value=val||'';});
  setPlatforms('f-platform-checks',w.platform||[]);
  clearPlatforms('f-sale-platform-checks');
  if(w.dial_color)highlightSwatch('dial-colors',w.dial_color);
  if(w.bezel_color)highlightSwatch('bezel-colors',w.bezel_color);
  document.getElementById('f-sale-date').value=new Date().toISOString().split('T')[0];
  switchTab('basics');
  document.getElementById('modal').classList.add('open');
}
function clearWatchForm(){
  ['f-brand','f-model','f-ref','f-serial','f-year','f-purchase-date','f-purchase-price','f-tax','f-shipping-in','f-other-fees','f-listed-price','f-msrp','f-notes','f-case-size','f-dial-color','f-bezel-color','f-bracelet-color','f-buy-name','f-buy-phone','f-buy-email','f-buy-location','f-sell-name','f-sell-phone','f-sell-email','f-sell-location','f-sell-name-sell','f-sell-phone-sell','f-sell-email-sell','f-sold-price','f-platform-fee','f-payment-fee','f-shipping-out','f-sale-date'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['f-condition','f-box-papers','f-case-material','f-movement','f-bracelet-type','f-contact-link'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  clearPlatforms('f-platform-checks');clearPlatforms('f-sale-platform-checks');
  document.querySelectorAll('.color-chip').forEach(c=>c.classList.remove('selected'));
  document.getElementById('sell-pnl').textContent='Enter sold price above to see projected profit.';
  document.getElementById('sell-pnl').style.color='var(--text2)';
}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function closeModalOverlay(e){if(e.target===document.getElementById('modal'))closeModal();}

function updateSellPnL(){
  const w=inventory.find(x=>x.id===editingId);if(!w)return;
  const b=costBasis(w),sp=parseFloat(document.getElementById('f-sold-price').value)||0;
  const pf=parseFloat(document.getElementById('f-platform-fee').value)||0;
  const payf=parseFloat(document.getElementById('f-payment-fee').value)||0;
  const ship=parseFloat(document.getElementById('f-shipping-out').value)||0;
  const profit=sp-pf-payf-ship-b,roi=b?profit/b*100:0;
  const el=document.getElementById('sell-pnl');
  el.innerHTML=`<span style="color:${profit>=0?'var(--green)':'var(--red)'}">Profit: ${fmt(profit)} (${fmtPct(roi)})</span> <span style="color:var(--text2);font-size:0.72rem">· Cost basis: ${fmt(b)}</span>`;
}

const STAGES=[
  'Purchased — Awaiting Payment',
  'Paid — Shipping to Me',
  'In Hand — Cleaning / Service',
  'Photography / Prep for Listing',
  'Listed — Active on Platforms',
  'Offer Accepted — Pending Auth',
  'Authentication — Shipped to Auth',
  'Awaiting Payment from Buyer',
  'Shipped to Buyer',
  'Closed / Complete',
];
const STAGE_ICONS=['💳','📦','🔧','📸','🏷️','🤝','🔍','⏳','🚚','✅'];

function buildStageSelector(selectedIdx){
  const el=document.getElementById('f-stage-selector');if(!el)return;
  el.innerHTML=STAGES.map((s,i)=>`
    <div class="stage-option${selectedIdx===i?' selected':''}" onclick="selectStage(${i})">
      <span class="stage-badge stage-${i}" style="flex-shrink:0"><span class="stage-dot"></span></span>
      <span class="stage-option-num">${i+1}.</span>
      <span>${STAGE_ICONS[i]} ${s}</span>
    </div>`).join('');
}
function selectStage(idx){
  document.querySelectorAll('.stage-option').forEach((el,i)=>el.classList.toggle('selected',i===idx));
}
function getSelectedStage(){
  const el=document.querySelector('.stage-option.selected');
  if(!el)return null;
  return Array.from(document.querySelectorAll('.stage-option')).indexOf(el);
}

function getPlatforms(groupId){return Array.from(document.querySelectorAll(`#${groupId} .platform-check.selected`)).map(el=>el.dataset.val);}
function togglePlatform(el){el.classList.toggle('selected');}
function setPlatforms(groupId,values){
  const arr=Array.isArray(values)?values:(values?[values]:[]);
  document.querySelectorAll(`#${groupId} .platform-check`).forEach(el=>{
    el.classList.toggle('selected',arr.includes(el.dataset.val));
  });
}
function clearPlatforms(groupId){document.querySelectorAll(`#${groupId} .platform-check`).forEach(el=>el.classList.remove('selected'));}

function getFormData(){
  const g=id=>document.getElementById(id);
  return{
    brand:g('f-brand').value.trim(),model:g('f-model').value.trim(),
    ref:g('f-ref').value.trim(),serial:g('f-serial').value.trim(),year:g('f-year').value.trim(),
    purchaseDate:g('f-purchase-date').value,
    purchasePrice:parseFloat(g('f-purchase-price').value)||0,
    tax:parseFloat(g('f-tax').value)||0,shippingIn:parseFloat(g('f-shipping-in').value)||0,
    otherFees:parseFloat(g('f-other-fees').value)||0,
    listedPrice:parseFloat(g('f-listed-price').value)||null,
    msrp:parseFloat(g('f-msrp').value)||null,
    platform:getPlatforms('f-platform-checks'),
    stageIndex:getSelectedStage(),
    notes:g('f-notes').value.trim(),
    contactId:g('f-contact-link').value||null,
    caseSize:g('f-case-size').value.trim(),caseMaterial:g('f-case-material').value,
    movement:g('f-movement').value,condition:g('f-condition').value,boxPapers:g('f-box-papers').value,
    dialColor:g('f-dial-color').value.trim(),bezelColor:g('f-bezel-color').value.trim(),
    braceletType:g('f-bracelet-type').value,braceletColor:g('f-bracelet-color').value.trim(),
    buyName:g('f-buy-name').value.trim(),buyPhone:g('f-buy-phone').value.trim(),
    buyEmail:g('f-buy-email').value.trim(),buyLocation:g('f-buy-location').value.trim(),
    sellName:g('f-sell-name').value.trim(),sellPhone:g('f-sell-phone').value.trim(),
    sellEmail:g('f-sell-email').value.trim(),sellLocation:g('f-sell-location').value.trim(),
  };
}
function localToDb(d){
  return{
    user_id:currentUser.id,brand:d.brand,model:d.model,ref:d.ref||null,serial:d.serial||null,
    year:d.year||null,purchase_date:d.purchaseDate||null,purchase_price:d.purchasePrice||0,
    tax:d.tax||0,shipping_in:d.shippingIn||0,other_fees:d.otherFees||0,
    listed_price:d.listedPrice||null,msrp:d.msrp||null,
    platform:d.platform&&d.platform.length?d.platform:null,
    stage_index:d.stageIndex!=null?d.stageIndex:0,
    notes:d.notes||null,contact_id:d.contactId||null,
    case_size:d.caseSize||null,case_material:d.caseMaterial||null,
    movement:d.movement||null,condition:d.condition||null,box_papers:d.boxPapers||null,
    dial_color:d.dialColor||null,bezel_color:d.bezelColor||null,
    bracelet_type:d.braceletType||null,bracelet_color:d.braceletColor||null,
    buy_name:d.buyName||null,buy_phone:d.buyPhone||null,buy_email:d.buyEmail||null,buy_location:d.buyLocation||null,
    sell_name:d.sellName||null,sell_phone:d.sellPhone||null,sell_email:d.sellEmail||null,sell_location:d.sellLocation||null,
  };
}

async function saveWatch(){
  const data=getFormData();
  if(!data.brand||!data.model){showToast('Brand and Model are required.');switchTab('basics');return;}
  const btn=document.getElementById('btn-save');
  btn.disabled=true;btn.textContent='Saving...';
  const dbRow=localToDb(data);
  let error,savedId;
  if(editingId){
    const res=await db.from('inventory').update(dbRow).eq('id',editingId);
    error=res.error;savedId=editingId;
    if(!error){const i=inventory.findIndex(w=>w.id===editingId);inventory[i]={...inventory[i],...dbRow,id:editingId};}
  }else{
    const res=await db.from('inventory').insert(dbRow).select().single();
    error=res.error;if(!error){savedId=res.data.id;inventory.unshift(res.data);}
  }
  if(error){btn.disabled=false;btn.textContent='Save Watch';showToast('Error: '+error.message);return;}
  btn.textContent=pendingPhotos.some(p=>!p.existing)?'Uploading...':'Saving...';
  const photoUrls=await uploadPhotosForWatch(savedId);
  await db.from('inventory').update({photo_urls:photoUrls}).eq('id',savedId);
  const idx=inventory.findIndex(w=>w.id===savedId);if(idx!==-1)inventory[idx].photo_urls=photoUrls;
  btn.disabled=false;btn.textContent='Save Watch';
  closeModal();refreshAll();showToast(editingId?'Watch updated.':'Watch added.');
}

async function deleteWatch(){
  if(!editingId||!confirm('Delete this watch? This cannot be undone.'))return;
  const{error}=await db.from('inventory').delete().eq('id',editingId);
  if(error){showToast('Error: '+error.message);return;}
  inventory=inventory.filter(w=>w.id!==editingId);
  closeModal();refreshAll();showToast('Watch deleted.');
}

async function markAsSold(){
  if(!editingId)return;
  const row=inventory.find(w=>w.id===editingId);if(!row)return;
  const soldPrice=parseFloat(document.getElementById('f-sold-price').value)||0;
  if(!soldPrice){showToast('Enter a sold price.');return;}
  const g=id=>document.getElementById(id).value.trim();
  const sellName=g('f-sell-name-sell')||row.sell_name||'';
  const sellPhone=g('f-sell-phone-sell')||row.sell_phone||'';
  const sellEmail=g('f-sell-email-sell')||row.sell_email||'';
  // Auto-create contact
  let contactId=row.contact_id;
  if(sellName&&!contactId){
    const existing=contacts.find(c=>c.name.toLowerCase()===sellName.toLowerCase());
    if(existing){contactId=existing.id;}
    else{
      const{data:nc}=await db.from('contacts').insert({user_id:currentUser.id,name:sellName,phone:sellPhone||null,email:sellEmail||null}).select().single();
      if(nc){contacts.unshift(nc);contactId=nc.id;updateNavBadges();}
    }
  }
  const soldRow={
    user_id:currentUser.id,contact_id:contactId||null,
    brand:row.brand,model:row.model,ref:row.ref,year:row.year,serial:row.serial,
    purchase_date:row.purchase_date,
    sale_date:document.getElementById('f-sale-date').value||new Date().toISOString().split('T')[0],
    purchase_price:row.purchase_price,tax:row.tax,shipping_in:row.shipping_in,other_fees:row.other_fees,
    sold_price:soldPrice,
    platform_fee:parseFloat(document.getElementById('f-platform-fee').value)||0,
    payment_fee:parseFloat(document.getElementById('f-payment-fee').value)||0,
    shipping_out:parseFloat(document.getElementById('f-shipping-out').value)||0,
    platform:getPlatforms('f-sale-platform-checks').length?getPlatforms('f-sale-platform-checks'):row.platform,
    notes:row.notes,condition:row.condition,box_papers:row.box_papers,
    case_size:row.case_size,case_material:row.case_material,movement:row.movement,
    dial_color:row.dial_color,bezel_color:row.bezel_color,bracelet_type:row.bracelet_type,bracelet_color:row.bracelet_color,
    buy_name:row.buy_name,buy_phone:row.buy_phone,buy_email:row.buy_email,buy_location:row.buy_location,
    sell_name:sellName,sell_phone:sellPhone,sell_email:sellEmail,sell_location:row.sell_location||'',
    photo_urls:row.photo_urls||[],
  };
  const[ins,del]=await Promise.all([
    db.from('sold_inventory').insert(soldRow).select().single(),
    db.from('inventory').delete().eq('id',editingId)
  ]);
  if(ins.error){showToast('Error: '+ins.error.message);return;}
  soldWatches.unshift(ins.data);
  inventory=inventory.filter(w=>w.id!==editingId);
  const p=soldNetProfit(ins.data);
  closeModal();refreshAll();populateContactDropdowns();
  showToast(`${row.brand} ${row.model} sold · Profit: ${fmt(p)}`);
}

function refreshAll(){renderDashboard();renderInventory();renderSold();updateNavBadges();}

// ── SWATCHES ──────────────────────────────────────
const DIAL_COLORS=[{hex:'#1a1a1a',name:'Black'},{hex:'#2c3e6b',name:'Blue'},{hex:'#1e4d3b',name:'Green'},{hex:'#f5f0e8',name:'White/Cream'},{hex:'#c9a84c',name:'Gold/Champagne'},{hex:'#8b7355',name:'Brown/Chocolate'},{hex:'#7b3f3f',name:'Burgundy/Wine'},{hex:'#9e9e9e',name:'Silver/Grey'},{hex:'#4a7fa5',name:'Slate Blue'},{hex:'#2d5a3d',name:'Olive Green'},{hex:'#d4a5a5',name:'Pink/Rose'},{hex:'#f2f2f2',name:'Panda/White'}];
const BEZEL_COLORS=[{hex:'#1a1a1a',name:'Black'},{hex:'#2c3e6b',name:'Blue'},{hex:'#1e4d3b',name:'Green'},{hex:'#9e9e9e',name:'Steel/Silver'},{hex:'#c9a84c',name:'Gold'},{hex:'#e8c97a',name:'Yellow Gold'},{hex:'#c0c0c0',name:'White Gold'},{hex:'#b87333',name:'Rose Gold'},{hex:'#ff5722',name:'Red/Orange'},{hex:'#f5f0e8',name:'Ceramic White'},{hex:'#3d3d3d',name:'Dark Ceramic'},{hex:'#7b3f3f',name:'Burgundy'}];
function buildSwatches(cid,colors,fid){const el=document.getElementById(cid);if(!el)return;el.innerHTML=colors.map(c=>`<div class="color-chip" title="${c.name}" style="background:${c.hex}" onclick="selectColor('${cid}','${fid}','${c.name}',this)"></div>`).join('');}
function selectColor(cid,fid,name,el){document.querySelectorAll(`#${cid} .color-chip`).forEach(c=>c.classList.remove('selected'));el.classList.add('selected');document.getElementById(fid).value=name;}
function highlightSwatch(cid,name){document.querySelectorAll(`#${cid} .color-chip`).forEach(c=>{if(c.title===name)c.classList.add('selected');});}

// ── PHOTO UPLOAD ──────────────────────────────────
let pendingPhotos=[],dragSrcIdx=null;

async function compressImage(dataUrl,maxWidth=1200,quality=0.82){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      let w=img.width,h=img.height;
      if(w>maxWidth){h=Math.round(h*maxWidth/w);w=maxWidth;}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg',quality));
    };
    img.onerror=()=>resolve(dataUrl);
    img.src=dataUrl;
  });
}
async function dataUrlToBlob(dataUrl){const res=await fetch(dataUrl);return res.blob();}

function initPhotoListeners(){
  const zone=document.getElementById('photo-upload-zone');
  const input=document.getElementById('photo-file-input');
  const grid=document.getElementById('photo-preview-grid');
  zone.addEventListener('click',e=>{if(e.target.tagName==='BUTTON')return;input.click();});
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.style.borderColor='var(--gold)';});
  zone.addEventListener('dragleave',()=>{zone.style.borderColor='var(--border2)';});
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.style.borderColor='var(--border2)';
    processPhotoFiles(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/')));
  });
  input.addEventListener('change',e=>{processPhotoFiles(Array.from(e.target.files));e.target.value='';});
  grid.addEventListener('dragstart',e=>{if(e.target.closest('button')){e.preventDefault();return;}const t=e.target.closest('[data-idx]');if(!t)return;dragSrcIdx=parseInt(t.dataset.idx);setTimeout(()=>t.style.opacity='0.35',0);});
  grid.addEventListener('dragover',e=>{e.preventDefault();const t=e.target.closest('[data-idx]');if(!t)return;grid.querySelectorAll('[data-idx]').forEach(x=>x.style.outline='');if(parseInt(t.dataset.idx)!==dragSrcIdx)t.style.outline='2px solid var(--gold)';});
  grid.addEventListener('dragleave',e=>{const t=e.target.closest('[data-idx]');if(t)t.style.outline='';});
  grid.addEventListener('drop',e=>{e.preventDefault();const t=e.target.closest('[data-idx]');if(!t||dragSrcIdx===null)return;const dest=parseInt(t.dataset.idx);if(dest!==dragSrcIdx){const m=pendingPhotos.splice(dragSrcIdx,1)[0];pendingPhotos.splice(dest,0,m);}dragSrcIdx=null;renderPhotoGrid();});
  grid.addEventListener('dragend',()=>{dragSrcIdx=null;grid.querySelectorAll('[data-idx]').forEach(t=>{t.style.opacity='';t.style.outline='';});});
}
function processPhotoFiles(files){
  const remaining=8-pendingPhotos.length;
  files.slice(0,remaining).forEach(file=>{
    const ext=file.name.split('.').pop().toLowerCase();
    if(ext==='heic'||ext==='heif'){showToast('⚠️ HEIC not supported. iPhone: Settings → Camera → Formats → Most Compatible.');return;}
    const reader=new FileReader();
    reader.onload=ev=>{pendingPhotos.push({file,url:ev.target.result,existing:false});renderPhotoGrid();};
    reader.readAsDataURL(file);
  });
}
function renderPhotoGrid(){
  const grid=document.getElementById('photo-preview-grid');
  const status=document.getElementById('photo-upload-status');
  if(!pendingPhotos.length){grid.innerHTML='';status.textContent='';return;}
  grid.innerHTML=pendingPhotos.map((p,i)=>`<div style="position:relative;aspect-ratio:1"><div class="photo-thumb" draggable="true" data-idx="${i}" style="position:absolute;inset:0"><img src="${p.url}" alt="Photo ${i+1}" style="pointer-events:none;width:100%;height:100%;object-fit:cover;display:block">${i===0?'<div class="photo-main-badge">Main</div>':''}</div><button onclick="removePhotoNow(event,${i})" style="position:absolute;top:3px;right:3px;background:rgba(200,0,0,0.95);color:#fff;border:none;width:24px;height:24px;border-radius:50%;font-size:0.9rem;cursor:pointer;font-weight:900;z-index:999;line-height:24px;text-align:center;padding:0">✕</button></div>`).join('');
  status.textContent=`${pendingPhotos.length}/8 photos · Drag to reorder · First = storefront main image`;
}
function removePhoto(idx){pendingPhotos.splice(idx,1);renderPhotoGrid();}
function removePhotoNow(e,idx){e.stopPropagation();pendingPhotos.splice(idx,1);renderPhotoGrid();}
function loadPhotosForEdit(urls){pendingPhotos=(urls||[]).map(url=>({file:null,url,existing:true}));renderPhotoGrid();}

async function uploadPhotosForWatch(watchId){
  const urls=[];
  for(const p of pendingPhotos){
    if(p.existing){urls.push(p.url);continue;}
    try{
      const compressed=await compressImage(p.url);
      const blob=await dataUrlToBlob(compressed);
      const path=`${currentUser.id}/${watchId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
      const{error:upErr}=await db.storage.from('watch-photos').upload(path,blob,{contentType:'image/jpeg',upsert:true});
      if(upErr){showToast('Upload error: '+upErr.message);continue;}
      const{data:urlData}=db.storage.from('watch-photos').getPublicUrl(path);
      urls.push(urlData.publicUrl);
    }catch(err){console.error('Photo error:',err);}
  }
  return urls;
}

// ── SOLD PHOTO MODAL ──────────────────────────────
let editingSoldId=null,soldPendingPhotos=[],soldDragSrcIdx=null;

function openSoldPhotoModal(id){
  const s=soldWatches.find(w=>w.id===id);if(!s)return;
  editingSoldId=id;
  document.getElementById('sold-photo-modal-title').textContent=`Photos — ${s.brand} ${s.model}`;
  soldPendingPhotos=(s.photo_urls||[]).map(url=>({file:null,url,existing:true}));
  renderSoldPhotoGrid();
  document.getElementById('sold-photo-modal').classList.add('open');
}
function closeSoldPhotoModal(){document.getElementById('sold-photo-modal').classList.remove('open');editingSoldId=null;soldPendingPhotos=[];}
function renderSoldPhotoGrid(){
  const grid=document.getElementById('sold-photo-preview-grid');
  const status=document.getElementById('sold-photo-status');
  if(!soldPendingPhotos.length){
    grid.innerHTML='<div style="padding:1rem;text-align:center;font-size:0.75rem;color:var(--text2)">No photos — add some above</div>';
    status.textContent='';return;
  }
  grid.innerHTML=soldPendingPhotos.map((p,i)=>`
    <div style="position:relative;aspect-ratio:1">
      <div class="photo-thumb" draggable="true" data-sidx="${i}" style="position:absolute;inset:0">
        <img src="${p.url}" alt="" style="pointer-events:none;width:100%;height:100%;object-fit:cover;display:block">
        ${i===0?'<div class="photo-main-badge">Main</div>':''}
      </div>
      <button onclick="deleteSoldPhoto(event,${i})" style="position:absolute;top:3px;right:3px;background:rgba(200,0,0,0.95);color:#fff;border:none;width:24px;height:24px;border-radius:50%;font-size:0.9rem;cursor:pointer;font-weight:900;z-index:999;line-height:24px;text-align:center;padding:0">✕</button>
    </div>`).join('');
  status.textContent=`${soldPendingPhotos.length}/8 · Drag to reorder · First = main`;
}
function deleteSoldPhoto(e,idx){
  e.stopPropagation();
  soldPendingPhotos.splice(idx,1);
  renderSoldPhotoGrid();
}

function initSoldPhotoListeners(){
  const zone=document.getElementById('sold-photo-upload-zone');
  const input=document.getElementById('sold-photo-file-input');
  const grid=document.getElementById('sold-photo-preview-grid');
  zone.addEventListener('click',e=>{if(e.target.tagName==='BUTTON'||e.target.closest('button'))return;input.click();});
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.style.borderColor='var(--gold)';});
  zone.addEventListener('dragleave',()=>{zone.style.borderColor='var(--border2)';});
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.style.borderColor='var(--border2)';
    const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
    const rem=8-soldPendingPhotos.length;
    files.slice(0,rem).forEach(file=>{const r=new FileReader();r.onload=ev=>{soldPendingPhotos.push({file,url:ev.target.result,existing:false});renderSoldPhotoGrid();};r.readAsDataURL(file);});
  });
  input.addEventListener('change',e=>{
    const files=Array.from(e.target.files);
    const rem=8-soldPendingPhotos.length;
    files.slice(0,rem).forEach(file=>{
      const ext=file.name.split('.').pop().toLowerCase();
      if(ext==='heic'||ext==='heif'){showToast('⚠️ HEIC not supported.');return;}
      const r=new FileReader();r.onload=ev=>{soldPendingPhotos.push({file,url:ev.target.result,existing:false});renderSoldPhotoGrid();};r.readAsDataURL(file);
    });
    e.target.value='';
  });
  grid.addEventListener('dragstart',e=>{if(e.target.closest('button')){e.preventDefault();return;}const t=e.target.closest('[data-sidx]');if(!t)return;soldDragSrcIdx=parseInt(t.dataset.sidx);setTimeout(()=>t.style.opacity='0.35',0);});
  grid.addEventListener('dragover',e=>{e.preventDefault();const t=e.target.closest('[data-sidx]');if(!t)return;grid.querySelectorAll('[data-sidx]').forEach(x=>x.style.outline='');if(parseInt(t.dataset.sidx)!==soldDragSrcIdx)t.style.outline='2px solid var(--gold)';});
  grid.addEventListener('dragleave',e=>{const t=e.target.closest('[data-sidx]');if(t)t.style.outline='';});
  grid.addEventListener('drop',e=>{e.preventDefault();const t=e.target.closest('[data-sidx]');if(!t||soldDragSrcIdx===null)return;const dest=parseInt(t.dataset.sidx);if(dest!==soldDragSrcIdx){const m=soldPendingPhotos.splice(soldDragSrcIdx,1)[0];soldPendingPhotos.splice(dest,0,m);}soldDragSrcIdx=null;renderSoldPhotoGrid();});
  grid.addEventListener('dragend',()=>{soldDragSrcIdx=null;grid.querySelectorAll('[data-sidx]').forEach(t=>{t.style.opacity='';t.style.outline='';});});
}

async function saveSoldPhotos(){
  if(!editingSoldId)return;
  const btn=document.getElementById('sold-photo-save-btn');
  btn.disabled=true;btn.textContent=soldPendingPhotos.some(p=>!p.existing)?'Uploading...':'Saving...';
  const urls=[];
  for(const p of soldPendingPhotos){
    if(p.existing){urls.push(p.url);continue;}
    try{
      const compressed=await compressImage(p.url);
      const blob=await dataUrlToBlob(compressed);
      const path=`${currentUser.id}/sold/${editingSoldId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
      const{error:upErr}=await db.storage.from('watch-photos').upload(path,blob,{contentType:'image/jpeg',upsert:true});
      if(upErr){showToast('Upload error: '+upErr.message);continue;}
      const{data:urlData}=db.storage.from('watch-photos').getPublicUrl(path);
      urls.push(urlData.publicUrl);
    }catch(err){console.error(err);}
  }
  const{error}=await db.from('sold_inventory').update({photo_urls:urls}).eq('id',editingSoldId);
  if(error){showToast('Error: '+error.message);btn.disabled=false;btn.textContent='Save Photos';return;}
  const idx=soldWatches.findIndex(w=>w.id===editingSoldId);
  if(idx!==-1)soldWatches[idx].photo_urls=urls;
  btn.disabled=false;btn.textContent='Save Photos';
  closeSoldPhotoModal();renderSold();showToast('Photos saved.');
}

// ── IMPORT / EXPORT ───────────────────────────────
function handleDrop(e,type){e.preventDefault();document.getElementById('drop-'+type).classList.remove('drag');const file=e.dataTransfer.files[0];if(file)parseCSV(file,type);}
function handleFileInput(e,type){const file=e.target.files[0];if(file)parseCSV(file,type);}

function parseCSV(file,type){
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').filter(l=>l.trim());
    if(lines.length<2){showToast('CSV must have a header row and at least one data row.');return;}
    const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
    const rows=lines.slice(1).map(line=>{
      const vals=line.split(',');
      const obj={};
      headers.forEach((h,i)=>obj[h]=(vals[i]||'').trim().replace(/^"|"$/g,''));
      return obj;
    }).filter(r=>r.brand&&r.model);
    showImportPreview(rows,type);
  };
  reader.readAsText(file);
}

function showImportPreview(rows,type){
  const preview=document.getElementById('import-preview');
  preview.style.display='block';
  preview.innerHTML=`
    <div class="panel">
      <div class="panel-title">Import Preview — ${rows.length} rows (${type})</div>
      <p style="font-size:0.75rem;color:var(--text2);margin-bottom:1rem">Review the data below, then click Import to add to your account.</p>
      <div style="overflow-x:auto;max-height:300px;overflow-y:auto">
        <table class="mini-table">
          <thead><tr><th>Brand</th><th>Model</th><th>Ref</th><th>Purchase Price</th>${type==='sold'?'<th>Sold Price</th>':''}</tr></thead>
          <tbody>${rows.slice(0,20).map(r=>`<tr><td>${r.brand}</td><td>${r.model}</td><td>${r.ref||'—'}</td><td>${r.purchase_price?'$'+r.purchase_price:'—'}</td>${type==='sold'?`<td>${r.sold_price?'$'+r.sold_price:'—'}</td>`:''}</tr>`).join('')}</tbody>
        </table>
        ${rows.length>20?`<p style="font-size:0.7rem;color:var(--text2);margin-top:0.5rem">...and ${rows.length-20} more rows</p>`:''}
      </div>
      <div style="margin-top:1rem;display:flex;gap:0.5rem">
        <button class="btn-gold" onclick="confirmImport(window._importRows,window._importType)">Import ${rows.length} Watches</button>
        <button class="btn-outline" onclick="document.getElementById('import-preview').style.display='none'">Cancel</button>
      </div>
    </div>`;
  window._importRows=rows;window._importType=type;
}

async function confirmImport(rows,type){
  const table=type==='sold'?'sold_inventory':'inventory';
  const dbRows=rows.map(r=>{
    const base={user_id:currentUser.id,brand:r.brand,model:r.model,ref:r.ref||null,serial:r.serial||null,year:r.year||null,purchase_date:r.purchase_date||null,purchase_price:parseFloat(r.purchase_price)||0,tax:parseFloat(r.tax)||0,shipping_in:parseFloat(r.shipping_in)||0,other_fees:parseFloat(r.other_fees)||0,notes:r.notes||null,condition:r.condition||null,box_papers:r.box_papers||null,platform:r.platform||null};
    if(type==='sold')return{...base,sale_date:r.sale_date||null,sold_price:parseFloat(r.sold_price)||0,platform_fee:parseFloat(r.platform_fee)||0,payment_fee:parseFloat(r.payment_fee)||0,shipping_out:parseFloat(r.shipping_out)||0};
    return{...base,listed_price:parseFloat(r.listed_price)||null};
  });
  const{error}=await db.from(table).insert(dbRows);
  if(error){showToast('Import error: '+error.message);return;}
  await loadAllData();refreshAll();
  document.getElementById('import-preview').style.display='none';
  showToast(`Imported ${rows.length} watches.`);
}

function copyAIPrompt(){
  const text = document.getElementById('ai-prompt-box').innerText;
  navigator.clipboard.writeText(text).then(()=>showToast('Prompt copied — paste into ChatGPT or Claude'));
}
function copyAISoldPrompt(){
  const text = document.getElementById('ai-sold-prompt-box').innerText;
  navigator.clipboard.writeText(text).then(()=>showToast('Sold prompt copied'));
}

function downloadTemplate(type){
  const invHeaders = 'brand,model,ref,serial,year,purchase_date,purchase_price,tax,shipping_in,other_fees,listed_price,platform,condition,box_papers,notes';
  const invExample = 'Rolex,Submariner,126610LN,ABC123,2022,2024-01-15,12500,0,45,0,14500,Direct,Excellent,Full Set,"Great condition no issues"';
  const invExample2 = 'Omega,Seamaster 300M,210.30.42.20.01.001,XYZ789,2021,2024-02-10,3800,0,30,15,4200,eBay,Mint,Box Only,';

  const soldHeaders = 'brand,model,ref,serial,year,purchase_date,purchase_price,tax,shipping_in,other_fees,sale_date,sold_price,platform_fee,payment_fee,shipping_out,platform,notes';
  const soldExample = 'Rolex,GMT-Master II,126710BLNR,DEF456,2020,2023-01-10,11000,0,50,0,2023-08-22,13500,135,0,30,eBay,"Good flip"';
  const soldExample2 = 'Tudor,Black Bay,79230N,GHI789,2019,2022-06-01,2200,0,25,0,2023-03-15,2800,0,56,0,Direct,';

  const inv = [invHeaders, invExample, invExample2].join('\n');
  const sold = [soldHeaders, soldExample, soldExample2].join('\n');

  const csv = type==='sold' ? sold : inv;
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `dialtrader-${type}-template.csv`;
  a.click();
  showToast(`Template downloaded — open in Excel or Google Sheets`);
}

function exportInventoryCSV(){
  if(!inventory.length){showToast('No inventory to export.');return;}
  const headers=['brand','model','ref','serial','year','purchase_date','purchase_price','tax','shipping_in','other_fees','listed_price','platform','condition','box_papers','notes'];
  const rows=inventory.map(w=>headers.map(h=>`"${(w[h]||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`dialtrader-inventory-${new Date().toISOString().split('T')[0]}.csv`;a.click();
}

// ── UNSELL ────────────────────────────────────────
async function unsellWatch(id){
  const s=soldWatches.find(w=>w.id===id);if(!s)return;
  if(!confirm(`Move "${s.brand} ${s.model}" back to inventory? All sale data will be cleared.`))return;
  const invRow={
    user_id:currentUser.id,brand:s.brand,model:s.model,ref:s.ref,serial:s.serial,year:s.year,
    purchase_date:s.purchase_date,purchase_price:s.purchase_price,tax:s.tax,
    shipping_in:s.shipping_in,other_fees:s.other_fees,
    listed_price:null,msrp:s.msrp||null,platform:s.platform||null,
    notes:s.notes,condition:s.condition,box_papers:s.box_papers,
    case_size:s.case_size,case_material:s.case_material,movement:s.movement,
    dial_color:s.dial_color,bezel_color:s.bezel_color,bracelet_type:s.bracelet_type,bracelet_color:s.bracelet_color,
    buy_name:s.buy_name,buy_phone:s.buy_phone,buy_email:s.buy_email,buy_location:s.buy_location,
    sell_name:null,sell_phone:null,sell_email:null,sell_location:null,
    contact_id:s.contact_id||null,
    photo_urls:s.photo_urls||[],
  };
  const[ins,del]=await Promise.all([
    db.from('inventory').insert(invRow).select().single(),
    db.from('sold_inventory').delete().eq('id',id)
  ]);
  if(ins.error){showToast('Error: '+ins.error.message);return;}
  inventory.unshift(ins.data);
  soldWatches=soldWatches.filter(w=>w.id!==id);
  refreshAll();showToast(`${s.brand} ${s.model} moved back to inventory.`);
}

// ── TAX REPORT ────────────────────────────────────
function renderTaxReport(){
  if(!soldWatches.length){
    document.getElementById('tax-report-content').innerHTML='<div class="empty-state"><h3>No sold watches yet</h3><p>Tax report will appear here once you have sold watches.</p></div>';
    return;
  }
  // Populate year filter
  const years=[...new Set(soldWatches.map(s=>s.sale_date?new Date(s.sale_date).getFullYear():null).filter(Boolean))].sort((a,b)=>b-a);
  const sel=document.getElementById('tax-year-filter');
  const cur=sel.value;
  sel.innerHTML='<option value="all">All Years</option>'+years.map(y=>`<option value="${y}">${y}</option>`).join('');
  if(cur)sel.value=cur;

  const filterYear=sel.value;
  const filtered=filterYear==='all'?soldWatches:soldWatches.filter(s=>s.sale_date&&new Date(s.sale_date).getFullYear()==filterYear);
  const yearsToShow=filterYear==='all'?years:[parseInt(filterYear)];

  const html=yearsToShow.map(year=>{
    const yw=filtered.filter(s=>s.sale_date&&new Date(s.sale_date).getFullYear()===year);
    if(!yw.length)return'';
    const grossSales=yw.reduce((s,w)=>s+(+w.sold_price||0),0);
    const totalCOGS=yw.reduce((s,w)=>s+soldCostBasis(w),0);
    const totalFees=yw.reduce((s,w)=>s+(+w.platform_fee||0)+(+w.payment_fee||0)+(+w.shipping_out||0),0);
    const netProfit=yw.reduce((s,w)=>s+soldNetProfit(w),0);
    return`<div class="tax-year-block">
      <div class="tax-year-header">
        <div class="tax-year-title">${year} Tax Year</div>
        <div class="tax-year-net ${netProfit>=0?'pos':'neg'}">${fmt(netProfit)}</div>
      </div>
      <div class="tax-summary-grid">
        <div class="tax-summary-cell"><div class="tax-summary-label">Gross Sales</div><div class="tax-summary-val">${fmt(grossSales)}</div></div>
        <div class="tax-summary-cell"><div class="tax-summary-label">Cost of Goods Sold</div><div class="tax-summary-val">${fmt(totalCOGS)}</div></div>
        <div class="tax-summary-cell"><div class="tax-summary-label">Platform &amp; Sell Fees</div><div class="tax-summary-val">${fmt(totalFees)}</div></div>
        <div class="tax-summary-cell"><div class="tax-summary-label">Net Profit</div><div class="tax-summary-val" style="color:${netProfit>=0?'var(--green)':'var(--red)'}">${fmt(netProfit)}</div></div>
      </div>
      <div class="tax-transactions">
        <table>
          <thead><tr><th>Sale Date</th><th>Watch</th><th>Ref / Serial</th><th>Cost Basis</th><th>Sold Price</th><th>Fees</th><th>Net Profit</th><th>ROI</th><th>Platform</th></tr></thead>
          <tbody>
            ${yw.map(s=>{
              const p=soldNetProfit(s),r=soldROI(s);
              const fees=(+s.platform_fee||0)+(+s.payment_fee||0)+(+s.shipping_out||0);
              const plat=Array.isArray(s.platform)?s.platform.join(', '):(s.platform||'—');
              return`<tr>
                <td style="white-space:nowrap">${s.sale_date||'—'}</td>
                <td><strong>${s.brand}</strong> ${s.model}</td>
                <td style="color:var(--text2)">${[s.ref,s.serial?'SN:'+s.serial:''].filter(Boolean).join(' · ')||'—'}</td>
                <td>${fmt(soldCostBasis(s))}</td>
                <td>${fmt(s.sold_price)}</td>
                <td style="color:var(--text2)">${fmt(fees)}</td>
                <td style="color:${p>=0?'var(--green)':'var(--red)'}"><strong>${p>=0?'+':''}${fmt(p)}</strong></td>
                <td style="color:${r>=0?'var(--green)':'var(--red)'}">${fmtPct(r)}</td>
                <td style="font-size:0.68rem;color:var(--text2)">${plat}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
  }).join('');
  document.getElementById('tax-report-content').innerHTML=html||'<div class="empty-state"><p>No data for selected year.</p></div>';
}

function exportTaxCSV(){
  const filterYear=document.getElementById('tax-year-filter').value;
  const f=filterYear==='all'?soldWatches:soldWatches.filter(s=>s.sale_date&&new Date(s.sale_date).getFullYear()==filterYear);
  if(!f.length){showToast('No data to export.');return;}
  const headers=['sale_date','brand','model','ref','serial','purchase_date','cost_basis','sold_price','platform_fee','payment_fee','shipping_out','net_profit','roi_pct','platform'];
  const rows=f.map(s=>{
    const p=soldNetProfit(s),r=soldROI(s);
    const plat=Array.isArray(s.platform)?s.platform.join('|'):(s.platform||'');
    return[s.sale_date||'',s.brand||'',s.model||'',s.ref||'',s.serial||'',s.purchase_date||'',soldCostBasis(s).toFixed(2),(+s.sold_price||0).toFixed(2),(+s.platform_fee||0).toFixed(2),(+s.payment_fee||0).toFixed(2),(+s.shipping_out||0).toFixed(2),p.toFixed(2),r.toFixed(2),plat].map(v=>`"${v}"`).join(',');
  });
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`dialtrader-tax-${filterYear}-${new Date().toISOString().split('T')[0]}.csv`;a.click();
}

// ── INVOICE TABS ─────────────────────────────────
let currentInvoiceTab='sent';
function switchInvoiceTab(tab){
  currentInvoiceTab=tab;
  const sentBtn=document.getElementById('tab-sent-btn');
  const recBtn=document.getElementById('tab-received-btn');
  const sentPanel=document.getElementById('sent-invoices-panel');
  const recPanel=document.getElementById('received-invoices-panel');
  const newBtn=document.getElementById('new-invoice-btn');
  const upBtn=document.getElementById('upload-invoice-btn');
  if(tab==='sent'){
    sentBtn.style.background='var(--charcoal)';sentBtn.style.color='#fff';
    recBtn.style.background='';recBtn.style.color='var(--text2)';
    sentPanel.style.display='';recPanel.style.display='none';
    newBtn.style.display='';upBtn.style.display='none';
  } else {
    recBtn.style.background='var(--charcoal)';recBtn.style.color='#fff';
    sentBtn.style.background='';sentBtn.style.color='var(--text2)';
    recPanel.style.display='';sentPanel.style.display='none';
    newBtn.style.display='none';upBtn.style.display='';
    renderReceivedInvoices();
  }
}

// ── RECEIVED INVOICES ────────────────────────────
let receivedInvoices=[],editingReceivedId=null,riFile=null,riFileDataUrl=null;

async function loadReceivedInvoices(){
  const{data}=await db.from('received_invoices').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
  receivedInvoices=data||[];
}

function renderReceivedInvoices(){
  const list=document.getElementById('received-invoice-list');
  const empty=document.getElementById('received-empty');
  if(!receivedInvoices.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=receivedInvoices.map(inv=>{
    // Find linked watch
    const w=inv.watch_id?inventory.find(x=>x.id===inv.watch_id)||soldWatches.find(x=>x.id===inv.watch_id):null;
    return`<div class="invoice-item" onclick="viewReceivedInvoice('${inv.id}')">
      <div class="invoice-num" style="color:var(--text2)">📥</div>
      <div>
        <div class="invoice-client">${inv.seller_name||'Unknown Seller'}</div>
        <div class="invoice-desc">${inv.invoice_date||''}${w?' · '+w.brand+' '+w.model:''}</div>
      </div>
      <div></div>
      <div class="invoice-amount">${inv.amount?fmt(inv.amount):'—'}</div>
      <div style="display:flex;gap:0.4rem;align-items:center">
        ${inv.file_url?`<span style="font-size:0.7rem;color:var(--blue)">📎 File</span>`:''}
        <button class="btn-outline btn-sm" onclick="event.stopPropagation();openReceivedModal('${inv.id}')">Edit</button>
      </div>
    </div>`;
  }).join('');
}

function openReceivedModal(id){
  editingReceivedId=id||null;riFile=null;riFileDataUrl=null;
  document.getElementById('received-modal-title').textContent=id?'Edit Received Invoice':'Upload Received Invoice';
  document.getElementById('ri-delete-btn').style.display=id?'inline-block':'none';
  document.getElementById('ri-file-preview').style.display='none';
  document.getElementById('ri-upload-label').textContent='Drop PDF or image here, or click to browse';
  // Populate watch dropdown
  const allWatches=[...inventory.map(w=>({id:w.id,label:`[Inventory] ${w.brand} ${w.model}${w.ref?' '+w.ref:''}`})),...soldWatches.map(w=>({id:w.id,label:`[Sold] ${w.brand} ${w.model}${w.ref?' '+w.ref:''}`}))];
  document.getElementById('ri-watch-link').innerHTML='<option value="">— None —</option>'+allWatches.map(w=>`<option value="${w.id}">${w.label}</option>`).join('');
  if(id){
    const inv=receivedInvoices.find(x=>x.id===id);if(!inv)return;
    document.getElementById('ri-seller').value=inv.seller_name||'';
    document.getElementById('ri-date').value=inv.invoice_date||'';
    document.getElementById('ri-amount').value=inv.amount||'';
    document.getElementById('ri-notes').value=inv.notes||'';
    document.getElementById('ri-watch-link').value=inv.watch_id||'';
    if(inv.file_url){document.getElementById('ri-upload-label').textContent='Current file attached — upload new to replace';}
  } else {
    ['ri-seller','ri-date','ri-amount','ri-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('ri-watch-link').value='';
    document.getElementById('ri-date').value=new Date().toISOString().split('T')[0];
  }
  document.getElementById('received-modal').classList.add('open');
}
function closeReceivedModal(){document.getElementById('received-modal').classList.remove('open');}

function handleRiDrop(e){
  e.preventDefault();document.getElementById('ri-upload-zone').style.borderColor='';
  const file=e.dataTransfer.files[0];if(file)setRiFile(file);
}
function handleRiFile(e){const file=e.target.files[0];if(file)setRiFile(file);e.target.value='';}
function setRiFile(file){
  riFile=file;
  const reader=new FileReader();
  reader.onload=ev=>{
    riFileDataUrl=ev.target.result;
    document.getElementById('ri-file-name').textContent=file.name;
    document.getElementById('ri-file-size').textContent=(file.size/1024).toFixed(0)+' KB';
    document.getElementById('ri-file-preview').style.display='block';
    document.getElementById('ri-upload-label').textContent='File ready — '+file.name;
  };
  reader.readAsDataURL(file);
}
function clearRiFile(){riFile=null;riFileDataUrl=null;document.getElementById('ri-file-preview').style.display='none';document.getElementById('ri-upload-label').textContent='Drop PDF or image here, or click to browse';}

async function saveReceivedInvoice(){
  const seller=document.getElementById('ri-seller').value.trim();
  if(!seller){showToast('Seller name is required.');return;}
  let fileUrl=editingReceivedId?(receivedInvoices.find(x=>x.id===editingReceivedId)||{}).file_url||null:null;
  if(riFile&&riFileDataUrl){
    const blob=await(await fetch(riFileDataUrl)).blob();
    const ext=riFile.name.split('.').pop();
    const path=`${currentUser.id}/received/${Date.now()}.${ext}`;
    const{error:upErr}=await db.storage.from('watch-photos').upload(path,blob,{contentType:riFile.type,upsert:true});
    if(upErr){showToast('Upload error: '+upErr.message);return;}
    const{data:urlData}=db.storage.from('watch-photos').getPublicUrl(path);
    fileUrl=urlData.publicUrl;
  }
  const row={user_id:currentUser.id,seller_name:seller,invoice_date:document.getElementById('ri-date').value||null,amount:parseFloat(document.getElementById('ri-amount').value)||null,notes:document.getElementById('ri-notes').value.trim()||null,watch_id:document.getElementById('ri-watch-link').value||null,file_url:fileUrl};
  if(editingReceivedId){
    const{error}=await db.from('received_invoices').update(row).eq('id',editingReceivedId);
    if(error){showToast('Error: '+error.message);return;}
    receivedInvoices=receivedInvoices.map(i=>i.id===editingReceivedId?{...i,...row,id:editingReceivedId}:i);
  } else {
    const{data,error}=await db.from('received_invoices').insert(row).select().single();
    if(error){showToast('Error: '+error.message);return;}
    receivedInvoices.unshift(data);
  }
  closeReceivedModal();renderReceivedInvoices();showToast('Invoice saved.');
}

async function deleteReceivedInvoice(){
  if(!editingReceivedId||!confirm('Delete this received invoice?'))return;
  const{error}=await db.from('received_invoices').delete().eq('id',editingReceivedId);
  if(error){showToast('Error: '+error.message);return;}
  receivedInvoices=receivedInvoices.filter(i=>i.id!==editingReceivedId);
  closeReceivedModal();renderReceivedInvoices();showToast('Invoice deleted.');
}

function viewReceivedInvoice(id){
  const inv=receivedInvoices.find(x=>x.id===id);if(!inv)return;
  if(inv.file_url){window.open(inv.file_url,'_blank');}
  else{openReceivedModal(id);}
}

// ── SOLD EDIT MODAL ──────────────────────────────
let editingSoldWatchId=null;

function switchSoldTab(tab){
  document.querySelectorAll('#sold-edit-modal .modal-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#sold-edit-modal .modal-tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelector(`#sold-edit-modal .modal-tab[onclick="switchSoldTab('${tab}')"]`).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
}

function openSoldEditModal(id){
  const s=soldWatches.find(w=>w.id===id);if(!s)return;
  editingSoldWatchId=id;
  document.getElementById('sold-edit-title').textContent=`Edit: ${s.brand} ${s.model}`;
  // Sale Details
  const fields={
    'se-sale-date':s.sale_date,'se-sold-price':s.sold_price,'se-platform-fee':s.platform_fee,
    'se-payment-fee':s.payment_fee,'se-shipping-out':s.shipping_out,
    'se-purchase-date':s.purchase_date,'se-purchase-price':s.purchase_price,
    'se-tax':s.tax,'se-shipping-in':s.shipping_in,'se-other-fees':s.other_fees,'se-notes':s.notes,
    // Watch info
    'se-brand':s.brand,'se-model':s.model,'se-ref':s.ref,'se-serial':s.serial,
    'se-year':s.year,'se-case-size':s.case_size,'se-dial-color':s.dial_color,
    // Contacts
    'se-buy-name':s.buy_name,'se-buy-phone':s.buy_phone,'se-buy-email':s.buy_email,
    'se-sell-name':s.sell_name,'se-sell-phone':s.sell_phone,'se-sell-email':s.sell_email,
  };
  Object.entries(fields).forEach(([fid,val])=>{const el=document.getElementById(fid);if(el)el.value=val||'';});
  document.getElementById('se-condition').value=s.condition||'';
  document.getElementById('se-box-papers').value=s.box_papers||'';
  setPlatforms('se-platform-checks',s.platform||[]);
  switchSoldTab('se-basics');
  document.getElementById('sold-edit-modal').classList.add('open');
}
function closeSoldEditModal(){document.getElementById('sold-edit-modal').classList.remove('open');editingSoldWatchId=null;}

async function saveSoldEdit(){
  if(!editingSoldWatchId)return;
  const g=id=>(document.getElementById(id).value||'').trim();

  // ── Upsert buyer contact ──────────────────────────
  const buyName=g('se-buy-name'), buyPhone=g('se-buy-phone'), buyEmail=g('se-buy-email');
  let buyContactId = null;
  if(buyName){
    // Check if contact already exists by name
    const existing = contacts.find(c=>c.name.toLowerCase()===buyName.toLowerCase());
    if(existing){
      buyContactId = existing.id;
      // Update phone/email if we have new info
      const updates={};
      if(buyPhone && !existing.phone) updates.phone=buyPhone;
      if(buyEmail && !existing.email) updates.email=buyEmail;
      if(Object.keys(updates).length){
        await db.from('contacts').update(updates).eq('id',buyContactId);
        contacts=contacts.map(c=>c.id===buyContactId?{...c,...updates}:c);
      }
    } else {
      const{data:nc}=await db.from('contacts').insert({
        user_id:currentUser.id, name:buyName,
        phone:buyPhone||null, email:buyEmail||null
      }).select().single();
      if(nc){ buyContactId=nc.id; contacts=[...contacts,nc]; }
    }
  }

  // ── Upsert seller contact ─────────────────────────
  const sellName=g('se-sell-name'), sellPhone=g('se-sell-phone'), sellEmail=g('se-sell-email');
  let sellContactId = null;
  if(sellName){
    const existing = contacts.find(c=>c.name.toLowerCase()===sellName.toLowerCase());
    if(existing){
      sellContactId = existing.id;
      const updates={};
      if(sellPhone && !existing.phone) updates.phone=sellPhone;
      if(sellEmail && !existing.email) updates.email=sellEmail;
      if(Object.keys(updates).length){
        await db.from('contacts').update(updates).eq('id',sellContactId);
        contacts=contacts.map(c=>c.id===sellContactId?{...c,...updates}:c);
      }
    } else {
      const{data:nc}=await db.from('contacts').insert({
        user_id:currentUser.id, name:sellName,
        phone:sellPhone||null, email:sellEmail||null
      }).select().single();
      if(nc){ sellContactId=nc.id; contacts=[...contacts,nc]; }
    }
  }

  const row={
    sale_date:g('se-sale-date')||null,
    sold_price:parseFloat(g('se-sold-price'))||0,
    platform_fee:parseFloat(g('se-platform-fee'))||0,
    payment_fee:parseFloat(g('se-payment-fee'))||0,
    shipping_out:parseFloat(g('se-shipping-out'))||0,
    purchase_date:g('se-purchase-date')||null,
    purchase_price:parseFloat(g('se-purchase-price'))||0,
    tax:parseFloat(g('se-tax'))||0,
    shipping_in:parseFloat(g('se-shipping-in'))||0,
    other_fees:parseFloat(g('se-other-fees'))||0,
    notes:g('se-notes')||null,
    brand:g('se-brand'),model:g('se-model'),ref:g('se-ref')||null,serial:g('se-serial')||null,
    year:g('se-year')||null,case_size:g('se-case-size')||null,dial_color:g('se-dial-color')||null,
    condition:document.getElementById('se-condition').value||null,
    box_papers:document.getElementById('se-box-papers').value||null,
    platform:getPlatforms('se-platform-checks'),
    buy_name:buyName||null, buy_phone:buyPhone||null, buy_email:buyEmail||null,
    sell_name:sellName||null, sell_phone:sellPhone||null, sell_email:sellEmail||null,
    contact_id: buyContactId || sellContactId || null,
  };
  const{error}=await db.from('sold_inventory').update(row).eq('id',editingSoldWatchId);
  if(error){showToast('Error: '+error.message);return;}
  soldWatches=soldWatches.map(w=>w.id===editingSoldWatchId?{...w,...row,id:editingSoldWatchId}:w);
  closeSoldEditModal();renderSold();renderDashboard();renderContacts();updateNavBadges();
  showToast('Sold watch updated.');
}

// ── USER PROFILE ─────────────────────────────────
let userProfile={
  biz_name:'',owner_name:'',phone:'',contact_email:'',address:'',
  website:'',zelle:'',applepay:'',wire_info:'',inv_notes:'',
  profile_complete:false
};

async function loadUserProfile(){
  const{data}=await db.from('user_profiles').select('*').eq('user_id',currentUser.id).single();
  if(data){
    userProfile={...userProfile,...data};
    updateSidebarProfile();
    return data.profile_complete;
  }
  return false;
}

function updateSidebarProfile(){
  document.getElementById('sidebar-user').textContent=userProfile.biz_name||currentUser.email;
  document.getElementById('sidebar-email').textContent=currentUser.email;
}

async function saveProfile(){
  const p={
    user_id:currentUser.id,
    biz_name:document.getElementById('sp-biz-name').value.trim(),
    owner_name:document.getElementById('sp-owner-name').value.trim(),
    phone:document.getElementById('sp-phone').value.trim(),
    contact_email:document.getElementById('sp-email').value.trim(),
    address:document.getElementById('sp-address').value.trim(),
    website:document.getElementById('sp-website').value.trim(),
    zelle:document.getElementById('sp-zelle').value.trim(),
    applepay:document.getElementById('sp-applepay').value.trim(),
    wire_info:document.getElementById('sp-wire').value.trim(),
    inv_notes:document.getElementById('sp-inv-notes').value.trim(),
    profile_complete:true,
    updated_at:new Date().toISOString()
  };
  const{error}=await db.from('user_profiles').upsert(p,{onConflict:'user_id'});
  if(error){showToast('Error saving profile: '+error.message);return;}
  userProfile={...userProfile,...p};
  updateSidebarProfile();
  const saved=document.getElementById('sp-saved');
  saved.style.display='inline';
  setTimeout(()=>saved.style.display='none',2500);
  showToast('Profile saved.');
}

function populateSettingsPage(){
  document.getElementById('sp-biz-name').value=userProfile.biz_name||'';
  document.getElementById('sp-owner-name').value=userProfile.owner_name||'';
  document.getElementById('sp-phone').value=userProfile.phone||'';
  document.getElementById('sp-email').value=userProfile.contact_email||'';
  document.getElementById('sp-address').value=userProfile.address||'';
  document.getElementById('sp-website').value=userProfile.website||'';
  document.getElementById('sp-zelle').value=userProfile.zelle||'';
  document.getElementById('sp-applepay').value=userProfile.applepay||'';
  document.getElementById('sp-wire').value=userProfile.wire_info||'';
  document.getElementById('sp-inv-notes').value=userProfile.inv_notes||'';
  document.getElementById('sp-login-email').textContent=currentUser.email;
}

async function changePassword(){
  const email=currentUser.email;
  const{error}=await db.auth.resetPasswordForEmail(email);
  if(error)showToast('Error: '+error.message);
  else showToast('Password reset email sent to '+email);
}

// ── PROFILE SETUP MODAL (first login) ─────────────
function openProfileSetupModal(){
  document.getElementById('profile-setup-modal').classList.add('open');
}
function skipProfileSetup(){
  document.getElementById('profile-setup-modal').classList.remove('open');
}
async function saveProfileSetup(){
  const bizName=document.getElementById('ps-biz-name').value.trim();
  if(!bizName){document.getElementById('ps-error').textContent='Business name is required.';return;}
  const p={
    user_id:currentUser.id,
    biz_name:bizName,
    owner_name:document.getElementById('ps-owner-name').value.trim(),
    phone:document.getElementById('ps-phone').value.trim(),
    contact_email:document.getElementById('ps-email').value.trim()||currentUser.email,
    address:document.getElementById('ps-address').value.trim(),
    zelle:document.getElementById('ps-zelle').value.trim(),
    applepay:document.getElementById('ps-applepay').value.trim(),
    profile_complete:true,
    updated_at:new Date().toISOString()
  };
  const{error}=await db.from('user_profiles').upsert(p,{onConflict:'user_id'});
  if(error){document.getElementById('ps-error').textContent='Error: '+error.message;return;}
  userProfile={...userProfile,...p};
  updateSidebarProfile();
  skipProfileSetup();
  showToast('Profile saved. Welcome to DialTrader!');
}

const STOREFRONT_TEMPLATE = atob("PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiPgo8dGl0bGUgaWQ9InBhZ2UtdGl0bGUiPk15IFdhdGNoIFN0b3JlPC90aXRsZT4KPG1ldGEgbmFtZT0iZGVzY3JpcHRpb24iIGlkPSJwYWdlLWRlc2MiIGNvbnRlbnQ9IlByZS1vd25lZCBsdXh1cnkgd2F0Y2hlcyDigJQgYXV0aGVudGljYXRlZCwgZmFpcmx5IHByaWNlZC4iPgo8bGluayBpZD0iZm9udC1saW5rIiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2NzczI/ZmFtaWx5PVBsYXlmYWlyK0Rpc3BsYXk6aXRhbCx3Z2h0QDAsNDAwOzAsNTAwOzAsNzAwOzEsNDAwOzEsNTAwJmZhbWlseT1SYWxld2F5OndnaHRAMzAwOzQwMDs1MDA7NjAwJmRpc3BsYXk9c3dhcCIgcmVsPSJzdHlsZXNoZWV0Ij4KCjxzY3JpcHQ+CiAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgLy8gIERJQUxUUkFERVIgU1RPUkVGUk9OVCBDT05GSUcg4oCUIGF1dG8tZ2VuZXJhdGVkCiAgLy8gIERvIG5vdCBlZGl0IG1hbnVhbGx5IOKAlCByZWdlbmVyYXRlIGZyb20gRGlhbFRyYWRlciBhcHAKICAvLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKICBjb25zdCBTVVBBQkFTRV9VUkwgID0gJyUlU1VQQUJBU0VfVVJMJSUnOwogIGNvbnN0IFNVUEFCQVNFX0FOT04gPSAnJSVTVVBBQkFTRV9BTk9OJSUnOwoKICAvLyBUaGVtZSDigJQgaW5qZWN0ZWQgYnkgRGlhbFRyYWRlciB0aGVtZSBwaWNrZXIKICBjb25zdCBUSEVNRSA9IHsKICAgIGJvZHlCZzogICAgICAgJyUlVEhFTUVfQk9EWV9CRyUlJywKICAgIGhlYWRlckJnOiAgICAgJyUlVEhFTUVfSEVBREVSX0JHJSUnLAogICAgZ29sZDogICAgICAgICAnJSVUSEVNRV9HT0xEJSUnLAogICAgZ29sZDI6ICAgICAgICAnJSVUSEVNRV9HT0xEMiUlJywKICAgIGJvZHlCb3JkZXI6ICAgJyUlVEhFTUVfQk9EWV9CT1JERVIlJScsCiAgICBmb250RGlzcGxheTogICclJVRIRU1FX0ZPTlRfRElTUExBWSUlJywKICAgIGZvbnRCb2R5OiAgICAgJyUlVEhFTUVfRk9OVF9CT0RZJSUnLAogICAgZm9udFVybDogICAgICAnJSVUSEVNRV9GT05UX1VSTCUlJywKICAgIGhlcm9CZzogICAgICAgJyUlVEhFTUVfSEVST19CRyUlJywKICB9OwoKICAvLyBQcm9maWxlIOKAlCBpbmplY3RlZCBmcm9tIHVzZXJfcHJvZmlsZXMgYXQgZG93bmxvYWQgdGltZQogIC8vIChhbHNvIHJlZnJlc2hlZCBsaXZlIGZyb20gU3VwYWJhc2Ugb24gbG9hZCkKICBjb25zdCBQUk9GSUxFX0NBQ0hFID0gewogICAgYml6TmFtZTogICAnJSVQUk9GSUxFX0JJWl9OQU1FJSUnLAogICAgcGhvbmU6ICAgICAnJSVQUk9GSUxFX1BIT05FJSUnLAogICAgZW1haWw6ICAgICAnJSVQUk9GSUxFX0VNQUlMJSUnLAogICAgaW5zdGFncmFtOiAnJSVQUk9GSUxFX0lOU1RBR1JBTSUlJywKICAgIGxvY2F0aW9uOiAgJyUlUFJPRklMRV9MT0NBVElPTiUlJywKICAgIHdlYnNpdGU6ICAgJyUlUFJPRklMRV9XRUJTSVRFJSUnLAogICAgdGFnbGluZTogICAnJSVQUk9GSUxFX1RBR0xJTkUlJScsCiAgfTsKPC9zY3JpcHQ+Cgo8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9Ac3VwYWJhc2Uvc3VwYWJhc2UtanNAMiI+PC9zY3JpcHQ+Cgo8c3R5bGU+CiosICo6OmJlZm9yZSwgKjo6YWZ0ZXIgeyBib3gtc2l6aW5nOiBib3JkZXItYm94OyBtYXJnaW46IDA7IHBhZGRpbmc6IDA7IH0KCjpyb290IHsKICAvKiBEeW5hbWljIOKAlCBpbmplY3RlZCBieSBhcHBseVRoZW1lKCkgb24gbG9hZCAqLwogIC0taGVhZGVyLWJnOiAjMkEyQTJBOwogIC0taGVhZGVyLWJvcmRlcjogIzNBM0EzQTsKICAtLWJvZHktYmc6ICNGNUYyRUQ7CiAgLS1ib2R5LXN1cmZhY2U6ICNGRkZGRkY7CiAgLS1ib2R5LXN1cmZhY2UyOiAjRUVFQkU1OwogIC0tYm9keS1ib3JkZXI6ICNEREQ4RDA7CiAgLS10ZXh0LWRhcms6ICMxQTFBMUE7CiAgLS10ZXh0LW1pZDogIzU1NTA1MDsKICAtLXRleHQtbGlnaHQ6ICM4QTgyNzg7CiAgLS1nb2xkOiAjQjg5NDNBOwogIC0tZ29sZDI6ICNENEFGNUE7CiAgLS1nb2xkLWxpZ2h0OiByZ2JhKDE4NCwxNDgsNTgsMC4xMik7CiAgLS1jaGFyY29hbDogIzJBMkEyQTsKICAtLXJlZDogI0IwM0EzQTsKICAtLWdyZWVuOiAjM0E3QTVBOwp9CgpodG1sIHsgc2Nyb2xsLWJlaGF2aW9yOiBzbW9vdGg7IH0KYm9keSB7CiAgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtYm9keSwgJ1JhbGV3YXknLCBzYW5zLXNlcmlmKTsKICBiYWNrZ3JvdW5kOiB2YXIoLS1ib2R5LWJnKTsKICBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsKICBtaW4taGVpZ2h0OiAxMDB2aDsKICBvdmVyZmxvdy14OiBoaWRkZW47Cn0KCkBrZXlmcmFtZXMgZmFkZUluIHsgZnJvbSB7IG9wYWNpdHk6MDsgdHJhbnNmb3JtOnRyYW5zbGF0ZVkoMTBweCk7IH0gdG8geyBvcGFjaXR5OjE7IHRyYW5zZm9ybTp0cmFuc2xhdGVZKDApOyB9IH0KCi8qIOKUgOKUgOKUgCBQQUdFIExPQURFUiDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAgKi8KI3BhZ2UtbG9hZGVyIHsKICBwb3NpdGlvbjogZml4ZWQ7IGluc2V0OiAwOwogIGJhY2tncm91bmQ6IHZhcigtLWNoYXJjb2FsKTsKICB6LWluZGV4OiA5OTk5OwogIGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBnYXA6IDEuMjVyZW07CiAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjZzIGVhc2U7Cn0KI3BhZ2UtbG9hZGVyLmhpZGRlbiB7IG9wYWNpdHk6IDA7IHBvaW50ZXItZXZlbnRzOiBub25lOyB9Ci5sb2FkZXItbG9nbyB7CiAgZm9udC1mYW1pbHk6ICdQbGF5ZmFpciBEaXNwbGF5Jywgc2VyaWY7CiAgZm9udC1zaXplOiAxLjhyZW07IGZvbnQtd2VpZ2h0OiA0MDA7IGxldHRlci1zcGFjaW5nOiAwLjEyZW07CiAgY29sb3I6ICNDOUE4NEM7IHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7Cn0KLmxvYWRlci1sb2dvIHNwYW4geyBmb250LXN0eWxlOiBpdGFsaWM7IGNvbG9yOiAjZmZmOyB9Ci5sb2FkZXItYmFyIHsgd2lkdGg6IDE0MHB4OyBoZWlnaHQ6IDFweDsgYmFja2dyb3VuZDogIzQ0NDsgcG9zaXRpb246IHJlbGF0aXZlOyBvdmVyZmxvdzogaGlkZGVuOyB9Ci5sb2FkZXItYmFyOjphZnRlciB7CiAgY29udGVudDogJyc7IHBvc2l0aW9uOiBhYnNvbHV0ZTsgbGVmdDogLTYwJTsgdG9wOiAwOwogIHdpZHRoOiA2MCU7IGhlaWdodDogMTAwJTsgYmFja2dyb3VuZDogI0M5QTg0QzsKICBhbmltYXRpb246IGxvYWQgMS4ycyBlYXNlIGluZmluaXRlOwp9CkBrZXlmcmFtZXMgbG9hZCB7IHRvIHsgbGVmdDogMTEwJTsgfSB9CgovKiDilIDilIDilIAgVE9QIEhFQURFUiBCQVIg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCi50b3AtYmFyIHsKICBiYWNrZ3JvdW5kOiB2YXIoLS1jaGFyY29hbCk7CiAgcGFkZGluZzogMC41cmVtIDJyZW07CiAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgZ2FwOiAycmVtOyBmbGV4LXdyYXA6IHdyYXA7CiAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWhlYWRlci1ib3JkZXIpOwp9Ci50b3AtYmFyIGEgewogIGZvbnQtc2l6ZTogMC43MnJlbTsgbGV0dGVyLXNwYWNpbmc6IDAuMWVtOwogIGNvbG9yOiAjQUFBOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IHRyYW5zaXRpb246IGNvbG9yIDAuMTVzOwp9Ci50b3AtYmFyIGE6aG92ZXIgeyBjb2xvcjogI0M5QTg0QzsgfQoudG9wLWJhci1kaXZpZGVyIHsgY29sb3I6ICM0NDQ7IGZvbnQtc2l6ZTogMC43cmVtOyB9CgovKiDilIDilIDilIAgTUFJTiBIRUFERVIg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCmhlYWRlciB7CiAgYmFja2dyb3VuZDogdmFyKC0tY2hhcmNvYWwpOwogIHBhZGRpbmc6IDEuNXJlbSAycmVtIDEuMjVyZW07CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIGJvcmRlci1ib3R0b206IDNweCBzb2xpZCB2YXIoLS1nb2xkKTsKICBwb3NpdGlvbjogc3RpY2t5OyB0b3A6IDA7IHotaW5kZXg6IDEwMDsKfQoubG9nby1hcmVhIHsgbWFyZ2luLWJvdHRvbTogMXJlbTsgfQoubG9nby10ZXh0IHsKICBmb250LWZhbWlseTogJ1BsYXlmYWlyIERpc3BsYXknLCBzZXJpZjsKICBmb250LXNpemU6IDIuMnJlbTsgZm9udC13ZWlnaHQ6IDUwMDsgbGV0dGVyLXNwYWNpbmc6IDAuMmVtOwogIGNvbG9yOiAjRkZGRkZGOyB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOyBsaW5lLWhlaWdodDogMTsKfQoubG9nby10ZXh0IGVtIHsKICBmb250LXN0eWxlOiBpdGFsaWM7IGNvbG9yOiB2YXIoLS1nb2xkMik7IGZvbnQtd2VpZ2h0OiA0MDA7Cn0KLmxvZ28tdGFnbGluZSB7CiAgZm9udC1mYW1pbHk6ICdSYWxld2F5Jywgc2Fucy1zZXJpZjsKICBmb250LXNpemU6IDAuNnJlbTsgbGV0dGVyLXNwYWNpbmc6IDAuMzVlbTsgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICBjb2xvcjogIzg4ODsgbWFyZ2luLXRvcDogMC40cmVtOwp9Ci5sb2dvLWljb24geyBmb250LXNpemU6IDEuOHJlbTsgbWFyZ2luLWJvdHRvbTogMC4zcmVtOyBkaXNwbGF5OiBibG9jazsgfQoKLyogUmVwbGFjZSBsb2dvLWFyZWEgd2l0aCBpbWFnZSB3aGVuIGxvZ28gZm91bmQgKi8KLmxvZ28taW1nIHsgaGVpZ2h0OiA3MHB4OyB3aWR0aDogYXV0bzsgZGlzcGxheTogYmxvY2s7IG1hcmdpbjogMCBhdXRvIDAuNXJlbTsgfQoKaGVhZGVyIG5hdiB7CiAgZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGdhcDogMi41cmVtOwp9CmhlYWRlciBuYXYgYSB7CiAgZm9udC1zaXplOiAwLjY4cmVtOyBsZXR0ZXItc3BhY2luZzogMC4xOGVtOyB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogIGNvbG9yOiAjQUFBOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IHRyYW5zaXRpb246IGNvbG9yIDAuMTVzOwogIHBhZGRpbmctYm90dG9tOiAycHg7IGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB0cmFuc3BhcmVudDsKfQpoZWFkZXIgbmF2IGE6aG92ZXIgeyBjb2xvcjogI2ZmZjsgYm9yZGVyLWJvdHRvbS1jb2xvcjogdmFyKC0tZ29sZCk7IH0KCi8qIOKUgOKUgOKUgCBIRVJPIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCAqLwouaGVybyB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIGhlaWdodDogNzV2aDsgbWluLWhlaWdodDogNTAwcHg7CiAgZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgdGV4dC1hbGlnbjogY2VudGVyOyBvdmVyZmxvdzogaGlkZGVuOwp9Ci5oZXJvLWJnIHsKICBwb3NpdGlvbjogYWJzb2x1dGU7IGluc2V0OiAwOwogIGJhY2tncm91bmQ6CiAgICBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCByZ2JhKDAsMCwwLDAuNTUpIDAlLCByZ2JhKDAsMCwwLDAuMykgNTAlLCByZ2JhKDAsMCwwLDAuNjUpIDEwMCUpLAogICAgdXJsKCdodHRwczovL2ltYWdlcy51bnNwbGFzaC5jb20vcGhvdG8tMTU4NzgzNjM3NDgyOC00ZGJhZmE5NGNmMGU/dz0xNjAwJnE9ODAmYXV0bz1mb3JtYXQnKSBjZW50ZXIvY292ZXIgbm8tcmVwZWF0Owp9Ci5oZXJvLWNvbnRlbnQgeyBwb3NpdGlvbjogcmVsYXRpdmU7IHotaW5kZXg6IDE7IHBhZGRpbmc6IDJyZW07IH0KLmhlcm8tZXllYnJvdyB7CiAgZm9udC1zaXplOiAwLjY4cmVtOyBsZXR0ZXItc3BhY2luZzogMC4zNWVtOyB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogIGNvbG9yOiB2YXIoLS1nb2xkMik7IG1hcmdpbi1ib3R0b206IDEuMjVyZW07CiAgYW5pbWF0aW9uOiBmYWRlSW4gMC44cyBlYXNlIGJvdGg7Cn0KLmhlcm8tZXllYnJvdzo6YmVmb3JlLCAuaGVyby1leWVicm93OjphZnRlciB7CiAgY29udGVudDogJ+KAlOKAlCc7IG1hcmdpbjogMCAwLjc1cmVtOyBvcGFjaXR5OiAwLjU7Cn0KLmhlcm8tdGl0bGUgewogIGZvbnQtZmFtaWx5OiAnUGxheWZhaXIgRGlzcGxheScsIHNlcmlmOwogIGZvbnQtc2l6ZTogY2xhbXAoMi41cmVtLCA3dncsIDVyZW0pOwogIGZvbnQtd2VpZ2h0OiA0MDA7IGNvbG9yOiAjRkZGRkZGOyBsaW5lLWhlaWdodDogMS4xOwogIGxldHRlci1zcGFjaW5nOiAwLjAyZW07IG1hcmdpbi1ib3R0b206IDEuMjVyZW07CiAgYW5pbWF0aW9uOiBmYWRlSW4gMC44cyAwLjFzIGVhc2UgYm90aDsKfQouaGVyby10aXRsZSBlbSB7IGZvbnQtc3R5bGU6IGl0YWxpYzsgY29sb3I6IHZhcigtLWdvbGQyKTsgfQouaGVyby1zdWIgewogIGZvbnQtc2l6ZTogMC44NXJlbTsgY29sb3I6IHJnYmEoMjU1LDI1NSwyNTUsMC43NSk7CiAgbGV0dGVyLXNwYWNpbmc6IDAuMDVlbTsgbWFyZ2luLWJvdHRvbTogMi41cmVtOwogIGFuaW1hdGlvbjogZmFkZUluIDAuOHMgMC4ycyBlYXNlIGJvdGg7Cn0KLmhlcm8tYnRucyB7CiAgZGlzcGxheTogZmxleDsgZ2FwOiAxcmVtOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgZmxleC13cmFwOiB3cmFwOwogIGFuaW1hdGlvbjogZmFkZUluIDAuOHMgMC4zcyBlYXNlIGJvdGg7Cn0KLmJ0bi1oZXJvLXByaW1hcnkgewogIGJhY2tncm91bmQ6ICNmZmY7IGNvbG9yOiAjMUExQTFBOwogIHBhZGRpbmc6IDAuODVyZW0gMi41cmVtOwogIGZvbnQtZmFtaWx5OiAnUmFsZXdheScsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOiAwLjcycmVtOyBmb250LXdlaWdodDogNjAwOyBsZXR0ZXItc3BhY2luZzogMC4xOGVtOwogIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuMTVzLCBjb2xvciAwLjE1czsKICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7Cn0KLmJ0bi1oZXJvLXByaW1hcnk6aG92ZXIgeyBiYWNrZ3JvdW5kOiB2YXIoLS1nb2xkMik7IGNvbG9yOiAjMUExQTFBOyB9Ci5idG4taGVyby1vdXRsaW5lIHsKICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsgY29sb3I6ICNmZmY7CiAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgyNTUsMjU1LDI1NSwwLjYpOwogIHBhZGRpbmc6IDAuODVyZW0gMi41cmVtOwogIGZvbnQtZmFtaWx5OiAnUmFsZXdheScsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOiAwLjcycmVtOyBmb250LXdlaWdodDogNTAwOyBsZXR0ZXItc3BhY2luZzogMC4xOGVtOwogIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICB0cmFuc2l0aW9uOiBhbGwgMC4xNXM7IGRpc3BsYXk6IGlubGluZS1ibG9jazsKfQouYnRuLWhlcm8tb3V0bGluZTpob3ZlciB7IGJvcmRlci1jb2xvcjogI2ZmZjsgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjEpOyB9CgovKiDilIDilIDilIAgR09MRCBESVZJREVSIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCAqLwouZ29sZC1kaXZpZGVyIHsKICBiYWNrZ3JvdW5kOiB2YXIoLS1jaGFyY29hbCk7CiAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWdvbGQpOwogIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1nb2xkKTsKICBwYWRkaW5nOiAxcmVtIDJyZW07CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBnYXA6IDNyZW07IGZsZXgtd3JhcDogd3JhcDsKfQouZGl2aWRlci1zdGF0IHsgdGV4dC1hbGlnbjogY2VudGVyOyB9Ci5kaXZpZGVyLXN0YXQtdmFsIHsKICBmb250LWZhbWlseTogJ1BsYXlmYWlyIERpc3BsYXknLCBzZXJpZjsKICBmb250LXNpemU6IDEuNnJlbTsgZm9udC13ZWlnaHQ6IDQwMDsgY29sb3I6IHZhcigtLWdvbGQyKTsKfQouZGl2aWRlci1zdGF0LWxhYmVsIHsKICBmb250LXNpemU6IDAuNThyZW07IGxldHRlci1zcGFjaW5nOiAwLjJlbTsgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsgY29sb3I6ICM4ODg7IG1hcmdpbi10b3A6IDAuMnJlbTsKfQouZGl2aWRlci1zZXAgeyBjb2xvcjogIzQ0NDsgZm9udC1zaXplOiAxLjVyZW07IH0KCi8qIOKUgOKUgOKUgCBTRUNUSU9OIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCAqLwouc2VjdGlvbiB7IHBhZGRpbmc6IDRyZW0gMnJlbTsgbWF4LXdpZHRoOiAxNDAwcHg7IG1hcmdpbjogMCBhdXRvOyB9Ci5zZWN0aW9uLWhlYWRlciB7IHRleHQtYWxpZ246IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogM3JlbTsgfQouc2VjdGlvbi1leWVicm93IHsKICBmb250LXNpemU6IDAuNjJyZW07IGxldHRlci1zcGFjaW5nOiAwLjI4ZW07IHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgY29sb3I6IHZhcigtLWdvbGQpOyBtYXJnaW4tYm90dG9tOiAwLjc1cmVtOwp9Ci5zZWN0aW9uLXRpdGxlIHsKICBmb250LWZhbWlseTogJ1BsYXlmYWlyIERpc3BsYXknLCBzZXJpZjsKICBmb250LXNpemU6IDIuMnJlbTsgZm9udC13ZWlnaHQ6IDQwMDsgY29sb3I6IHZhcigtLXRleHQtZGFyayk7CiAgbGV0dGVyLXNwYWNpbmc6IDAuMDJlbTsKfQouc2VjdGlvbi10aXRsZSBlbSB7IGZvbnQtc3R5bGU6IGl0YWxpYzsgY29sb3I6IHZhcigtLWdvbGQpOyB9Ci5zZWN0aW9uLWxpbmUgewogIHdpZHRoOiA2MHB4OyBoZWlnaHQ6IDJweDsgYmFja2dyb3VuZDogdmFyKC0tZ29sZCk7CiAgbWFyZ2luOiAxcmVtIGF1dG8gMDsKfQoKLyog4pSA4pSA4pSAIEZJTFRFUiBCQVIg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCi5maWx0ZXItc3RyaXAgewogIGRpc3BsYXk6IGZsZXg7IGdhcDogMC43NXJlbTsgZmxleC13cmFwOiB3cmFwOwogIG1hcmdpbi1ib3R0b206IDIuNXJlbTsgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBwYWRkaW5nLWJvdHRvbTogMS41cmVtOyBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tYm9keS1ib3JkZXIpOwp9Ci5maWx0ZXItaW5wdXQgewogIGJhY2tncm91bmQ6ICNmZmY7IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvZHktYm9yZGVyKTsKICBjb2xvcjogdmFyKC0tdGV4dC1kYXJrKTsgcGFkZGluZzogMC42cmVtIDFyZW07CiAgZm9udC1mYW1pbHk6ICdSYWxld2F5Jywgc2Fucy1zZXJpZjsgZm9udC1zaXplOiAwLjc4cmVtOwogIG91dGxpbmU6IG5vbmU7IHdpZHRoOiAyODBweDsgdHJhbnNpdGlvbjogYm9yZGVyLWNvbG9yIDAuMTVzOwp9Ci5maWx0ZXItaW5wdXQ6OnBsYWNlaG9sZGVyIHsgY29sb3I6IHZhcigtLXRleHQtbGlnaHQpOyB9Ci5maWx0ZXItaW5wdXQ6Zm9jdXMgeyBib3JkZXItY29sb3I6IHZhcigtLWdvbGQpOyB9Ci5maWx0ZXItc2VsZWN0IHsKICBiYWNrZ3JvdW5kOiAjZmZmOyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1ib2R5LWJvcmRlcik7CiAgY29sb3I6IHZhcigtLXRleHQtbWlkKTsgcGFkZGluZzogMC42cmVtIDAuOXJlbTsKICBmb250LWZhbWlseTogJ1JhbGV3YXknLCBzYW5zLXNlcmlmOyBmb250LXNpemU6IDAuNzVyZW07IG91dGxpbmU6IG5vbmU7IGN1cnNvcjogcG9pbnRlcjsKfQoucmVzdWx0cy1jb3VudCB7IGZvbnQtc2l6ZTogMC43cmVtOyBjb2xvcjogdmFyKC0tdGV4dC1saWdodCk7IG1hcmdpbi1sZWZ0OiBhdXRvOyBmb250LXN0eWxlOiBpdGFsaWM7IH0KCi8qIOKUgOKUgOKUgCBXQVRDSCBHUklEIOKAlCBUQUxMIFBPUlRSQUlUIENBUkRTIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCAqLwoud2F0Y2gtZ3JpZCB7CiAgZGlzcGxheTogZ3JpZDsKICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdChhdXRvLWZpbGwsIG1pbm1heCgyNjBweCwgMWZyKSk7CiAgZ2FwOiAxLjVyZW07Cn0KLndhdGNoLWNhcmQgewogIGJhY2tncm91bmQ6IHZhcigtLWJvZHktc3VyZmFjZSk7CiAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYm9keS1ib3JkZXIpOwogIGN1cnNvcjogcG9pbnRlcjsKICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4ycyBlYXNlLCBib3gtc2hhZG93IDAuMnMgZWFzZTsKICBhbmltYXRpb246IGZhZGVJbiAwLjRzIGVhc2UgYm90aDsKICBkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwp9Ci53YXRjaC1jYXJkOmhvdmVyIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTRweCk7CiAgYm94LXNoYWRvdzogMCAxMnB4IDQwcHggcmdiYSgwLDAsMCwwLjEyKTsKfQoud2F0Y2gtY2FyZDpob3ZlciAud2F0Y2gtcGhvdG8gaW1nIHsgdHJhbnNmb3JtOiBzY2FsZSgxLjA0KTsgfQoKLyogVEFMTCBQT1JUUkFJVCDigJQgMzo0IHJhdGlvICovCi53YXRjaC1waG90byB7CiAgYXNwZWN0LXJhdGlvOiAzLzQ7CiAgb3ZlcmZsb3c6IGhpZGRlbjsKICBiYWNrZ3JvdW5kOiB2YXIoLS1ib2R5LXN1cmZhY2UyKTsKICBwb3NpdGlvbjogcmVsYXRpdmU7Cn0KLndhdGNoLXBob3RvIGltZyB7CiAgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgb2JqZWN0LWZpdDogY292ZXI7CiAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuNXMgZWFzZTsgZGlzcGxheTogYmxvY2s7Cn0KLndhdGNoLXBob3RvLXBsYWNlaG9sZGVyIHsKICB3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOwogIGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBnYXA6IDAuNzVyZW07Cn0KLnBoLWljb24geyBmb250LXNpemU6IDNyZW07IG9wYWNpdHk6IDAuMTU7IH0KLnBoLWJyYW5kIHsKICBmb250LWZhbWlseTogJ1BsYXlmYWlyIERpc3BsYXknLCBzZXJpZjsKICBmb250LXNpemU6IDFyZW07IGxldHRlci1zcGFjaW5nOiAwLjE1ZW07IHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgY29sb3I6IHZhcigtLXRleHQtbGlnaHQpOyBvcGFjaXR5OiAwLjU7Cn0KLnBob3RvLWNvdW50LWJhZGdlIHsKICBwb3NpdGlvbjogYWJzb2x1dGU7IGJvdHRvbTogMC42cmVtOyByaWdodDogMC42cmVtOwogIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC42NSk7IGNvbG9yOiAjZmZmOwogIGZvbnQtc2l6ZTogMC42cmVtOyBwYWRkaW5nOiAwLjJyZW0gMC41cmVtOyBsZXR0ZXItc3BhY2luZzogMC4wNmVtOwp9Ci53YXRjaC10YWcgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsgdG9wOiAwLjc1cmVtOyBsZWZ0OiAwLjc1cmVtOwogIGJhY2tncm91bmQ6IHZhcigtLWNoYXJjb2FsKTsgY29sb3I6ICNmZmY7CiAgZm9udC1zaXplOiAwLjU1cmVtOyBsZXR0ZXItc3BhY2luZzogMC4xNGVtOyB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwogIHBhZGRpbmc6IDAuMjVyZW0gMC42cmVtOwp9Cgoud2F0Y2gtaW5mbyB7IHBhZGRpbmc6IDFyZW0gMS4xcmVtIDEuMjVyZW07IGZsZXg6IDE7IGRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IH0KLndhdGNoLWNhcmQtYnJhbmQgewogIGZvbnQtc2l6ZTogMC42cmVtOyBsZXR0ZXItc3BhY2luZzogMC4yZW07IHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgY29sb3I6IHZhcigtLWdvbGQpOyBtYXJnaW4tYm90dG9tOiAwLjM1cmVtOyBmb250LXdlaWdodDogNjAwOwp9Ci53YXRjaC1jYXJkLW1vZGVsIHsKICBmb250LWZhbWlseTogJ1BsYXlmYWlyIERpc3BsYXknLCBzZXJpZjsKICBmb250LXNpemU6IDEuMDVyZW07IGxpbmUtaGVpZ2h0OiAxLjM7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwogIG1hcmdpbi1ib3R0b206IDAuMjVyZW07Cn0KLndhdGNoLWNhcmQtcmVmIHsgZm9udC1zaXplOiAwLjY4cmVtOyBjb2xvcjogdmFyKC0tdGV4dC1saWdodCk7IG1hcmdpbi1ib3R0b206IDAuODVyZW07IH0KLndhdGNoLWNhcmQtY2hpcHMgeyBkaXNwbGF5OiBmbGV4OyBmbGV4LXdyYXA6IHdyYXA7IGdhcDogMC4zcmVtOyBtYXJnaW4tYm90dG9tOiAxcmVtOyB9Ci5jaGlwIHsKICBmb250LXNpemU6IDAuNThyZW07IGxldHRlci1zcGFjaW5nOiAwLjA2ZW07CiAgYmFja2dyb3VuZDogdmFyKC0tYm9keS1zdXJmYWNlMik7IGNvbG9yOiB2YXIoLS10ZXh0LW1pZCk7CiAgcGFkZGluZzogMC4xNXJlbSAwLjVyZW07IGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvZHktYm9yZGVyKTsKfQoud2F0Y2gtY2FyZC1mb290ZXIgewogIGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBwYWRkaW5nLXRvcDogMC44NXJlbTsgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWJvZHktYm9yZGVyKTsKICBtYXJnaW4tdG9wOiBhdXRvOwp9Ci53YXRjaC1wcmljZSB7CiAgZm9udC1mYW1pbHk6ICdQbGF5ZmFpciBEaXNwbGF5Jywgc2VyaWY7CiAgZm9udC1zaXplOiAxLjNyZW07IGZvbnQtd2VpZ2h0OiA1MDA7IGNvbG9yOiB2YXIoLS10ZXh0LWRhcmspOwp9Ci53YXRjaC1pbnF1aXJlIHsKICBmb250LXNpemU6IDAuNnJlbTsgbGV0dGVyLXNwYWNpbmc6IDAuMTJlbTsgdGV4dC10cmFuc2Zvcm06IHVwcGVyY2FzZTsKICBjb2xvcjogdmFyKC0tdGV4dC1taWQpOyBiYWNrZ3JvdW5kOiBub25lOwogIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvZHktYm9yZGVyKTsKICBwYWRkaW5nOiAwLjRyZW0gMC44NXJlbTsgY3Vyc29yOiBwb2ludGVyOwogIGZvbnQtZmFtaWx5OiAnUmFsZXdheScsIHNhbnMtc2VyaWY7IGZvbnQtd2VpZ2h0OiA2MDA7CiAgdHJhbnNpdGlvbjogYWxsIDAuMTVzOwp9Ci53YXRjaC1pbnF1aXJlOmhvdmVyIHsgYmFja2dyb3VuZDogdmFyKC0tY2hhcmNvYWwpOyBjb2xvcjogI2ZmZjsgYm9yZGVyLWNvbG9yOiB2YXIoLS1jaGFyY29hbCk7IH0KCi8qIOKUgOKUgOKUgCBMSUdIVEJPWCDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAgKi8KLmxpZ2h0Ym94IHsKICBkaXNwbGF5OiBub25lOyBwb3NpdGlvbjogZml4ZWQ7IGluc2V0OiAwOwogIGJhY2tncm91bmQ6IHJnYmEoMCwwLDAsMC44OCk7IHotaW5kZXg6IDYwMDsKICBhbGlnbi1pdGVtczogY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgcGFkZGluZzogMXJlbTsKfQoubGlnaHRib3gub3BlbiB7IGRpc3BsYXk6IGZsZXg7IH0KLmxiLWlubmVyIHsKICBiYWNrZ3JvdW5kOiAjZmZmOyB3aWR0aDogOTAwcHg7IG1heC13aWR0aDogMTAwJTsKICBtYXgtaGVpZ2h0OiA5MnZoOyBvdmVyZmxvdy15OiBhdXRvOwogIGFuaW1hdGlvbjogZmFkZUluIDAuMnMgZWFzZTsKICBkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDEuMWZyIDFmcjsKfQpAbWVkaWEobWF4LXdpZHRoOjY0MHB4KXsgLmxiLWlubmVyIHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnI7IH0gfQoKLmxiLXBob3RvLXBhbmVsIHsgYmFja2dyb3VuZDogdmFyKC0tYm9keS1zdXJmYWNlMik7IHBvc2l0aW9uOiByZWxhdGl2ZTsgfQoubGItbWFpbi1pbWcgeyBhc3BlY3QtcmF0aW86IDMvNDsgb3ZlcmZsb3c6IGhpZGRlbjsgfQoubGItbWFpbi1pbWcgaW1nIHsgd2lkdGg6MTAwJTsgaGVpZ2h0OjEwMCU7IG9iamVjdC1maXQ6Y292ZXI7IGRpc3BsYXk6YmxvY2s7IH0KLmxiLW1haW4tcGxhY2Vob2xkZXIgeyBhc3BlY3QtcmF0aW86My80OyBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmNlbnRlcjsgZm9udC1zaXplOjVyZW07IG9wYWNpdHk6MC4xOyB9Ci5sYi10aHVtYnMtcm93IHsgZGlzcGxheTpmbGV4OyBnYXA6MnB4OyBwYWRkaW5nOjJweDsgb3ZlcmZsb3cteDphdXRvOyBiYWNrZ3JvdW5kOnZhcigtLWJvZHktYm9yZGVyKTsgfQoubGItdGh1bWIgeyB3aWR0aDo2NXB4OyBoZWlnaHQ6NjVweDsgZmxleC1zaHJpbms6MDsgb3ZlcmZsb3c6aGlkZGVuOyBjdXJzb3I6cG9pbnRlcjsgb3BhY2l0eTowLjU7IHRyYW5zaXRpb246b3BhY2l0eSAwLjE1czsgfQoubGItdGh1bWIuYWN0aXZlIHsgb3BhY2l0eToxOyBvdXRsaW5lOjJweCBzb2xpZCB2YXIoLS1nb2xkKTsgfQoubGItdGh1bWIgaW1nIHsgd2lkdGg6MTAwJTsgaGVpZ2h0OjEwMCU7IG9iamVjdC1maXQ6Y292ZXI7IH0KLmxiLWNsb3NlIHsKICBwb3NpdGlvbjphYnNvbHV0ZTsgdG9wOjAuNzVyZW07IHJpZ2h0OjAuNzVyZW07CiAgYmFja2dyb3VuZDpyZ2JhKDAsMCwwLDAuNSk7IGJvcmRlcjpub25lOyBjb2xvcjojZmZmOwogIHdpZHRoOjMwcHg7IGhlaWdodDozMHB4OyBib3JkZXItcmFkaXVzOjUwJTsgZm9udC1zaXplOjAuOXJlbTsKICBjdXJzb3I6cG9pbnRlcjsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGp1c3RpZnktY29udGVudDpjZW50ZXI7IHotaW5kZXg6MTA7Cn0KCi5sYi1pbmZvIHsgcGFkZGluZzogMnJlbSAxLjc1cmVtOyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjsgfQoubGItYnJhbmQgeyBmb250LXNpemU6MC42MnJlbTsgbGV0dGVyLXNwYWNpbmc6MC4yMmVtOyB0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7IGNvbG9yOnZhcigtLWdvbGQpOyBmb250LXdlaWdodDo2MDA7IG1hcmdpbi1ib3R0b206MC40cmVtOyB9Ci5sYi1tb2RlbCB7IGZvbnQtZmFtaWx5OidQbGF5ZmFpciBEaXNwbGF5JyxzZXJpZjsgZm9udC1zaXplOjEuN3JlbTsgZm9udC13ZWlnaHQ6NDAwOyBsaW5lLWhlaWdodDoxLjI7IGNvbG9yOnZhcigtLXRleHQtZGFyayk7IG1hcmdpbi1ib3R0b206MC4zcmVtOyB9Ci5sYi1yZWYgeyBmb250LXNpemU6MC43MnJlbTsgY29sb3I6dmFyKC0tdGV4dC1saWdodCk7IG1hcmdpbi1ib3R0b206MXJlbTsgcGFkZGluZy1ib3R0b206MXJlbTsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9keS1ib3JkZXIpOyB9Ci5sYi1wcmljZSB7IGZvbnQtZmFtaWx5OidQbGF5ZmFpciBEaXNwbGF5JyxzZXJpZjsgZm9udC1zaXplOjJyZW07IGZvbnQtd2VpZ2h0OjUwMDsgY29sb3I6dmFyKC0tdGV4dC1kYXJrKTsgbWFyZ2luLWJvdHRvbToxLjVyZW07IH0KLmxiLXNwZWNzIHsgZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyIDFmcjsgZ2FwOjAuNnJlbTsgbWFyZ2luLWJvdHRvbToxLjVyZW07IH0KLmxiLXNwZWMgeyBiYWNrZ3JvdW5kOnZhcigtLWJvZHktc3VyZmFjZTIpOyBwYWRkaW5nOjAuNnJlbSAwLjc1cmVtOyB9Ci5sYi1zcGVjLWxhYmVsIHsgZm9udC1zaXplOjAuNTVyZW07IGxldHRlci1zcGFjaW5nOjAuMTRlbTsgdGV4dC10cmFuc2Zvcm06dXBwZXJjYXNlOyBjb2xvcjp2YXIoLS10ZXh0LWxpZ2h0KTsgbWFyZ2luLWJvdHRvbTowLjJyZW07IH0KLmxiLXNwZWMtdmFsdWUgeyBmb250LXNpemU6MC44cmVtOyBjb2xvcjp2YXIoLS10ZXh0LWRhcmspOyBmb250LXdlaWdodDo1MDA7IH0KLmxiLW5vdGVzIHsgZm9udC1zaXplOjAuNzVyZW07IGNvbG9yOnZhcigtLXRleHQtbWlkKTsgbGluZS1oZWlnaHQ6MS43OyBtYXJnaW4tYm90dG9tOjEuNXJlbTsgcGFkZGluZzowLjg1cmVtOyBiYWNrZ3JvdW5kOnZhcigtLWJvZHktc3VyZmFjZTIpOyBib3JkZXItbGVmdDozcHggc29saWQgdmFyKC0tZ29sZCk7IH0KLmxiLWFjdGlvbnMgeyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjsgZ2FwOjAuNnJlbTsgbWFyZ2luLXRvcDphdXRvOyB9Ci5sYi1idG4tcHJpbWFyeSB7CiAgYmFja2dyb3VuZDp2YXIoLS1jaGFyY29hbCk7IGNvbG9yOiNmZmY7IGJvcmRlcjpub25lOwogIHBhZGRpbmc6MC45cmVtOyBmb250LWZhbWlseTonUmFsZXdheScsc2Fucy1zZXJpZjsKICBmb250LXNpemU6MC43MnJlbTsgZm9udC13ZWlnaHQ6NjAwOyBsZXR0ZXItc3BhY2luZzowLjE2ZW07CiAgdGV4dC10cmFuc2Zvcm06dXBwZXJjYXNlOyBjdXJzb3I6cG9pbnRlcjsgdHJhbnNpdGlvbjpiYWNrZ3JvdW5kIDAuMTVzOwp9Ci5sYi1idG4tcHJpbWFyeTpob3ZlciB7IGJhY2tncm91bmQ6IzQ0NDsgfQoubGItYnRuLW91dGxpbmUgewogIGJhY2tncm91bmQ6bm9uZTsgY29sb3I6dmFyKC0tdGV4dC1taWQpOwogIGJvcmRlcjoxcHggc29saWQgdmFyKC0tYm9keS1ib3JkZXIpOyBwYWRkaW5nOjAuNzVyZW07CiAgZm9udC1mYW1pbHk6J1JhbGV3YXknLHNhbnMtc2VyaWY7IGZvbnQtc2l6ZTowLjY4cmVtOwogIGxldHRlci1zcGFjaW5nOjAuMTJlbTsgdGV4dC10cmFuc2Zvcm06dXBwZXJjYXNlOyBjdXJzb3I6cG9pbnRlcjsKICB0cmFuc2l0aW9uOmFsbCAwLjE1czsgdGV4dC1hbGlnbjpjZW50ZXI7IHRleHQtZGVjb3JhdGlvbjpub25lOyBkaXNwbGF5OmJsb2NrOwp9Ci5sYi1idG4tb3V0bGluZTpob3ZlciB7IGJvcmRlci1jb2xvcjp2YXIoLS1jaGFyY29hbCk7IGNvbG9yOnZhcigtLWNoYXJjb2FsKTsgfQoKLyog4pSA4pSA4pSAIFNPTEQgU0VDVElPTiDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAgKi8KLnNvbGQtc2VjdGlvbi13cmFwIHsgYmFja2dyb3VuZDogdmFyKC0tY2hhcmNvYWwpOyBwYWRkaW5nOiA0cmVtIDJyZW07IH0KLnNvbGQtc2VjdGlvbi1pbm5lciB7IG1heC13aWR0aDoxNDAwcHg7IG1hcmdpbjowIGF1dG87IH0KLnNvbGQtc2VjdGlvbi10aXRsZSB7CiAgZm9udC1mYW1pbHk6J1BsYXlmYWlyIERpc3BsYXknLHNlcmlmOwogIGZvbnQtc2l6ZToxLjhyZW07IGZvbnQtd2VpZ2h0OjQwMDsgY29sb3I6I2ZmZjsKICB0ZXh0LWFsaWduOmNlbnRlcjsgbWFyZ2luLWJvdHRvbTowLjVyZW07Cn0KLnNvbGQtc2VjdGlvbi10aXRsZSBlbSB7IGZvbnQtc3R5bGU6aXRhbGljOyBjb2xvcjp2YXIoLS1nb2xkMik7IH0KLnNvbGQtc3ViIHsgdGV4dC1hbGlnbjpjZW50ZXI7IGZvbnQtc2l6ZTowLjY4cmVtOyBsZXR0ZXItc3BhY2luZzowLjE2ZW07IHRleHQtdHJhbnNmb3JtOnVwcGVyY2FzZTsgY29sb3I6Izg4ODsgbWFyZ2luLWJvdHRvbToycmVtOyB9Ci5zb2xkLWdyaWQgewogIGRpc3BsYXk6Z3JpZDsKICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KGF1dG8tZmlsbCwgbWlubWF4KDE2MHB4LDFmcikpOwogIGdhcDoxcHg7IGJhY2tncm91bmQ6dmFyKC0taGVhZGVyLWJvcmRlcik7Cn0KLnNvbGQtcGhvdG8geyBhc3BlY3QtcmF0aW86My80OyBvdmVyZmxvdzpoaWRkZW47IH0KLnNvbGQtcGhvdG8gaW1nIHsgd2lkdGg6MTAwJTsgaGVpZ2h0OjEwMCU7IG9iamVjdC1maXQ6Y292ZXI7IGRpc3BsYXk6YmxvY2s7IGZpbHRlcjpncmF5c2NhbGUoMjAlKSBicmlnaHRuZXNzKDAuODUpOyB0cmFuc2l0aW9uOiBmaWx0ZXIgMC4zczsgfQouc29sZC1jYXJkOmhvdmVyIC5zb2xkLXBob3RvIGltZyB7IGZpbHRlcjpncmF5c2NhbGUoMCUpIGJyaWdodG5lc3MoMSk7IH0KLnNvbGQtY2FyZC1ib2R5IHsgcGFkZGluZzowLjg1cmVtIDFyZW07IH0KLnNvbGQtY2FyZCB7CiAgYmFja2dyb3VuZDp2YXIoLS1jaGFyY29hbCk7IHBhZGRpbmc6MDsKICBwb3NpdGlvbjpyZWxhdGl2ZTsgb3ZlcmZsb3c6aGlkZGVuOwogIGJvcmRlci10b3A6IDFweCBzb2xpZCAjM0EzQTNBOwp9Ci5zb2xkLWNhcmQ6OmFmdGVyIHsKICBjb250ZW50OidTT0xEJzsgcG9zaXRpb246YWJzb2x1dGU7IHRvcDoxMnB4OyByaWdodDotMjRweDsKICBiYWNrZ3JvdW5kOnZhcigtLXJlZCk7IGNvbG9yOiNmZmY7CiAgZm9udC1zaXplOjAuNXJlbTsgbGV0dGVyLXNwYWNpbmc6MC4xZW07IGZvbnQtd2VpZ2h0OjcwMDsKICBwYWRkaW5nOjAuMnJlbSAycmVtOyB0cmFuc2Zvcm06cm90YXRlKDQ1ZGVnKTsKfQouc29sZC1icmFuZCB7IGZvbnQtc2l6ZTowLjU4cmVtOyBsZXR0ZXItc3BhY2luZzowLjE2ZW07IHRleHQtdHJhbnNmb3JtOnVwcGVyY2FzZTsgY29sb3I6IzY2NjsgbWFyZ2luLWJvdHRvbTowLjI1cmVtOyB9Ci5zb2xkLW1vZGVsIHsgZm9udC1mYW1pbHk6J1BsYXlmYWlyIERpc3BsYXknLHNlcmlmOyBmb250LXNpemU6MC45cmVtOyBjb2xvcjojQUFBOyBsaW5lLWhlaWdodDoxLjM7IH0KCi8qIOKUgOKUgOKUgCBTRUxMIFlPVVIgV0FUQ0gg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCi5zZWxsLXdyYXAgeyBiYWNrZ3JvdW5kOnZhcigtLWJvZHktc3VyZmFjZSk7IGJvcmRlci10b3A6MXB4IHNvbGlkIHZhcigtLWJvZHktYm9yZGVyKTsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9keS1ib3JkZXIpOyB9Ci5zZWxsLWlubmVyIHsgbWF4LXdpZHRoOjExMDBweDsgbWFyZ2luOjAgYXV0bzsgcGFkZGluZzo0cmVtIDJyZW07IGRpc3BsYXk6Z3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjFmciAxZnI7IGdhcDo0cmVtOyBhbGlnbi1pdGVtczpzdGFydDsgfQpAbWVkaWEobWF4LXdpZHRoOjcwMHB4KXsgLnNlbGwtaW5uZXIgeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyOyBnYXA6MnJlbTsgfSB9Cgouc2VsbC1waXRjaCBoMiB7IGZvbnQtZmFtaWx5OidQbGF5ZmFpciBEaXNwbGF5JyxzZXJpZjsgZm9udC1zaXplOjJyZW07IGZvbnQtd2VpZ2h0OjQwMDsgbWFyZ2luLWJvdHRvbToxcmVtOyB9Ci5zZWxsLXBpdGNoIGgyIGVtIHsgZm9udC1zdHlsZTppdGFsaWM7IGNvbG9yOnZhcigtLWdvbGQpOyB9Ci5zZWxsLXBpdGNoIHAgeyBmb250LXNpemU6MC44cmVtOyBjb2xvcjp2YXIoLS10ZXh0LW1pZCk7IGxpbmUtaGVpZ2h0OjEuODsgbWFyZ2luLWJvdHRvbTowLjg1cmVtOyB9Ci5zZWxsLXN0ZXBzIHsgbGlzdC1zdHlsZTpub25lOyBjb3VudGVyLXJlc2V0OnN0ZXBzOyBtYXJnaW4tdG9wOjEuNXJlbTsgfQouc2VsbC1zdGVwcyBsaSB7CiAgY291bnRlci1pbmNyZW1lbnQ6c3RlcHM7IGZvbnQtc2l6ZTowLjc4cmVtOyBjb2xvcjp2YXIoLS10ZXh0LW1pZCk7CiAgbGluZS1oZWlnaHQ6MS43OyBwYWRkaW5nLWxlZnQ6Mi4yNXJlbTsgcG9zaXRpb246cmVsYXRpdmU7IG1hcmdpbi1ib3R0b206MC42cmVtOwp9Ci5zZWxsLXN0ZXBzIGxpOjpiZWZvcmUgewogIGNvbnRlbnQ6Y291bnRlcihzdGVwcyk7CiAgcG9zaXRpb246YWJzb2x1dGU7IGxlZnQ6MDsgdG9wOjA7CiAgd2lkdGg6MS41cmVtOyBoZWlnaHQ6MS41cmVtOyBiYWNrZ3JvdW5kOnZhcigtLWdvbGQpOwogIGNvbG9yOiNmZmY7IGZvbnQtc2l6ZTowLjdyZW07IGZvbnQtd2VpZ2h0OjcwMDsKICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmNlbnRlcjsKfQoKLmZvcm0tZ3JvdXAgeyBtYXJnaW4tYm90dG9tOjFyZW07IH0KLmZvcm0tbGFiZWwgeyBkaXNwbGF5OmJsb2NrOyBmb250LXNpemU6MC42MnJlbTsgbGV0dGVyLXNwYWNpbmc6MC4xNGVtOyB0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7IGNvbG9yOnZhcigtLXRleHQtbWlkKTsgbWFyZ2luLWJvdHRvbTowLjRyZW07IGZvbnQtd2VpZ2h0OjYwMDsgfQouZm9ybS1pbnB1dCwgLmZvcm0tc2VsZWN0LCAuZm9ybS10ZXh0YXJlYSB7CiAgd2lkdGg6MTAwJTsgYmFja2dyb3VuZDojZmZmOyBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvZHktYm9yZGVyKTsKICBjb2xvcjp2YXIoLS10ZXh0LWRhcmspOyBwYWRkaW5nOjAuN3JlbSAwLjlyZW07CiAgZm9udC1mYW1pbHk6J1JhbGV3YXknLHNhbnMtc2VyaWY7IGZvbnQtc2l6ZTowLjhyZW07IG91dGxpbmU6bm9uZTsKICB0cmFuc2l0aW9uOmJvcmRlci1jb2xvciAwLjE1czsKfQouZm9ybS1pbnB1dDpmb2N1cywgLmZvcm0tc2VsZWN0OmZvY3VzLCAuZm9ybS10ZXh0YXJlYTpmb2N1cyB7IGJvcmRlci1jb2xvcjp2YXIoLS1nb2xkKTsgfQouZm9ybS10ZXh0YXJlYSB7IHJlc2l6ZTp2ZXJ0aWNhbDsgbWluLWhlaWdodDoxMDBweDsgfQouZm9ybS1zZWxlY3Qgb3B0aW9uIHsgYmFja2dyb3VuZDojZmZmOyB9Ci5mb3JtLXJvdyB7IGRpc3BsYXk6Z3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjFmciAxZnI7IGdhcDowLjc1cmVtOyB9Ci5mb3JtLXN1Ym1pdCB7CiAgd2lkdGg6MTAwJTsgYmFja2dyb3VuZDp2YXIoLS1jaGFyY29hbCk7IGNvbG9yOiNmZmY7IGJvcmRlcjpub25lOwogIHBhZGRpbmc6MC45NXJlbTsgZm9udC1mYW1pbHk6J1JhbGV3YXknLHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOjAuNzVyZW07IGZvbnQtd2VpZ2h0OjYwMDsgbGV0dGVyLXNwYWNpbmc6MC4xOGVtOwogIHRleHQtdHJhbnNmb3JtOnVwcGVyY2FzZTsgY3Vyc29yOnBvaW50ZXI7IG1hcmdpbi10b3A6MC41cmVtOwogIHRyYW5zaXRpb246YmFja2dyb3VuZCAwLjE1czsKfQouZm9ybS1zdWJtaXQ6aG92ZXIgeyBiYWNrZ3JvdW5kOiM0NDQ7IH0KCi8qIOKUgOKUgOKUgCBUUlVTVCBTVFJJUCDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAgKi8KLnRydXN0LXN0cmlwIHsgYmFja2dyb3VuZDp2YXIoLS1ib2R5LXN1cmZhY2UyKTsgYm9yZGVyLXRvcDoxcHggc29saWQgdmFyKC0tYm9keS1ib3JkZXIpOyBib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib2R5LWJvcmRlcik7IH0KLnRydXN0LWlubmVyIHsgbWF4LXdpZHRoOjExMDBweDsgbWFyZ2luOjAgYXV0bzsgcGFkZGluZzozcmVtIDJyZW07IGRpc3BsYXk6Z3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdCgzLDFmcik7IGdhcDoycmVtOyB9CkBtZWRpYShtYXgtd2lkdGg6NjQwcHgpeyAudHJ1c3QtaW5uZXIgeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyOyB9IH0KLnRydXN0LWl0ZW0geyB0ZXh0LWFsaWduOmNlbnRlcjsgfQoudHJ1c3QtaWNvbiB7IGZvbnQtc2l6ZToycmVtOyBtYXJnaW4tYm90dG9tOjAuNzVyZW07IH0KLnRydXN0LXRpdGxlIHsgZm9udC1mYW1pbHk6J1BsYXlmYWlyIERpc3BsYXknLHNlcmlmOyBmb250LXNpemU6MS4xcmVtOyBtYXJnaW4tYm90dG9tOjAuNXJlbTsgfQoudHJ1c3QtZGVzYyB7IGZvbnQtc2l6ZTowLjc1cmVtOyBjb2xvcjp2YXIoLS10ZXh0LW1pZCk7IGxpbmUtaGVpZ2h0OjEuNzsgfQoKLyog4pSA4pSA4pSAIENPTlRBQ1Qg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCi5jb250YWN0LXN0cmlwIHsgYmFja2dyb3VuZDp2YXIoLS1jaGFyY29hbCk7IHBhZGRpbmc6My41cmVtIDJyZW07IH0KLmNvbnRhY3QtaW5uZXIgeyBtYXgtd2lkdGg6OTAwcHg7IG1hcmdpbjowIGF1dG87IHRleHQtYWxpZ246Y2VudGVyOyB9Ci5jb250YWN0LXRpdGxlIHsgZm9udC1mYW1pbHk6J1BsYXlmYWlyIERpc3BsYXknLHNlcmlmOyBmb250LXNpemU6MS44cmVtOyBmb250LXdlaWdodDo0MDA7IGNvbG9yOiNmZmY7IG1hcmdpbi1ib3R0b206MC41cmVtOyB9Ci5jb250YWN0LXRpdGxlIGVtIHsgZm9udC1zdHlsZTppdGFsaWM7IGNvbG9yOnZhcigtLWdvbGQyKTsgfQouY29udGFjdC1zdWIgeyBmb250LXNpemU6MC43NXJlbTsgY29sb3I6Izg4ODsgbWFyZ2luLWJvdHRvbToyLjVyZW07IH0KLmNvbnRhY3QtaXRlbXMgeyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpjZW50ZXI7IGdhcDozcmVtOyBmbGV4LXdyYXA6d3JhcDsgfQouY29udGFjdC1pdGVtIHsgdGV4dC1hbGlnbjpjZW50ZXI7IH0KLmNvbnRhY3QtaWNvbiB7IGZvbnQtc2l6ZToxLjVyZW07IG1hcmdpbi1ib3R0b206MC41cmVtOyB9Ci5jb250YWN0LWxhYmVsIHsgZm9udC1zaXplOjAuNThyZW07IGxldHRlci1zcGFjaW5nOjAuMThlbTsgdGV4dC10cmFuc2Zvcm06dXBwZXJjYXNlOyBjb2xvcjojNjY2OyBtYXJnaW4tYm90dG9tOjAuM3JlbTsgfQouY29udGFjdC12YWwgeyBjb2xvcjp2YXIoLS1nb2xkMik7IGZvbnQtc2l6ZTowLjg4cmVtOyB0ZXh0LWRlY29yYXRpb246bm9uZTsgfQouY29udGFjdC12YWw6aG92ZXIgeyBjb2xvcjojZmZmOyB9CgovKiDilIDilIDilIAgRk9PVEVSIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCAqLwpmb290ZXIgeyBiYWNrZ3JvdW5kOiMxQTFBMUE7IHBhZGRpbmc6M3JlbSAycmVtOyB9Ci5mb290ZXItaW5uZXIgeyBtYXgtd2lkdGg6MTIwMHB4OyBtYXJnaW46MCBhdXRvOyBkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczoxLjVmciAxZnIgMWZyOyBnYXA6Mi41cmVtOyB9CkBtZWRpYShtYXgtd2lkdGg6NjQwcHgpeyAuZm9vdGVyLWlubmVyIHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOjFmcjsgfSB9Ci5mb290ZXItbG9nbyB7IGZvbnQtZmFtaWx5OidQbGF5ZmFpciBEaXNwbGF5JyxzZXJpZjsgZm9udC1zaXplOjEuMnJlbTsgbGV0dGVyLXNwYWNpbmc6MC4xNWVtOyB0ZXh0LXRyYW5zZm9ybTp1cHBlcmNhc2U7IGNvbG9yOiNDOUE4NEM7IG1hcmdpbi1ib3R0b206MC43NXJlbTsgfQouZm9vdGVyLWxvZ28gc3BhbiB7IGZvbnQtc3R5bGU6aXRhbGljOyBjb2xvcjojZmZmOyB9Ci5mb290ZXItZGVzYyB7IGZvbnQtc2l6ZTowLjcycmVtOyBjb2xvcjojNjY2OyBsaW5lLWhlaWdodDoxLjc1OyB9Ci5mb290ZXItaGVhZGluZyB7IGZvbnQtc2l6ZTowLjU4cmVtOyBsZXR0ZXItc3BhY2luZzowLjJlbTsgdGV4dC10cmFuc2Zvcm06dXBwZXJjYXNlOyBjb2xvcjojQzlBODRDOyBtYXJnaW4tYm90dG9tOjFyZW07IGZvbnQtd2VpZ2h0OjYwMDsgfQouZm9vdGVyLWxpbmtzIHsgbGlzdC1zdHlsZTpub25lOyB9Ci5mb290ZXItbGlua3MgbGkgeyBtYXJnaW4tYm90dG9tOjAuNXJlbTsgfQouZm9vdGVyLWxpbmtzIGEgeyBmb250LXNpemU6MC43MnJlbTsgY29sb3I6IzY2NjsgdGV4dC1kZWNvcmF0aW9uOm5vbmU7IHRyYW5zaXRpb246Y29sb3IgMC4xNXM7IH0KLmZvb3Rlci1saW5rcyBhOmhvdmVyIHsgY29sb3I6I2ZmZjsgfQouZm9vdGVyLWJvdHRvbSB7IG1heC13aWR0aDoxMjAwcHg7IG1hcmdpbjoycmVtIGF1dG8gMDsgcGFkZGluZy10b3A6MS41cmVtOyBib3JkZXItdG9wOjFweCBzb2xpZCAjMkEyQTJBOyBkaXNwbGF5OmZsZXg7IGp1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuOyBmbGV4LXdyYXA6d3JhcDsgZ2FwOjAuNXJlbTsgfQouZm9vdGVyLWJvdHRvbSBwIHsgZm9udC1zaXplOjAuNjJyZW07IGNvbG9yOiM0NDQ7IH0KCi8qIOKUgOKUgOKUgCBFTVBUWSBTVEFURSDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAgKi8KLmVtcHR5LXN0YXRlIHsgdGV4dC1hbGlnbjpjZW50ZXI7IHBhZGRpbmc6NXJlbSAycmVtOyB9Ci5lbXB0eS1zdGF0ZSBoMyB7IGZvbnQtZmFtaWx5OidQbGF5ZmFpciBEaXNwbGF5JyxzZXJpZjsgZm9udC1zaXplOjEuNnJlbTsgZm9udC13ZWlnaHQ6NDAwOyBjb2xvcjp2YXIoLS10ZXh0LW1pZCk7IG1hcmdpbi1ib3R0b206MC41cmVtOyB9Ci5lbXB0eS1zdGF0ZSBwIHsgZm9udC1zaXplOjAuNzhyZW07IGNvbG9yOnZhcigtLXRleHQtbGlnaHQpOyB9CgovKiDilIDilIDilIAgVE9BU1Qg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCi50b2FzdCB7IHBvc2l0aW9uOmZpeGVkOyBib3R0b206MnJlbTsgcmlnaHQ6MnJlbTsgYmFja2dyb3VuZDp2YXIoLS1jaGFyY29hbCk7IGNvbG9yOiNmZmY7IGJvcmRlci1sZWZ0OjNweCBzb2xpZCB2YXIoLS1nb2xkKTsgcGFkZGluZzowLjg1cmVtIDEuMjVyZW07IGZvbnQtc2l6ZTowLjc1cmVtOyB6LWluZGV4OjkwMDA7IGRpc3BsYXk6bm9uZTsgYW5pbWF0aW9uOmZhZGVJbiAwLjJzIGVhc2U7IG1heC13aWR0aDozMjBweDsgZm9udC1mYW1pbHk6J1JhbGV3YXknLHNhbnMtc2VyaWY7IH0KLnRvYXN0LnNob3cgeyBkaXNwbGF5OmJsb2NrOyB9Cgo6Oi13ZWJraXQtc2Nyb2xsYmFyIHsgd2lkdGg6NHB4OyBoZWlnaHQ6NHB4OyB9Cjo6LXdlYmtpdC1zY3JvbGxiYXItdHJhY2sgeyBiYWNrZ3JvdW5kOiNmMGVkZTg7IH0KOjotd2Via2l0LXNjcm9sbGJhci10aHVtYiB7IGJhY2tncm91bmQ6I2NjYzsgfQoKLyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIE1PQklMRSBSRVNQT05TSVZFIOKAlCBhZGRlZCBmb3IgZnVsbCBtb2JpbGUgc3VwcG9ydArilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAgKi8KQG1lZGlhIChtYXgtd2lkdGg6IDc2OHB4KSB7CiAgLyogSGVhZGVyICovCiAgaGVhZGVyIHsgcGFkZGluZzogMXJlbSAxcmVtIDAuODVyZW07IH0KICAubG9nby10ZXh0IHsgZm9udC1zaXplOiAxLjVyZW07IGxldHRlci1zcGFjaW5nOiAwLjFlbTsgfQogIC5sb2dvLWljb24geyBmb250LXNpemU6IDEuNHJlbTsgbWFyZ2luLWJvdHRvbTogMC4ycmVtOyB9CiAgLmxvZ28tdGFnbGluZSB7IGZvbnQtc2l6ZTogMC41MnJlbTsgbGV0dGVyLXNwYWNpbmc6IDAuMmVtOyB9CiAgaGVhZGVyIG5hdiB7IGdhcDogMS4ycmVtOyBmbGV4LXdyYXA6IHdyYXA7IH0KICBoZWFkZXIgbmF2IGEgeyBmb250LXNpemU6IDAuNjJyZW07IGxldHRlci1zcGFjaW5nOiAwLjEyZW07IH0KCiAgLyogSGVybyAqLwogIC5oZXJvIHsgaGVpZ2h0OiA2MHZoOyBtaW4taGVpZ2h0OiAzODBweDsgfQogIC5oZXJvLWNvbnRlbnQgeyBwYWRkaW5nOiAxcmVtOyB9CiAgLmhlcm8tdGl0bGUgeyBmb250LXNpemU6IGNsYW1wKDEuOHJlbSwgOXZ3LCAzcmVtKTsgfQogIC5oZXJvLXN1YiB7IGZvbnQtc2l6ZTogMC43NXJlbTsgbWFyZ2luLWJvdHRvbTogMS41cmVtOyB9CiAgLmJ0bi1oZXJvLXByaW1hcnksIC5idG4taGVyby1vdXRsaW5lIHsgcGFkZGluZzogMC43NXJlbSAxLjVyZW07IGZvbnQtc2l6ZTogMC42OHJlbTsgfQogIC5oZXJvLWJ0bnMgeyBnYXA6IDAuNzVyZW07IH0KCiAgLyogR29sZCBkaXZpZGVyIHN0YXRzICovCiAgLmdvbGQtZGl2aWRlciB7IGdhcDogMS4yNXJlbTsgcGFkZGluZzogMC44NXJlbSAxcmVtOyB9CiAgLmRpdmlkZXItc3RhdC12YWwgeyBmb250LXNpemU6IDEuMnJlbTsgfQogIC5kaXZpZGVyLXNlcCB7IGRpc3BsYXk6IG5vbmU7IH0KCiAgLyogU2VjdGlvbiBwYWRkaW5nICovCiAgLnNlY3Rpb24geyBwYWRkaW5nOiAyLjVyZW0gMXJlbTsgfQogIC5zZWN0aW9uLXRpdGxlIHsgZm9udC1zaXplOiAxLjZyZW07IH0KCiAgLyogRmlsdGVyIGJhciDigJQgc3RhY2sgdmVydGljYWxseSAqLwogIC5maWx0ZXItc3RyaXAgeyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBhbGlnbi1pdGVtczogc3RyZXRjaDsgZ2FwOiAwLjVyZW07IH0KICAuZmlsdGVyLWlucHV0IHsgd2lkdGg6IDEwMCU7IH0KICAuZmlsdGVyLXNlbGVjdCB7IHdpZHRoOiAxMDAlOyB9CiAgLnJlc3VsdHMtY291bnQgeyBtYXJnaW4tbGVmdDogMDsgdGV4dC1hbGlnbjogY2VudGVyOyB9CgogIC8qIFdhdGNoIGdyaWQg4oCUIDIgY29sdW1ucyBvbiBtb2JpbGUgKi8KICAud2F0Y2gtZ3JpZCB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcik7IGdhcDogMC43NXJlbTsgfQoKICAvKiBMaWdodGJveCAqLwogIC5sYi1pbm5lciB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOyB9CiAgLmxiLWRldGFpbHMgeyBwYWRkaW5nOiAxLjVyZW0gMXJlbTsgfQoKICAvKiBTb2xkIGdyaWQgKi8KICAuc29sZC1ncmlkIHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiByZXBlYXQoMiwgbWlubWF4KDEyMHB4LCAxZnIpKTsgfQogIC5zb2xkLXNlY3Rpb24taW5uZXIgeyBwYWRkaW5nOiAycmVtIDFyZW07IH0KICAuc29sZC1zZWN0aW9uLXRpdGxlIHsgZm9udC1zaXplOiAxLjVyZW07IH0KCiAgLyogQWJvdXQgYmx1cmIgKi8KICAuYWJvdXQtYmx1cmIgeyBwYWRkaW5nOiAyLjVyZW0gMXJlbTsgfQogIC5hYm91dC1ibHVyYiBoMSB7IGZvbnQtc2l6ZTogMS41cmVtOyB9CgogIC8qIFNlbGwgc2VjdGlvbiAqLwogIC5zZWxsLWlubmVyIHsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnI7IGdhcDogMS41cmVtOyBwYWRkaW5nOiAycmVtIDFyZW07IH0KCiAgLyogVHJ1c3Qgc3RyaXAgKi8KICAudHJ1c3QtaW5uZXIgeyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmcjsgZ2FwOiAxLjI1cmVtOyBwYWRkaW5nOiAycmVtIDFyZW07IHRleHQtYWxpZ246IGNlbnRlcjsgfQoKICAvKiBDb250YWN0ICovCiAgLmNvbnRhY3QtaW5uZXIgeyBwYWRkaW5nOiAycmVtIDFyZW07IH0KCiAgLyogRm9vdGVyICovCiAgLmZvb3Rlci1pbm5lciB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOyBnYXA6IDEuNXJlbTsgcGFkZGluZzogMnJlbSAxcmVtOyB9CiAgLmZvb3Rlci1ib3R0b20geyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyB0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDFyZW07IH0KfQoKQG1lZGlhIChtYXgtd2lkdGg6IDQwMHB4KSB7CiAgLyogVmVyeSBzbWFsbCBwaG9uZXMg4oCUIDEgY29sdW1uIHdhdGNoIGdyaWQgKi8KICAud2F0Y2gtZ3JpZCB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOyB9CiAgLnNvbGQtZ3JpZCB7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogcmVwZWF0KDIsIDFmcik7IH0KICAubG9nby10ZXh0IHsgZm9udC1zaXplOiAxLjI1cmVtOyB9Cn0KCgovKiDilIDilIDilIAgQUJPVVQgQkxVUkIg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAICovCi5hYm91dC1ibHVyYiB7CiAgYmFja2dyb3VuZDogdmFyKC0tY2hhcmNvYWwpOwogIGJvcmRlci10b3A6IDFweCBzb2xpZCB2YXIoLS1nb2xkKTsKICBib3JkZXItYm90dG9tOiAxcHggc29saWQgdmFyKC0tZ29sZCk7CiAgcGFkZGluZzogNHJlbSAycmVtOwogIHRleHQtYWxpZ246IGNlbnRlcjsKfQouYWJvdXQtYmx1cmItaW5uZXIgeyBtYXgtd2lkdGg6IDc4MHB4OyBtYXJnaW46IDAgYXV0bzsgfQouYWJvdXQtYmx1cmIgaDEgewogIGZvbnQtZmFtaWx5OiAnUGxheWZhaXIgRGlzcGxheScsIHNlcmlmOwogIGZvbnQtc2l6ZTogMnJlbTsgZm9udC13ZWlnaHQ6IDQwMDsKICBjb2xvcjogI2ZmZjsgbGV0dGVyLXNwYWNpbmc6IDAuMDNlbTsKICBtYXJnaW4tYm90dG9tOiAxLjI1cmVtOyBsaW5lLWhlaWdodDogMS4zOwp9Ci5hYm91dC1ibHVyYiBoMSBlbSB7IGZvbnQtc3R5bGU6IGl0YWxpYzsgY29sb3I6IHZhcigtLWdvbGQyKTsgfQouYWJvdXQtYmx1cmIgcCB7CiAgZm9udC1mYW1pbHk6ICdSYWxld2F5Jywgc2Fucy1zZXJpZjsKICBmb250LXNpemU6IDAuOXJlbTsgbGluZS1oZWlnaHQ6IDEuODU7CiAgY29sb3I6ICNBQUE7IGxldHRlci1zcGFjaW5nOiAwLjAyZW07Cn0KLmFib3V0LWJsdXJiLWxpbmUgewogIHdpZHRoOiA1MHB4OyBoZWlnaHQ6IDJweDsgYmFja2dyb3VuZDogdmFyKC0tZ29sZCk7CiAgbWFyZ2luOiAxLjI1cmVtIGF1dG8gMS41cmVtOwp9Cgo8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgoKPCEtLSBMT0FERVIgLS0+CjxkaXYgaWQ9InBhZ2UtbG9hZGVyIj4KICA8ZGl2IGNsYXNzPSJsb2FkZXItbG9nbyIgaWQ9ImxvYWRlci1iaXotbmFtZSI+TG9hZGluZy4uLjwvZGl2PgogIDxkaXYgY2xhc3M9ImxvYWRlci1iYXIiPjwvZGl2Pgo8L2Rpdj4KCjwhLS0gVE9QIEJBUiAtLT4KPGRpdiBjbGFzcz0idG9wLWJhciI+CiAgPGEgaWQ9InRiLXBob25lIiBocmVmPSIjIj48L2E+CiAgPHNwYW4gY2xhc3M9InRvcC1iYXItZGl2aWRlciI+fDwvc3Bhbj4KICA8YSBpZD0idGItZW1haWwiIGhyZWY9IiMiPjwvYT4KICA8c3BhbiBjbGFzcz0idG9wLWJhci1kaXZpZGVyIj58PC9zcGFuPgogIDxhIGlkPSJ0Yi1pbnN0YWdyYW0iIGhyZWY9IiMiIHRhcmdldD0iX2JsYW5rIj48L2E+CiAgPHNwYW4gY2xhc3M9InRvcC1iYXItZGl2aWRlciI+fDwvc3Bhbj4KICA8YSBocmVmPSIjIiBzdHlsZT0iY29sb3I6Izg4OCIgaWQ9Imhlcm8tbG9jYXRpb24iPjwvYT4KPC9kaXY+Cgo8IS0tIEhFQURFUiAtLT4KPGhlYWRlcj4KICA8ZGl2IGNsYXNzPSJsb2dvLWFyZWEiPgogICAgPCEtLSBMT0dPIElNQUdFIOKAlCB1bmNvbW1lbnQgYW5kIHVwZGF0ZSBzcmMgd2hlbiB5b3UgaGF2ZSB5b3VyIGxvZ28gZmlsZToKICAgIDxpbWcgY2xhc3M9ImxvZ28taW1nIiBpZD0iaGVhZGVyLWxvZ28taW1nIiBzcmM9IiIgYWx0PSIiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPgogICAgLS0+CiAgICA8IS0tIFRFWFQgTE9HTyDigJQgcmVtb3ZlIHRoaXMgYmxvY2sgd2hlbiB5b3UgYWRkIHlvdXIgaW1hZ2UgbG9nbyBhYm92ZSAtLT4KICAgIDxkaXYgY2xhc3M9ImxvZ28taWNvbiI+4peJPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJsb2dvLXRleHQiIGlkPSJoZHItYml6LW5hbWUtZGlzcGxheSI+TXkgV2F0Y2ggU3RvcmU8L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImxvZ28tdGFnbGluZSIgaWQ9Imhkci10YWdsaW5lIj5QcmUtT3duZWQgTHV4dXJ5IFRpbWVwaWVjZXM8L2Rpdj4KICA8L2Rpdj4KICA8bmF2PgogICAgPGEgaHJlZj0iI2F2YWlsYWJsZSI+QXZhaWxhYmxlIFdhdGNoZXM8L2E+CiAgICA8YSBocmVmPSIjc2VsbCI+U2VsbCBZb3VyIFdhdGNoPC9hPgogICAgPGEgaHJlZj0iI2NvbnRhY3QiPkNvbnRhY3Q8L2E+CiAgPC9uYXY+CjwvaGVhZGVyPgoKPCEtLSBIRVJPIC0tPgo8c2VjdGlvbiBjbGFzcz0iaGVybyI+CiAgPGRpdiBjbGFzcz0iaGVyby1iZyI+PC9kaXY+CiAgPGRpdiBjbGFzcz0iaGVyby1jb250ZW50Ij4KICAgIDxkaXYgY2xhc3M9Imhlcm8tZXllYnJvdyI+V2VsY29tZTwvZGl2PgogICAgPGgxIGNsYXNzPSJoZXJvLXRpdGxlIj5MdXh1cnkgV2F0Y2hlczxicj48ZW0+RG9uZSBSaWdodDwvZW0+PC9oMT4KICAgIDxwIGNsYXNzPSJoZXJvLXN1YiI+UGVyc29uYWxseSBzb3VyY2VkIMK3IEF1dGhlbnRpY2F0ZWQgwrcgRmFpcmx5IHByaWNlZDwvcD4KICAgIDxkaXYgY2xhc3M9Imhlcm8tYnRucyI+CiAgICAgIDxhIGhyZWY9IiNhdmFpbGFibGUiIGNsYXNzPSJidG4taGVyby1wcmltYXJ5Ij5TaG9wIEFsbCBXYXRjaGVzPC9hPgogICAgICA8YSBocmVmPSIjc2VsbCIgY2xhc3M9ImJ0bi1oZXJvLW91dGxpbmUiPlNlbGwgWW91ciBXYXRjaDwvYT4KICAgIDwvZGl2PgogIDwvZGl2Pgo8L3NlY3Rpb24+Cgo8IS0tIFNUQVRTIERJVklERVIgLS0+CjxkaXYgY2xhc3M9ImdvbGQtZGl2aWRlciI+CiAgPGRpdiBjbGFzcz0iZGl2aWRlci1zdGF0Ij4KICAgIDxkaXYgY2xhc3M9ImRpdmlkZXItc3RhdC12YWwiIGlkPSJzdGF0LWF2YWlsYWJsZSI+4oCUPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXN0YXQtbGFiZWwiPkF2YWlsYWJsZSBOb3c8L2Rpdj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXNlcCI+wrc8L2Rpdj4KICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXN0YXQiPgogICAgPGRpdiBjbGFzcz0iZGl2aWRlci1zdGF0LXZhbCIgaWQ9InN0YXQtc29sZCI+4oCUPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXN0YXQtbGFiZWwiPldhdGNoZXMgU29sZDwvZGl2PgogIDwvZGl2PgogIDxkaXYgY2xhc3M9ImRpdmlkZXItc2VwIj7CtzwvZGl2PgogIDxkaXYgY2xhc3M9ImRpdmlkZXItc3RhdCI+CiAgICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXN0YXQtdmFsIj4xMDAlPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXN0YXQtbGFiZWwiPkF1dGhlbnRpY2F0ZWQ8L2Rpdj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXNlcCI+wrc8L2Rpdj4KICA8ZGl2IGNsYXNzPSJkaXZpZGVyLXN0YXQiPgogICAgPGRpdiBjbGFzcz0iZGl2aWRlci1zdGF0LXZhbCI+MjRocjwvZGl2PgogICAgPGRpdiBjbGFzcz0iZGl2aWRlci1zdGF0LWxhYmVsIj5SZXNwb25zZSBUaW1lPC9kaXY+CiAgPC9kaXY+CjwvZGl2PgoKCjwhLS0gQUJPVVQgQkxVUkIgLS0+CjxkaXYgY2xhc3M9ImFib3V0LWJsdXJiIj4KICA8ZGl2IGNsYXNzPSJhYm91dC1ibHVyYi1pbm5lciI+CiAgICA8aDE+THV4dXJ5IFdhdGNoZXMgZm9yIHRoZSBXb3JsZCwgPGVtPmZyb20gQXJrYW5zYXM8L2VtPjwvaDE+CiAgICA8ZGl2IGNsYXNzPSJhYm91dC1ibHVyYi1saW5lIj48L2Rpdj4KICAgIDxwPkluIGJ1c2luZXNzIHNpbmNlIDIwMTcsIHdlIGJ1eSwgc2VsbCwgdHJhZGUsIHNvdXJjZSwgYW5kIGJyb2tlciBsdXh1cnkgdGltZXBpZWNlcy4gV2l0aCBhY2Nlc3MgdG8gbWFzc2l2ZSBzdG9ja3Mgb2YgaW52ZW50b3J5IHdvcmxkd2lkZSwgd2UgY2FuIGZpbmQgdmlydHVhbGx5IGFueXRoaW5nIHlvdSdyZSBsb29raW5nIGZvciDigJQgYXQgYSBmYWlyIHByaWNlLCBmcm9tIHNvbWVvbmUgeW91IGNhbiB0cnVzdC4gRmlsbCBvdXQgb3VyIGZvcm0gYW5kIHdlJ2xsIGJlIGluIHRvdWNoIGluIGEgZmxhc2guPC9wPgogIDwvZGl2Pgo8L2Rpdj4KCjwhLS0gQ1VSUkVOVExZIEFWQUlMQUJMRSAtLT4KPHNlY3Rpb24gY2xhc3M9InNlY3Rpb24iIGlkPSJhdmFpbGFibGUiPgogIDxkaXYgY2xhc3M9InNlY3Rpb24taGVhZGVyIj4KICAgIDxkaXYgY2xhc3M9InNlY3Rpb24tZXllYnJvdyI+SW4gU3RvY2s8L2Rpdj4KICAgIDxoMiBjbGFzcz0ic2VjdGlvbi10aXRsZSI+Q3VycmVudGx5IDxlbT5BdmFpbGFibGU8L2VtPjwvaDI+CiAgICA8ZGl2IGNsYXNzPSJzZWN0aW9uLWxpbmUiPjwvZGl2PgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJmaWx0ZXItc3RyaXAiPgogICAgPGlucHV0IGNsYXNzPSJmaWx0ZXItaW5wdXQiIHR5cGU9InRleHQiIGlkPSJzZWFyY2gtaW5wdXQiIHBsYWNlaG9sZGVyPSJTZWFyY2ggYnJhbmQsIG1vZGVsLCByZWZlcmVuY2UuLi4iIG9uaW5wdXQ9ImZpbHRlcldhdGNoZXMoKSI+CiAgICA8c2VsZWN0IGNsYXNzPSJmaWx0ZXItc2VsZWN0IiBpZD0iYnJhbmQtZmlsdGVyIiBvbmNoYW5nZT0iZmlsdGVyV2F0Y2hlcygpIj4KICAgICAgPG9wdGlvbiB2YWx1ZT0iIj5BbGwgQnJhbmRzPC9vcHRpb24+CiAgICA8L3NlbGVjdD4KICAgIDxzZWxlY3QgY2xhc3M9ImZpbHRlci1zZWxlY3QiIGlkPSJzb3J0LXNlbGVjdCIgb25jaGFuZ2U9ImZpbHRlcldhdGNoZXMoKSI+CiAgICAgIDxvcHRpb24gdmFsdWU9Im5ld2VzdCI+TmV3ZXN0IEZpcnN0PC9vcHRpb24+CiAgICAgIDxvcHRpb24gdmFsdWU9InByaWNlLWFzYyI+UHJpY2U6IExvdyB0byBIaWdoPC9vcHRpb24+CiAgICAgIDxvcHRpb24gdmFsdWU9InByaWNlLWRlc2MiPlByaWNlOiBIaWdoIHRvIExvdzwvb3B0aW9uPgogICAgPC9zZWxlY3Q+CiAgICA8ZGl2IGNsYXNzPSJyZXN1bHRzLWNvdW50IiBpZD0icmVzdWx0cy1jb3VudCI+PC9kaXY+CiAgPC9kaXY+CgogIDxkaXYgY2xhc3M9IndhdGNoLWdyaWQiIGlkPSJ3YXRjaC1ncmlkIj48L2Rpdj4KICA8ZGl2IGNsYXNzPSJlbXB0eS1zdGF0ZSIgaWQ9Im5vLXJlc3VsdHMiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPgogICAgPGgzPk5vIHdhdGNoZXMgZm91bmQ8L2gzPgogICAgPHA+VHJ5IGNsZWFyaW5nIHlvdXIgZmlsdGVycyDigJQgbmV3IHdhdGNoZXMgYWRkZWQgcmVndWxhcmx5LjwvcD4KICA8L2Rpdj4KPC9zZWN0aW9uPgoKPCEtLSBUUlVTVCBTVFJJUCAtLT4KPGRpdiBjbGFzcz0idHJ1c3Qtc3RyaXAiPgogIDxkaXYgY2xhc3M9InRydXN0LWlubmVyIj4KICAgIDxkaXYgY2xhc3M9InRydXN0LWl0ZW0iPgogICAgICA8ZGl2IGNsYXNzPSJ0cnVzdC1pY29uIj7inKY8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idHJ1c3QtdGl0bGUiPlBlcnNvbmFsbHkgQXV0aGVudGljYXRlZDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJ0cnVzdC1kZXNjIj5FdmVyeSB3YXRjaCBpbnNwZWN0ZWQgZm9yIGF1dGhlbnRpY2l0eSBhbmQgY29uZGl0aW9uIGJlZm9yZSBsaXN0aW5nLiBXaGF0IHlvdSBzZWUgaXMgd2hhdCB5b3UgZ2V0LjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0cnVzdC1pdGVtIj4KICAgICAgPGRpdiBjbGFzcz0idHJ1c3QtaWNvbiI+4peIPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InRydXN0LXRpdGxlIj5JbnN1cmVkIFNoaXBwaW5nPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InRydXN0LWRlc2MiPkZ1bGx5IGluc3VyZWQgb24gZXZlcnkgb3JkZXIuIFNlY3VyZSBwYWNrYWdpbmcsIHRyYWNraW5nIHByb3ZpZGVkLCBzaGlwcyB3aXRoaW4gMjQgaG91cnMgb2YgcGF5bWVudC48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0idHJ1c3QtaXRlbSI+CiAgICAgIDxkaXYgY2xhc3M9InRydXN0LWljb24iPvCfpJ08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idHJ1c3QtdGl0bGUiPkZhaXIgTWFya2V0IFByaWNpbmc8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0idHJ1c3QtZGVzYyI+Tm8gcmV0YWlsIG1hcmt1cHMuIFByaWNlZCBiYXNlZCBvbiBjdXJyZW50IG1hcmtldCBjb21wcy4gVHJhZGVzIGFuZCBjYXNoIGNvbnNpZGVyZWQuPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9kaXY+Cgo8IS0tIFJFQ0VOVExZIFNPTEQgLS0+CjxkaXYgY2xhc3M9InNvbGQtc2VjdGlvbi13cmFwIiBpZD0ic29sZC13cmFwIj4KICA8ZGl2IGNsYXNzPSJzb2xkLXNlY3Rpb24taW5uZXIiPgogICAgPGRpdiBjbGFzcz0ic29sZC1zZWN0aW9uLXRpdGxlIj5SZWNlbnRseSA8ZW0+R29uZTwvZW0+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJzb2xkLXN1YiI+VGhlc2UgbW92ZWQgZmFzdCDigJQgbmV3IGludmVudG9yeSBhZGRlZCByZWd1bGFybHk8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InNvbGQtZ3JpZCIgaWQ9InNvbGQtZ3JpZCI+PC9kaXY+CiAgPC9kaXY+CjwvZGl2PgoKPCEtLSBTRUxMIFlPVVIgV0FUQ0ggLS0+CjxkaXYgY2xhc3M9InNlbGwtd3JhcCIgaWQ9InNlbGwiPgogIDxkaXYgY2xhc3M9InNlbGwtaW5uZXIiPgogICAgPGRpdiBjbGFzcz0ic2VsbC1waXRjaCI+CiAgICAgIDxoMj5TZWxsIFlvdXIgPGVtPldhdGNoPC9lbT48L2gyPgogICAgICA8cD5Mb29raW5nIHRvIHNlbGwgYSBsdXh1cnkgdGltZXBpZWNlPyBJIG9mZmVyIGZhaXIsIGNvbXBldGl0aXZlIG9mZmVycyBiYXNlZCBvbiBjdXJyZW50IG1hcmtldCBjb25kaXRpb25zIOKAlCBmYXN0IHBheW1lbnQsIG5vIGhhc3NsZS48L3A+CiAgICAgIDxwPlJvbGV4LCBPbWVnYSwgVHVkb3IsIENhcnRpZXIsIEFQLCBQYXRlayBhbmQgbW9yZS4gQm94IGFuZCBwYXBlcnMgYWx3YXlzIGEgcGx1cyBidXQgbm90IHJlcXVpcmVkLjwvcD4KICAgICAgPG9sIGNsYXNzPSJzZWxsLXN0ZXBzIj4KICAgICAgICA8bGk+RmlsbCBvdXQgdGhlIGZvcm0gd2l0aCB5b3VyIHdhdGNoIGRldGFpbHM8L2xpPgogICAgICAgIDxsaT5JJ2xsIHJlc3BvbmQgd2l0aGluIDI0IGhvdXJzIHdpdGggYW4gb2ZmZXI8L2xpPgogICAgICAgIDxsaT5BY2NlcHQgYW5kIHNoaXAgd2l0aCBhIHByZXBhaWQgaW5zdXJlZCBsYWJlbDwvbGk+CiAgICAgICAgPGxpPkdldCBwYWlkIHByb21wdGx5IHVwb24gcmVjZWlwdCBhbmQgdmVyaWZpY2F0aW9uPC9saT4KICAgICAgPC9vbD4KICAgIDwvZGl2PgogICAgPGRpdj4KICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+CiAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5Zb3VyIE5hbWUgKjwvbGFiZWw+CiAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWlucHV0IiBpZD0ic2VsbC1uYW1lIiBwbGFjZWhvbGRlcj0iRnVsbCBuYW1lIj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImZvcm0tcm93Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+UGhvbmU8L2xhYmVsPgogICAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWlucHV0IiBpZD0ic2VsbC1waG9uZSIgdHlwZT0idGVsIiBwbGFjZWhvbGRlcj0iKDU1NSkgMDAwLTAwMDAiPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPgogICAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5FbWFpbCAqPC9sYWJlbD4KICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1pbnB1dCIgaWQ9InNlbGwtZW1haWwiIHR5cGU9ImVtYWlsIiBwbGFjZWhvbGRlcj0ieW91QGVtYWlsLmNvbSI+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4KICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPldhdGNoIEJyYW5kICo8L2xhYmVsPgogICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1pbnB1dCIgaWQ9InNlbGwtYnJhbmQiIHBsYWNlaG9sZGVyPSJlLmcuIFJvbGV4LCBPbWVnYSwgVHVkb3IuLi4iPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+CiAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5Nb2RlbCAvIFJlZmVyZW5jZTwvbGFiZWw+CiAgICAgICAgPGlucHV0IGNsYXNzPSJmb3JtLWlucHV0IiBpZD0ic2VsbC1tb2RlbCIgcGxhY2Vob2xkZXI9ImUuZy4gU3VibWFyaW5lciAxMjY2MTBMTiI+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4KICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPkJveCAmIFBhcGVycz88L2xhYmVsPgogICAgICAgIDxzZWxlY3QgY2xhc3M9ImZvcm0tc2VsZWN0IiBpZD0ic2VsbC1wYXBlcnMiPgogICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj7igJQgU2VsZWN0IOKAlDwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbj5GdWxsIFNldCAoQm94ICsgUGFwZXJzKTwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbj5Cb3ggT25seTwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbj5QYXBlcnMgT25seTwvb3B0aW9uPgogICAgICAgICAgPG9wdGlvbj5ObyBCb3gsIE5vIFBhcGVyczwvb3B0aW9uPgogICAgICAgIDwvc2VsZWN0PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+CiAgICAgICAgPGxhYmVsIGNsYXNzPSJmb3JtLWxhYmVsIj5Db25kaXRpb24gJiBOb3RlczwvbGFiZWw+CiAgICAgICAgPHRleHRhcmVhIGNsYXNzPSJmb3JtLXRleHRhcmVhIiBpZD0ic2VsbC1ub3RlcyIgcGxhY2Vob2xkZXI9IkRlc2NyaWJlIGNvbmRpdGlvbiwgYW55IHNjcmF0Y2hlcywgc2VydmljZSBoaXN0b3J5LCBhc2tpbmcgcHJpY2UuLi4iPjwvdGV4dGFyZWE+CiAgICAgIDwvZGl2PgogICAgICA8YnV0dG9uIGNsYXNzPSJmb3JtLXN1Ym1pdCIgb25jbGljaz0ic3VibWl0U2VsbElucXVpcnkoKSI+U3VibWl0IGZvciBPZmZlcjwvYnV0dG9uPgogICAgICA8ZGl2IGlkPSJzZWxsLW1zZyIgc3R5bGU9ImZvbnQtc2l6ZTowLjcycmVtO21hcmdpbi10b3A6MC43NXJlbTt0ZXh0LWFsaWduOmNlbnRlcjtmb250LWZhbWlseTonUmFsZXdheScsc2Fucy1zZXJpZiI+PC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9kaXY+Cgo8IS0tIENPTlRBQ1QgLS0+CjxkaXYgY2xhc3M9ImNvbnRhY3Qtc3RyaXAiIGlkPSJjb250YWN0Ij4KICA8ZGl2IGNsYXNzPSJjb250YWN0LWlubmVyIj4KICAgIDxkaXYgY2xhc3M9ImNvbnRhY3QtdGl0bGUiPkdldCBJbiA8ZW0+VG91Y2g8L2VtPjwvZGl2PgogICAgPGRpdiBjbGFzcz0iY29udGFjdC1zdWIiPkF2YWlsYWJsZSBieSBwaG9uZSwgdGV4dCwgZW1haWwsIG9yIEluc3RhZ3JhbS4gUXVpY2sgcmVzcG9uc2VzIGd1YXJhbnRlZWQuPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJjb250YWN0LWl0ZW1zIj4KICAgICAgPGRpdiBjbGFzcz0iY29udGFjdC1pdGVtIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWN0LWljb24iPvCfk548L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWN0LWxhYmVsIj5QaG9uZSAvIFRleHQ8L2Rpdj4KICAgICAgICA8YSBjbGFzcz0iY29udGFjdC12YWwiIGlkPSJjLXBob25lIiBocmVmPSIjIj48L2E+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJjb250YWN0LWl0ZW0iPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbnRhY3QtaWNvbiI+4pyJ77iPPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFjdC1sYWJlbCI+RW1haWw8L2Rpdj4KICAgICAgICA8YSBjbGFzcz0iY29udGFjdC12YWwiIGlkPSJjLWVtYWlsIiBocmVmPSIjIj48L2E+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJjb250YWN0LWl0ZW0iPgogICAgICAgIDxkaXYgY2xhc3M9ImNvbnRhY3QtaWNvbiI+8J+TuDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbnRhY3QtbGFiZWwiPkluc3RhZ3JhbTwvZGl2PgogICAgICAgIDxhIGNsYXNzPSJjb250YWN0LXZhbCIgaWQ9ImMtaW5zdGFncmFtIiBocmVmPSIjIiB0YXJnZXQ9Il9ibGFuayI+PC9hPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iY29udGFjdC1pdGVtIj4KICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWN0LWljb24iPuKXiTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNvbnRhY3QtbGFiZWwiPkxvY2F0aW9uPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFjdC12YWwiIGlkPSJjLWxvY2F0aW9uIj48L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9kaXY+Cgo8IS0tIEZPT1RFUiAtLT4KPGZvb3Rlcj4KICA8ZGl2IGNsYXNzPSJmb290ZXItaW5uZXIiPgogICAgPGRpdj4KICAgICAgPGRpdiBjbGFzcz0iZm9vdGVyLWxvZ28iIGlkPSJmb290ZXItYml6LW5hbWUiPk15IFdhdGNoIFN0b3JlPC9kaXY+CiAgICAgIDxwIGNsYXNzPSJmb290ZXItZGVzYyIgaWQ9ImZvb3Rlci1kZXNjIj5QcmUtb3duZWQgbHV4dXJ5IHdhdGNoZXMgcGVyc29uYWxseSBzb3VyY2VkLCBhdXRoZW50aWNhdGVkLCBhbmQgZmFpcmx5IHByaWNlZC48L3A+CiAgICA8L2Rpdj4KICAgIDxkaXY+CiAgICAgIDxkaXYgY2xhc3M9ImZvb3Rlci1oZWFkaW5nIj5OYXZpZ2F0aW9uPC9kaXY+CiAgICAgIDx1bCBjbGFzcz0iZm9vdGVyLWxpbmtzIj4KICAgICAgICA8bGk+PGEgaHJlZj0iI2F2YWlsYWJsZSI+QXZhaWxhYmxlIFdhdGNoZXM8L2E+PC9saT4KICAgICAgICA8bGk+PGEgaHJlZj0iI3NlbGwiPlNlbGwgWW91ciBXYXRjaDwvYT48L2xpPgogICAgICAgIDxsaT48YSBocmVmPSIjY29udGFjdCI+Q29udGFjdDwvYT48L2xpPgogICAgICA8L3VsPgogICAgPC9kaXY+CiAgICA8ZGl2PgogICAgICA8ZGl2IGNsYXNzPSJmb290ZXItaGVhZGluZyI+Q29udGFjdDwvZGl2PgogICAgICA8dWwgY2xhc3M9ImZvb3Rlci1saW5rcyI+CiAgICAgICAgPGxpPjxhIGlkPSJmLXBob25lIiBocmVmPSIjIj7igJQ8L2E+PC9saT4KICAgICAgICA8bGk+PGEgaWQ9ImYtZW1haWwiIGhyZWY9IiMiPuKAlDwvYT48L2xpPgogICAgICAgIDxsaT48YSBpZD0iZi1pZyIgaHJlZj0iIyIgdGFyZ2V0PSJfYmxhbmsiPuKAlDwvYT48L2xpPgogICAgICA8L3VsPgogICAgPC9kaXY+CiAgPC9kaXY+CiAgPGRpdiBjbGFzcz0iZm9vdGVyLWJvdHRvbSI+CiAgICA8cCBpZD0iZm9vdGVyLWNvcHkiPsKpIDIwMjUgTXkgV2F0Y2ggU3RvcmUuIEFsbCByaWdodHMgcmVzZXJ2ZWQuPC9wPgogICAgPHA+QWxsIHdhdGNoZXMgZ3VhcmFudGVlZCBhdXRoZW50aWMuIFByaW9yIHNhbGUgcG9zc2libGUuPC9wPgogIDwvZGl2Pgo8L2Zvb3Rlcj4KCjwhLS0gTElHSFRCT1ggLS0+CjxkaXYgY2xhc3M9ImxpZ2h0Ym94IiBpZD0ibGlnaHRib3giIG9uY2xpY2s9ImNsb3NlTGJPdmVybGF5KGV2ZW50KSI+CiAgPGRpdiBjbGFzcz0ibGItaW5uZXIiPgogICAgPGRpdiBjbGFzcz0ibGItcGhvdG8tcGFuZWwiPgogICAgICA8YnV0dG9uIGNsYXNzPSJsYi1jbG9zZSIgb25jbGljaz0iY2xvc2VMYigpIj7inJU8L2J1dHRvbj4KICAgICAgPGRpdiBpZD0ibGItbWFpbiI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImxiLXRodW1icy1yb3ciIGlkPSJsYi10aHVtYnMiPjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJsYi1pbmZvIiBpZD0ibGItaW5mbyI+PC9kaXY+CiAgPC9kaXY+CjwvZGl2PgoKPGRpdiBjbGFzcz0idG9hc3QiIGlkPSJ0b2FzdCI+PC9kaXY+Cgo8c2NyaXB0PgovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKLy8gIElOSVQKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCmNvbnN0IHsgY3JlYXRlQ2xpZW50IH0gPSBzdXBhYmFzZTsKY29uc3QgZGIgPSBjcmVhdGVDbGllbnQoU1VQQUJBU0VfVVJMLCBTVVBBQkFTRV9BTk9OKTsKCi8vIOKUgOKUgCBUSEVNRSBFTkdJTkUg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACmZ1bmN0aW9uIGFwcGx5VGhlbWUodCkgewogIGNvbnN0IHIgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGU7CiAgaWYgKHQuYm9keUJnKSAgICAgeyByLnNldFByb3BlcnR5KCctLWJvZHktYmcnLCB0LmJvZHlCZyk7IHIuc2V0UHJvcGVydHkoJy0tYm9keS1zdXJmYWNlMicsIHNoYWRlQ29sb3IodC5ib2R5QmcsIC01KSk7IHIuc2V0UHJvcGVydHkoJy0tYm9keS1zdXJmYWNlJywgc2hhZGVDb2xvcih0LmJvZHlCZywgNSkpOyB9CiAgaWYgKHQuaGVhZGVyQmcpICAgeyByLnNldFByb3BlcnR5KCctLWhlYWRlci1iZycsIHQuaGVhZGVyQmcpOyByLnNldFByb3BlcnR5KCctLWNoYXJjb2FsJywgdC5oZWFkZXJCZyk7IHIuc2V0UHJvcGVydHkoJy0taGVhZGVyLWJvcmRlcicsIHNoYWRlQ29sb3IodC5oZWFkZXJCZywgMTUpKTsgfQogIGlmICh0LmdvbGQpICAgICAgIHsgci5zZXRQcm9wZXJ0eSgnLS1nb2xkJywgdC5nb2xkKTsgci5zZXRQcm9wZXJ0eSgnLS1nb2xkLWxpZ2h0JywgaGV4VG9SZ2JhKHQuZ29sZCwgMC4xMikpOyB9CiAgaWYgKHQuZ29sZDIpICAgICAgeyByLnNldFByb3BlcnR5KCctLWdvbGQyJywgdC5nb2xkMik7IH0KICBpZiAodC5ib2R5Qm9yZGVyKSB7IHIuc2V0UHJvcGVydHkoJy0tYm9keS1ib3JkZXInLCB0LmJvZHlCb3JkZXIpOyB9CiAgaWYgKHQuaGVyb0JnKSB7CiAgICBjb25zdCBoZXJvRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuaGVyby1iZycpOwogICAgaWYgKGhlcm9FbCkgaGVyb0VsLnN0eWxlLmJhY2tncm91bmQgPSBgbGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgcmdiYSgwLDAsMCwwLjQ1KSAwJSwgcmdiYSgwLDAsMCwwLjIpIDUwJSwgcmdiYSgwLDAsMCwwLjYpIDEwMCUpLCB1cmwoJyR7dC5oZXJvQmd9JykgY2VudGVyL2NvdmVyIG5vLXJlcGVhdGA7CiAgfQogIGlmICh0LmZvbnRVcmwgJiYgdC5mb250RGlzcGxheSAmJiB0LmZvbnRCb2R5KSB7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9udC1saW5rJykuaHJlZiA9IHQuZm9udFVybDsKICAgIHIuc2V0UHJvcGVydHkoJy0tZm9udC1kaXNwbGF5JywgYCcke3QuZm9udERpc3BsYXl9Jywgc2VyaWZgKTsKICAgIHIuc2V0UHJvcGVydHkoJy0tZm9udC1ib2R5JywgYCcke3QuZm9udEJvZHl9Jywgc2Fucy1zZXJpZmApOwogICAgZG9jdW1lbnQuYm9keS5zdHlsZS5mb250RmFtaWx5ID0gYCcke3QuZm9udEJvZHl9Jywgc2Fucy1zZXJpZmA7CiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcubG9nby10ZXh0LCAuc2VjdGlvbi10aXRsZSwgLmhlcm8tdGl0bGUsIC53YXRjaC1tb2RlbCwgLmxiLW1vZGVsLCAuc29sZC1zZWN0aW9uLXRpdGxlJykuZm9yRWFjaChlbCA9PiB7CiAgICAgIGVsLnN0eWxlLmZvbnRGYW1pbHkgPSBgJyR7dC5mb250RGlzcGxheX0nLCBzZXJpZmA7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHNoYWRlQ29sb3IoaGV4LCBwY3QpIHsKICB0cnkgewogICAgY29uc3QgbnVtID0gcGFyc2VJbnQoaGV4LnJlcGxhY2UoJyMnLCcnKSwgMTYpOwogICAgY29uc3QgciA9IE1hdGgubWluKDI1NSwgTWF0aC5tYXgoMCwgKG51bSA+PiAxNikgKyBwY3QqMikpOwogICAgY29uc3QgZyA9IE1hdGgubWluKDI1NSwgTWF0aC5tYXgoMCwgKChudW0gPj4gOCkgJiAweGZmKSArIHBjdCoyKSk7CiAgICBjb25zdCBiID0gTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCAobnVtICYgMHhmZikgKyBwY3QqMikpOwogICAgcmV0dXJuICcjJyArIFtyLGcsYl0ubWFwKHYgPT4gdi50b1N0cmluZygxNikucGFkU3RhcnQoMiwnMCcpKS5qb2luKCcnKTsKICB9IGNhdGNoKGUpIHsgcmV0dXJuIGhleDsgfQp9CgpmdW5jdGlvbiBoZXhUb1JnYmEoaGV4LCBhbHBoYSkgewogIHRyeSB7CiAgICBjb25zdCBudW0gPSBwYXJzZUludChoZXgucmVwbGFjZSgnIycsJycpLCAxNik7CiAgICByZXR1cm4gYHJnYmEoJHtudW0+PjE2fSwkeyhudW0+PjgpJjB4ZmZ9LCR7bnVtJjB4ZmZ9LCR7YWxwaGF9KWA7CiAgfSBjYXRjaChlKSB7IHJldHVybiAncmdiYSgxODQsMTQ4LDU4LDAuMTIpJzsgfQp9CgovLyDilIDilIAgUFJPRklMRSBFTkdJTkUg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSACmFzeW5jIGZ1bmN0aW9uIGxvYWRBbmRBcHBseVByb2ZpbGUoKSB7CiAgLy8gMS4gQXBwbHkgY2FjaGVkIHByb2ZpbGUgaW5zdGFudGx5IChubyBmbGFzaCkKICBhcHBseVByb2ZpbGVEYXRhKFBST0ZJTEVfQ0FDSEUpOwogIC8vIDIuIFRoZW4gZmV0Y2ggbGl2ZSBmcm9tIFN1cGFiYXNlIChwaWNrcyB1cCBhbnkgdXBkYXRlcykKICB0cnkgewogICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBkYi5mcm9tKCd1c2VyX3Byb2ZpbGVzJykuc2VsZWN0KCcqJykuZXEoJ3VzZXJfaWQnLCAoYXdhaXQgZGIuYXV0aC5nZXRVc2VyKCkpLmRhdGE/LnVzZXI/LmlkKS5zaW5nbGUoKTsKICAgIGlmIChkYXRhKSB7CiAgICAgIHdpbmRvdy5fcHJvZmlsZSA9IHsKICAgICAgICBiaXpOYW1lOiAgIGRhdGEuYml6X25hbWUgICB8fCBQUk9GSUxFX0NBQ0hFLmJpek5hbWUsCiAgICAgICAgcGhvbmU6ICAgICBkYXRhLnBob25lICAgICAgfHwgUFJPRklMRV9DQUNIRS5waG9uZSwKICAgICAgICBlbWFpbDogICAgIGRhdGEuY29udGFjdF9lbWFpbCB8fCBQUk9GSUxFX0NBQ0hFLmVtYWlsLAogICAgICAgIGluc3RhZ3JhbTogZGF0YS53ZWJzaXRlICAgIHx8IFBST0ZJTEVfQ0FDSEUuaW5zdGFncmFtLAogICAgICAgIGxvY2F0aW9uOiAgZGF0YS5hZGRyZXNzICAgIHx8IFBST0ZJTEVfQ0FDSEUubG9jYXRpb24sCiAgICAgICAgd2Vic2l0ZTogICBkYXRhLndlYnNpdGUgICAgfHwgUFJPRklMRV9DQUNIRS53ZWJzaXRlLAogICAgICAgIHRhZ2xpbmU6ICAgZGF0YS50YWdsaW5lICAgIHx8IFBST0ZJTEVfQ0FDSEUudGFnbGluZSwKICAgICAgfTsKICAgICAgYXBwbHlQcm9maWxlRGF0YSh3aW5kb3cuX3Byb2ZpbGUpOwogICAgfQogIH0gY2F0Y2goZSkgewogICAgLy8gVXNlIGNhY2hlIG9ubHkg4oCUIHN0b3JlZnJvbnQgaXMgcHVibGljLCB1c2VyIG1heSBub3QgYmUgbG9nZ2VkIGluCiAgfQp9CgpmdW5jdGlvbiBhcHBseVByb2ZpbGVEYXRhKHApIHsKICBjb25zdCBiaXpOYW1lID0gcC5iaXpOYW1lIHx8IHAuYml6X25hbWUgfHwgJ015IFdhdGNoIFN0b3JlJzsKICBjb25zdCBsb2NhdGlvbiA9IHAubG9jYXRpb24gfHwgcC5hZGRyZXNzIHx8ICcnOwogIGNvbnN0IGVtYWlsID0gcC5lbWFpbCB8fCBwLmNvbnRhY3RfZW1haWwgfHwgJyc7CiAgY29uc3QgcGhvbmUgPSBwLnBob25lIHx8ICcnOwoKICAvLyBVcGRhdGUgYWxsIHRleHQgbm9kZXMKICBjb25zdCBzZXQgPSAoaWQsIHZhbCkgPT4geyBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsgaWYoZWwgJiYgdmFsKSBlbC50ZXh0Q29udGVudCA9IHZhbDsgfTsKICBzZXQoJ2xvYWRlci1iaXotbmFtZScsIGJpek5hbWUpOwogIHNldCgnaGRyLXRhZ2xpbmUnLCBsb2NhdGlvbiA/IGBQcmUtT3duZWQgTHV4dXJ5IFRpbWVwaWVjZXMgwrcgJHtsb2NhdGlvbn1gIDogJ1ByZS1Pd25lZCBMdXh1cnkgVGltZXBpZWNlcycpOwogIHNldCgnaGVyby1sb2NhdGlvbicsIGxvY2F0aW9uKTsKICBzZXQoJ2Zvb3Rlci1iaXotbmFtZScsIGJpek5hbWUpOwogIHNldCgnZm9vdGVyLWRlc2MnLCBgUHJlLW93bmVkIGx1eHVyeSB3YXRjaGVzIHBlcnNvbmFsbHkgc291cmNlZCwgYXV0aGVudGljYXRlZCwgYW5kIGZhaXJseSBwcmljZWQuJHtsb2NhdGlvbiA/ICcgQmFzZWQgaW4gJytsb2NhdGlvbisnLicgOiAnJ31gKTsKICBzZXQoJ2Zvb3Rlci1jb3B5JywgYMKpICR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAke2Jpek5hbWV9LiBBbGwgcmlnaHRzIHJlc2VydmVkLmApOwoKICAvLyBMb2dvIHRleHQg4oCUIHNwbGl0IGludG8gcGxhaW4gKyBpdGFsaWMKICBjb25zdCBoZHJFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZHItYml6LW5hbWUtZGlzcGxheScpOwogIGlmIChoZHJFbCkgewogICAgY29uc3QgcGFydHMgPSBiaXpOYW1lLnNwbGl0KCcgJyk7CiAgICBpZiAocGFydHMubGVuZ3RoID4gMSkgewogICAgICBoZHJFbC5pbm5lckhUTUwgPSBwYXJ0cy5zbGljZSgwLC0xKS5qb2luKCcgJykgKyAnIDxlbT4nICsgcGFydHNbcGFydHMubGVuZ3RoLTFdICsgJzwvZW0+JzsKICAgIH0gZWxzZSB7CiAgICAgIGhkckVsLnRleHRDb250ZW50ID0gYml6TmFtZTsKICAgIH0KICB9CgogIC8vIFBhZ2UgdGl0bGUgJiBtZXRhCiAgZG9jdW1lbnQudGl0bGUgPSBiaXpOYW1lICsgJyDigJQgUHJlLU93bmVkIEx1eHVyeSBXYXRjaGVzJzsKICBjb25zdCBtZXRhRGVzYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWdlLWRlc2MnKTsKICBpZiAobWV0YURlc2MpIG1ldGFEZXNjLmNvbnRlbnQgPSBgUHJlLW93bmVkIGx1eHVyeSB3YXRjaGVzIGZyb20gJHtiaXpOYW1lfSR7bG9jYXRpb24gPyAnLCAnK2xvY2F0aW9uIDogJyd9LmA7CgogIC8vIENvbnRhY3QgbGlua3MKICBjb25zdCBzZXRIcmVmID0gKGlkLCBocmVmKSA9PiB7IGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOyBpZihlbCkgZWwuaHJlZiA9IGhyZWY7IH07CiAgaWYgKHBob25lKSB7CiAgICBjb25zdCB0ZWwgPSBwaG9uZS5yZXBsYWNlKC9cRC9nLCcnKTsKICAgIFsndGItcGhvbmUnLCdjLXBob25lJywnZi1waG9uZSddLmZvckVhY2goaWQgPT4gc2V0SHJlZihpZCwgJ3RlbDonK3RlbCkpOwogIH0KICBpZiAoZW1haWwpIHsKICAgIFsndGItZW1haWwnLCdjLWVtYWlsJywnZi1lbWFpbCddLmZvckVhY2goaWQgPT4gc2V0SHJlZihpZCwgJ21haWx0bzonK2VtYWlsKSk7CiAgfQp9CgpsZXQgYWxsV2F0Y2hlcyA9IFtdLCBzb2xkV2F0Y2hlcyA9IFtdLCBsYlBob3RvcyA9IFtdLCBsYklkeCA9IDA7CgovLyBDb250YWN0IGluZm8KZnVuY3Rpb24gc2V0Q29udGFjdCgpIHsKICAvLyBDb250YWN0IGluZm8gbG9hZGVkIGZyb20gcHJvZmlsZSAoc2VlIGFwcGx5UHJvZmlsZSBiZWxvdykKICBjb25zdCBwaG9uZSA9IHdpbmRvdy5fcHJvZmlsZT8ucGhvbmUgfHwgUFJPRklMRV9DQUNIRS5waG9uZSB8fCAnJzsKICBjb25zdCBlbWFpbCA9IHdpbmRvdy5fcHJvZmlsZT8uZW1haWwgfHwgUFJPRklMRV9DQUNIRS5lbWFpbCB8fCAnJzsKICBjb25zdCBpZyA9IHdpbmRvdy5fcHJvZmlsZT8uaW5zdGFncmFtIHx8IFBST0ZJTEVfQ0FDSEUuaW5zdGFncmFtIHx8ICcnOwogIGNvbnN0IGxvYyA9IHdpbmRvdy5fcHJvZmlsZT8ubG9jYXRpb24gfHwgUFJPRklMRV9DQUNIRS5sb2NhdGlvbiB8fCAnJzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGItcGhvbmUnKS50ZXh0Q29udGVudCA9IHBob25lOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0Yi1waG9uZScpLmhyZWYgPSAndGVsOicrcGhvbmUucmVwbGFjZSgvXEQvZywnJyk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RiLWVtYWlsJykudGV4dENvbnRlbnQgPSBlbWFpbDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGItZW1haWwnKS5ocmVmID0gJ21haWx0bzonK2VtYWlsOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0Yi1pbnN0YWdyYW0nKS50ZXh0Q29udGVudCA9ICdAJytpZzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGItaW5zdGFncmFtJykuaHJlZiA9ICdodHRwczovL2luc3RhZ3JhbS5jb20vJytpZzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYy1waG9uZScpLnRleHRDb250ZW50ID0gcGhvbmU7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2MtcGhvbmUnKS5ocmVmID0gJ3RlbDonK3Bob25lLnJlcGxhY2UoL1xEL2csJycpOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjLWVtYWlsJykudGV4dENvbnRlbnQgPSBlbWFpbDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYy1lbWFpbCcpLmhyZWYgPSAnbWFpbHRvOicrZW1haWw7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2MtaW5zdGFncmFtJykudGV4dENvbnRlbnQgPSAnQCcraWc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2MtaW5zdGFncmFtJykuaHJlZiA9ICdodHRwczovL2luc3RhZ3JhbS5jb20vJytpZzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYy1sb2NhdGlvbicpLnRleHRDb250ZW50ID0gbG9jOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLXBob25lJykudGV4dENvbnRlbnQgPSBwaG9uZTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1waG9uZScpLmhyZWYgPSAndGVsOicrcGhvbmUucmVwbGFjZSgvXEQvZywnJyk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2YtZW1haWwnKS50ZXh0Q29udGVudCA9IGVtYWlsOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLWVtYWlsJykuaHJlZiA9ICdtYWlsdG86JytlbWFpbDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1pZycpLnRleHRDb250ZW50ID0gJ0AnK2lnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLWlnJykuaHJlZiA9ICdodHRwczovL2luc3RhZ3JhbS5jb20vJytpZzsKfQoKYXN5bmMgZnVuY3Rpb24gaW5pdCgpIHsKICAvLyBBcHBseSB0aGVtZSAmIHByb2ZpbGUgaW1tZWRpYXRlbHkgb24gbG9hZAogIGFwcGx5VGhlbWUoVEhFTUUpOwogIGFwcGx5UHJvZmlsZURhdGEoUFJPRklMRV9DQUNIRSk7CiAgbG9hZEFuZEFwcGx5UHJvZmlsZSgpOyAvLyBhbHNvIHJlZnJlc2hlcyBsaXZlIGZyb20gU3VwYWJhc2UKICBzZXRDb250YWN0KCk7CiAgdHJ5IHsKICAgIGNvbnN0IFtpbnZSZXMsIHNvbGRSZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICBkYi5mcm9tKCdpbnZlbnRvcnknKS5zZWxlY3QoJyonKS5vcmRlcignY3JlYXRlZF9hdCcsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KSwKICAgICAgZGIuZnJvbSgnc29sZF9pbnZlbnRvcnknKS5zZWxlY3QoJ2JyYW5kLG1vZGVsLHJlZixzYWxlX2RhdGUscGhvdG9fdXJscycpLm9yZGVyKCdzYWxlX2RhdGUnLCB7IGFzY2VuZGluZzogZmFsc2UgfSkubGltaXQoNTApCiAgICBdKTsKICAgIGFsbFdhdGNoZXMgPSBpbnZSZXMuZGF0YSB8fCBbXTsKICAgIHNvbGRXYXRjaGVzID0gc29sZFJlcy5kYXRhIHx8IFtdOwogIH0gY2F0Y2goZSkgeyBhbGxXYXRjaGVzID0gW107IHNvbGRXYXRjaGVzID0gW107IH0KCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXQtYXZhaWxhYmxlJykudGV4dENvbnRlbnQgPSBhbGxXYXRjaGVzLmxlbmd0aDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdC1zb2xkJykudGV4dENvbnRlbnQgPSBzb2xkV2F0Y2hlcy5sZW5ndGggKyAnKyc7CgogIC8vIEJyYW5kIGZpbHRlcgogIGNvbnN0IGJyYW5kcyA9IFsuLi5uZXcgU2V0KGFsbFdhdGNoZXMubWFwKHc9PncuYnJhbmQpLmZpbHRlcihCb29sZWFuKSldLnNvcnQoKTsKICBjb25zdCBzZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnJhbmQtZmlsdGVyJyk7CiAgYnJhbmRzLmZvckVhY2goYiA9PiB7IGNvbnN0IG89ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7IG8udmFsdWU9Yjsgby50ZXh0Q29udGVudD1iOyBzZWwuYXBwZW5kQ2hpbGQobyk7IH0pOwoKICByZW5kZXJXYXRjaGVzKGFsbFdhdGNoZXMpOwogIHJlbmRlclNvbGQoKTsKICBoaWRlTG9hZGVyKCk7Cn0KCmZ1bmN0aW9uIGhpZGVMb2FkZXIoKSB7CiAgY29uc3QgbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWdlLWxvYWRlcicpOwogIGwuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7CiAgc2V0VGltZW91dCgoKT0+bC5zdHlsZS5kaXNwbGF5PSdub25lJywgNzAwKTsKfQoKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCi8vICBXQVRDSCBHUklECi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkApmdW5jdGlvbiBmaWx0ZXJXYXRjaGVzKCkgewogIGNvbnN0IHEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VhcmNoLWlucHV0JykudmFsdWUudG9Mb3dlckNhc2UoKTsKICBjb25zdCBicmFuZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdicmFuZC1maWx0ZXInKS52YWx1ZTsKICBjb25zdCBzb3J0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvcnQtc2VsZWN0JykudmFsdWU7CgogIGxldCBmaWx0ZXJlZCA9IGFsbFdhdGNoZXMuZmlsdGVyKHcgPT4gewogICAgY29uc3QgdHh0ID0gYCR7dy5icmFuZH0gJHt3Lm1vZGVsfSAke3cucmVmfWAudG9Mb3dlckNhc2UoKTsKICAgIHJldHVybiB0eHQuaW5jbHVkZXMocSkgJiYgKCFicmFuZCB8fCB3LmJyYW5kPT09YnJhbmQpOwogIH0pOwoKICBmaWx0ZXJlZC5zb3J0KChhLGIpID0+IHsKICAgIGlmKHNvcnQ9PT0ncHJpY2UtYXNjJykgcmV0dXJuIChhLmxpc3RlZF9wcmljZXx8MCktKGIubGlzdGVkX3ByaWNlfHwwKTsKICAgIGlmKHNvcnQ9PT0ncHJpY2UtZGVzYycpIHJldHVybiAoYi5saXN0ZWRfcHJpY2V8fDApLShhLmxpc3RlZF9wcmljZXx8MCk7CiAgICByZXR1cm4gbmV3IERhdGUoYi5jcmVhdGVkX2F0fHwwKS1uZXcgRGF0ZShhLmNyZWF0ZWRfYXR8fDApOwogIH0pOwoKICByZW5kZXJXYXRjaGVzKGZpbHRlcmVkKTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdWx0cy1jb3VudCcpLnRleHRDb250ZW50ID0KICAgIGZpbHRlcmVkLmxlbmd0aCAhPT0gYWxsV2F0Y2hlcy5sZW5ndGggPyBgU2hvd2luZyAke2ZpbHRlcmVkLmxlbmd0aH0gb2YgJHthbGxXYXRjaGVzLmxlbmd0aH1gIDogYCR7YWxsV2F0Y2hlcy5sZW5ndGh9IHdhdGNoZXNgOwp9CgpmdW5jdGlvbiByZW5kZXJXYXRjaGVzKHdhdGNoZXMpIHsKICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dhdGNoLWdyaWQnKTsKICBjb25zdCBub1JlcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduby1yZXN1bHRzJyk7CiAgaWYgKCF3YXRjaGVzLmxlbmd0aCkgeyBncmlkLmlubmVySFRNTD0nJzsgbm9SZXMuc3R5bGUuZGlzcGxheT0nYmxvY2snOyByZXR1cm47IH0KICBub1Jlcy5zdHlsZS5kaXNwbGF5PSdub25lJzsKCiAgZ3JpZC5pbm5lckhUTUwgPSB3YXRjaGVzLm1hcCgodyxpKSA9PiB7CiAgICBjb25zdCBwaG90b3MgPSB3LnBob3RvX3VybHMgfHwgW107CiAgICBjb25zdCBtYWluUGhvdG8gPSBwaG90b3NbMF07CiAgICBjb25zdCBwcmljZSA9IHcubGlzdGVkX3ByaWNlID8gJyQnK051bWJlcih3Lmxpc3RlZF9wcmljZSkudG9Mb2NhbGVTdHJpbmcoKSA6ICdJbnF1aXJlIGZvciBQcmljZSc7CiAgICBjb25zdCBjaGlwcyA9IFt3LmNvbmRpdGlvbiwgdy5ib3hfcGFwZXJzLCB3LmNhc2VfbWF0ZXJpYWxdLmZpbHRlcihCb29sZWFuKS5zbGljZSgwLDMpOwoKICAgIHJldHVybiBgPGRpdiBjbGFzcz0id2F0Y2gtY2FyZCIgb25jbGljaz0ib3BlbkxiKCcke3cuaWR9JykiIHN0eWxlPSJhbmltYXRpb24tZGVsYXk6JHtNYXRoLm1pbihpLDEyKSowLjA0fXMiPgogICAgICA8ZGl2IGNsYXNzPSJ3YXRjaC1waG90byI+CiAgICAgICAgJHttYWluUGhvdG8KICAgICAgICAgID8gYDxpbWcgc3JjPSIke21haW5QaG90b30iIGFsdD0iJHt3LmJyYW5kfHwnJ30gJHt3Lm1vZGVsfHwnJ30iIGxvYWRpbmc9ImxhenkiPmAKICAgICAgICAgIDogYDxkaXYgY2xhc3M9IndhdGNoLXBob3RvLXBsYWNlaG9sZGVyIj48ZGl2IGNsYXNzPSJwaC1pY29uIj7il4k8L2Rpdj48ZGl2IGNsYXNzPSJwaC1icmFuZCI+JHt3LmJyYW5kfHwnJ308L2Rpdj48L2Rpdj5gCiAgICAgICAgfQogICAgICAgICR7cGhvdG9zLmxlbmd0aD4xP2A8ZGl2IGNsYXNzPSJwaG90by1jb3VudC1iYWRnZSI+8J+TtyAke3Bob3Rvcy5sZW5ndGh9PC9kaXY+YDonJ30KICAgICAgICAke3cuYm94X3BhcGVycz09PSdGdWxsIFNldCAoQm94ICsgUGFwZXJzKSc/YDxkaXYgY2xhc3M9IndhdGNoLXRhZyI+RnVsbCBTZXQ8L2Rpdj5gOicnfQogICAgICA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0id2F0Y2gtaW5mbyI+CiAgICAgICAgPGRpdiBjbGFzcz0id2F0Y2gtY2FyZC1icmFuZCI+JHt3LmJyYW5kfHwnJ30ke3cueWVhcj8nIMK3ICcrdy55ZWFyOicnfTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9IndhdGNoLWNhcmQtbW9kZWwiPiR7dy5tb2RlbHx8Jyd9PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0id2F0Y2gtY2FyZC1yZWYiPiR7dy5yZWZ8fCfigJQnfTwvZGl2PgogICAgICAgICR7Y2hpcHMubGVuZ3RoP2A8ZGl2IGNsYXNzPSJ3YXRjaC1jYXJkLWNoaXBzIj4ke2NoaXBzLm1hcChjPT5gPHNwYW4gY2xhc3M9ImNoaXAiPiR7Y308L3NwYW4+YCkuam9pbignJyl9PC9kaXY+YDonJ30KICAgICAgICA8ZGl2IGNsYXNzPSJ3YXRjaC1jYXJkLWZvb3RlciI+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJ3YXRjaC1wcmljZSI+JHtwcmljZX08L2Rpdj4KICAgICAgICAgIDxidXR0b24gY2xhc3M9IndhdGNoLWlucXVpcmUiIG9uY2xpY2s9ImV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO2RvSW5xdWlyZSgnJHsody5icmFuZHx8JycpKycgJysody5tb2RlbHx8JycpfScpIj5JbnF1aXJlPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+YDsKICB9KS5qb2luKCcnKTsKCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3VsdHMtY291bnQnKS50ZXh0Q29udGVudCA9IGAke3dhdGNoZXMubGVuZ3RofSB3YXRjaCR7d2F0Y2hlcy5sZW5ndGghPT0xPydlcyc6Jyd9YDsKfQoKZnVuY3Rpb24gcmVuZGVyU29sZCgpIHsKICBpZighc29sZFdhdGNoZXMubGVuZ3RoKXsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvbGQtd3JhcCcpLnN0eWxlLmRpc3BsYXk9J25vbmUnOyByZXR1cm47IH0KICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc29sZC1ncmlkJykuaW5uZXJIVE1MID0gc29sZFdhdGNoZXMubWFwKHMgPT4gewogICAgY29uc3QgcGhvdG8gPSBzLnBob3RvX3VybHMgJiYgcy5waG90b191cmxzWzBdOwogICAgcmV0dXJuIGA8ZGl2IGNsYXNzPSJzb2xkLWNhcmQiPgogICAgICAke3Bob3RvID8gYDxkaXYgY2xhc3M9InNvbGQtcGhvdG8iPjxpbWcgc3JjPSIke3Bob3RvfSIgYWx0PSIke3MuYnJhbmR8fCcnfSAke3MubW9kZWx8fCcnfSIgbG9hZGluZz0ibGF6eSI+PC9kaXY+YCA6ICcnfQogICAgICA8ZGl2IGNsYXNzPSJzb2xkLWNhcmQtYm9keSI+CiAgICAgICAgPGRpdiBjbGFzcz0ic29sZC1icmFuZCI+JHtzLmJyYW5kfHwnJ308L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzb2xkLW1vZGVsIj4ke3MubW9kZWx8fCcnfTwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PmA7CiAgfSkuam9pbignJyk7Cn0KCi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAovLyAgTElHSFRCT1gKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCmZ1bmN0aW9uIG9wZW5MYihpZCkgewogIGNvbnN0IHcgPSBhbGxXYXRjaGVzLmZpbmQoeD0+eC5pZD09PWlkKTsgaWYoIXcpIHJldHVybjsKICBsYlBob3RvcyA9IHcucGhvdG9fdXJsc3x8W107IGxiSWR4PTA7CgogIGNvbnN0IG1haW5FbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsYi1tYWluJyk7CiAgbWFpbkVsLmlubmVySFRNTCA9IGxiUGhvdG9zLmxlbmd0aAogICAgPyBgPGRpdiBjbGFzcz0ibGItbWFpbi1pbWciPjxpbWcgc3JjPSIke2xiUGhvdG9zWzBdfSIgYWx0PSIke3cuYnJhbmR8fCcnfSAke3cubW9kZWx8fCcnfSI+PC9kaXY+YAogICAgOiBgPGRpdiBjbGFzcz0ibGItbWFpbi1wbGFjZWhvbGRlciI+4peJPC9kaXY+YDsKCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xiLXRodW1icycpLmlubmVySFRNTCA9IGxiUGhvdG9zLmxlbmd0aD4xCiAgICA/IGxiUGhvdG9zLm1hcCgocCxpKT0+YDxkaXYgY2xhc3M9ImxiLXRodW1iICR7aT09PTA/J2FjdGl2ZSc6Jyd9IiBvbmNsaWNrPSJzZXRMYkltZygke2l9KSI+PGltZyBzcmM9IiR7cH0iIGFsdD0iUGhvdG8gJHtpKzF9Ij48L2Rpdj5gKS5qb2luKCcnKQogICAgOiAnJzsKCiAgY29uc3QgcHJpY2UgPSB3Lmxpc3RlZF9wcmljZSA/ICckJytOdW1iZXIody5saXN0ZWRfcHJpY2UpLnRvTG9jYWxlU3RyaW5nKCkgOiAnSW5xdWlyZSBmb3IgUHJpY2UnOwogIGNvbnN0IHNwZWNzID0gWwogICAgdy5jb25kaXRpb24mJntsOidDb25kaXRpb24nLHY6dy5jb25kaXRpb259LAogICAgdy5ib3hfcGFwZXJzJiZ7bDonQm94ICYgUGFwZXJzJyx2OncuYm94X3BhcGVyc30sCiAgICB3LmNhc2Vfc2l6ZSYme2w6J0Nhc2UgU2l6ZScsdjp3LmNhc2Vfc2l6ZX0sCiAgICB3LmNhc2VfbWF0ZXJpYWwmJntsOidNYXRlcmlhbCcsdjp3LmNhc2VfbWF0ZXJpYWx9LAogICAgdy5tb3ZlbWVudCYme2w6J01vdmVtZW50Jyx2OncubW92ZW1lbnR9LAogICAgdy5kaWFsX2NvbG9yJiZ7bDonRGlhbCcsdjp3LmRpYWxfY29sb3J9LAogICAgdy5iZXplbF9jb2xvciYme2w6J0JlemVsJyx2OncuYmV6ZWxfY29sb3J9LAogICAgdy5icmFjZWxldF90eXBlJiZ7bDonQnJhY2VsZXQnLHY6dy5icmFjZWxldF90eXBlfSwKICAgIHcueWVhciYme2w6J1llYXInLHY6dy55ZWFyfSwKICAgIHcucmVmJiZ7bDonUmVmZXJlbmNlJyx2OncucmVmfSwKICBdLmZpbHRlcihCb29sZWFuKTsKCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xiLWluZm8nKS5pbm5lckhUTUwgPSBgCiAgICA8ZGl2IGNsYXNzPSJsYi1icmFuZCI+JHt3LmJyYW5kfHwnJ308L2Rpdj4KICAgIDxkaXYgY2xhc3M9ImxiLW1vZGVsIj4ke3cubW9kZWx8fCcnfTwvZGl2PgogICAgPGRpdiBjbGFzcz0ibGItcmVmIj4ke3cucmVmfHwnJ30ke3cueWVhcj8nIMK3ICcrdy55ZWFyOicnfTwvZGl2PgogICAgPGRpdiBjbGFzcz0ibGItcHJpY2UiPiR7cHJpY2V9PC9kaXY+CiAgICAke3NwZWNzLmxlbmd0aD9gPGRpdiBjbGFzcz0ibGItc3BlY3MiPiR7c3BlY3MubWFwKHM9PmA8ZGl2IGNsYXNzPSJsYi1zcGVjIj48ZGl2IGNsYXNzPSJsYi1zcGVjLWxhYmVsIj4ke3MubH08L2Rpdj48ZGl2IGNsYXNzPSJsYi1zcGVjLXZhbHVlIj4ke3Mudn08L2Rpdj48L2Rpdj5gKS5qb2luKCcnKX08L2Rpdj5gOicnfQogICAgJHt3Lm5vdGVzP2A8ZGl2IGNsYXNzPSJsYi1ub3RlcyI+JHt3Lm5vdGVzfTwvZGl2PmA6Jyd9CiAgICA8ZGl2IGNsYXNzPSJsYi1hY3Rpb25zIj4KICAgICAgPGJ1dHRvbiBjbGFzcz0ibGItYnRuLXByaW1hcnkiIG9uY2xpY2s9ImRvSW5xdWlyZSgnJHsody5icmFuZHx8JycpKycgJysody5tb2RlbHx8JycpfScpIj5JbnF1aXJlIEFib3V0IFRoaXMgV2F0Y2g8L2J1dHRvbj4KICAgICAgPGEgY2xhc3M9ImxiLWJ0bi1vdXRsaW5lIiBocmVmPSJzbXM6JHsod2luZG93Ll9wcm9maWxlPy5waG9uZXx8UFJPRklMRV9DQUNIRS5waG9uZXx8JycpLnJlcGxhY2UoL1xEL2csJycpfSZib2R5PUhpLCBJJ20gaW50ZXJlc3RlZCBpbiB0aGUgJHtlbmNvZGVVUklDb21wb25lbnQoKHcuYnJhbmR8fCcnKSsnICcrKHcubW9kZWx8fCcnKSl9Ij5UZXh0IFVzIERpcmVjdGx5PC9hPgogICAgICA8YSBjbGFzcz0ibGItYnRuLW91dGxpbmUiIGhyZWY9Im1haWx0bzoke3dpbmRvdy5fcHJvZmlsZT8uZW1haWx8fFBST0ZJTEVfQ0FDSEUuZW1haWx8fCcnfT9zdWJqZWN0PUlucXVpcnk6ICR7ZW5jb2RlVVJJQ29tcG9uZW50KCh3LmJyYW5kfHwnJykrJyAnKyh3Lm1vZGVsfHwnJykpfSI+U2VuZCBFbWFpbDwvYT4KICAgIDwvZGl2PgogIGA7CgogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaWdodGJveCcpLmNsYXNzTGlzdC5hZGQoJ29wZW4nKTsKICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93PSdoaWRkZW4nOwp9CgpmdW5jdGlvbiBzZXRMYkltZyhpKSB7CiAgbGJJZHg9aTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGItbWFpbicpLmlubmVySFRNTD1gPGRpdiBjbGFzcz0ibGItbWFpbi1pbWciPjxpbWcgc3JjPSIke2xiUGhvdG9zW2ldfSIgYWx0PSJQaG90byAke2krMX0iPjwvZGl2PmA7CiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmxiLXRodW1iJykuZm9yRWFjaCgodCxqKT0+dC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLGo9PT1pKSk7Cn0KCmZ1bmN0aW9uIGNsb3NlTGIoKSB7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaWdodGJveCcpLmNsYXNzTGlzdC5yZW1vdmUoJ29wZW4nKTsgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdz0nJzsgfQpmdW5jdGlvbiBjbG9zZUxiT3ZlcmxheShlKSB7IGlmKGUudGFyZ2V0PT09ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpZ2h0Ym94JykpY2xvc2VMYigpOyB9CgovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKLy8gIENPTlRBQ1QgLyBTRUxMCi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkApmdW5jdGlvbiBkb0lucXVpcmUod2F0Y2gpIHsKICBjbG9zZUxiKCk7CiAgd2luZG93LmxvY2F0aW9uLmhyZWY9YG1haWx0bzoke3dpbmRvdy5fcHJvZmlsZT8uZW1haWx8fFBST0ZJTEVfQ0FDSEUuZW1haWx8fCcnfT9zdWJqZWN0PUlucXVpcnk6ICR7ZW5jb2RlVVJJQ29tcG9uZW50KHdhdGNoKX0mYm9keT1IaSwgSSdtIGludGVyZXN0ZWQgaW4gdGhlICR7ZW5jb2RlVVJJQ29tcG9uZW50KHdhdGNoKX0uIElzIGl0IHN0aWxsIGF2YWlsYWJsZT9gOwp9CgpmdW5jdGlvbiBzdWJtaXRTZWxsSW5xdWlyeSgpIHsKICBjb25zdCBuYW1lPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZWxsLW5hbWUnKS52YWx1ZS50cmltKCk7CiAgY29uc3QgZW1haWw9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbGwtZW1haWwnKS52YWx1ZS50cmltKCk7CiAgY29uc3QgYnJhbmQ9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbGwtYnJhbmQnKS52YWx1ZS50cmltKCk7CiAgY29uc3QgbXNnPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZWxsLW1zZycpOwogIGlmKCFuYW1lfHwhZW1haWx8fCFicmFuZCl7IG1zZy5zdHlsZS5jb2xvcj0nI0IwM0EzQSc7IG1zZy50ZXh0Q29udGVudD0nUGxlYXNlIGZpbGwgaW4gbmFtZSwgZW1haWwsIGFuZCBicmFuZC4nOyByZXR1cm47IH0KICBjb25zdCBtb2RlbD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VsbC1tb2RlbCcpLnZhbHVlLnRyaW0oKTsKICBjb25zdCBwYXBlcnM9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbGwtcGFwZXJzJykudmFsdWU7CiAgY29uc3Qgbm90ZXM9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbGwtbm90ZXMnKS52YWx1ZS50cmltKCk7CiAgY29uc3QgcGhvbmU9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbGwtcGhvbmUnKS52YWx1ZS50cmltKCk7CiAgY29uc3QgYm9keT1gU2VsbCBJbnF1aXJ5XApcCk5hbWU6ICR7bmFtZX1cClBob25lOiAke3Bob25lfVwKRW1haWw6ICR7ZW1haWx9XApcCldhdGNoOiAke2JyYW5kfSAke21vZGVsfVwKQm94ICYgUGFwZXJzOiAke3BhcGVyc31cClwKTm90ZXM6XAoke25vdGVzfWA7CiAgd2luZG93LmxvY2F0aW9uLmhyZWY9YG1haWx0bzoke3dpbmRvdy5fcHJvZmlsZT8uZW1haWx8fFBST0ZJTEVfQ0FDSEUuZW1haWx8fCcnfT9zdWJqZWN0PVNlbGwgSW5xdWlyeTogJHtlbmNvZGVVUklDb21wb25lbnQoYnJhbmQrJyAnK21vZGVsKX0mYm9keT0ke2VuY29kZVVSSUNvbXBvbmVudChib2R5KX1gOwogIG1zZy5zdHlsZS5jb2xvcj0nIzNBN0E1QSc7IG1zZy50ZXh0Q29udGVudD0nT3BlbmluZyB5b3VyIGVtYWlsIGFwcCDigJQgd2UgcmVzcG9uZCB3aXRoaW4gMjQgaG91cnMhJzsKfQoKZnVuY3Rpb24gc2hvd1RvYXN0KG0peyBjb25zdCB0PWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdCcpOyB0LnRleHRDb250ZW50PW07IHQuY2xhc3NMaXN0LmFkZCgnc2hvdycpOyBzZXRUaW1lb3V0KCgpPT50LmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKSwzNTAwKTsgfQoKaW5pdCgpOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+");
// decoded from base64 to avoid backtick escaping issues
// ── MY STOREFRONT ─────────────────────────────────

const SF_THEMES = [
  { id:'classic-dark', name:'Classic Dark',
    headerBg:'#1A1A1A', bodyBg:'#F5F2ED', gold:'#B8943A', gold2:'#D4AF5A',
    bodyBorder:'#DDD8D0', headerSwatch:'#1A1A1A', bodySwatch:'#F5F2ED', accentSwatch:'#D4AF5A' },
  { id:'navy-gold', name:'Navy & Gold',
    headerBg:'#0F2040', bodyBg:'#F0F4F8', gold:'#C89E2F', gold2:'#E5C15A',
    bodyBorder:'#D0D8E4', headerSwatch:'#0F2040', bodySwatch:'#F0F4F8', accentSwatch:'#E5C15A' },
  { id:'all-dark', name:'Full Dark',
    headerBg:'#111111', bodyBg:'#1A1A1A', gold:'#C89E2F', gold2:'#E5C15A',
    bodyBorder:'#333333', headerSwatch:'#111', bodySwatch:'#1A1A1A', accentSwatch:'#E5C15A' },
  { id:'forest', name:'Forest & Cream',
    headerBg:'#1E2D1E', bodyBg:'#F5F2EC', gold:'#7A9A5A', gold2:'#9CBD7A',
    bodyBorder:'#DDD8CC', headerSwatch:'#1E2D1E', bodySwatch:'#F5F2EC', accentSwatch:'#9CBD7A' },
  { id:'slate-copper', name:'Slate & Copper',
    headerBg:'#2C3040', bodyBg:'#F4F2F0', gold:'#B87040', gold2:'#D4925A',
    bodyBorder:'#DDD8D2', headerSwatch:'#2C3040', bodySwatch:'#F4F2F0', accentSwatch:'#D4925A' },
  { id:'midnight-silver', name:'Midnight Silver',
    headerBg:'#0A0A12', bodyBg:'#F2F2F5', gold:'#8090A8', gold2:'#A8BACE',
    bodyBorder:'#D8D8E0', headerSwatch:'#0A0A12', bodySwatch:'#F2F2F5', accentSwatch:'#A8BACE' },
];

const SF_FONTS = [
  { id:'playfair-raleway', name:'Playfair Display', sub:'+ Raleway (Luxury Classic)',
    display:'Playfair Display', body:'Raleway',
    url:'https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,700;1,400;1,500&family=Raleway:wght@300;400;500;600&display=swap' },
  { id:'cormorant-jost', name:'Cormorant Garamond', sub:'+ Jost (Refined Editorial)',
    display:'Cormorant Garamond', body:'Jost',
    url:'https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Jost:wght@300;400;500;600&display=swap' },
  { id:'libre-source', name:'Libre Baskerville', sub:'+ Source Sans 3 (Bold & Clear)',
    display:'Libre Baskerville', body:'Source Sans 3',
    url:'https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@300;400;600&display=swap' },
  { id:'dm-serif', name:'DM Serif Display', sub:'+ DM Sans (Clean Minimal)',
    display:'DM Serif Display', body:'DM Sans',
    url:'https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap' },
  { id:'crimson-nunito', name:'Crimson Pro', sub:'+ Nunito (Warm & Approachable)',
    display:'Crimson Pro', body:'Nunito',
    url:'https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Nunito:wght@300;400;500;600&display=swap' },
];

const SF_HEROES = [
  { id:'watches-dark', label:'Watch Close-Up',
    url:'https://images.unsplash.com/photo-1547996160-81dfa63595aa?w=1600&q=80&auto=format' },
  { id:'rolex', label:'Classic Dial',
    url:'https://images.unsplash.com/photo-1587836374828-4dbafa94cf0e?w=1600&q=80&auto=format' },
  { id:'watch-flat', label:'Flat Lay',
    url:'https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=1600&q=80&auto=format' },
  { id:'luxury-table', label:'Luxury Still Life',
    url:'https://images.unsplash.com/photo-1612817288484-6f916006741a?w=1600&q=80&auto=format' },
  { id:'watch-wrist', label:'On Wrist',
    url:'https://images.unsplash.com/photo-1601121141461-9d6647bef0a1?w=1600&q=80&auto=format' },
  { id:'watch-tools', label:'Watchmaker',
    url:'https://images.unsplash.com/photo-1617038260897-41a1f14a8ca0?w=1600&q=80&auto=format' },
];

let sfState = {
  themeId: 'classic-dark',
  fontId:  'playfair-raleway',
  heroId:  'watches-dark',
  heroCustom: '',
};

function sfInit() {
  // Build theme swatches
  const tg = document.getElementById('sf-theme-grid');
  tg.innerHTML = SF_THEMES.map(t => `
    <div class="sf-theme-swatch ${t.id===sfState.themeId?'active':''}" onclick="sfSelectTheme('${t.id}')" title="${t.name}">
      <div class="sf-theme-swatch-inner">
        <div class="sf-swatch-header" style="background:${t.headerSwatch};padding:4px;">
          <div class="sf-swatch-dot" style="background:${t.accentSwatch}"></div>
        </div>
        <div class="sf-swatch-body" style="background:${t.bodySwatch}">
          <div style="width:60%;height:4px;background:${t.accentSwatch};opacity:0.5;border-radius:1px"></div>
        </div>
      </div>
      <div class="sf-swatch-label">${t.name}</div>
    </div>`).join('');

  // Build font list
  const fl = document.getElementById('sf-font-list');
  fl.innerHTML = SF_FONTS.map(f => `
    <div class="sf-font-item ${f.id===sfState.fontId?'active':''}" onclick="sfSelectFont('${f.id}')">
      <div class="sf-font-display">${f.name}</div>
      <div class="sf-font-sub">${f.sub}</div>
    </div>`).join('');

  // Build hero grid
  const hg = document.getElementById('sf-hero-grid');
  hg.innerHTML = SF_HEROES.map(h => `
    <div class="sf-hero-thumb ${h.id===sfState.heroId?'active':''}"
      style="background-image:url('${h.url}')"
      onclick="sfSelectHero('${h.id}')">
      <div class="sf-hero-thumb-label">${h.label}</div>
    </div>`).join('');

  sfRefreshPreview();
}

function sfSelectTheme(id) {
  sfState.themeId = id;
  document.querySelectorAll('.sf-theme-swatch').forEach(el => el.classList.remove('active'));
  document.querySelector(`.sf-theme-swatch[onclick="sfSelectTheme('${id}')"]`)?.classList.add('active');
  const t = SF_THEMES.find(x=>x.id===id);
  document.getElementById('sf-status-theme').textContent = t?.name || id;
  sfRefreshPreview();
}

function sfSelectFont(id) {
  sfState.fontId = id;
  document.querySelectorAll('.sf-font-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`.sf-font-item[onclick="sfSelectFont('${id}')"]`)?.classList.add('active');
  const f = SF_FONTS.find(x=>x.id===id);
  document.getElementById('sf-status-font').textContent = f ? `${f.display} + ${f.body}` : id;
  sfRefreshPreview();
}

function sfSelectHero(id) {
  sfState.heroId = id;
  sfState.heroCustom = '';
  document.getElementById('sf-hero-custom').value = '';
  document.querySelectorAll('.sf-hero-thumb').forEach(el => el.classList.remove('active'));
  document.querySelector(`.sf-hero-thumb[onclick="sfSelectHero('${id}')"]`)?.classList.add('active');
  sfRefreshPreview();
}

function sfSetCustomHero(url) {
  if (!url) return;
  sfState.heroCustom = url;
  sfState.heroId = '';
  document.querySelectorAll('.sf-hero-thumb').forEach(el => el.classList.remove('active'));
  sfRefreshPreview();
}

function sfBuildHTML() {
  const theme = SF_THEMES.find(t=>t.id===sfState.themeId) || SF_THEMES[0];
  const font  = SF_FONTS.find(f=>f.id===sfState.fontId)   || SF_FONTS[0];
  const hero  = sfState.heroCustom || SF_HEROES.find(h=>h.id===sfState.heroId)?.url || SF_HEROES[0].url;

  const supaUrl  = typeof SUPABASE_URL  !== 'undefined' ? SUPABASE_URL  : 'PASTE_YOUR_PROJECT_URL_HERE';
  const supaAnon = typeof SUPABASE_ANON !== 'undefined' ? SUPABASE_ANON : 'PASTE_YOUR_ANON_KEY_HERE';

  // Profile from userProfile
  const p = userProfile;

  let html = STOREFRONT_TEMPLATE;
  html = html.replace(/%%SUPABASE_URL%%/g,     supaUrl);
  html = html.replace(/%%SUPABASE_ANON%%/g,    supaAnon);
  html = html.replace(/%%THEME_BODY_BG%%/g,    theme.bodyBg);
  html = html.replace(/%%THEME_HEADER_BG%%/g,  theme.headerBg);
  html = html.replace(/%%THEME_GOLD%%/g,        theme.gold);
  html = html.replace(/%%THEME_GOLD2%%/g,       theme.gold2);
  html = html.replace(/%%THEME_BODY_BORDER%%/g, theme.bodyBorder);
  html = html.replace(/%%THEME_FONT_DISPLAY%%/g,font.display);
  html = html.replace(/%%THEME_FONT_BODY%%/g,   font.body);
  html = html.replace(/%%THEME_FONT_URL%%/g,    font.url);
  html = html.replace(/%%THEME_HERO_BG%%/g,     hero);
  html = html.replace(/%%PROFILE_BIZ_NAME%%/g,  (p.biz_name||'').replace(/'/g,"\\'"));
  html = html.replace(/%%PROFILE_PHONE%%/g,     (p.phone||'').replace(/'/g,"\\'"));
  html = html.replace(/%%PROFILE_EMAIL%%/g,     (p.contact_email||'').replace(/'/g,"\\'"));
  html = html.replace(/%%PROFILE_INSTAGRAM%%/g, (p.website||'').replace(/'/g,"\\'"));
  html = html.replace(/%%PROFILE_LOCATION%%/g,  (p.address||'').replace(/'/g,"\\'"));
  html = html.replace(/%%PROFILE_WEBSITE%%/g,   (p.website||'').replace(/'/g,"\\'"));
  html = html.replace(/%%PROFILE_TAGLINE%%/g,   'Pre-Owned Luxury Timepieces');
  return html;
}

function sfRefreshPreview() {
  const frame = document.getElementById('sf-preview-frame');
  const html = sfBuildHTML();
  frame.srcdoc = html;
  // Update preview URL bar
  const bizName = userProfile.biz_name||'yourstore';
  document.getElementById('sf-preview-url').textContent =
    bizName.toLowerCase().replace(/\s+/g,'')+'.vercel.app';
}

function sfDownload() {
  if (!userProfile.biz_name) {
    showToast('Please set your Business Name in Settings first.');
    showPage('settings');
    return;
  }
  const html = sfBuildHTML();
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const slug = (userProfile.biz_name||'storefront').toLowerCase().replace(/\s+/g,'-');
  a.download = slug+'-storefront.html';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Storefront downloaded! Rename to index.html and upload to GitHub.');
}

// Called when My Storefront page opens
function initStorefrontPage() {
  // Warn if profile incomplete
  const warn = document.getElementById('sf-profile-warn');
  if (!userProfile.biz_name || !userProfile.contact_email) {
    warn.style.display = 'block';
  } else {
    warn.style.display = 'none';
  }
  sfInit();
}

// ── HELP CONTENT ──────────────────────────────────
const HELP_ARTICLES={
  'welcome':`<div class="help-article">
    <h1>Welcome to DialTrader</h1>
    <div class="help-tag">Getting Started</div>
    <p>DialTrader is your complete watch trading business desk — built specifically for independent watch traders who need a professional tool without enterprise-software complexity.</p>
    <div class="help-tip"><strong>Quick Start:</strong> The fastest way to get going is to set up your profile (Settings), add a few watches to Inventory, then explore from there.</div>
    <h2>What's in the App</h2>
    <ul>
      <li><strong>Dashboard</strong> — Your business at a glance. Total invested, gross sales, net profit, avg ROI, days-to-sell.</li>
      <li><strong>Inventory</strong> — Every watch you currently own. Add specs, photos, deal stage, and platform listings.</li>
      <li><strong>Sold History</strong> — Complete record of every watch you've sold with profit calculations.</li>
      <li><strong>Contacts / CRM</strong> — Build your buyer and seller database with full transaction history.</li>
      <li><strong>Invoices</strong> — Create and send professional PDF invoices. Store received invoices too.</li>
      <li><strong>Import / Export</strong> — Bring in existing data from spreadsheets.</li>
      <li><strong>Tax Report</strong> — P&L summary filtered by year for your accountant.</li>
      <li><strong>Settings</strong> — Your business profile, payment info, and invoice defaults.</li>
    </ul>
    <h2>Your Public Storefront</h2>
    <p>Every DialTrader account includes a public storefront — a beautiful website that automatically shows your current inventory and recently sold watches. Check the <strong>Storefront</strong> section of Help to get yours set up.</p>
  </div>`,

  'profile':`<div class="help-article">
    <h1>Setting Up Your Profile</h1>
    <div class="help-tag">Getting Started</div>
    <p>Your profile is the foundation of everything in DialTrader. Your business name, contact info, and payment details flow automatically into your invoices and storefront.</p>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Open Settings</strong><span>Click Settings in the left sidebar.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Fill in Business Profile</strong><span>Add your trading name, phone, email, and city/state. This appears on every invoice you send.</span></div></div>
    <div class="help-step"><div class="help-step-num">3</div><div class="help-step-body"><strong>Add Payment Info</strong><span>Enter your Zelle number/email and Apple Pay number. When you create an invoice, you can toggle these on so buyers see exactly how to pay you.</span></div></div>
    <div class="help-step"><div class="help-step-num">4</div><div class="help-step-body"><strong>Set Invoice Defaults</strong><span>Add any standard terms or notes that should appear on every invoice — e.g. "All sales final. Watch authenticated before shipment."</span></div></div>
    <div class="help-tip"><strong>Tip:</strong> Your contact email in your profile doesn't have to be the same as your login email. Use a business email for invoices if you prefer.</div>
  </div>`,

  'first-watch':`<div class="help-article">
    <h1>Adding Your First Watch</h1>
    <div class="help-tag">Getting Started</div>
    <p>Adding a watch takes about 2 minutes. Click <strong>+ Add Watch</strong> in the Inventory page. The modal has four tabs:</p>
    <h2>Basics</h2>
    <p>Brand and Model are required. Fill in purchase price, taxes, shipping, and any other fees — this builds your true cost basis. Set your listed price and select which platforms you've listed it on.</p>
    <h2>Deal Stage</h2>
    <p>Select where the watch currently sits in your pipeline — from "Purchased — Awaiting Payment" all the way through "Closed / Complete." This is visible on every inventory row so you always know what needs attention.</p>
    <h2>Details</h2>
    <p>Reference number, serial, year, condition, box & papers, case size, dial color. The more you fill in here, the better your storefront listing will look.</p>
    <h2>Photos</h2>
    <p>Upload up to 8 photos. Drag to reorder — the first photo becomes your main listing image. Photos are compressed automatically on upload.</p>
    <div class="help-tip"><strong>Tip:</strong> Add photos before the watch goes on your storefront — listings with photos sell faster and build more trust.</div>
  </div>`,

  'import-data':`<div class="help-article">
    <h1>Importing Your Existing Data</h1>
    <div class="help-tag">Getting Started</div>
    <p>If you've been tracking watches in a spreadsheet, you can get all of that data into DialTrader using our import tool — and AI makes the conversion easy.</p>
    <h2>Step 1: Download the Template</h2>
    <p>Go to <strong>Import / Export</strong> in the sidebar and download the DialTrader CSV template. This shows you exactly what columns the system expects.</p>
    <h2>Step 2: Use AI to Convert Your Spreadsheet</h2>
    <p>Open ChatGPT or Claude and paste this prompt:</p>
    <div class="help-tip"><strong>Copy this prompt:</strong><br><br>"I have a watch inventory spreadsheet I need to convert to a specific CSV format. Here are the column headers I need in the output: brand, model, ref, serial, year, purchase_date, purchase_price, tax, shipping_in, other_fees, listed_price, condition, box_papers, notes<br><br>Here is my data: [paste your spreadsheet data here]<br><br>Please output only the CSV with these exact headers, no extra columns, dates in YYYY-MM-DD format, numbers with no dollar signs or commas."</div>
    <h2>Step 3: Review and Import</h2>
    <p>Copy the AI's CSV output, paste it into a text file, save as <code>.csv</code>, then use the Import tool to upload it. Review the preview before confirming.</p>
    <div class="help-warn"><strong>Note:</strong> The import tool adds watches to Inventory. For sold watches, use the Sold History import separately.</div>
  </div>`,

  'storefront-intro':`<div class="help-article">
    <h1>What Is the Storefront?</h1>
    <div class="help-tag">Your Storefront</div>
    <p>Every DialTrader account comes with a storefront template — a standalone public website that pulls your inventory and sold watches from your account in real time.</p>
    <h2>What It Shows</h2>
    <ul>
      <li>Your current inventory with photos, specs, and asking prices</li>
      <li>Brand filter, search, and sort controls</li>
      <li>Photo lightbox when visitors click a watch</li>
      <li>Contact/inquiry form for interested buyers</li>
      <li>Recently sold section (social proof)</li>
      <li>Sell Your Watch section</li>
    </ul>
    <h2>How It Stays Updated</h2>
    <p>The storefront reads directly from your Supabase database — the same one DialTrader uses. When you add a watch in the app, it appears on your storefront automatically. When you mark a watch sold, it moves to the Recently Sold section. No manual updates needed.</p>
    <div class="help-tip"><strong>Cost:</strong> Hosting your storefront is completely free using Vercel's hobby tier. See the Vercel setup guide for step-by-step instructions.</div>
  </div>`,

  'vercel-deploy':`<div class="help-article">
    <h1>Deploying Your Storefront on Vercel</h1>
    <div class="help-tag">Your Storefront</div>
    <p>Vercel is a free hosting platform that will serve your storefront to the world. This takes about 10 minutes.</p>
    <div class="help-tip"><strong>What you need:</strong> A free GitHub account and a free Vercel account. Both are at github.com and vercel.com.</div>
    <h2>Step 1: Get Your Storefront File</h2>
    <p>Download your storefront template from the Import / Export page. It's a single HTML file customized with your Supabase credentials.</p>
    <h2>Step 2: Create a GitHub Repository</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Go to github.com</strong><span>Sign in or create a free account.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Create a new repository</strong><span>Click the + icon → New repository. Name it anything (e.g. "my-watch-store"). Set it to Public. Click Create.</span></div></div>
    <div class="help-step"><div class="help-step-num">3</div><div class="help-step-body"><strong>Upload your file</strong><span>Click "uploading an existing file," drag in your storefront HTML file, rename it to <code>index.html</code>, and commit.</span></div></div>
    <h2>Step 3: Deploy on Vercel</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Go to vercel.com</strong><span>Sign in with your GitHub account.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Add New Project</strong><span>Click "Add New" → Project → Import your GitHub repo.</span></div></div>
    <div class="help-step"><div class="help-step-num">3</div><div class="help-step-body"><strong>Deploy</strong><span>Click Deploy. In about 30 seconds your site will be live at a <code>yourname.vercel.app</code> URL.</span></div></div>
    <h2>Updating Your Storefront</h2>
    <p>When you want to update the storefront (new theme, new features), just replace <code>index.html</code> in your GitHub repo. Vercel detects the change and redeploys automatically within a minute.</p>
  </div>`,

  'custom-domain':`<div class="help-article">
    <h1>Using Your Own Domain</h1>
    <div class="help-tag">Your Storefront</div>
    <p>If you have a domain name (e.g. <code>yourwatchbusiness.com</code>) you can point it to your Vercel storefront for free.</p>
    <div class="help-tip"><strong>Don't have a domain?</strong> Namecheap.com and Cloudflare Registrar both offer .com domains for around $10-12/year. This is worth it for a professional appearance.</div>
    <h2>Step 1: Add Domain in Vercel</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Open your project in Vercel</strong><span>Go to Settings → Domains.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Add your domain</strong><span>Type your domain name and click Add. Vercel will show you DNS records to configure.</span></div></div>
    <h2>Step 2: Update DNS at Your Registrar</h2>
    <p>Log into wherever you bought your domain (Namecheap, GoDaddy, Cloudflare, etc.) and add the DNS records Vercel shows you. This is usually either:</p>
    <ul>
      <li>An <strong>A record</strong> pointing to Vercel's IP address, or</li>
      <li>A <strong>CNAME record</strong> pointing to <code>cname.vercel-dns.com</code></li>
    </ul>
    <p>DNS changes take 5 minutes to 24 hours to propagate. Usually it's under 30 minutes.</p>
    <div class="help-tip"><strong>SSL is free and automatic.</strong> Vercel provisions an SSL certificate (the padlock in the browser) automatically once your DNS is pointed correctly. No setup needed.</div>
  </div>`,

  'storefront-themes':`<div class="help-article">
    <h1>Storefront Themes & Customization</h1>
    <div class="help-tag">Your Storefront</div>
    <p>Your storefront can be customized with different color schemes, font pairings, and hero images. Themes are coming as a built-in feature — for now, here are the manual customization options.</p>
    <h2>Color Schemes</h2>
    <p>At the top of your storefront file, find the <code>:root</code> CSS block. The key variables to change are:</p>
    <ul>
      <li><code>--bg</code> — main page background</li>
      <li><code>--charcoal</code> — header and card backgrounds</li>
      <li><code>--gold</code> and <code>--gold2</code> — accent colors</li>
      <li><code>--body-bg</code> — the light section background</li>
    </ul>
    <h2>Popular Color Combos</h2>
    <div class="help-tip"><strong>Classic Dark (default):</strong> --bg: #0A0A0A · --charcoal: #1A1A1A · --gold: #C89E2F · --gold2: #E5C15A</div>
    <div class="help-tip"><strong>Navy & Gold:</strong> --bg: #0A1628 · --charcoal: #0F2040 · --gold: #C89E2F · --gold2: #E5C15A</div>
    <div class="help-tip"><strong>Forest & Cream:</strong> --bg: #1A2418 · --charcoal: #232E21 · --gold: #8FB87A · --gold2: #B5D4A0</div>
    <h2>Font Pairings</h2>
    <p>The storefront uses Google Fonts. Replace the font import link and update <code>font-family</code> references in CSS:</p>
    <ul>
      <li><strong>Current (Luxury):</strong> Playfair Display + Raleway</li>
      <li><strong>Modern:</strong> Cormorant Garamond + Jost</li>
      <li><strong>Bold:</strong> Libre Baskerville + Source Sans 3</li>
      <li><strong>Minimal:</strong> DM Serif Display + DM Sans</li>
    </ul>
    <h2>Hero Background Photo</h2>
    <p>Find <code>.hero-bg</code> in the CSS. Replace the Unsplash URL with any image URL. For best results use a landscape photo at least 1600px wide. Free options: <a href="https://unsplash.com" target="_blank">unsplash.com</a> (search "luxury watch").</p>
  </div>`,

  'pipeline':`<div class="help-article">
    <h1>The 10-Stage Deal Pipeline</h1>
    <div class="help-tag">Features</div>
    <p>Every watch in your inventory moves through a 10-stage pipeline that tracks exactly where it is in your trading workflow.</p>
    <h2>The Stages</h2>
    <ol>
      <li><strong>Purchased — Awaiting Payment</strong> — Deal struck, waiting to pay seller</li>
      <li><strong>Paid — Shipping to Me</strong> — Payment sent, watch in transit</li>
      <li><strong>In Hand — Cleaning / Service</strong> — Watch received, being prepared</li>
      <li><strong>Photography / Prep for Listing</strong> — Shooting photos, writing description</li>
      <li><strong>Listed — Active on Platforms</strong> — Watch is live and for sale</li>
      <li><strong>Offer Accepted — Pending Authentication</strong> — Buyer found, deal in progress</li>
      <li><strong>Authentication — Shipped to Auth</strong> — Watch sent for authentication</li>
      <li><strong>Awaiting Payment from Buyer</strong> — Auth passed, waiting on buyer's payment</li>
      <li><strong>Shipped to Buyer</strong> — Payment received, watch shipped out</li>
      <li><strong>Closed / Complete</strong> — Deal done, ready to mark as sold</li>
    </ol>
    <div class="help-tip"><strong>Tip:</strong> Once a watch reaches Stage 10, click Edit and use the Mark as Sold tab to move it to your Sold History and record the final sale details.</div>
  </div>`,

  'invoices':`<div class="help-article">
    <h1>Creating Invoices</h1>
    <div class="help-tag">Features</div>
    <p>DialTrader generates clean, professional invoices with your business branding. Your name, address, email, and payment info all pull from your Settings profile automatically.</p>
    <h2>Sending an Invoice</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Go to Invoices → + New Invoice</strong><span>Fill in the buyer's name and billing info.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Add line items</strong><span>Add the watch description, quantity, and price. You can add multiple line items.</span></div></div>
    <div class="help-step"><div class="help-step-num">3</div><div class="help-step-body"><strong>Enable payment methods</strong><span>Check Zelle and/or Apple Pay to show your payment info on the invoice.</span></div></div>
    <div class="help-step"><div class="help-step-num">4</div><div class="help-step-body"><strong>Preview and Print/PDF</strong><span>Click Preview, then use Print / PDF to save as a PDF you can email.</span></div></div>
    <div class="help-tip"><strong>Received Invoices:</strong> Use the Received tab in Invoices to store invoices you receive from sellers when buying watches. Upload the PDF or image and link it to the watch in your inventory for a complete paper trail.</div>
  </div>`,

  'photos':`<div class="help-article">
    <h1>Photo Management</h1>
    <div class="help-tag">Features</div>
    <p>Each watch supports up to 8 photos. Photos are stored in the cloud and automatically appear on your storefront.</p>
    <h2>Adding Photos</h2>
    <p>Open any watch in Inventory or Sold History → Photos tab. Click the upload area or drag and drop images. JPG and PNG are supported.</p>
    <h2>Ordering Photos</h2>
    <p>Drag photos to reorder them. The first photo is your main listing image — it shows as the thumbnail in the inventory grid and as the hero image on your storefront.</p>
    <h2>Deleting Photos</h2>
    <p>Hover over any photo and click the red ✕ button to remove it. Click Save Photos to confirm.</p>
    <div class="help-tip"><strong>Photo Tips for Watch Trading:</strong> Dial straight-on, case at 3/4 angle, caseback, crown/pushers, bracelet clasp, box & papers laid out. 6 photos covers most buyers' questions before they even ask.</div>
    <div class="help-warn"><strong>HEIC files (iPhone):</strong> Export your iPhone photos as JPG in your phone's settings (Settings → Camera → Formats → Most Compatible) or convert to JPG before uploading.</div>
  </div>`,

  'crm':`<div class="help-article">
    <h1>CRM & Contacts</h1>
    <div class="help-tag">Features</div>
    <p>DialTrader keeps a running database of everyone you buy from and sell to, with a full transaction history for each person.</p>
    <h2>Adding Contacts</h2>
    <p>Contacts are added automatically when you enter buyer/seller info on a watch, or you can add them manually in the Contacts page.</p>
    <h2>Transaction History</h2>
    <p>Click any contact to see every watch you've bought from them or sold to them — with dates and prices. This is invaluable for knowing who your best repeat buyers are and who you've done the most volume with.</p>
    <div class="help-tip"><strong>Tip:</strong> When adding a watch, always fill in the Contacts tab with the seller's info. This builds your rolodex automatically over time.</div>
  </div>`,

  'tax':`<div class="help-article">
    <h1>Tax Reporting</h1>
    <div class="help-tag">Features</div>
    <p>The Tax Report page generates a P&L summary of all your sold watches for any year. It's designed to give your accountant exactly what they need.</p>
    <h2>What It Shows</h2>
    <ul>
      <li>Total gross sales</li>
      <li>Total cost of goods (purchase price + fees + shipping + tax paid)</li>
      <li>Platform fees and payment fees paid</li>
      <li>Net profit</li>
      <li>Per-watch breakdown</li>
    </ul>
    <h2>Exporting</h2>
    <p>Click <strong>Export CSV</strong> to download a spreadsheet version, or <strong>Print Report</strong> to save as PDF. Both are formatted for easy hand-off to an accountant.</p>
    <div class="help-tip"><strong>Important:</strong> Keep this report in mind throughout the year — every purchase cost, shipping fee, and platform fee you record in DialTrader reduces your taxable profit at year end. The more complete your data, the lower your tax bill.</div>
  </div>`,

  'plans':`<div class="help-article">
    <h1>Membership Plans</h1>
    <div class="help-tag">Getting Started</div>
    <p>DialTrader has two membership tiers. Both give you the full trading app — the difference is whether you get a public-facing storefront website.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin:1.5rem 0">
      <div style="border:1px solid var(--border);padding:1.25rem">
        <div style="font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--text2);margin-bottom:0.5rem">Starter Plan</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--text1);margin-bottom:0.75rem">App Only</div>
        <ul style="margin:0 0 0 1.25rem;font-size:0.8rem;color:var(--text2);line-height:2">
          <li>Full inventory management</li>
          <li>10-stage deal pipeline</li>
          <li>Professional invoices</li>
          <li>CRM &amp; contacts</li>
          <li>Photo management (8 per watch)</li>
          <li>Tax reporting &amp; export</li>
          <li>Spreadsheet import</li>
        </ul>
        <div style="margin-top:1rem;font-size:0.72rem;color:var(--text2)">No public storefront. Great for traders who use their own website or sell via social media.</div>
      </div>
      <div style="border:1px solid var(--gold2);padding:1.25rem;background:rgba(184,148,58,0.04)">
        <div style="font-size:0.6rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold2);margin-bottom:0.5rem">Professional Plan</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--text1);margin-bottom:0.75rem">App + Storefront</div>
        <ul style="margin:0 0 0 1.25rem;font-size:0.8rem;color:var(--text2);line-height:2">
          <li>Everything in Starter, plus:</li>
          <li>Public storefront website</li>
          <li>Live inventory sync (auto-updates)</li>
          <li>6 color themes + 5 font pairs</li>
          <li>Custom domain support</li>
          <li>Buy/sell inquiry forms</li>
          <li>Recently sold section</li>
        </ul>
        <div style="margin-top:1rem;font-size:0.72rem;color:var(--text2)">Your own professional watch dealer website, hosted free on Vercel. No technical setup required beyond a 10-minute Vercel deploy.</div>
      </div>
    </div>
    <div class="help-tip"><strong>Upgrading or questions:</strong> Contact us at hello@dialtrader.com to change your plan. Your data stays exactly as-is when you switch.</div>
  </div>`,

  'storefront-intro':`<div class="help-article">
    <h1>What Is the Storefront?</h1>
    <div class="help-tag">Your Storefront · Professional Plan</div>
    <p>The DialTrader storefront is a standalone public website that shows your current inventory and recently sold watches in real time — automatically, with no manual updates ever needed.</p>
    <h2>How It Works</h2>
    <p>When you add a watch in the DialTrader app, it appears on your storefront immediately. When you mark it sold, it moves to the Recently Sold section. The storefront reads directly from the DialTrader database using your account — nothing to sync, nothing to publish manually.</p>
    <div class="help-tip"><strong>No separate database setup needed.</strong> Your storefront connects to DialTrader's existing database automatically. The file you download from My Storefront already has everything it needs — you just host it.</div>
    <h2>What Visitors See</h2>
    <ul>
      <li>Your full inventory with photos, specs, and asking prices</li>
      <li>Brand filter, search, and sort controls</li>
      <li>Photo lightbox on every listing</li>
      <li>Email and SMS inquiry buttons</li>
      <li>Sell Your Watch form for sourcing leads</li>
      <li>Recently Sold section (builds trust)</li>
      <li>Your business name, location, and contact info</li>
    </ul>
    <h2>What You Need</h2>
    <ul>
      <li>A free <strong>GitHub</strong> account — github.com</li>
      <li>A free <strong>Vercel</strong> account — vercel.com (sign in with GitHub)</li>
      <li>Optionally: a custom domain (~$10/year)</li>
    </ul>
    <p>See <strong>Deploying on Vercel</strong> for the full step-by-step walkthrough.</p>
  </div>`,

  'vercel-deploy':`<div class="help-article">
    <h1>Deploying Your Storefront on Vercel</h1>
    <div class="help-tag">Your Storefront · Professional Plan</div>
    <p>This walks you through getting your storefront live from scratch. Takes about 10 minutes. Everything is free.</p>

    <h2>Before You Start</h2>
    <p>You need two free accounts: <a href="https://github.com" target="_blank">GitHub</a> (for storing your file) and <a href="https://vercel.com" target="_blank">Vercel</a> (for hosting it). If you don't have them, create them now — both take about 2 minutes.</p>

    <h2>Part 1 — Download Your File</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Go to My Storefront in the sidebar</strong><span>Pick your color theme, font pairing, and hero photo. Your business info from Settings is baked in automatically.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Click "Download Storefront"</strong><span>A single HTML file downloads to your computer. This file is your entire website — it connects to DialTrader automatically, no extra setup.</span></div></div>
    <div class="help-step"><div class="help-step-num">3</div><div class="help-step-body"><strong>Rename it to <code>index.html</code></strong><span>Vercel requires the homepage to be named exactly <code>index.html</code>. Rename it before uploading.</span></div></div>

    <h2>Part 2 — Create a GitHub Repository</h2>
    <div class="help-step"><div class="help-step-num">4</div><div class="help-step-body"><strong>Sign in to GitHub and click the + icon</strong><span>Top right corner → New repository.</span></div></div>
    <div class="help-step"><div class="help-step-num">5</div><div class="help-step-body"><strong>Name your repository and create it</strong><span>Call it anything — e.g. <code>my-watch-store</code>. Set to <strong>Public</strong>. Leave everything else default. Click <strong>Create repository</strong>.</span></div></div>
    <div class="help-step"><div class="help-step-num">6</div><div class="help-step-body"><strong>Upload your index.html</strong><span>On the new repo page, click the link that says <strong>"uploading an existing file"</strong>. Drag your <code>index.html</code> into the upload area. Scroll down and click <strong>Commit changes</strong>.</span></div></div>

    <h2>Part 3 — Deploy on Vercel</h2>
    <div class="help-step"><div class="help-step-num">7</div><div class="help-step-body"><strong>Go to vercel.com and sign in with GitHub</strong><span>Authorizing with GitHub lets Vercel see your repositories automatically.</span></div></div>
    <div class="help-step"><div class="help-step-num">8</div><div class="help-step-body"><strong>Click Add New → Project</strong><span>Find your repository in the list (e.g. <code>my-watch-store</code>) and click <strong>Import</strong>.</span></div></div>
    <div class="help-step"><div class="help-step-num">9</div><div class="help-step-body"><strong>Click Deploy</strong><span>Leave all settings as defaults. Vercel detects it's a static site automatically. In about 30 seconds you'll see a success screen with your live URL — something like <code>my-watch-store.vercel.app</code>.</span></div></div>

    <div class="help-tip"><strong>You're live.</strong> Share your Vercel URL right away. You can add a custom domain at any time — instructions are in the Custom Domain guide.</div>

    <h2>Updating Your Storefront Later</h2>
    <p>Whenever you want a new theme, or after updating your profile info in Settings: go to My Storefront, download a fresh file, rename it <code>index.html</code>, and replace the file in your GitHub repo (upload → commit). Vercel redeploys automatically within about a minute.</p>
  </div>`,

  'custom-domain':`<div class="help-article">
    <h1>Using Your Own Domain</h1>
    <div class="help-tag">Your Storefront · Professional Plan</div>
    <p>A custom domain like <code>jacksonwatches.com</code> looks professional and is easy for buyers to remember. Cost: ~$10–12/year. Setup takes about 15 minutes.</p>

    <h2>Step 1 — Buy a Domain (if you don't have one)</h2>
    <p>We recommend <strong>Cloudflare Registrar</strong> at cloudflare.com — they sell at cost, typically $8–10/year for a .com with no markup. Namecheap is also good at ~$11–12/year. Avoid GoDaddy — renewal prices jump significantly after the first year.</p>
    <div class="help-tip"><strong>Domain name ideas:</strong> yourname-watches.com · yourlastnamewatches.com · yourcitywatches.com · or match your Instagram handle.</div>

    <h2>Step 2 — Add the Domain in Vercel</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Open your Vercel project</strong><span>Go to vercel.com → click your project → <strong>Settings</strong> tab → <strong>Domains</strong> in the left menu.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Type your domain and click Add</strong><span>Enter your domain (e.g. <code>jacksonwatches.com</code>). Vercel will show you the DNS records you need to add. Keep this page open.</span></div></div>

    <h2>Step 3 — Add DNS Records at Your Registrar</h2>
    <p>Log into wherever you bought your domain and add these two records. The exact menu location varies by registrar but is usually under <strong>DNS</strong> or <strong>DNS Management</strong>.</p>

    <div class="help-warn"><strong>Record 1 — A Record (root domain)</strong><br>Type: <strong>A</strong> &nbsp;·&nbsp; Name/Host: <code>@</code> &nbsp;·&nbsp; Value/Points to: <code>76.76.21.21</code> &nbsp;·&nbsp; TTL: Auto or 3600</div>
    <div class="help-warn"><strong>Record 2 — CNAME Record (www subdomain)</strong><br>Type: <strong>CNAME</strong> &nbsp;·&nbsp; Name/Host: <code>www</code> &nbsp;·&nbsp; Value/Points to: <code>cname.vercel-dns.com</code> &nbsp;·&nbsp; TTL: Auto or 3600</div>

    <p>If you registered with <strong>Cloudflare</strong>: make sure both records are set to <strong>DNS only</strong> (grey cloud icon, not orange). The orange proxy cloud will break Vercel's SSL certificate.</p>

    <h2>Step 4 — Wait for DNS Propagation</h2>
    <p>DNS changes usually go live in 5–30 minutes, sometimes up to a few hours. Once active, Vercel automatically provisions a free SSL certificate — your site will be at <code>https://yourdomain.com</code> with the padlock showing.</p>
    <div class="help-tip"><strong>Check propagation status:</strong> Go to <a href="https://dnschecker.org" target="_blank">dnschecker.org</a>, enter your domain, and look for <code>76.76.21.21</code> showing up in most locations. Once you see it, your domain is live.</div>
    <div class="help-tip"><strong>Vercel shows a warning?</strong> If Vercel says the domain isn't configured yet, wait 15 minutes and refresh — DNS just needs time to propagate globally.</div>
  </div>`,

  'storefront-themes':`<div class="help-article">
    <h1>Themes &amp; Customization</h1>
    <div class="help-tag">Your Storefront · Professional Plan</div>
    <p>Customize your storefront's look from the <strong>My Storefront</strong> page in the sidebar. The right panel shows a live preview that updates instantly as you pick options.</p>

    <h2>Color Themes</h2>
    <ul>
      <li><strong>Classic Dark</strong> — Dark charcoal header, warm cream body, gold accents. The default DialTrader look.</li>
      <li><strong>Navy &amp; Gold</strong> — Deep navy header, blue-grey body. Clean and nautical.</li>
      <li><strong>Full Dark</strong> — All dark. Best if your photos have dark backgrounds.</li>
      <li><strong>Forest &amp; Cream</strong> — Deep green header, warm cream body, sage green accents. Distinctive.</li>
      <li><strong>Slate &amp; Copper</strong> — Dark slate header, warm body, copper accents. Earthy and bold.</li>
      <li><strong>Midnight Silver</strong> — Near-black header, light grey body, silver-blue accents. Modern and cool.</li>
    </ul>

    <h2>Font Pairings</h2>
    <ul>
      <li><strong>Playfair + Raleway</strong> — Classic luxury. Works for any watch business style.</li>
      <li><strong>Cormorant + Jost</strong> — Refined editorial. Good for high-end or vintage dealers.</li>
      <li><strong>Libre Baskerville + Source Sans</strong> — Bold and clear. Good for high-volume traders.</li>
      <li><strong>DM Serif + DM Sans</strong> — Clean minimal. Contemporary feel.</li>
      <li><strong>Crimson Pro + Nunito</strong> — Warm and approachable. Great for relationship-focused dealers.</li>
    </ul>

    <h2>Hero Background Photo</h2>
    <p>Six built-in watch photography options are included. You can also paste any image URL into the custom field at the bottom of the hero section. For the best result use a landscape photo at least 1600px wide. <a href="https://unsplash.com/s/photos/luxury-watch" target="_blank">Unsplash.com</a> has excellent free options — search "luxury watch" or "watch close up".</p>

    <h2>Business Info on Your Storefront</h2>
    <p>Your business name, phone, email, address, and any contact links come from your <strong>Settings</strong> profile. Update your profile there, then re-download and redeploy your storefront to push the changes live.</p>

    <h2>After Customizing</h2>
    <p>Click <strong>Download Storefront</strong>, rename the file to <code>index.html</code>, and replace the existing file in your GitHub repo. Vercel redeploys automatically in about a minute.</p>
  </div>`,

  'import-data':`<div class="help-article">
    <h1>Importing Your Existing Data</h1>
    <div class="help-tag">Getting Started</div>
    <p>If you've been tracking watches in a spreadsheet, the <strong>Import / Export</strong> page has everything you need — including a ready-made AI prompt that converts your spreadsheet format to DialTrader's format automatically.</p>

    <h2>Using the AI Conversion (Recommended)</h2>
    <div class="help-step"><div class="help-step-num">1</div><div class="help-step-body"><strong>Go to Import / Export in the sidebar</strong><span>Click the Copy button on the AI prompt box at the top of the page.</span></div></div>
    <div class="help-step"><div class="help-step-num">2</div><div class="help-step-body"><strong>Open ChatGPT or Claude</strong><span>Go to chat.openai.com or claude.ai — both are free. Paste the prompt.</span></div></div>
    <div class="help-step"><div class="help-step-num">3</div><div class="help-step-body"><strong>Add your spreadsheet data</strong><span>Replace the placeholder text at the bottom of the prompt with your actual data — copy from Excel or Google Sheets and paste it in directly.</span></div></div>
    <div class="help-step"><div class="help-step-num">4</div><div class="help-step-body"><strong>Save the output as a .csv file</strong><span>Copy the AI's response into Notepad (Windows) or TextEdit (Mac). Save as <code>my-inventory.csv</code>.</span></div></div>
    <div class="help-step"><div class="help-step-num">5</div><div class="help-step-body"><strong>Drop the file into the import zone</strong><span>DialTrader shows a preview before importing. Review it, then click Confirm to import all rows.</span></div></div>

    <div class="help-tip"><strong>If the AI output has <code>&#96;&#96;&#96;</code> marks at the top and bottom, delete those two lines. Keep only the comma-separated rows starting with the header.</div>

    <h2>Manual Template</h2>
    <p>Prefer to do it yourself? Click <strong>Download Template</strong> to get a CSV with the correct headers and two example rows. Fill it in with your watches (one per row), save as CSV, and drop it in the import zone.</p>

    <h2>Sold History</h2>
    <p>There's a separate AI prompt and import zone for sold watches. The sold template includes sale date, sold price, and fee fields in addition to the watch specs.</p>

    <h2>After Importing</h2>
    <p>Photos are not imported — they'll need to be added manually to watches that need them. All other data (brand, model, ref, prices, dates, notes) comes in exactly as entered. Check the Inventory page after import to confirm everything looks right.</p>
  </div>`
};

let currentHelpArticle='welcome';
function showHelp(key){
  currentHelpArticle=key;
  document.querySelectorAll('.help-nav-item').forEach(i=>i.classList.remove('active'));
  document.querySelector(`.help-nav-item[onclick="showHelp('${key}')"]`)?.classList.add('active');
  const area=document.getElementById('help-content-area');
  area.innerHTML=HELP_ARTICLES[key]||'<div class="help-article"><h1>Coming Soon</h1><p>This article is being written.</p></div>';
  area.scrollTop=0;
}


// ── NOTES / ACTIVITY LOG ─────────────────────────
let currentWatchId=null;
let watchNotes={};

async function loadNotesForWatch(id){
  const{data}=await db.from('watch_notes').select('*').eq('watch_id',id).order('created_at',{ascending:false});
  watchNotes[id]=data||[];
  renderNotesList(id);
}

function renderNotesList(id){
  const notes=watchNotes[id]||[];
  const list=document.getElementById('notes-list');
  const empty=document.getElementById('notes-empty');
  if(!list)return;
  if(!notes.length){list.innerHTML='';if(empty)empty.style.display='block';return;}
  if(empty)empty.style.display='none';
  list.innerHTML=notes.map(n=>`
    <div class="note-item" id="note-${n.id}">
      <div class="note-body">
        <div class="note-text" id="note-text-${n.id}">${escHtml(n.text)}</div>
        <div class="note-meta">${fmtNoteDate(n.created_at)}${n.updated_at&&n.updated_at!==n.created_at?' · edited':''}</div>
      </div>
      <div class="note-actions">
        <button class="note-btn" onclick="editNote('${n.id}','${id}')">Edit</button>
        <button class="note-btn red" onclick="deleteNote('${n.id}','${id}')">✕</button>
      </div>
    </div>`).join('');
}

function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtNoteDate(ts){
  if(!ts)return'';
  const d=new Date(ts);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
}

async function addWatchNote(){
  const inp=document.getElementById('note-input');
  const text=(inp.value||'').trim();
  if(!text||!currentWatchId)return;
  inp.value='';
  const{data,error}=await db.from('watch_notes').insert({watch_id:currentWatchId,user_id:currentUser.id,text}).select().single();
  if(error){showToast('Error: '+error.message);return;}
  if(!watchNotes[currentWatchId])watchNotes[currentWatchId]=[];
  watchNotes[currentWatchId].unshift(data);
  renderNotesList(currentWatchId);
}

function editNote(noteId,watchId){
  const textEl=document.getElementById(`note-text-${noteId}`);
  const note=watchNotes[watchId]?.find(n=>n.id===noteId);
  if(!textEl||!note)return;
  textEl.outerHTML=`<textarea class="note-edit-ta" id="note-edit-${noteId}" rows="3">${escHtml(note.text)}</textarea>`;
  const item=document.getElementById(`note-${noteId}`);
  item.querySelector('.note-actions').innerHTML=`
    <button class="note-btn" onclick="saveNote('${noteId}','${watchId}')">Save</button>
    <button class="note-btn" onclick="renderNotesList('${watchId}')">Cancel</button>`;
}

async function saveNote(noteId,watchId){
  const ta=document.getElementById(`note-edit-${noteId}`);
  const text=(ta?.value||'').trim();if(!text)return;
  const{error}=await db.from('watch_notes').update({text,updated_at:new Date().toISOString()}).eq('id',noteId);
  if(error){showToast('Error: '+error.message);return;}
  const note=watchNotes[watchId]?.find(n=>n.id===noteId);
  if(note){note.text=text;note.updated_at=new Date().toISOString();}
  renderNotesList(watchId);
}

async function deleteNote(noteId,watchId){
  if(!confirm('Delete this note?'))return;
  const{error}=await db.from('watch_notes').delete().eq('id',noteId);
  if(error){showToast('Error: '+error.message);return;}
  watchNotes[watchId]=(watchNotes[watchId]||[]).filter(n=>n.id!==noteId);
  renderNotesList(watchId);
}

// ── TRASH BIN ────────────────────────────────────
let trashItems=[];
const TRASH_DAYS=14;

async function loadTrash(){
  const{data}=await db.from('deleted_watches').select('*').eq('user_id',currentUser.id).order('deleted_at',{ascending:false});
  trashItems=data||[];
  updateTrashBadges();
}

function updateTrashBadges(){
  const invCount=trashItems.filter(t=>t.type==='inventory').length;
  const soldCount=trashItems.filter(t=>t.type==='sold').length;
  const ib=document.getElementById('inv-trash-badge');
  const sb=document.getElementById('sold-trash-badge');
  if(ib){ib.textContent=invCount;ib.style.display=invCount?'inline':'';}
  if(sb){sb.textContent=soldCount;sb.style.display=soldCount?'inline':'';}
}

async function softDelete(id,type){
  const list=type==='inventory'?inventory:soldWatches;
  const watch=list.find(w=>w.id===id);if(!watch)return;
  const label=`${watch.brand||''} ${watch.model||''}`.trim();
  if(!confirm(`Move "${label}" to Trash? You have ${TRASH_DAYS} days to restore it.`))return;
  const expires=new Date(Date.now()+TRASH_DAYS*86400000).toISOString();
  const{error:insErr}=await db.from('deleted_watches').insert({
    user_id:currentUser.id,original_id:id,type,data:watch,
    deleted_at:new Date().toISOString(),expires_at:expires
  });
  if(insErr){showToast('Error: '+insErr.message);return;}
  const table=type==='inventory'?'inventory':'sold_inventory';
  await db.from(table).delete().eq('id',id);
  if(type==='inventory')inventory=inventory.filter(w=>w.id!==id);
  else soldWatches=soldWatches.filter(w=>w.id!==id);
  await loadTrash();refreshAll();
  showToast(`"${label}" moved to Trash. Restore within ${TRASH_DAYS} days.`);
}

async function restoreWatch(trashId){
  const item=trashItems.find(t=>t.id===trashId);if(!item)return;
  const table=item.type==='inventory'?'inventory':'sold_inventory';
  const rowData={...item.data};delete rowData.id;
  const{data:restored,error}=await db.from(table).insert(rowData).select().single();
  if(error){showToast('Error restoring: '+error.message);return;}
  await db.from('deleted_watches').delete().eq('id',trashId);
  if(item.type==='inventory')inventory.unshift(restored);
  else soldWatches.unshift(restored);
  trashItems=trashItems.filter(t=>t.id!==trashId);
  updateTrashBadges();refreshAll();
  showToast(`Watch restored to ${item.type==='inventory'?'Inventory':'Sold History'}.`);
}

async function permanentDelete(trashId){
  if(!confirm('Permanently delete? This cannot be undone.'))return;
  await db.from('deleted_watches').delete().eq('id',trashId);
  trashItems=trashItems.filter(t=>t.id!==trashId);
  updateTrashBadges();
  // Re-render whichever bin is open
  ['inv-trash','sold-trash'].forEach(id=>{
    const el=document.getElementById(id);
    if(el&&el.style.display!=='none')renderTrashBin(id);
  });
  showToast('Permanently deleted.');
}

function renderTrashBin(binId){
  const el=document.getElementById(binId);if(!el)return;
  const type=binId.startsWith('sold')?'sold':'inventory';
  const items=trashItems.filter(t=>t.type===type);
  if(!items.length){el.innerHTML='<div style="padding:1rem;font-size:0.78rem;color:var(--text2);text-align:center">Trash is empty</div>';return;}
  const now=Date.now();
  el.innerHTML='<div class="trash-list">'+items.map(t=>{
    const w=t.data||{};
    const daysLeft=Math.max(0,Math.ceil((new Date(t.expires_at)-now)/86400000));
    return`<div class="trash-row">
      <div><div class="trash-name">${w.brand||''} ${w.model||''}</div><div class="trash-sub">${w.ref?'Ref: '+w.ref:''}</div></div>
      <div class="trash-type">${type==='sold'?'Sold':'Inventory'}</div>
      <div class="trash-expiry">${daysLeft}d left</div>
      <div class="trash-actions">
        <button class="btn-restore" onclick="restoreWatch('${t.id}')">Restore</button>
        <button class="trash-perm-btn" onclick="permanentDelete('${t.id}')" title="Permanently delete">🗑</button>
      </div>
    </div>`;
  }).join('')+'</div>';
}

function toggleTrash(binId){
  const el=document.getElementById(binId);if(!el)return;
  const showing=el.style.display!=='none';
  el.style.display=showing?'none':'block';
  if(!showing)renderTrashBin(binId);
}

// ── MOBILE BOTTOM NAV ────────────────────────────
function bNav(page){
  closeMore();showPage(page);
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('bnav-'+page);
  if(btn)btn.classList.add('active');
  else document.getElementById('bnav-more')?.classList.add('active');
}
function moreNav(page){
  closeMore();showPage(page);
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('bnav-more')?.classList.add('active');
}
function toggleMore(){
  const m=document.getElementById('more-menu'),o=document.getElementById('more-overlay');
  const open=m.classList.toggle('open');
  o.classList.toggle('open',open);
}
function closeMore(){
  document.getElementById('more-menu')?.classList.remove('open');
  document.getElementById('more-overlay')?.classList.remove('open');
}


// ── MOBILE NAV ────────────────────────────────────────
const MOB_MAIN_TABS = ['dashboard','inventory','contacts','invoices'];
function mobNav(name){
  document.getElementById('mob-more-menu').classList.remove('open');
  showPage(name);
  document.querySelectorAll('.mob-tab').forEach(t=>t.classList.remove('active'));
  const btn = document.getElementById('mobt-'+name);
  if(btn) btn.classList.add('active');
  else document.getElementById('mobt-more').classList.add('active');
}
function toggleMobMore(){
  document.getElementById('mob-more-menu').classList.toggle('open');
}
// Sync sidebar nav clicks to also update mob nav
const _origShowPage = showPage;
function showPage(name){
  _origShowPage(name);
  if(window.innerWidth <= 768){
    document.querySelectorAll('.mob-tab').forEach(t=>t.classList.remove('active'));
    const btn = document.getElementById('mobt-'+name);
    if(btn) btn.classList.add('active');
    else document.getElementById('mobt-more') && document.getElementById('mobt-more').classList.add('active');
    document.getElementById('mob-more-menu').classList.remove('open');
  }
}
document.addEventListener('click', e=>{
  const menu = document.getElementById('mob-more-menu');
  if(menu && !menu.contains(e.target) && !e.target.closest('.mob-tab[onclick*="toggleMobMore"]')){
    menu.classList.remove('open');
  }
});

// ── CONTACTS LIST VIEW ────────────────────────────────
function renderContacts(){
  const q=(document.getElementById('contact-search').value||'').toLowerCase();
  const f=contacts.filter(c=>`${c.name} ${c.email||''} ${c.phone||''}`.toLowerCase().includes(q));
  document.getElementById('contacts-subtitle').textContent=`${contacts.length} contacts`;
  const grid=document.getElementById('contacts-grid');
  const empty=document.getElementById('contacts-empty');
  if(!f.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  // Sort alphabetically
  const sorted = [...f].sort((a,b)=>a.name.localeCompare(b.name));
  grid.innerHTML='<div class="contact-list">' + sorted.map(c=>{
    const bought=inventory.filter(w=>w.contact_id===c.id);
    const sold2=soldWatches.filter(w=>w.contact_id===c.id);
    const txns = bought.length + sold2.length;
    const isBuyer=sold2.length>0, isSeller=bought.length>0;
    const tag=isBuyer&&isSeller?'both':isBuyer?'buyer':isSeller?'seller':'';
    const tagLabel=tag==='both'?'Buyer & Seller':tag==='buyer'?'Buyer':tag==='seller'?'Seller':'';
    const initials = c.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    const sub = [c.phone, c.email].filter(Boolean).join(' · ');
    return `<div class="contact-list-item" onclick="showContactDetail('${c.id}')">
      <div class="contact-list-avatar">${initials}</div>
      <div class="contact-list-info">
        <div class="contact-list-name">${c.name}</div>
        ${sub ? `<div class="contact-list-sub">${sub}</div>` : ''}
      </div>
      <div class="contact-list-meta">
        ${tag ? `<span class="contact-tag ${tag}">${tagLabel}</span>` : ''}
        <span class="contact-list-txn">${txns ? txns+' transaction'+(txns!==1?'s':'') : 'No transactions'}</span>
      </div>
    </div>`;
  }).join('') + '</div>';
}

// ── NOTES / ACTIVITY LOG ──────────────────────────────
let watchNotes = []; // loaded per watch
let editingNoteId = null;

async function loadWatchNotes(watchId){
  watchNotes = [];
  if(!watchId) return;
  const {data} = await db.from('watch_notes')
    .select('*')
    .eq('watch_id', watchId)
    .order('created_at', {ascending: false});
  watchNotes = data || [];
  renderNotes();
}

function renderNotes(){
  const list = document.getElementById('notes-list');
  if(!list) return;
  if(!watchNotes.length){
    list.innerHTML = '<div style="font-size:0.78rem;color:var(--text2);text-align:center;padding:2rem">No notes yet. Add the first one above.</div>';
    return;
  }
  list.innerHTML = watchNotes.map(n=>`
    <div class="note-entry" id="note-${n.id}">
      <div class="note-ts">${new Date(n.created_at).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'})}</div>
      <div class="note-body" id="note-body-${n.id}">${escHtml(n.body)}</div>
      <div class="note-actions">
        <button class="note-edit-btn" onclick="editNote('${n.id}')">Edit</button>
        <button class="note-del-btn" onclick="deleteNote('${n.id}')">Delete</button>
      </div>
    </div>`).join('');
}

function escHtml(str){ return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function addWatchNote(){
  const inp = document.getElementById('note-input');
  const body = (inp.value||'').trim();
  if(!body) return;
  const watchId = editingId;
  if(!watchId){ showToast('Save the watch first before adding notes.'); return; }
  const {data, error} = await db.from('watch_notes').insert({
    watch_id: watchId, user_id: currentUser.id, body
  }).select().single();
  if(error){ showToast('Error: '+error.message); return; }
  watchNotes.unshift(data);
  renderNotes();
  inp.value = '';
}

async function editNote(id){
  const note = watchNotes.find(n=>n.id===id);
  if(!note) return;
  const bodyEl = document.getElementById('note-body-'+id);
  const current = note.body;
  // Replace body with inline textarea
  bodyEl.innerHTML = `<textarea class="form-textarea" id="note-edit-${id}" style="width:100%;min-height:60px;margin-bottom:0.4rem">${escHtml(current)}</textarea>
    <div style="display:flex;gap:0.4rem">
      <button class="note-edit-btn" onclick="saveNoteEdit('${id}')">Save</button>
      <button class="note-del-btn" onclick="renderNotes()">Cancel</button>
    </div>`;
}

async function saveNoteEdit(id){
  const ta = document.getElementById('note-edit-'+id);
  const body = (ta?.value||'').trim();
  if(!body) return;
  const {error} = await db.from('watch_notes').update({body}).eq('id',id);
  if(error){ showToast('Error: '+error.message); return; }
  watchNotes = watchNotes.map(n=>n.id===id ? {...n, body} : n);
  renderNotes();
}

async function deleteNote(id){
  if(!confirm('Delete this note?')) return;
  await db.from('watch_notes').delete().eq('id',id);
  watchNotes = watchNotes.filter(n=>n.id!==id);
  renderNotes();
}

// ── TRASH BIN ────────────────────────────────────────
const TRASH_DAYS = 14;
let trashedItems = [];

async function loadTrash(){
  const cutoff = new Date(Date.now() - TRASH_DAYS * 24*60*60*1000).toISOString();
  // Auto-purge expired items first
  await db.from('inventory').delete().eq('user_id',currentUser.id).eq('trashed',true).lt('trashed_at',cutoff);
  await db.from('sold_inventory').delete().eq('user_id',currentUser.id).eq('trashed',true).lt('trashed_at',cutoff);
  // Load remaining trash
  const [invT, soldT] = await Promise.all([
    db.from('inventory').select('*').eq('user_id',currentUser.id).eq('trashed',true).order('trashed_at',{ascending:false}),
    db.from('sold_inventory').select('*').eq('user_id',currentUser.id).eq('trashed',true).order('trashed_at',{ascending:false})
  ]);
  trashedItems = [
    ...(invT.data||[]).map(w=>({...w, _type:'inventory'})),
    ...(soldT.data||[]).map(w=>({...w, _type:'sold'}))
  ].sort((a,b)=>new Date(b.trashed_at)-new Date(a.trashed_at));
}

function showTrash(){
  document.getElementById('trash-overlay').style.display='flex';
  renderTrash();
  loadTrash().then(renderTrash);
}
function closeTrash(){ document.getElementById('trash-overlay').style.display='none'; }

function renderTrash(){
  const list = document.getElementById('trash-list');
  const empty = document.getElementById('trash-empty');
  if(!trashedItems.length){ list.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  list.innerHTML = trashedItems.map(w=>{
    const daysLeft = Math.ceil((new Date(w.trashed_at).getTime() + TRASH_DAYS*86400000 - Date.now()) / 86400000);
    const typeLabel = w._type==='sold' ? '(Sold)' : '(Inventory)';
    return `<div class="trash-item">
      <div class="trash-item-info">
        <div class="trash-item-name">${w.brand} ${w.model} <span class="trash-badge">${typeLabel}</span></div>
        <div class="trash-item-sub">${[w.ref, w.serial ? 'SN:'+w.serial : ''].filter(Boolean).join(' · ')} ${w.year||''}</div>
        <div class="trash-item-days">Permanently deleted in ${daysLeft} day${daysLeft!==1?'s':''}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:0.4rem">
        <button class="btn-outline btn-sm" onclick="restoreFromTrash('${w.id}','${w._type}')">↩ Restore</button>
        <button class="btn-danger btn-sm" onclick="permanentDelete('${w.id}','${w._type}')">Delete Now</button>
      </div>
    </div>`;
  }).join('');
}

async function trashWatch(){
  if(!editingId){ showToast('No watch selected.'); return; }
  const isInv = !!inventory.find(w=>w.id===editingId);
  const table = isInv ? 'inventory' : 'sold_inventory';
  const confirmed = confirm(`Move this watch to the trash? You have ${TRASH_DAYS} days to restore it.`);
  if(!confirmed) return;
  await db.from(table).update({trashed:true, trashed_at:new Date().toISOString()}).eq('id',editingId);
  if(isInv){
    inventory = inventory.filter(w=>w.id!==editingId);
    renderInventory();
  } else {
    soldWatches = soldWatches.filter(w=>w.id!==editingId);
    renderSold();
  }
  closeModal();
  updateNavBadges();
  showToast('Watch moved to trash. You have 14 days to restore it.');
}

async function trashSoldWatch(id){
  const confirmed = confirm('Move this sold watch to the trash? You have 14 days to restore it.');
  if(!confirmed) return;
  await db.from('sold_inventory').update({trashed:true, trashed_at:new Date().toISOString()}).eq('id',id);
  soldWatches = soldWatches.filter(w=>w.id!==id);
  renderSold(); updateNavBadges();
  showToast('Moved to trash.');
}

async function restoreFromTrash(id, type){
  const table = type==='sold' ? 'sold_inventory' : 'inventory';
  await db.from(table).update({trashed:false, trashed_at:null}).eq('id',id);
  trashedItems = trashedItems.filter(w=>!(w.id===id&&w._type===type));
  // Reload the restored item into local array
  const {data} = await db.from(table).select('*').eq('id',id).single();
  if(data){
    if(type==='inventory') inventory.unshift(data);
    else soldWatches.unshift(data);
  }
  renderTrash(); renderInventory(); renderSold(); updateNavBadges();
  showToast('Watch restored.');
}

async function permanentDelete(id, type){
  if(!confirm('Permanently delete this watch? This cannot be undone.')) return;
  const table = type==='sold' ? 'sold_inventory' : 'inventory';
  await db.from(table).delete().eq('id',id);
  trashedItems = trashedItems.filter(w=>!(w.id===id&&w._type===type));
  renderTrash();
  showToast('Permanently deleted.');
}


function loadNotesForWatch(id){ loadWatchNotes(id); }
// ── BOOT ──────────────────────────────────────────
document.addEventListener('DOMContentLoaded',()=>{
  initAuth();
  initPhotoListeners();
  initSoldPhotoListeners();
  // Inject logo into sidebar - above text, fills sidebar width
  const sidebarIcon=document.getElementById('sidebar-logo-icon');
  if(sidebarIcon&&typeof LOGO_SVG!=='undefined'){
    // Size to fit sidebar (210px wide, keep aspect ratio 600:700 = 0.857)
    // At width 160px, height = 160*(700/600) = 186px — fits well
    const sized=LOGO_SVG
      .replace(/width="600"/, 'width="160"')
      .replace(/height="700"/, 'height="187"');
    sidebarIcon.innerHTML=sized;
  }
});
</script>
</body>
</html>
